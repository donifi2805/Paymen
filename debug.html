<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandawa Debugger Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #111827; color: #e5e7eb; font-family: monospace; }
        .log-box { background: #1f2937; padding: 15px; border-radius: 8px; border: 1px solid #374151; margin-bottom: 10px; white-space: pre-wrap; word-break: break-all; font-size: 11px; max-height: 300px; overflow-y: auto; }
        .success { color: #34d399; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
    </style>
</head>
<body class="p-6 max-w-2xl mx-auto">

    <div class="mb-8 text-center">
        <h1 class="text-2xl font-bold text-white mb-2"><i class="fas fa-bug text-red-500 mr-2"></i>Pandawa Debugger</h1>
        <p class="text-gray-400 text-sm">Alat cek jalur API & Respon Khfy</p>
    </div>

    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700 mb-6">
        <div class="mb-4">
            <label class="block text-xs font-bold text-gray-400 mb-1">API KEY (Khfy)</label>
            <input type="text" id="apiKey" value="8F1199C1-483A-4C96-825E-F5EBD33AC60A" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white text-xs focus:border-blue-500 outline-none">
        </div>
        <div class="mb-4">
            <label class="block text-xs font-bold text-gray-400 mb-1">REF ID / TRX ID (UUID)</label>
            <input type="text" id="refId" placeholder="Contoh: 751d2003-..." class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white text-xs focus:border-blue-500 outline-none">
            <p class="text-[10px] text-gray-500 mt-1">*Ambil ID ini dari Database Firestore (field: trx_id) atau riwayat aplikasi.</p>
        </div>
        <button onclick="startDebug()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg">
            MULAI DIAGNOSA
        </button>
    </div>

    <div id="resultArea" class="hidden">
        <h3 class="font-bold text-white mb-2">Logs & Analisa:</h3>
        
        <div class="mb-4">
            <p class="text-xs font-bold text-gray-400 mb-1">1. Cek Koneksi & Proxy</p>
            <div id="logConnection" class="log-box text-gray-500">Menunggu...</div>
        </div>

        <div class="mb-4">
            <p class="text-xs font-bold text-gray-400 mb-1">2. Respon Mentah (Raw JSON)</p>
            <div id="logRaw" class="log-box text-purple-300">Menunggu...</div>
        </div>

        <div class="mb-4">
            <p class="text-xs font-bold text-gray-400 mb-1">3. Kesimpulan Diagnosa</p>
            <div id="logAnalysis" class="bg-gray-800 p-4 rounded-xl border border-gray-600">
                Menunggu hasil...
            </div>
        </div>
    </div>

<script>
    // KONFIGURASI SAMA PERSIS DENGAN APLIKASI UTAMA
    const BASE_URL = "https://panel.khfy-store.com/api_v2";
    const PROXY_LIST = [
        { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
        { name: 'CorsProxy', url: 'https://corsproxy.io/?' },
        { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' },
        { name: 'AllOrigins', url: 'https://api.allorigins.win/raw?url=' },
        { name: 'Direct', url: '' }
    ];

    async function startDebug() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const refId = document.getElementById('refId').value.trim();
        const resArea = document.getElementById('resultArea');
        const logCon = document.getElementById('logConnection');
        const logRaw = document.getElementById('logRaw');
        const logAnl = document.getElementById('logAnalysis');

        if(!refId) return alert("Masukkan REF ID Transaksi!");

        resArea.classList.remove('hidden');
        logCon.innerHTML = "Memulai tes koneksi...\n";
        logRaw.innerHTML = "-";
        logAnl.innerHTML = '<p class="text-gray-400 text-xs animate-pulse">Sedang menganalisa...</p>';

        const targetUrl = `${BASE_URL}/history?api_key=${apiKey}&refid=${refId}`;
        
        let finalData = null;
        let usedProxy = null;

        // SIMULASI FETCHING SEPERTI DI INDEX.HTML
        for (const proxy of PROXY_LIST) {
            logCon.innerHTML += `> Mencoba jalur: ${proxy.name || 'Direct'}... `;
            const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 Detik
                
                const startT = Date.now();
                const response = await fetch(fullUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                const ping = Date.now() - startT;

                if (response.ok) {
                    const text = await response.text();
                    try {
                        const json = JSON.parse(text);
                        logCon.innerHTML += `<span class="success">BERHASIL (${ping}ms)</span>\n`;
                        finalData = json;
                        usedProxy = proxy.name;
                        break; // Stop jika berhasil
                    } catch (e) {
                        logCon.innerHTML += `<span class="warning">Bukan JSON</span>\n`;
                    }
                } else {
                    logCon.innerHTML += `<span class="error">HTTP ${response.status}</span>\n`;
                }
            } catch (error) {
                logCon.innerHTML += `<span class="error">GAGAL (${error.message})</span>\n`;
            }
        }

        // TAMPILKAN HASIL RAW
        if (finalData) {
            logRaw.innerText = JSON.stringify(finalData, null, 2);
            analyzeResult(finalData, usedProxy);
        } else {
            logRaw.innerHTML = '<span class="error">TIDAK ADA RESPON DARI SERVER MANAPUN.</span>';
            logAnl.innerHTML = `
                <div class="text-red-400 font-bold text-sm mb-2"><i class="fas fa-times-circle"></i> KESIMPULAN: BLOKIR JARINGAN</div>
                <p class="text-xs text-gray-300">Aplikasi tidak bisa menghubungi Khfy sama sekali.</p>
                <ul class="list-disc list-inside text-xs text-gray-400 mt-2">
                    <li>Coba ganti jaringan (WiFi ke Data atau sebaliknya).</li>
                    <li>IP Server Hosting/HP mungkin diblokir sementara oleh proxy publik.</li>
                </ul>
            `;
        }
    }

    function analyzeResult(data, proxy) {
        const logAnl = document.getElementById('logAnalysis');
        
        // NORMALISASI DATA (Sesuai logika index.html)
        const d = (data.data && data.data.trxid) ? data.data : (data.data || data); 
        
        // Cek Status
        const rawStatus = String(d.status || d.status_text || d.result || 'Unknown').toLowerCase();
        let appStatus = 'Pending';
        
        if (rawStatus.includes('sukses') || rawStatus.includes('success') || rawStatus === '0') appStatus = 'Sukses';
        else if (rawStatus.includes('gagal') || rawStatus.includes('batal') || rawStatus === '1') appStatus = 'Gagal';

        // Cek Pesan SN
        const sn = d.sn || d.keterangan || d.message || '-';

        let html = '';

        if (appStatus === 'Sukses') {
            html += `<div class="text-green-400 font-bold text-lg mb-2"><i class="fas fa-check-circle"></i> STATUS SERVER: SUKSES</div>`;
            html += `<p class="text-xs text-gray-300 mb-2">Aplikasi seharusnya menampilkan <b>SUKSES</b>.</p>`;
            html += `<div class="bg-gray-900 p-2 rounded text-xs text-gray-400 border border-gray-700">
                <b>Data Terbaca:</b><br>
                Status Asli: <span class="text-white">${rawStatus}</span><br>
                Status App: <span class="text-green-400">${appStatus}</span><br>
                SN/Pesan: <span class="text-white">${sn}</span>
            </div>`;
            html += `<p class="text-xs text-yellow-500 mt-3 font-bold">Kenapa di Aplikasi Masih Pending?</p>
            <ul class="list-disc list-inside text-xs text-gray-400 mt-1">
                <li>Apakah RefID yang dimasukkan (<code>${document.getElementById('refId').value}</code>) SAMA PERSIS dengan yang ada di aplikasi?</li>
                <li>Mungkin fitur "Auto-Check" di aplikasi gagal menyimpan ke database Firestore (Izin Write/Internet user terputus saat update).</li>
            </ul>`;

        } else if (appStatus === 'Gagal') {
            html += `<div class="text-red-400 font-bold text-lg mb-2"><i class="fas fa-times-circle"></i> STATUS SERVER: GAGAL</div>`;
            html += `<p class="text-xs text-gray-300">Transaksi memang gagal di server pusat.</p>`;
        } else {
            html += `<div class="text-orange-400 font-bold text-lg mb-2"><i class="fas fa-clock"></i> STATUS SERVER: PENDING</div>`;
            html += `<p class="text-xs text-gray-300">Server Khfy memang belum memproses transaksi ini (atau sedang proses).</p>`;
        }

        logAnl.innerHTML = html;
    }
</script>

</body>
</html>
