<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG: Double Refund Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #111827; color: #fff; font-family: monospace; }
        .log-item { border-bottom: 1px solid #374151; padding: 4px 0; }
        .success { color: #4ade80; }
        .fail { color: #f87171; }
        .info { color: #60a5fa; }
        .warn { color: #facc15; }
    </style>
</head>
<body class="p-6 max-w-2xl mx-auto">
    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
        <h1 class="text-2xl font-bold text-red-500"><i class="fas fa-bug mr-2"></i>EXPLOIT TESTER</h1>
        <span class="bg-gray-800 text-xs px-2 py-1 rounded">v3.4 DoniGuard Check</span>
    </div>
    
    <div id="authStatus" class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-700">
        <p class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-1">Target User</p>
        <h2 id="userDisplay" class="text-lg font-bold animate-pulse text-yellow-500">Memuat status login...</h2>
        <p class="text-[10px] text-gray-500 mt-2">*Pastikan Anda sudah login di <a href="index.html" class="text-blue-400 underline">index.html</a> pada browser ini.</p>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <button onclick="runExploitTest()" id="btnRun" disabled class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-red-900/50">
            <i class="fas fa-bomb mr-2"></i>JALANKAN SERANGAN (5x)
        </button>
        <button onclick="window.location.reload()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-4 rounded-lg transition shadow-lg">
            <i class="fas fa-sync mr-2"></i>Reset Konsol
        </button>
    </div>

    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 h-96 overflow-y-auto font-mono text-xs shadow-inner" id="consoleLogs">
        <div class="text-gray-500 italic">// Menunggu perintah eksekusi...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, runTransaction, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Konfigurasi Firebase (Sama dengan Index)
        const firebaseConfig = {
            apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
            authDomain: "ppob-3ea96.firebaseapp.com",
            projectId: "ppob-3ea96",
            storageBucket: "ppob-3ea96.firebasestorage.app",
            messagingSenderId: "181320175094",
            appId: "1:181320175094:web:306b79071018410b910bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- UTILS: UI LOGGER ---
        function log(msg, type = 'normal') {
            const box = document.getElementById('consoleLogs');
            const div = document.createElement('div');
            div.className = 'log-item ' + type;
            div.innerHTML = `<span class="opacity-50 mr-2">[${new Date().toLocaleTimeString('id-ID', {hour12:false})}]</span>${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- 1. AUTH CHECKER ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userDisplay').innerText = "✅ TERHUBUNG: " + (user.email || user.uid);
                document.getElementById('userDisplay').classList.remove('animate-pulse', 'text-yellow-500');
                document.getElementById('userDisplay').classList.add('text-green-400');
                document.getElementById('btnRun').disabled = false;
                log("Koneksi Firebase Berhasil. User Authenticated.", 'success');
            } else {
                document.getElementById('userDisplay').innerText = "❌ BELUM LOGIN";
                document.getElementById('userDisplay').classList.remove('text-yellow-500');
                document.getElementById('userDisplay').classList.add('text-red-500');
                document.getElementById('btnRun').disabled = true;
                log("Silakan buka index.html dan login terlebih dahulu.", 'fail');
            }
        });

        // --- 2. SISTEM TARGET (DONIGUARD REPLICA) ---
        // Kita mendefinisikan ulang fungsi ini di sini agar bisa dites secara terisolasi
        
        async function logDoniGuardAudit(t, uid, type, amount, before, after, trxId, note) {
            const auditId = 'DG-TEST-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            const auditRef = doc(db, "doniguard_audit", auditId);
            t.set(auditRef, {
                uid: uid, type: type, amount: amount,
                balance_before: before, balance_after: after,
                trx_id: trxId, timestamp: serverTimestamp(), note: note
            });
        }

        // Ini adalah fungsi inti yang akan kita serang
        async function processSmartRefund(uid, trxId, reason) {
            const userRef = doc(db, "users", uid);
            const historyRef = doc(db, "users", uid, "history", trxId);
            
            try {
                // KUNCI KEAMANAN: runTransaction (Atomic Operation)
                await runTransaction(db, async (t) => {
                    const trxDoc = await t.get(historyRef);
                    const userDoc = await t.get(userRef);
                    
                    if (!trxDoc.exists()) throw "Trx 404";
                    const trxData = trxDoc.data();
                    
                    // --- DONIGUARD CHECK POINT ---
                    // Jika status sudah REFUNDED, tolak request berikutnya
                    if (trxData.doniguard_status === 'REFUNDED') {
                        throw "BLOCKED: Transaksi sudah direfund sebelumnya!";
                    }

                    const currentBal = userDoc.data().balance || 0;
                    const amountTrx = parseInt(trxData.amount) || 0;
                    const newBalance = currentBal + amountTrx;

                    // EKSEKUSI REFUND
                    t.update(userRef, { balance: newBalance });
                    t.update(historyRef, {
                        status: 'Gagal',
                        api_msg: reason,
                        doniguard_status: 'REFUNDED', // Flagging
                        is_refunded: true,
                        refund_date: new Date().toISOString()
                    });
                    
                    logDoniGuardAudit(t, uid, 'REFUND', amountTrx, currentBal, newBalance, trxId, reason);
                });
                return { success: true, msg: "Refund Berhasil" };
            } catch (e) {
                // Jika error string, kembalikan msg. Jika object error, ambil message
                const errMsg = typeof e === 'string' ? e : e.message;
                return { success: false, msg: errMsg };
            }
        }

        // --- 3. EXPLOIT RUNNER (PENYERANG) ---
        window.runExploitTest = async () => {
            const box = document.getElementById('consoleLogs');
            box.innerHTML = ''; // Clear logs
            
            log("--- MEMULAI SKENARIO SERANGAN ---", 'info');
            const amount = 5000;
            const testTrxId = 'EXPL-' + Date.now();
            const userRef = doc(db, "users", currentUser.uid);

            try {
                // LANGKAH 1: SETUP (Buat Transaksi Palsu)
                log("1. SETUP: Membuat transaksi dummy pending...", 'warn');
                await runTransaction(db, async (t) => {
                    const uSnap = await t.get(userRef);
                    const currentBal = uSnap.data().balance || 0;
                    
                    // Kurangi saldo user (pura-pura beli)
                    t.update(userRef, { balance: currentBal - amount });
                    
                    // Buat history pending di database
                    const hRef = doc(db, "users", currentUser.uid, "history", testTrxId);
                    t.set(hRef, {
                        title: "⚔️ TARGET UJI COBA",
                        amount: amount,
                        type: 'out',
                        date: new Date().toISOString(),
                        status: 'Pending',
                        trx_id: testTrxId,
                        balance_before: currentBal,
                        balance_after: currentBal - amount
                    });
                });
                log(`   > Sukses. ID: ${testTrxId} | Nominal: Rp ${amount}`, 'normal');

                // LANGKAH 2: SERANGAN (Race Condition)
                log("2. ATTACK: Mengirim 5 Request Refund Serentak...", 'fail');
                log("   > Menguji ketahanan Transaction Lock...", 'normal');
                
                // Membuat 5 janji (promise) eksekusi tanpa 'await' satu per satu
                // Ini mensimulasikan klik tombol 5x sangat cepat atau lag jaringan
                const attacks = [];
                for(let i=1; i<=5; i++) {
                    attacks.push(
                        processSmartRefund(currentUser.uid, testTrxId, `Exploit Attempt #${i}`)
                        .then(res => ({ id: i, ...res }))
                    );
                }

                // Tunggu semua selesai
                const results = await Promise.all(attacks);

                // LANGKAH 3: ANALISIS HASIL
                log("3. HASIL AKHIR:", 'info');
                let successCount = 0;
                let blockedCount = 0;

                results.forEach(r => {
                    if(r.success) {
                        successCount++;
                        log(`   [REQ #${r.id}] ❌ JEBOL! Refund Sukses`, 'fail');
                    } else {
                        blockedCount++;
                        // Cek pesan error, pastikan itu dari DoniGuard
                        const isProtected = r.msg.includes("BLOCKED") || r.msg.includes("direfund sebelumnya");
                        log(`   [REQ #${r.id}] ✅ ${isProtected ? 'TERTANGKIS' : 'GAGAL'}: ${r.msg}`, isProtected ? 'success' : 'warn');
                    }
                });

                log("===================================");
                if(successCount === 1 && blockedCount === 4) {
                    log("KESIMPULAN: SISTEM AMAN (SECURE)", 'success');
                    log("Mekanisme 'runTransaction' berhasil mencegah Race Condition.", 'success');
                } else if(successCount > 1) {
                    log(`KESIMPULAN: SISTEM JEBOL (VULNERABLE)! ${successCount}x Refund Masuk.`, 'fail');
                    log("Saldo user bertambah berlipat ganda.", 'fail');
                } else {
                    log("KESIMPULAN: Tidak Biasa (Gagal Semua/Error Lain).", 'warn');
                }

            } catch (e) {
                log("FATAL ERROR: " + e.message, 'fail');
            }
        };
        
        // Expose function to global scope for button click
        window.runExploitTest = runExploitTest;
    </script>
</body>
</html>