<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG CONSOLE - Pandawa Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Consolas', monospace; }
        .log-container { height: 200px; overflow-y: auto; background: #000; padding: 10px; border-radius: 8px; font-size: 12px; border: 1px solid #334155; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        input, select { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-blue-400"><i class="fas fa-terminal mr-2"></i>DEBUG SYSTEM V3</h1>
            <div id="authStatus" class="text-xs bg-red-900/30 text-red-400 px-3 py-1 rounded-full border border-red-800">Disconnected</div>
        </div>

        <div class="mb-6">
            <p class="text-xs font-bold text-gray-500 mb-2">SYSTEM LOGS</p>
            <div id="logs" class="log-container">
                <div class="info">> System initialized. Waiting for Auth...</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                <h2 class="text-sm font-bold mb-3 border-b border-slate-800 pb-2 text-blue-300">USER INFO</h2>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between"><span>Username:</span> <span id="uName">-</span></div>
                    <div class="flex justify-between"><span>Balance:</span> <span id="uBal" class="text-green-400">Rp 0</span></div>
                    <div class="flex justify-between"><span>UID:</span> <span id="uUid" class="text-[10px] text-gray-500">-</span></div>
                </div>
            </div>

            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                <h2 class="text-sm font-bold mb-3 border-b border-slate-800 pb-2 text-orange-300">FORCE TRANSACTION</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1">Target Number</label>
                        <input type="tel" id="targetNum" class="w-full p-2 rounded text-sm" placeholder="08xxx">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1">Product SKU / Code</label>
                        <input type="text" id="productCode" class="w-full p-2 rounded text-sm" placeholder="Contoh: XDA13">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="executeDebugTrx('KHFY')" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded text-xs font-bold">BYPASS KHFY</button>
                        <button onclick="executeDebugTrx('ICS')" class="flex-1 bg-cyan-600 hover:bg-cyan-700 py-2 rounded text-xs font-bold">BYPASS ICS</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 bg-slate-900 p-4 rounded-xl border border-slate-800">
            <h2 class="text-sm font-bold mb-3 text-purple-300">RECENT RAW DATA</h2>
            <div id="rawHistory" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <p class="text-[10px] text-gray-500 italic">No recent transaction data found.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Identical Config from index.html
        const firebaseConfig = {
            apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
            authDomain: "ppob-3ea96.firebaseapp.com",
            projectId: "ppob-3ea96",
            storageBucket: "ppob-3ea96.firebasestorage.app",
            messagingSenderId: "181320175094",
            appId: "1:181320175094:web:306b79071018410b910bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const PROXY = "https://api.codetabs.com/v1/proxy?quest=";
        const KHFY_CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };
        const ICS_CONFIG = { apiKey: "dcc0a69aa74abfde7b1bc5d252d858cb2fc5e32192da06a3", baseUrl: "https://reseller.ics-store.my.id" };

        let currentUser = null;
        let userData = null;

        function addLog(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        onAuthStateChanged(auth, (user) => {
            const status = document.getElementById('authStatus');
            if (user) {
                currentUser = user;
                status.innerText = "Connected: " + user.email;
                status.className = "text-xs bg-green-900/30 text-green-400 px-3 py-1 rounded-full border border-green-800";
                addLog(`User authenticated: ${user.uid}`, 'success');
                listenUserData(user.uid);
            } else {
                status.innerText = "Disconnected";
                addLog("No user session found. Please login at index.html", 'error');
            }
        });

        function listenUserData(uid) {
            onSnapshot(doc(db, "users", uid), (snap) => {
                if (snap.exists()) {
                    userData = snap.data();
                    document.getElementById('uName').innerText = userData.username || 'N/A';
                    document.getElementById('uBal').innerText = `Rp ${parseInt(userData.balance).toLocaleString()}`;
                    document.getElementById('uUid').innerText = uid;
                }
            });

            // Listen History
            const q = query(collection(db, "users", uid, "history"), orderBy("date", "desc"), limit(5));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('rawHistory');
                container.innerHTML = '';
                snap.forEach(d => {
                    const t = d.data();
                    container.innerHTML += `
                        <div class="bg-black/40 p-2 rounded border border-slate-800 text-[10px]">
                            <div class="flex justify-between font-bold">
                                <span class="text-blue-400">${t.title}</span>
                                <span class="${t.status === 'Sukses' ? 'text-green-400' : 'text-orange-400'}">${t.status}</span>
                            </div>
                            <div class="text-gray-500 mt-1">ID: ${t.trx_id} | MSG: ${t.api_msg || '-'}</div>
                        </div>
                    `;
                });
            });
        }

        window.executeDebugTrx = async (system) => {
            const num = document.getElementById('targetNum').value;
            const code = document.getElementById('productCode').value;

            if (!num || !code) return alert("Nomor dan Kode wajib diisi!");
            if (!currentUser) return alert("Auth Session Error!");

            addLog(`Starting ${system} Transaction for ${code}...`);
            
            const reffId = `DBG-${Date.now()}`;
            const trxCode = Math.floor(100000 + Math.random() * 900000).toString();

            try {
                // 1. Database Deduction
                await runTransaction(db, async (t) => {
                    const uRef = doc(db, "users", currentUser.uid);
                    const uSnap = await t.get(uRef);
                    const bal = uSnap.data().balance;
                    
                    addLog(`Current balance: Rp ${bal}`);
                    
                    // Note: Pada mode debug kita tidak tahu harga pasti sebelum API hit, 
                    // tapi sistem asli butuh pengurangan saldo. Kita asumsikan harga input manual 0 untuk debug bypass jika mau.
                    // Namun agar identik, kita catat di history sebagai 'PROSES'.
                    
                    const hRef = doc(db, "users", currentUser.uid, "history", reffId);
                    t.set(hRef, {
                        title: `[DEBUG] ${code}`,
                        amount: 0,
                        type: 'out',
                        date: new Date().toISOString(),
                        status: 'Proses',
                        api_msg: 'Debug Bypass Sent',
                        trx_id: reffId,
                        trx_code: trxCode,
                        dest_num: num
                    });
                });

                // 2. Call API
                let result;
                if (system === 'KHFY') {
                    const url = `${KHFY_CONFIG.baseUrl}/trx?api_key=${KHFY_CONFIG.apiKey}&produk=${code}&tujuan=${num}&reff_id=${reffId}`;
                    const res = await fetch(PROXY + encodeURIComponent(url));
                    result = await res.json();
                } else {
                    const url = `${ICS_CONFIG.baseUrl}/?action=createTransaction&apikey=${ICS_CONFIG.apiKey}&kode_produk=${code}&nomor_tujuan=${num}&refid=${reffId}`;
                    const res = await fetch(PROXY + encodeURIComponent(url));
                    result = await res.json();
                }

                addLog(`API Response: ${JSON.stringify(result)}`, 'info');
                
                if (result.success || result.status === 'success' || result.status === true) {
                    addLog("Transaction Accepted by Server!", 'success');
                    await updateDoc(doc(db, "users", currentUser.uid, "history", reffId), {
                        status: 'Pending',
                        api_msg: result.message || 'Processing'
                    });
                } else {
                    addLog("API Rejected: " + (result.message || result.error), 'error');
                }

            } catch (e) {
                addLog("Debug Execution Error: " + e.message, 'error');
            }
        };

    </script>
</body>
</html>