<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG CONSOLE - Pandawa Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Consolas', monospace; }
        .log-container { height: 200px; overflow-y: auto; background: #000; padding: 10px; border-radius: 8px; font-size: 12px; border: 1px solid #334155; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        input, select { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; }
        .tab-content.hidden { display: none; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-blue-400"><i class="fas fa-terminal mr-2"></i>DEBUG SYSTEM V3</h1>
            <div id="authStatus" class="text-xs bg-red-900/30 text-red-400 px-3 py-1 rounded-full border border-red-800">Disconnected</div>
        </div>

        <div class="mb-6">
            <p class="text-xs font-bold text-gray-500 mb-2">SYSTEM LOGS</p>
            <div id="logs" class="log-container">
                <div class="info">> System initialized. Waiting for Auth...</div>
            </div>
        </div>

        <div class="flex gap-2 mb-6 border-b border-slate-800 pb-2">
            <button onclick="switchTab('user-tab')" id="btn-user-tab" class="px-4 py-2 text-xs font-bold rounded-t-lg bg-blue-600 text-white transition-all">USER INFO</button>
            <button onclick="switchTab('preorder-tab')" id="btn-preorder-tab" class="px-4 py-2 text-xs font-bold rounded-t-lg bg-slate-800 text-gray-400 transition-all">REQUEST PREORDER</button>
        </div>

        <div id="user-tab-content" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                    <h2 class="text-sm font-bold mb-3 border-b border-slate-800 pb-2 text-blue-300">USER INFO</h2>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between"><span>Username:</span> <span id="uName">-</span></div>
                        <div class="flex justify-between"><span>Balance:</span> <span id="uBal" class="text-green-400">Rp 0</span></div>
                        <div class="flex justify-between"><span>UID:</span> <span id="uUid" class="text-[10px] text-gray-500">-</span></div>
                    </div>
                </div>

                <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                    <h2 class="text-sm font-bold mb-3 border-b border-slate-800 pb-2 text-orange-300">FORCE TRANSACTION</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] text-gray-400 mb-1">Target Number</label>
                            <input type="tel" id="targetNum" class="w-full p-2 rounded text-sm" placeholder="08xxx">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 mb-1">Product SKU / Code</label>
                            <input type="text" id="productCode" class="w-full p-2 rounded text-sm" placeholder="Contoh: XDA13">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="executeDebugTrx('KHFY')" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded text-xs font-bold transition-all">BYPASS KHFY</button>
                            <button onclick="executeDebugTrx('ICS')" class="flex-1 bg-cyan-600 hover:bg-cyan-700 py-2 rounded text-xs font-bold transition-all">BYPASS ICS</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="preorder-tab-content" class="tab-content hidden">
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                <h2 class="text-sm font-bold mb-4 text-purple-300 flex justify-between items-center">
                    <span>LIST REQUEST PREORDER</span>
                    <span id="po-count" class="bg-purple-900 text-purple-200 px-2 py-0.5 rounded text-[10px]">0 Antrean</span>
                </h2>
                <div id="preorder-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                    <p class="text-[10px] text-gray-500 italic">Menunggu data pre-order...</p>
                </div>
            </div>
        </div>

        <div class="mt-6 bg-slate-900 p-4 rounded-xl border border-slate-800">
            <h2 class="text-sm font-bold mb-3 text-purple-300">RECENT RAW DATA</h2>
            <div id="rawHistory" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <p class="text-[10px] text-gray-500 italic">No recent transaction data found.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, orderBy, limit, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
            authDomain: "ppob-3ea96.firebaseapp.com",
            projectId: "ppob-3ea96",
            storageBucket: "ppob-3ea96.firebasestorage.app",
            messagingSenderId: "181320175094",
            appId: "1:181320175094:web:306b79071018410b910bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const PROXY = "https://api.codetabs.com/v1/proxy?quest=";
        const KHFY_CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };
        const ICS_CONFIG = { apiKey: "dcc0a69aa74abfde7b1bc5d252d858cb2fc5e32192da06a3", baseUrl: "https://reseller.ics-store.my.id" };

        let currentUser = null;
        let userData = null;
        let currentProcessingPoId = null;

        function addLog(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        onAuthStateChanged(auth, (user) => {
            const status = document.getElementById('authStatus');
            if (user) {
                currentUser = user;
                status.innerText = "Connected: " + user.email;
                status.className = "text-xs bg-green-900/30 text-green-400 px-3 py-1 rounded-full border border-green-800";
                listenUserData(user.uid);
                listenPreOrders();
            } else {
                status.innerText = "Disconnected";
                addLog("No user session found.", 'error');
            }
        });

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tab + '-content').classList.remove('hidden');
            document.getElementById('btn-user-tab').className = tab === 'user-tab' ? 'px-4 py-2 text-xs font-bold rounded-t-lg bg-blue-600 text-white' : 'px-4 py-2 text-xs font-bold rounded-t-lg bg-slate-800 text-gray-400';
            document.getElementById('btn-preorder-tab').className = tab === 'preorder-tab' ? 'px-4 py-2 text-xs font-bold rounded-t-lg bg-purple-600 text-white' : 'px-4 py-2 text-xs font-bold rounded-t-lg bg-slate-800 text-gray-400';
        };

        function listenPreOrders() {
            const q = query(collection(db, "preorders"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('preorder-list');
                document.getElementById('po-count').innerText = snap.size + " Antrean";
                container.innerHTML = '';

                snap.forEach(docSnap => {
                    const po = docSnap.data();
                    const id = docSnap.id;
                    const date = po.timestamp ? new Date(po.timestamp.toDate()).toLocaleString('id-ID') : '-';
                    
                    container.innerHTML += `
                        <div class="bg-black/40 p-3 rounded-lg border border-slate-700 text-[11px] mb-3">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="text-purple-400 font-bold">${po.productName}</span>
                                    <span class="text-gray-500 block text-[9px]">${date}</span>
                                </div>
                                <span class="px-2 py-0.5 rounded text-[9px] font-bold ${po.status === 'Pending' ? 'bg-orange-900 text-orange-300' : 'bg-green-900 text-green-300'}">${po.status}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-3 bg-slate-800/50 p-2 rounded">
                                <div><p class="text-gray-500 text-[9px]">Target:</p><p class="font-bold text-white">${po.targetNumber}</p></div>
                                <div><p class="text-gray-500 text-[9px]">User:</p><p class="font-bold text-white">${po.username}</p></div>
                                <div><p class="text-gray-500 text-[9px]">Provider (Code):</p><p class="font-bold text-blue-400">${po.provider}</p></div>
                                <div><p class="text-gray-500 text-[9px]">Harga:</p><p class="font-bold text-green-400">Rp ${parseInt(po.price).toLocaleString()}</p></div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="processPreOrderToSystem('${id}', '${po.targetNumber}', '${po.provider}')" class="flex-1 bg-purple-600 hover:bg-purple-700 py-1.5 rounded text-[10px] font-bold flex items-center justify-center gap-1 transition-all"><i class="fas fa-bolt"></i> PROSES SISTEM</button>
                                <button onclick="deletePo('${id}')" class="bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded text-[10px] transition-all"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.processPreOrderToSystem = async (id, target, providerCode) => {
            if(!confirm(`Proses Pre-Order menggunakan kode ${providerCode}?`)) return;
            
            try {
                currentProcessingPoId = id; // Simpan ID untuk auto-delete
                const numInput = document.getElementById('targetNum');
                const codeInput = document.getElementById('productCode');

                if(!numInput || !codeInput) throw new Error("Input tidak ditemukan.");

                numInput.value = target;
                codeInput.value = providerCode; 
                
                addLog(`Auto-fill: Target=${target}, Code=${providerCode}`, 'info');
                switchTab('user-tab');
                
                await window.executeDebugTrx('KHFY');
                
                await updateDoc(doc(db, "preorders", id), { 
                    status: "Diproses",
                    processedAt: serverTimestamp()
                });
            } catch(e) {
                addLog("Gagal: " + e.message, 'error');
            }
        };

        window.deletePo = async (id) => {
            if(!confirm('Hapus permanen data ini?')) return;
            try {
                await deleteDoc(doc(db, "preorders", id));
                addLog("Data dihapus.", 'info');
            } catch(e) { addLog("Error: " + e.message, 'error'); }
        };

        function listenUserData(uid) {
            onSnapshot(doc(db, "users", uid), (snap) => {
                if (snap.exists()) {
                    userData = snap.data();
                    document.getElementById('uName').innerText = userData.username || 'N/A';
                    document.getElementById('uBal').innerText = `Rp ${parseInt(userData.balance).toLocaleString()}`;
                    document.getElementById('uUid').innerText = uid;
                }
            });
        }

        window.executeDebugTrx = async (system) => {
            const num = document.getElementById('targetNum').value;
            const code = document.getElementById('productCode').value;

            if (!num || !code) return alert("Data tidak lengkap!");
            addLog(`Eksekusi ${system} untuk kode ${code}...`);
            
            const reffId = `DBG-${Date.now()}`;
            try {
                let result;
                if (system === 'KHFY') {
                    const url = `${KHFY_CONFIG.baseUrl}/trx?api_key=${KHFY_CONFIG.apiKey}&produk=${code}&tujuan=${num}&reff_id=${reffId}`;
                    const res = await fetch(PROXY + encodeURIComponent(url));
                    result = await res.json();
                } else {
                    const url = `${ICS_CONFIG.baseUrl}/?action=createTransaction&apikey=${ICS_CONFIG.apiKey}&kode_produk=${code}&nomor_tujuan=${num}&refid=${reffId}`;
                    const res = await fetch(PROXY + encodeURIComponent(url));
                    result = await res.json();
                }

                const rawResponse = JSON.stringify(result);
                addLog(`API Response: ${rawResponse}`, (result.success || result.status === 'success' || result.status === true) ? 'success' : 'error');
                
                // AUTO-DELETE LOGIC
                if (rawResponse.includes("#Gagal. Produk Salah")) {
                    addLog("Indikasi Produk/Nomor Salah terdeteksi. Menghapus antrean...", 'error');
                    if (currentProcessingPoId) {
                        await deleteDoc(doc(db, "preorders", currentProcessingPoId));
                        addLog(`Pre-Order ${currentProcessingPoId} dihapus otomatis.`, 'success');
                        currentProcessingPoId = null;
                    }
                }
            } catch (e) {
                addLog("Error API: " + e.message, 'error');
            }
        };
    </script>
</body>
</html>