<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pandawa Store</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); overflow-x: hidden; padding-bottom: 90px; }
        body { background-color: #f8fafc; }
        .app-container { background-color: #ffffff; }
        html.dark body { background-color: #111827; } 
        html.dark .app-container { background-color: #030712; box-shadow: 0 0 25px rgba(0,0,0,0.5); } 
        .hide { display: none !important; }
        .page { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes pop-in { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
@keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        .bg-gradient-brand { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        html.dark .bg-gradient-brand { background: linear-gradient(135deg, #1d4ed8 0%, #172554 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .input-group { position: relative; }
        .input-group i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; z-index: 10;}
        .input-group input:focus + i { color: #2563eb; }
        .input-group input { padding-left: 44px; transition: all 0.3s; }
        .input-group select { padding-left: 44px; transition: all 0.3s; appearance: none; }
        html.dark .input-group i { color: #6b7280; }
        html.dark .input-group input:focus + i { color: #60a5fa; }
        .qris-btn-container { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .qris-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3); border: 2px solid white; }
        html.dark .qris-btn { border-color: #1f2937; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Profile Upload Style */
        .profile-upload { width: 100px; height: 100px; margin: 0 auto; position: relative; cursor: pointer; border-radius: 50%; border: 3px dashed #cbd5e1; overflow: hidden; transition: all 0.3s; }
        .profile-upload:hover { border-color: #2563eb; }
        .profile-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .profile-upload .upload-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #94a3b8; pointer-events: none; }
            /* LIVE CHAT STYLES */
        .chat-float-btn { position: fixed; bottom: 65px; left: 90%; transform: translateX(-50%); z-index: 50; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); transition: all 0.3s; }
        .chat-float-btn:active { transform: scale(0.9); }
        @keyframes floatBounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } }
        
        .chat-window { position: fixed; bottom: 100px; right: 20px; width: 320px; height: 450px; background: white; z-index: 46; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transform-origin: bottom right; transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); border: 1px solid #e2e8f0; }
        html.dark .chat-window { background: #111827; border-color: #374151; }
        .chat-window.hide { transform: scale(0); opacity: 0; pointer-events: none; }
        
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; background-color: #f8fafc; }
        html.dark .chat-body { background-color: #0f172a; }
        
        .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 12px; line-height: 1.4; position: relative; word-wrap: break-word; margin-bottom: 8px; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .chat-me { align-self: flex-end; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-bottom-right-radius: 2px; margin-left: auto; }
        .chat-admin { align-self: flex-start; background: #e2e8f0; color: #1e293b; border-bottom-left-radius: 2px; margin-right: auto; }
        html.dark .chat-admin { background: #374151; color: #f3f4f6; }
            .prov-maintenance { filter: grayscale(100%); opacity: 0.8; background-color: #f3f4f6 !important; border-color: #e5e7eb !important; cursor: not-allowed !important; pointer-events: none; } 
        html.dark .prov-maintenance { background-color: #1f2937 !important; border-color: #374151 !important; } 
        .mt-badge { display: none; font-size: 9px; background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 8px; } 
        .prov-maintenance .mt-badge { display: inline-block; } 
        .prov-maintenance .fa-chevron-right { display: none; }
</style>
</head>
<body>

<div class="app-container transition-colors duration-300">

        
    
    
    
    <div id="customAlertModal" class="hide fixed inset-0 z-[300] flex items-center justify-center bg-black/60 backdrop-blur-sm p-6">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl border border-white/20 dark:border-gray-800 transform transition-all animate-pop-in relative overflow-hidden">
            <div id="alertIconContainer" class="w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                <i id="alertIcon" class="text-4xl text-white"></i>
            </div>
            <div class="text-center">
                <h3 id="alertTitle" class="text-xl font-black text-gray-800 dark:text-white mb-2 tracking-tight uppercase"></h3>
                <p id="alertMessage" class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-8 px-2"></p>
                <button onclick="closeAlert()" class="w-full py-4 bg-gradient-brand text-white font-black rounded-2xl shadow-xl shadow-blue-600/30 active:scale-95 transition-all uppercase tracking-wider text-xs">Oke, Mengerti</button>
            </div>
        </div>
    </div>
<div id="updateNoticeModal" class="hide fixed inset-0 z-[300] flex items-center justify-center bg-black/80 backdrop-blur-md p-6">
        <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl relative border-2 border-orange-500 animate-pop-in">
            <button onclick="closeUpdateNotice()" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 dark:bg-gray-800 text-gray-500 hover:text-red-500 rounded-full flex items-center justify-center transition-all z-10 shadow-sm">
                <i class="fas fa-times text-lg"></i>
            </button>
            <div class="bg-orange-500 p-6 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-white mb-2"></i>
                <h3 class="text-xl font-black text-white leading-tight uppercase">PEMBERITAHUAN UPDATE!!</h3>
            </div>
            <div class="p-8">
                <div class="space-y-4 text-sm leading-relaxed">
                    <p class="text-gray-600 dark:text-gray-300 font-medium text-center">
                        Dikarenakan server down, sistem telah diperbarui ke server baru.
                    </p>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800">
                        <p class="text-blue-700 dark:text-blue-300 text-xs font-bold">
                             <i class="fab fa-google mr-1"></i> User Google:
                        </p>
                        <p class="text-gray-600 dark:text-gray-400 text-xs mt-1">
                            Aman. Silakan masuk menggunakan email yang biasa digunakan untuk login.
                        </p>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-2xl border-2 border-dashed border-red-200 dark:border-red-800">
                        <p class="text-red-600 dark:text-red-400 text-xs font-black uppercase">
                            <i class="fas fa-envelope mr-1"></i> User Email & Sandi:
                        </p>
                        <p class="text-gray-800 dark:text-gray-200 text-xs mt-2 font-bold">
                            Harap DAFTARKAN AKUN ANDA KEMBALI menggunakan <span class="text-red-600 underline">EMAIL YANG SAMA</span> seperti sebelumnya agar saldo tersinkronisasi otomatis.
                        </p>
                    </div>
                </div>
                <button onclick="closeUpdateNotice()" class="mt-8 w-full py-4 bg-orange-500 hover:bg-orange-600 text-white font-black rounded-2xl shadow-lg shadow-orange-500/30 transition-all active:scale-95 uppercase tracking-wider text-sm">
                    Saya Mengerti
                </button>
            </div>
        </div>
    </div>
<div id="globalNotifModal" class="hide fixed inset-0 z-[250] flex items-center justify-center bg-black/80 backdrop-blur-sm p-6 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative animate-pop-in">
            <button onclick="closeGlobalNotif()" class="absolute top-3 right-3 w-8 h-8 bg-black/20 hover:bg-red-500 text-white rounded-full flex items-center justify-center transition z-10 backdrop-blur-md">
                <i class="fas fa-times"></i>
            </button>
            <div id="gNotifImageArea" class="hide w-full flex justify-center items-center bg-gray-50 dark:bg-gray-800 rounded-xl mb-4 overflow-hidden">
                <img id="gNotifImg" src="" class="w-auto h-auto max-w-full max-h-[60vh] object-contain shadow-sm rounded-lg">
            </div>
            <div class="p-6 text-center">
                <h3 id="gNotifTitle" class="text-xl font-black text-gray-800 dark:text-white mb-2 leading-tight"></h3>
                <p id="gNotifBody" class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed max-h-40 overflow-y-auto custom-scroll"></p>
                <button onclick="closeGlobalNotif()" class="mt-6 w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition">Tutup</button>
            </div>
        </div>
    </div>

<div id="globalLoader" class="hide fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 p-5 rounded-2xl flex flex-col items-center shadow-2xl">
            <div class="loader mb-3"></div>
            <p class="text-xs font-bold text-gray-600 dark:text-gray-300" id="loaderText">Memuat Data...</p>
        </div>
    </div>

    <div id="setupProfileModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl overflow-hidden">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Selamat Datang!</h3>
                <p class="text-xs text-gray-500">Lengkapi data diri Anda untuk melanjutkan.</p>
            </div>
            <div class="space-y-4">
                <div class="text-center mb-4">
                    <label for="setupProfilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800"><img id="setupProfilePreview" src="" alt="Profile"><div class="upload-placeholder" id="setupUploadPlaceholder"><i class="fas fa-camera text-2xl mb-1"></i><p class="text-[9px]">Foto (Wajib)</p></div></label>
                    <input type="file" id="setupProfilePicInput" accept="image/*" class="hidden" onchange="previewImage(this, 'setup')">
                </div>
                <div class="input-group"><input type="text" id="setupUsername" placeholder="Buat Username" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white"><i class="fas fa-user"></i></div>
                <div class="flex gap-2">
                    <div class="input-group w-1/2"><select id="setupGender" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-xs"><option value="" disabled selected>Gender</option><option value="Laki-laki">Pria</option><option value="Perempuan">Wanita</option></select><i class="fas fa-venus-mars"></i></div>
                    <div class="input-group w-1/2"><input type="date" id="setupDob" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-xs"><i class="fas fa-calendar"></i></div>
                </div>
                <button type="button" onclick="saveProfileSetup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg mt-2">SIMPAN & LANJUTKAN</button>
            </div>
        </div>
    </div>

    <div id="passwordPromptModal" class="hide fixed inset-0 z-[130] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 text-center">Konfirmasi Transaksi</h3>
            <p class="text-xs text-gray-500 text-center mb-4">Ketik <b>"ya"</b> (kecil semua) untuk melanjutkan.</p>
            <div class="input-group mb-4">
                <input type="text" id="confirmPasswordInput" placeholder="Ketik: ya" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-lg font-bold text-center uppercase">
            </div>
            <div class="flex gap-2">
                <button onclick="closePasswordPrompt(false)" class="flex-1 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 font-bold text-xs">Batal</button>
                <button id="btnConfirmPassword" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg">PROSES</button>
            </div>
        </div>
    </div>

    <div id="incomingRequestModal" class="hide fixed inset-0 z-[140] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-orange-500"></div>
            <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"><i class="fas fa-hand-holding-usd"></i></div>
            <h3 class="text-lg font-black text-gray-800 dark:text-white uppercase tracking-tight">Permintaan Dana</h3>
            <div class="my-4 py-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 mb-1">Dari Pengguna</p>
                <p class="text-base font-bold text-gray-800 dark:text-white mb-2" id="reqSenderName">-</p>
                <p class="text-xs text-gray-500 mb-1">Jumlah</p>
                <p class="text-2xl font-black text-blue-600 dark:text-blue-400" id="reqAmount">Rp 0</p>
            </div>
            <div class="flex gap-3">
                <button onclick="rejectRequest()" class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-red-500 font-bold text-xs hover:bg-gray-200">Tolak</button>
                <button onclick="approveRequest()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg shadow-blue-500/30">Setujui & Bayar</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="hide fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2rem] p-6 shadow-2xl border border-white/20 dark:border-gray-800 transform transition-all scale-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-brand"></div>
            <div class="text-center mb-6 mt-2">
                <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm ring-4 ring-blue-50/50 dark:ring-blue-900/20"><i class="fas fa-info-circle text-3xl"></i></div>
                <h3 class="text-xl font-black text-gray-800 dark:text-white mb-2 tracking-tight" id="confirmTitle">Konfirmasi</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed px-4" id="confirmMessage">Apakah anda yakin?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-3.5 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-bold text-xs hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-transparent hover:border-gray-200 dark:hover:border-gray-700">Batal</button>
                <button id="confirmYesBtn" class="flex-1 py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-xs shadow-lg shadow-blue-600/20 hover:shadow-blue-600/40 transition transform active:scale-95">Ya, Proses</button>
            </div>
        </div>
    </div>

                    <div id="detailTrxModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-blue-500"></div>
            <button onclick="closeTrxDetail()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 z-10"><i class="fas fa-times text-xl"></i></button>
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-2xl mb-4 text-center border border-blue-100 dark:border-blue-800">
                <p class="text-[10px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-widest">Kode Transaksi</p>
                <p class="text-lg font-mono font-black text-gray-800 dark:text-white" id="dtTrxCode">------</p>
            </div>
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Detail Transaksi</h3>
            
            <div class="space-y-3">
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
                    <p class="text-[10px] text-gray-500 mb-1">Produk / Layanan</p>
                    <p class="text-sm font-bold text-gray-800 dark:text-white leading-tight" id="dtTitle">-</p>
                </div>
                
                <div class="flex gap-3">
                    <div class="flex-1 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 relative">
                        <p class="text-[10px] text-gray-500 mb-1">Status</p>
                        <p class="text-xs font-bold" id="dtStatus">-</p>
                        <button id="btnRefreshStatus" onclick="" class="hide absolute top-2 right-2 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all shadow-sm"><i class="fas fa-sync-alt text-[10px]"></i></button>
                    </div>
                    <div class="flex-1 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-500 mb-1">Nominal</p>
                        <p class="text-xs font-bold text-gray-800 dark:text-white" id="dtAmount">-</p>
                    </div>
                </div>

                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
                    <p class="text-[10px] text-blue-600 dark:text-blue-400 mb-1 font-bold flex items-center gap-1"><i class="fas fa-info-circle"></i> Pesan Server / Info</p>
                    <p class="text-xs text-gray-700 dark:text-gray-300 font-mono break-words leading-relaxed" id="dtSn">-</p>
                </div>

                                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
                    <p class="text-[10px] text-gray-500 mb-1">Waktu Transaksi</p>
                    <p class="text-xs font-bold text-gray-800 dark:text-white" id="dtDate">-</p>
                </div>

                <div class="mt-2">
                    <details class="group" style="display:none!important">
                        <summary class="flex justify-between items-center cursor-pointer list-none p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-[10px] font-bold text-gray-500 hover:text-blue-600 select-none">
                            <span><i class="fas fa-code mr-1"></i> Lihat Data Mentah (JSON)</span>
                            <i class="fas fa-chevron-down transition-transform group-open:rotate-180"></i>
                        </summary>
                        <div class="mt-2 p-3 bg-gray-900 rounded-xl overflow-x-auto border border-gray-700 shadow-inner max-h-40 custom-scroll">
                            <pre id="dtRawJson" class="text-[9px] font-mono text-green-400 whitespace-pre-wrap leading-tight">Klik tombol refresh (ikon sync) di atas untuk memuat data mentah dari server...</pre>
                        </div>
                    </details>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                 <button onclick="copyToClipboard(document.getElementById('dtSn').innerText)" class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-bold text-xs hover:bg-gray-200"><i class="fas fa-copy mr-1"></i> Salin Info</button>
                 
                 <button id="btnCancelPreorder" onclick="" class="hide flex-1 py-3 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-bold text-xs hover:bg-red-200 transition"><i class="fas fa-ban mr-1"></i> Batalkan PO</button>
<button onclick="closeTrxDetail()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg">Tutup</button>
            </div>
        </div>
    </div>

<div id="stockModal" class="hide fixed inset-0 z-[120] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">Stok XL Akrab</h3>
                <button onclick="closeStockModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="stockList" class="overflow-y-auto pr-1 space-y-2 flex-1 no-scrollbar"></div>
            <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-800 text-center">
                 <p class="text-[10px] text-gray-400">Data Realtime Server v3</p>
            </div>
        </div>
    </div>

    <div id="invoiceModal" class="hide fixed inset-0 z-[150] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2rem] overflow-hidden shadow-2xl relative border border-white/20">
            <div class="bg-gradient-brand p-8 text-center relative overflow-hidden">
                <div class="absolute -top-10 -left-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <i class="fas fa-receipt text-5xl text-white/40 mb-3 transform -rotate-12"></i>
                <p class="text-blue-100 text-[10px] font-bold uppercase tracking-widest mb-1">Total Tagihan</p>
                <h2 class="text-3xl font-black text-white tracking-tight" id="invTotalMain">Rp 0</h2>
            </div>
            <div class="p-6 relative bg-white dark:bg-gray-900">
                <div class="absolute top-0 left-0 w-full -mt-2 flex justify-between px-2 overflow-hidden">
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                </div>
                
                <div class="space-y-4 mt-4">
                    <div class="flex justify-between items-start">
                        <span class="text-xs text-gray-500 font-medium">Produk</span>
                        <span class="text-xs font-bold text-gray-800 dark:text-white text-right max-w-[60%] leading-tight" id="invProductName">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-medium">Nomor Tujuan</span>
                        <span class="text-xs font-bold text-gray-800 dark:text-white font-mono bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded" id="invDestNum">-</span>
                    </div>
                    <div class="my-4 border-t-2 border-dashed border-gray-100 dark:border-gray-800"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-medium">Harga</span>
                        <span class="text-xs font-bold text-gray-800 dark:text-white" id="invPrice">Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-medium">Biaya Admin</span>
                        <span class="text-[10px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full">GRATIS</span>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-sm font-bold text-gray-800 dark:text-white">Total Bayar</span>
                        <span class="text-lg font-black text-blue-600 dark:text-blue-400" id="invTotalBottom">Rp 0</span>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="closeInvoice()" class="flex-1 py-3.5 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-bold text-xs hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-transparent hover:border-gray-200 dark:hover:border-gray-700">Batal</button>
                    <button id="btnPayInvoice" class="flex-1 py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-xs shadow-lg shadow-blue-600/30 hover:shadow-blue-600/50 transition transform active:scale-95">Konfirmasi Bayar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="fullQrModal" class="hide fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-md p-6 fade-enter">
        <div class="relative w-full max-w-xs flex flex-col items-center">
            <button onclick="closeFullQr()" class="absolute -top-12 right-0 w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white hover:bg-white/30 transition backdrop-blur-sm shadow-lg">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div class="bg-white p-4 rounded-3xl shadow-2xl w-full">
                <img id="fullQrImage" src="" class="w-full h-auto object-contain rounded-xl">
                <div class="text-center mt-4">
                    <p class="text-lg font-black text-gray-800">Scan QRIS</p>
                    <p class="text-xs text-gray-500">Pastikan nama merchant sesuai</p>
                </div>
            </div>
        </div>
    </div>

    <div id="qiosModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl relative">
            <button onclick="closeQios()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            
            <div id="qiosStep1">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">Top Up Saldo</h3>
                <p class="text-xs text-gray-500 mb-4">Pilih nominal instan atau manual</p>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="setTopUpAmount(50000)" class="py-3 rounded-xl bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold border border-blue-100 dark:border-blue-800 hover:bg-blue-100 transition shadow-sm">50.000</button>
                    <button onclick="setTopUpAmount(100000)" class="py-3 rounded-xl bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold border border-blue-100 dark:border-blue-800 hover:bg-blue-100 transition shadow-sm">100.000</button>
                </div>

                <div class="input-group mb-4">
                    <input type="number" id="qiosInputAmount" placeholder="Nominal Lain (Min 1.000)" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <button onclick="generateQiosTicket()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg mb-4">LANJUTKAN PEMBAYARAN</button>
                
                <div class="pt-3 border-t border-gray-100 dark:border-gray-800">
                     <div class="flex justify-between items-center mb-2">
                        <p class="text-[10px] font-bold text-gray-500">Riwayat Top Up Terakhir</p>
                        <span class="text-[9px] text-blue-500 cursor-pointer" onclick="nav('historyPage')">Lihat Semua</span>
                     </div>
                     <div id="qiosMiniHistory" class="space-y-2 max-h-32 overflow-y-auto no-scrollbar">
                        <p class="text-[10px] text-center text-gray-400 py-2">Memuat riwayat...</p>
                     </div>
                </div>
            </div>
                        
            <div id="qiosStep2" class="hide text-center">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Scan & Bayar</h3>
                <div class="bg-white p-2 rounded-xl border border-gray-200 inline-block mb-2">
                    <img id="qiosQrDisplay" src="" class="w-48 h-48 object-contain cursor-pointer hover:opacity-90 transition" onclick="openFullQr()">
                    <p class="text-[9px] text-gray-400 mt-1">(Klik gambar untuk memperbesar)</p>
                </div>
                <p class="text-xs text-gray-500">Total Transfer (Wajib Sama):</p>
                <div class="flex justify-center items-center gap-2 mb-2">
                    <h2 class="text-2xl font-black text-blue-600 dark:text-blue-400" id="qiosTotalDisplay">Rp 0</h2>
                    <button onclick="copyToClipboard(document.getElementById('qiosTotalDisplay').innerText.replace(/[^0-9]/g,''))" class="text-gray-400 hover:text-blue-500"><i class="fas fa-copy"></i></button>
                </div>
                
                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-2 mb-3 border border-red-100 dark:border-red-800">
                    <p class="text-[10px] text-red-600 dark:text-red-400 mb-0">Batas Waktu Pembayaran</p>
                    <div id="qiosTimerDisplay" class="text-xl font-mono font-bold text-red-600 dark:text-red-400">25:00</div>
                </div>

                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-xl border border-yellow-100 dark:border-yellow-800 mb-3">
                    <p class="text-[10px] text-left text-yellow-700 dark:text-yellow-400 leading-tight"><b>PENTING:</b><br>1. Transfer nominal persis sampai 3 digit terakhir.<br>2. Saldo masuk otomatis setelah transfer berhasil.</p>
                </div>
                
                <div class="flex flex-col gap-2">
                    <button onclick="checkQiosStatus()" id="btnCheckQios" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition">SAYA SUDAH BAYAR</button>
                    <button onclick="cancelQiosTransaction()" class="w-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 text-gray-500 hover:text-red-500 font-bold py-3 rounded-xl transition">Batalkan Transaksi</button>
                </div>
            </div>
        </div>
    </div>

            <div id="manualTopUpModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl relative">
            <button onclick="closeManualTopUp()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            
            <div id="mtStep1">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">Top Up Manual</h3>
                <p class="text-xs text-gray-500 mb-4">Metode Transfer Bank (Cek Manual)</p>
                
                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800 mb-4 text-center">
                    <p class="text-[10px] text-gray-500">Bank Tujuan</p>
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOXd7uJlgyXODfLIhtY64i_e5FRtHLSIE7KwhQ9c_MZg&s=10" class="h-6 mx-auto my-1">
                    <p class="text-sm font-bold text-gray-800 dark:text-white">901338749488</p>
                    <p class="text-[10px] text-gray-600 dark:text-gray-400 font-medium">a.n Denissa Ermadianis Tarisna Dewi</p>
                    <button onclick="copyToClipboard('901338749488')" class="mt-2 text-[10px] text-blue-600 font-bold bg-white dark:bg-gray-800 px-2 py-1 rounded border shadow-sm">Salin No. Rek</button>
                </div>

                <div class="input-group mb-4">
                    <input type="number" id="mtInputAmount" placeholder="Masukkan Nominal (Min 10.000)" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <button onclick="submitManualTopUp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg mb-2">LANJUTKAN</button>
            </div>

            <div id="mtStep2" class="hide">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-white rounded-full shadow-lg mx-auto flex items-center justify-center -mt-10 mb-3 relative z-10 border-4 border-white dark:border-gray-800">
                         <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOXd7uJlgyXODfLIhtY64i_e5FRtHLSIE7KwhQ9c_MZg&s=10" alt="Seabank" class="w-16">
                    </div>
                    <h3 class="text-xl font-black text-gray-800 dark:text-white">Menunggu Pembayaran</h3>
                    <p class="text-xs text-gray-500">Selesaikan pembayaran sebelum waktu habis</p>
                </div>

                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-2xl p-4 mb-4 border border-orange-100 dark:border-orange-800 flex justify-between items-center">
                    <span class="text-xs text-orange-600 dark:text-orange-400 font-bold"><i class="fas fa-stopwatch mr-1.5"></i>Sisa Waktu</span>
                    <span id="mtTimer" class="text-lg font-mono font-black text-orange-600 dark:text-orange-400">03:00:00</span>
                </div>

                <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-5 border border-gray-100 dark:border-gray-700 space-y-4 mb-6">
                    <div>
                        <p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold mb-1">Total Transfer (Wajib Sama)</p>
                        <div class="flex justify-between items-end">
                            <h2 class="text-3xl font-black text-blue-600 dark:text-blue-400 leading-none" id="mtTotalDisplay">Rp 0</h2>
                            <button onclick="copyToClipboard(document.getElementById('mtTotalDisplay').innerText.replace(/[^0-9]/g,''))" class="text-xs font-bold text-blue-600 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-lg transition">Salin</button>
                        </div>
                        <p class="text-[10px] text-red-400 italic mt-1">*Termasuk kode unik 3 digit terakhir</p>
                    </div>
                    <div class="border-t border-dashed border-gray-200 dark:border-gray-600"></div>
                    <div>
                        <p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold mb-1">Rekening Tujuan</p>
                        <div class="flex items-center gap-3">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOXd7uJlgyXODfLIhtY64i_e5FRtHLSIE7KwhQ9c_MZg&s=10" class="h-8">
                            <div class="flex-1">
                                <p class="text-sm font-bold text-gray-800 dark:text-white">901338749488</p>
                                <p class="text-[10px] text-gray-500">a.n Denissa Ermadianis Tarisna Dewi</p>
                            </div>
                            <button onclick="copyToClipboard('901338749488')" class="text-gray-400 hover:text-blue-600"><i class="fas fa-copy text-lg"></i></button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="closeManualTopUp()" class="w-full py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-sm shadow-lg shadow-blue-600/30 active:scale-95 transition-transform">Saya Sudah Transfer</button>
                    <button onclick="cancelManualTopUp()" class="w-full py-3.5 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-red-500 font-bold text-xs transition">Batalkan Transaksi</button>
                </div>
            </div>
        </div>
    </div>

    <div id="topUpSheet" class="hide fixed inset-0 z-50 flex flex-col justify-end bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-full rounded-t-[30px] p-6 modal-enter max-w-[480px] mx-auto">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Pilih Metode Top Up</h3>
            <div class="space-y-3">
                <div onclick="openManualTopUp()" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition mb-3">
                    <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center"><i class="fas fa-university"></i></div>
                    <div class="flex-1"><h4 class="font-bold text-gray-800 dark:text-white text-sm">Seabank (Manual)</h4><p class="text-xs text-gray-500">Konfirmasi Admin (Max 3 Jam)</p></div><i class="fas fa-chevron-right text-gray-300"></i>
                </div>
                <div onclick="openQios()" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition mb-3">
                    <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-qrcode"></i></div>
                    <div class="flex-1"><h4 class="font-bold text-gray-800 dark:text-white text-sm">QRIS (Otomatis)</h4><p class="text-xs text-gray-500">Metode QiosPay (Cek Otomatis)</p></div><i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            </div>
            <button onclick="closeTopUp()" class="mt-6 w-full py-3 text-gray-500 dark:text-gray-400 font-semibold text-sm">Tutup</button>
        </div>
    </div>

    <section id="loginPage" class="page flex flex-col justify-between min-h-screen bg-white dark:bg-gray-950 relative z-50">
        <div class="absolute top-0 left-0 w-full h-[45vh] bg-gradient-brand rounded-b-[50px] z-0"></div>
        <div class="relative z-10 px-8 pt-20 w-full">
            <div class="text-center mb-6 text-white">
                <div class="w-24 h-24 bg-white rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-2xl border-4 border-white/20 overflow-hidden transform hover:scale-105 transition-transform duration-300">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0fosGjHRqeGRj63MDerdrDw8AHgrP9qLpKg8f21SFnCQPjpHiQjUifDF8pMZwEPpVX7KWzLjgiMUHUmnzgSRRK4xjDa1ukm3Vwn6cZUARnuepXtSGHlXgsASE5UpoF4nKVLjMamAj7qR0wcP6qxR0UqIjw30OSUIhsjnrzwj8kE9HrgpE6cGMqvRRSLM/s1600/play_store_512.png" 
                     class="w-20 h-20 object-contain" 
                     alt="Pandawa Logo">
            </div>
                <h1 class="text-3xl font-bold tracking-tight">Pandawa Store</h1>
                <p class="text-blue-100 text-sm mt-1">Agen Pulsa PPOB Terpercaya</p>
<p class="text-blue-200/70 text-[10px] mt-2 font-mono tracking-widest bg-white/10 px-2 py-0.5 rounded-lg inline-block" id="versionDisplay">v3.1</p>
            </div>
            
            <div class="bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-xl shadow-blue-900/10 dark:shadow-black/30 transition-all duration-300">
                <h2 id="authTitle" class="text-xl font-bold text-gray-800 dark:text-white text-center mb-6">Masuk Akun</h2>
                <div id="authTabs" class="flex bg-gray-100 dark:bg-gray-800 rounded-xl p-1 mb-6">
                    <button id="tabEmail" onclick="switchLoginMethod('email')" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400 transition-all">Email</button>
                    <button id="tabPhone" onclick="switchLoginMethod('phone')" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">No. HP</button>
                </div>
                <div id="loginFormContainer" class="space-y-4">
                    <div id="registerFields" class="hide space-y-4 animate-fade-in-down">
                        <div class="text-center mb-4">
                            <label for="profilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800"><img id="profilePreview" src="" alt="Profile"><div class="upload-placeholder" id="uploadPlaceholder"><i class="fas fa-camera text-2xl mb-1"></i><p class="text-[9px]">Upload Foto (Wajib)</p></div></label>
                            <input type="file" id="profilePicInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                        </div>
                        <div class="input-group"><input type="text" id="regUsername" placeholder="Username" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11"><i class="fas fa-user" style="color: #94a3b8;"></i></div>
                        <div class="flex gap-2">
                            <div class="input-group w-1/2"><select id="regGender" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11"><option value="" disabled selected>Gender</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select><i class="fas fa-venus-mars" style="color: #94a3b8;"></i></div>
                            <div class="input-group w-1/2"><input type="date" id="regDob" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-100 text-xs font-medium pl-11"><i class="fas fa-calendar" style="color: #94a3b8;"></i></div>
                        </div>
                    </div>
                    <div class="input-group"><input type="email" id="emailInput" placeholder="Email" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11"><i class="fas fa-envelope" id="loginIcon"></i></div>
                    <div class="relative" id="passContainer">
                        <div class="input-group">
                            <input type="password" id="passwordInput" placeholder="Kata Sandi" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11 pr-10">
                            <i class="fas fa-lock"></i>
                        </div>
                        <button type="button" id="togglePassBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 z-20 outline-none"><i class="fas fa-eye"></i></button>
                    </div>
                    <div id="extraOptions" class="flex justify-between items-center text-xs mt-2"><label class="flex items-center gap-2 text-gray-500 dark:text-gray-400 cursor-pointer select-none"><input type="checkbox" id="rememberMe" class="rounded text-blue-600 focus:ring-blue-500 bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-700"><span>Ingat Saya</span></label><button onclick="setAuthMode('forgot')" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Lupa Sandi?</button></div>
                    <div id="otpContainer" class="hide space-y-4"><div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 text-xs text-blue-800 dark:text-blue-300">Kode OTP dikirim. Masukkan kode 6 digit.</div><input type="number" id="otpInput" placeholder="123456" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg font-bold tracking-widest"></div>
                    <div id="recaptcha-container"></div>
                    <button id="btnAuthAction" class="w-full bg-blue-600 dark:bg-blue-500 text-white h-12 rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-transform hover:bg-blue-700 mt-2">MASUK</button>
                    <button onclick="loginWithGoogle()" class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 h-12 rounded-xl font-bold shadow-sm active:scale-95 transition-transform hover:bg-gray-50 dark:hover:bg-gray-700 mt-3 flex items-center justify-center gap-3">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                        <span class="text-sm">Masuk dengan Google</span>
                    </button>
                    <button id="btnVerifyOtp" class="hide w-full bg-green-600 text-white h-12 rounded-xl font-bold shadow-lg shadow-green-500/30 active:scale-95 transition-transform hover:bg-green-700 mt-2">VERIFIKASI OTP</button>
                </div>
                <div id="authFooter" class="text-center mt-6 text-xs text-gray-500 dark:text-gray-400">Belum punya akun? <button onclick="setAuthMode('register')" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Daftar Sekarang</button></div>
                <div id="backToLoginContainer" class="hide text-center mt-6 text-xs"><button onclick="setAuthMode('login')" class="text-gray-500 dark:text-gray-400 font-bold hover:text-gray-800 dark:hover:text-white"><i class="fas fa-arrow-left mr-1"></i> Kembali ke Login</button></div>
                <p class="text-center text-[10px] text-gray-400 mt-4" id="statusMessage">Aman & Terenkripsi</p>
            </div>
        </div>
    </section>
    <section id="akrabV2Page" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="nav('homePage')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
                    <h2 class="font-bold text-lg text-gray-800 dark:text-white">Akrab v2 (Premium)</h2>
        </div>
        <div class="p-4 pb-24">
            <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
            <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Kategori / Provider</label>
                    <div onclick="openIcsSheet()" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <span id="icsProviderDisplay">XL Akrab (XLA)</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1"><label class="block text-xs font-bold text-gray-500 ml-1">Pilih Paket</label><button onclick="initAkrabV2Data()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100"><i class="fas fa-sync-alt mr-1"></i> Refresh</button></div>
                    <select id="icsProductSelect" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 px-3 text-sm font-bold dark:text-white" onchange="updateIcsPriceDisplay()">
                        <option value="" disabled selected>-- Memuat Data... --</option>
                    </select>
                    <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="icsPriceDisplay">Harga: -</p>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
                    <div class="input-group">
                        <input type="tel" id="icsNumberInput" placeholder="Nomor HP" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
                        <i class="fas fa-address-book text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 z-10"></i>
                    </div>
                </div>
                <button onclick="processAkrabV2Transaction()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-cyan-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span><i class="fas fa-arrow-right"></i></button>
                                <p class="text-[10px] text-gray-400 mt-4 text-center">Powered by Official API</p>
            </div>
        </div>
    </section>


    <section id="homePage" class="page hide bg-gray-50/50 dark:bg-gray-950">
        <div class="bg-gradient-brand text-white pt-8 pb-24 px-6 rounded-b-[40px] shadow-lg relative overflow-hidden">
            <div class="flex justify-between items-center mb-6 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border-2 border-white/30 p-0.5 overflow-hidden"><img id="headerProfileImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover rounded-full bg-white dark:bg-gray-800"></div>
                    <div><p class="text-xs text-blue-100">Selamat Datang,</p><p class="font-bold text-lg leading-tight" id="headerUsername">Loading...</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur flex items-center justify-center hover:bg-white/30 transition active:scale-95"><i id="themeIcon" class="fas fa-moon text-white"></i></button>
                </div>
            </div>
        </div>
        <div class="mx-6 -mt-24 relative z-20">
            <div class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl rounded-[2.5rem] p-5 shadow-[0_20px_40px_-15px_rgba(37,99,235,0.2)] dark:shadow-none border border-white/50 dark:border-gray-700 relative overflow-hidden group">
                <div class="flex justify-between items-start mb-3 relative">
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-1 flex items-center gap-1.5"><i class="fas fa-wallet text-blue-500"></i> Total Saldo</p>
                        <h2 class="text-[2.2rem] font-black text-gray-800 dark:text-white leading-none tracking-tight" id="displayBalance">Rp 0</h2>
                    </div>
                    <button onclick="initProductData()" class="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-800 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center shadow-sm"><i class="fas fa-sync-alt text-xs"></i></button>
                </div>
                <div class="grid grid-cols-4 gap-2">
                                        <div class="text-center group/btn cursor-pointer" onclick="openTopUpSheet()"><div class="w-11 h-11 mx-auto bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-600/30 mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300 relative"><div id="badge-topup-home" class="hide absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white rounded-full flex items-center justify-center text-[9px] font-bold">1</div><i class="fas fa-plus text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Top Up</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="nav('sendPage')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-paper-plane text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Kirim</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="nav('requestPage')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-arrow-down text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Minta</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="startScan()"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-qrcode text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Scan</span></div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 px-6">
            <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm">Layanan</h3>
            <div class="grid grid-cols-4 gap-4">
                <div class="text-center group cursor-pointer" onclick="openPPOB('akrab')"><div class="bg-blue-100 dark:bg-blue-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-globe text-blue-600 dark:text-blue-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Data</span></div>
                <div class="text-center group cursor-pointer" onclick="window.showAlert("Info", "Menu Paket OTP Segera Hadir", "info");"><div class="bg-emerald-100 dark:bg-emerald-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-key text-emerald-600 dark:text-emerald-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Paket OTP</span></div>
                <div class="text-center group cursor-pointer" onclick="nav('preorderPage')"><div class="bg-purple-100 dark:bg-purple-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-clock text-purple-600 dark:text-purple-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Pre-Order</span></div>
                <div class="text-center group cursor-pointer" onclick="checkAkrabStock()"><div class="bg-orange-100 dark:bg-orange-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-cubes text-orange-600 dark:text-orange-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Stok Akrab</span></div>
                <div class="text-center group cursor-pointer" onclick="window.showAlert("Info", "Menu Login OTP Segera Hadir", "info");"><div class="bg-rose-100 dark:bg-rose-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-lock text-rose-600 dark:text-rose-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Login OTP</span></div>
                <div class="text-center group cursor-pointer" onclick="nav('historyPage')"><div class="bg-indigo-100 dark:bg-indigo-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-history text-indigo-600 dark:text-indigo-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Riwayat</span></div>
            </div>
        </div>

                <div class="mt-6 px-6 mb-2">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-gray-800 dark:text-white text-sm">Live Stok Akrab</h3>
                <button id="btnRefreshStock" onclick="manualRefreshStock()" class="flex items-center gap-1 bg-blue-100 dark:bg-blue-900/30 px-3 py-1 rounded-lg active:scale-95 transition hover:bg-blue-200 dark:hover:bg-blue-800">
                    <i class="fas fa-sync-alt text-[10px] text-blue-600 dark:text-blue-400"></i>
                    <span class="text-[10px] text-blue-700 dark:text-blue-400 font-bold">Refresh Stok</span>
                </button>
            </div>
            <div id="liveStockContainer" class="grid grid-cols-2 gap-2">
                <div class="text-center text-[10px] text-gray-400 py-4 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-200 dark:border-gray-800">Memuat Data Stok...</div>
            </div>
        </div>

        <div class="mt-2 bg-white dark:bg-gray-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)] dark:shadow-[0_-5px_20px_rgba(0,0,0,0.2)] p-6 min-h-[300px]">
            <div class="flex justify-between items-end mb-4"><h3 class="font-bold text-gray-800 dark:text-white">Transaksi Terakhir</h3><span class="text-xs text-blue-600 dark:text-blue-400 font-semibold cursor-pointer" onclick="nav('historyPage')">Lihat Semua</span></div>
            <div id="miniHistory" class="space-y-4"></div>
        </div>
    </section>

    <section id="sendPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="nav('homePage')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">Kirim Saldo</h2>
        </div>
        <div class="p-6">
            <div class="bg-white dark:bg-gray-900 p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Username Penerima</label>
                    <div class="input-group">
                        <input type="text" id="sendTargetUser" placeholder="Contoh: user123" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nominal Transfer</label>
                    <div class="input-group">
                        <input type="number" id="sendAmount" placeholder="0" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <button onclick="initiateSend()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Lanjut</span><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </section>

    <section id="requestPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="nav('homePage')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">Minta Saldo</h2>
        </div>
        <div class="p-6">
            <div class="bg-white dark:bg-gray-900 p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl mb-6 border border-orange-100 dark:border-orange-800">
                    <p class="text-xs text-orange-600 dark:text-orange-400">Notifikasi permintaan akan muncul langsung di layar temanmu jika mereka sedang online.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Minta ke Username</label>
                    <div class="input-group">
                        <input type="text" id="reqTargetUser" placeholder="Contoh: sultan99" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white">
                        <i class="fas fa-hand-holding"></i>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nominal Diminta</label>
                    <div class="input-group">
                        <input type="number" id="reqAmountInput" placeholder="0" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
                        <i class="fas fa-tag"></i>
                    </div>
                </div>
                <button onclick="initiateRequest()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Kirim Permintaan</span><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </section>

    <section id="preorderPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="nav('homePage')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">Layanan Preorder</h2>
        </div>
        <div class="p-4 pb-24">
            <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Pilih Provider</label>
                    <div onclick="openSheet('provider')" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer">
                        <span id="displayProviderPO">-- Pilih Provider --</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Pilih Produk</label>
                    <div onclick="openSheet('product')" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer">
                        <span id="displayProductPO">-- Pilih Produk --</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
                    <input type="tel" id="poNumber" placeholder="08xxxx" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 text-sm font-bold dark:text-white">
                </div>
                <button onclick="submitPreorder()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg">Kirim Pesanan (PO)</button>
            </div>
        </div>
    </section>
<section id="ppobPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="closePPOB()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white" id="ppobTitle">Isi Pulsa (Live API)</h2>
        </div>
        <div class="p-4 pb-24">
            <div id="inputSection" class="transition-all duration-300">
                <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                                        <div class="mb-4">
                        <div class="flex justify-between items-center mb-1"><label class="block text-xs font-bold text-gray-500 ml-1">Provider</label><button onclick="initProductData()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100"><i class="fas fa-sync-alt mr-1"></i> Refresh Data</button></div>
                        <div onclick="openSheet('provider')" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            <span id="displayProvider">-- Pilih Provider --</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                        <input type="hidden" id="formProvider" onchange="updateProductDropdown()">
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Produk</label>
                        <div onclick="openSheet('product')" id="btnProductTrigger" class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 text-sm rounded-xl px-4 py-3 font-medium flex justify-between items-center cursor-not-allowed transition">
                            <span id="displayProduct">Menunggu Provider...</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                        <input type="hidden" id="formProduct">
                        <input type="hidden" id="selectedProductName">
                        <input type="hidden" id="selectedProductPrice">
                        <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="priceDisplay"></p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
                        <div class="input-group" id="singleNumContainer">
                            <input type="tel" id="ppobNumber" placeholder="Nomor HP / ID Pelanggan" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
                            <i class="fas fa-address-book text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 z-10"></i>
                        </div>
                        <div id="productDescription" class="hide mt-2 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-xs text-gray-600 dark:text-gray-300 border border-blue-100 dark:border-blue-800 leading-relaxed transition-all animate-fade-in-down"></div>
                    </div>
                    <button onclick="processFormTransaction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </section>

    <section id="akrabV2Page" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="nav('homePage')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
                    <h2 class="font-bold text-lg text-gray-800 dark:text-white">Akrab v2 (Premium)</h2>
        </div>
        <div class="p-4 pb-24">
            <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1"><label class="block text-xs font-bold text-gray-500 ml-1">Pilih Paket</label><button onclick="initAkrabV2Data()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100"><i class="fas fa-sync-alt mr-1"></i> Refresh</button></div>
                    <select id="icsProductSelect" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 px-3 text-sm font-bold dark:text-white" onchange="updateIcsPriceDisplay()">
                        <option value="" disabled selected>-- Memuat Data... --</option>
                    </select>
                    <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="icsPriceDisplay">Harga: -</p>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
                    <div class="input-group">
                        <input type="tel" id="icsNumberInput" placeholder="Nomor HP" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
                        <i class="fas fa-address-book text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 z-10"></i>
                    </div>
                </div>
                <button onclick="processAkrabV2Transaction()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-cyan-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span><i class="fas fa-arrow-right"></i></button>
                                <p class="text-[10px] text-gray-400 mt-4 text-center">Powered by Official API</p>
            </div>
        </div>
    </section>

    <section id="historyPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-10 shadow-sm dark:shadow-gray-800">
            <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg text-gray-800 dark:text-white">Riwayat</h2><div class="flex gap-2"><button onclick="downloadHistoryPDF()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition"><i class="fas fa-file-pdf mr-1"></i> PDF</button></div></div>
                        <div class="flex gap-2 items-center bg-gray-50 dark:bg-gray-800 p-2 rounded-xl border border-gray-100 dark:border-gray-700 mt-2">
                <span class="text-[10px] font-bold text-gray-500 ml-1">Pilih Tanggal:</span>
                <input type="date" id="historyDateFilter" onchange="filterHistoryByDate(this.value)" class="flex-1 bg-transparent text-xs font-bold text-blue-600 focus:outline-none">
            </div>
        </div>
        <div id="fullHistory" class="p-4 space-y-3 pb-24"></div>
    </section>

    <section id="profilePage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="bg-gradient-brand text-white p-6 pb-12 rounded-b-[40px] text-center shadow-lg relative transition-colors">
            <div class="w-24 h-24 bg-white dark:bg-gray-900 p-1 rounded-full mx-auto mb-4 shadow-xl transition-colors overflow-hidden"><img id="profilePageImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover"></div>
            <h2 class="text-xl font-bold" id="profileName">Dev User</h2><p class="text-blue-200 text-sm" id="profilePhone">-</p>
            <div class="mt-4 inline-flex items-center bg-blue-800/50 dark:bg-blue-900/50 backdrop-blur px-4 py-1.5 rounded-full text-xs font-semibold border border-blue-400/30"><i class="fas fa-crown text-yellow-400 mr-2"></i> Pelanggan Setia</div>
        </div>
        <div class="px-6 -mt-6 pb-24 relative z-10">
            <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-black/30 overflow-hidden transition-colors">
                 <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center"><span class="text-xs text-gray-500">Gender</span><span class="text-sm font-bold dark:text-white" id="profileGender">-</span></div>
                 <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center"><span class="text-xs text-gray-500">Tgl. Lahir</span><span class="text-sm font-bold dark:text-white" id="profileDob">-</span></div>
                 <div onclick="handleLogout()" class="p-4 flex items-center gap-4 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer transition-colors group"><div class="w-9 h-9 rounded-full bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400 group-hover:bg-red-100 dark:group-hover:bg-red-900/50 flex items-center justify-center transition-colors"><i class="fas fa-sign-out-alt text-sm"></i></div><div class="flex-1 text-sm font-bold text-red-500 dark:text-red-400">Keluar</div></div>
            </div>
        </div>
    </section>

    <section id="scanPage" class="page hide bg-black min-h-screen text-white flex flex-col fixed top-0 w-full max-w-[480px] z-50">
        <div class="flex justify-between items-center p-4 absolute top-0 w-full z-10">
            <button onclick="stopScan()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-times"></i></button>
            <h2 class="font-bold">Scan QRIS</h2>
            <button class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-bolt"></i></button>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div id="reader" class="rounded-3xl overflow-hidden border-2 border-white/50 shadow-2xl"></div>
            <div class="absolute bottom-32 text-center pointer-events-none"><p class="text-sm font-medium bg-black/40 px-4 py-1 rounded-full">Arahkan kamera ke kode QRIS</p></div>
        </div>
    </section>

        <div id="liveChatContainer"><div id="liveChatModal" class="chat-window hide">
            <div class="bg-blue-600 p-4 flex justify-between items-center shadow-md shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white"><i class="fas fa-user-astronaut"></i></div>
                    <div>
                        <h4 class="text-white font-bold text-sm leading-tight">Admin Support</h4>
                        <p class="text-blue-100 text-[10px]">Online  Membalas cepat</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i class="fas fa-times text-lg"></i></button>
            </div>
            
            <div id="chatMessages" class="chat-body flex flex-col gap-2 custom-scroll">
                <div class="text-center mt-10 opacity-50">
                    <i class="fas fa-comments text-4xl text-gray-300 mb-2"></i>
                    <p class="text-xs text-gray-400">Mulai percakapan dengan Admin.</p>
                </div>
            </div>

            <div class="p-3 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 shrink-0">
                <form onsubmit="event.preventDefault(); sendChatMessage();" class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Tulis pesan..." class="flex-1 bg-gray-100 dark:bg-gray-800 border-0 rounded-xl px-4 py-3 text-xs focus:ring-2 focus:ring-blue-500 dark:text-white">
                    <button type="submit" class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center hover:bg-blue-700 transition shadow-lg shadow-blue-500/30"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 flex justify-around items-end pb-4 pt-3 text-[10px] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-40 hide rounded-t-3xl">
        <div class="text-center cursor-pointer w-1/5 nav-item text-blue-600 dark:text-blue-400 group" id="nav-home" onclick="nav('homePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-home text-xl"></i></div><p class="font-medium">Beranda</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-buy" onclick="openPPOB('akrab')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-shopping-cart text-xl"></i></div><p class="font-medium">Beli</p></div>
                <div class="text-center w-1/5 qris-btn-container cursor-pointer" onclick="openTopUpSheet()"><div class="qris-btn w-11 h-11 rounded-full flex items-center justify-center mx-auto text-white transform transition hover:scale-105 active:scale-95 mb-1 relative"><div id="badge-topup-nav" class="hide absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white dark:border-gray-900 rounded-full flex items-center justify-center text-[9px] font-bold">1</div><i class="fas fa-plus text-lg"></i></div><p class="font-bold text-gray-700 dark:text-gray-400">Top Up</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-preorder" onclick="nav('sendPage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-paper-plane text-xl"></i></div><p class="font-medium">Kirim</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-profile" onclick="nav('profilePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-user text-xl"></i></div><p class="font-medium">Saya</p></div>
    
    <div class="absolute -top-8 right-[7%] z-50">
        <button onclick="toggleChat()" id="chatFloatBtn" class="hide w-11 h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-600/40 border-2 border-white dark:border-gray-800 transition-transform active:scale-95">
            <i class="fas fa-headset text-sm"></i>
            <div id="chatBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white rounded-full text-[9px] font-bold flex items-center justify-center hide">!</div>
        </button>
    </div>
</nav>
</div>

    
    <div id="sheetOverlay" onclick="closeAllSheets()" class="hide fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm fade-enter"></div>

    
    <div id="sheetProvider" class="hide fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-gray-900 rounded-t-[2rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.3)] max-w-[480px] mx-auto transition-transform duration-300 transform translate-y-0">
        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white">Pilih Provider</h3>
            <button onclick="closeAllSheets()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-2 max-h-[60vh] overflow-y-auto no-scrollbar pb-8">
            
                        <div id="prov_ICS_XDA" onclick="checkProv('ICS_XDA') && selectProvider('ICS_XDA', 'Akrab Fresh (XDA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab Fresh (XDA)</span><span class="mt-badge">GANGGUAN</span></div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_ICS_CIRCLE" onclick="checkProv('ICS_CIRCLE') && selectProvider('ICS_CIRCLE', 'XL Circle')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Circle</span><span class="mt-badge">GANGGUAN</span></div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
                        <div id="prov_XDA" onclick="checkProv('XDA') && selectProvider('XDA', 'Akrab V2 (XDA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab V2 (XDA)</span><span class="mt-badge">GANGGUAN</span></div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
<div id="prov_XLA" onclick="checkProv('XLA') && selectProvider('XLA', 'Akrab Fresh (XLA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab Fresh (XLA)</span><span class="mt-badge">GANGGUAN</span></div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_FMX" onclick="checkProv('FMX') && selectProvider('FMX', 'FlexMax (FMX)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">FlexMax (FMX)</span><span class="mt-badge">GANGGUAN</span></div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_XLR" onclick="checkProv('XLR') && selectProvider('XLR', 'XL Reguler (XLR)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Reguler (XLR)</span><span class="mt-badge">GANGGUAN</span></div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_PLN" onclick="checkProv('PLN') && selectProvider('PLN', 'PLN Pascabayar')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">PLN Pascabayar</span><span class="mt-badge">GANGGUAN</span></div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
        </div>
    </div>

    
    <div id="sheetIcsProvider" class="hide fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-gray-900 rounded-t-[2rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.3)] max-w-[480px] mx-auto transition-transform duration-300 transform translate-y-0">
        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white">Pilih Kategori</h3>
            <button onclick="closeIcsSheet()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-2 max-h-[60vh] overflow-y-auto no-scrollbar pb-8">
                        <div id="prov_ICS_xla" onclick="checkProv('xla') && setIcsProvider('xla', 'XL Akrab (XLA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Akrab (XLA)</span><span class="mt-badge">GANGGUAN</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_ICS_xda" onclick="checkProv('xda') && setIcsProvider('xda', 'Akrab Fresh (XDA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab Fresh (XDA)</span><span class="mt-badge">GANGGUAN</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_ICS_fmax" onclick="checkProv('fmax') && setIcsProvider('fmax', 'FlexMax (FMAX)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">FlexMax (FMAX)</span><span class="mt-badge">GANGGUAN</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_ICS_circle" onclick="checkProv('circle') && setIcsProvider('circle', 'XL Circle')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Circle</span><span class="mt-badge">GANGGUAN</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
            <div id="prov_ICS_bpa" onclick="checkProv('bpa') && setIcsProvider('bpa', 'Bagi Pulsa (BPA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
                <div class="flex items-center"><span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Bagi Pulsa (BPA)</span><span class="mt-badge">GANGGUAN</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
        </div>
    </div>
    <div id="sheetProduct" class="hide fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-gray-900 rounded-t-[2rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.3)] max-w-[480px] mx-auto transition-transform duration-300">
        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white">Pilih Produk</h3>
            <button onclick="closeAllSheets()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div id="sheetProductList" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar pb-8">
            <div class="text-center text-gray-400 py-10">Silakan pilih provider terlebih dahulu</div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        sendPasswordResetEmail,
        signInWithPhoneNumber, 
        RecaptchaVerifier, 
        signOut, 
        onAuthStateChanged,
        EmailAuthProvider,
        reauthenticateWithCredential,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, where, getDocs, runTransaction, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
        authDomain: "ppob-3ea96.firebaseapp.com",
        projectId: "ppob-3ea96",
        storageBucket: "ppob-3ea96.firebasestorage.app",
        messagingSenderId: "181320175094",
        appId: "1:181320175094:web:306b79071018410b910bd7",
        measurementId: "G-0K2V796QDX"
    };

    const app = initializeApp(firebaseConfig);

    // --- FITUR AUTO UPDATE & PWA ---
        const APP_VERSION_CODE = 'v3.1'; // Versi saat ini

    // Update Label Versi di Login
    setTimeout(() => {
        const vEl = document.getElementById('versionDisplay');
        if(vEl) vEl.innerText = APP_VERSION_CODE;
    }, 500);

    // Fungsi Cek Update ke Firebase
    async function checkSystemUpdate() {
        console.log("Checking system update...");
        try {
            const db = getFirestore(app);
            const docRef = doc(db, "settings", "app_info");
            const snapshot = await getDoc(docRef);

            if (snapshot.exists()) {
                const serverData = snapshot.data();
                const serverVersion = serverData.version; // Field 'version' di Firebase

                if (serverVersion && serverVersion !== APP_VERSION_CODE) {
                    console.warn(`Update Ditemukan: ${APP_VERSION_CODE} -> ${serverVersion}`);
                    
                    // Tampilkan Loader
                    const loader = document.getElementById('globalLoader');
                    if(loader) {
                        document.getElementById('loaderText').innerText = `Update Sistem ke ${serverVersion}...`;
                        loader.classList.remove('hide');
                    }

                    // Hapus Service Worker (PWA Cache)
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                        }
                    }

                    // Hapus Cache Storage
                    if ('caches' in window) {
                        const keys = await caches.keys();
                        await Promise.all(keys.map(key => caches.delete(key)));
                    }

                    // Paksa Reload dari Server (True)
                    setTimeout(() => window.location.reload(true), 2000);
                } else {
                    console.log("Sistem sudah versi terbaru.");
                }
            }
        } catch (e) {
            console.error("Gagal cek update:", e);
        }
    }

    // Jalankan Pengecekan
    checkSystemUpdate();

    // Register Service Worker (Template PWA)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW Ready:', reg.scope))
                .catch(err => console.log('SW Fail:', err));
        });
    }


    // 1. PROXY LIST (Global)
        // 1. PROXY LIST (Global) - Prioritaskan CorsProxyIO untuk POST Request
        // 1. PROXY LIST (Global) - Update dengan CodeTabs sebagai cadangan handal
        // 1. PROXY LIST (Global) - Update dengan CodeTabs (Paling Stabil)
        const PROXY_LIST = [
        { name: 'CorsProxyIO', url: 'https://corsproxy.io/?' },
        { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
        { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' },
        { name: 'AllOrigins', url: 'https://api.allorigins.win/raw?url=' },
        { name: 'Direct', url: '' }
    ];

        // 3. TELEGRAM NOTIFICATION SYSTEM
    const TELEGRAM_CONFIG = {
        token: "7507761189:AAGUCYltzj_IMuDRgjUzUPiZDz4nbVXvOME",
        chatId: "-1002997407612"
    };

                            window.sendTelegramNotif = async (type, data) => {
        let message = "";
        let topicId = null;
        const now = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const formattedDate = now.toLocaleDateString('id-ID', options).replace(/ pukul /g, ' | ');

        let safeDest = data.dest || "-";
        if (safeDest && safeDest.length > 4) {
             safeDest = safeDest.substring(0, safeDest.length - 4) + "****";
        }

        let safeTrxId = data.trxId || "-";
        try {
            const parts = safeTrxId.split('-');
            if (parts.length >= 3 && (parts[0] === 'TRX' || parts[0] === 'ICS')) {
                const phoneSegment = parts[1];
                if (phoneSegment.length > 4 && /^\d+$/.test(phoneSegment)) {
                    const maskedPhone = phoneSegment.substring(0, phoneSegment.length - 4) + "****";
                    parts[1] = maskedPhone;
                    safeTrxId = parts.join('-');
                }
            }
        } catch (e) { console.log("Masking TRX Error", e); }

        if (type === 'TOPUP') {
            topicId = 7;
            message = ` DEPOSIT BERHASIL \n` +
                      `\n` +
                      ` Jumlah : Rp ${window.formatRp(data.amount).replace('Rp', '').trim()}\n` +
                      ` Waktu : ${formattedDate}\n` +
                      ` User ID : ${currentUsername}\n` +
                      ` Status : BERHASIL\n` +
                      ` ID Transaksi :\n` +
                      `${safeTrxId}\n` +
                      `\n` +
                      ` PANDAWA SYSTEM\n` +
                      `https://www.pandawa-digital.store`;
        } else {
            topicId = 6;
            message = ` TRANSAKSI BERHASIL \n` +
                      `\n` +
                      ` Produk : ${data.title}\n` +
                      ` Tujuan : ${safeDest}\n` +
                      ` Harga : Rp ${window.formatRp(data.amount).replace('Rp', '').trim()}\n` +
                      ` Waktu : ${formattedDate}\n` +
                      ` User : ${currentUsername}\n` +
                      ` TRX ID : ${safeTrxId}\n` +
                      `\n` +
                      ` PANDAWA SYSTEM\n` +
                      `https://www.pandawa-digital.store`;
        }

        // METODE GET + URL PARAMETERS (FIX PROXY)
        const baseUrl = `https://api.telegram.org/bot${TELEGRAM_CONFIG.token}/sendMessage`;
        const params = new URLSearchParams({
            chat_id: TELEGRAM_CONFIG.chatId,
            text: message,
            message_thread_id: topicId
        });
        
        const targetUrl = `${baseUrl}?${params.toString()}`;

        for (const proxy of PROXY_LIST) {
            try {
                const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                const res = await fetch(fullUrl);
                if(res.ok) {
                    console.log("Telegram Notif Sent via " + proxy.name);
                    break;
                }
            } catch (e) { console.warn("Telegram Proxy Error via " + proxy.name, e); }
        }
    };

// 2. ICS STORE INTEGRATION
    const ICS_CONFIG = {
        apiKey: "dcc0a69aa74abfde7b1bc5d252d858cb2fc5e32192da06a3",
        baseUrl: "https://api.ics-store.my.id/api/reseller"
    };

        let currentIcsType = 'xla';

    window.openIcsSheet = () => {
        document.getElementById('sheetIcsProvider').classList.remove('hide');
        document.getElementById('sheetOverlay').classList.remove('hide');
        document.body.style.overflow = 'hidden';
    };

    window.closeIcsSheet = () => {
        document.getElementById('sheetIcsProvider').classList.add('hide');
        document.getElementById('sheetOverlay').classList.add('hide');
        document.body.style.overflow = '';
    };

    window.setIcsProvider = (type, name) => {
        currentIcsType = type;
        document.getElementById('icsProviderDisplay').innerText = name;
        window.closeIcsSheet();
        window.initAkrabV2Data();
    };

window.openAkrabV2 = () => {
        window.nav('akrabV2Page');
        window.initAkrabV2Data();
    };

                    async function callIcsApi(action, params = {}, method = 'GET') {
        // MENGGUNAKAN VERCEL RELAY (Lebih Stabil & Cepat)
        const relayUrl = '/api/relay';
        const payload = { ...params, action, _t: Date.now() }; // _t anti-cache

        try {
            const options = {
                method: method === 'GET' ? 'GET' : 'POST',
                headers: { 'Content-Type': 'application/json' }
            };

            let url = relayUrl;
            if (method === 'GET') {
                const qs = new URLSearchParams(payload).toString();
                url += `?${qs}`;
            } else {
                options.body = JSON.stringify(payload);
            }

            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            return data;

        } catch (e) {
            console.error('ICS Relay Error:', e);
            // Fallback pesan error yang user-friendly
            return { success: false, message: 'Gagal koneksi server: ' + e.message };
        }
    }



        window.initAkrabV2Data = async () => {
        const select = document.getElementById('icsProductSelect');
        select.innerHTML = '<option>Memuat...</option>';
        
        // Muat Aturan Harga & Nama Custom
        try {
            const settingsSnap = await getDoc(doc(db, "settings", "pricing"));
            if (settingsSnap.exists()) pricingRules = settingsSnap.data().rules || {};
        } catch(e) { console.log("Load pricing rules error", e); }

        const res = await callIcsApi('listProducts', { type: currentIcsType });
        select.innerHTML = '';

        // PERBAIKAN: Handle Respon Sukses (Gabung Ready + Empty)
                     if (res.success && res.data) {
                // ADAPTASI FORMAT BARU ICS (Array Langsung)
                let allProducts = [];
                if (Array.isArray(res.data)) {
                    allProducts = res.data;
                } else if (res.data.ready || res.data.empty) {
                     allProducts = [...(res.data.ready||[]), ...(res.data.empty||[])];
                }

                // Normalisasi Data
                allProducts = allProducts.map(p => ({
                    code: p.code || p.kode_produk,
                    name: p.name || p.nama_produk,
                    price: parseInt(p.price || p.harga || 0),
                    stock: (p.stock !== undefined) ? p.stock : (p.stok !== undefined ? p.stok : 0),
                    status: p.status || (p.stok > 0 ? 'available' : 'empty'),
                    desc: p.description || p.deskripsi || ''
                }));

                allProducts.sort((a, b) => a.price - b.price);

                if(allProducts.length === 0) {
                     if(txtProd) txtProd.innerText = 'Stok Kosong';
                     listContainer.innerHTML = '<div class="text-center py-8 text-gray-400 flex flex-col items-center"><i class="fas fa-box-open text-2xl mb-2"></i><p class="text-xs">Tidak ada produk tersedia di ICS</p></div>';
                     return;
                }

                if(btnProd) {
                    btnProd.classList.remove('cursor-not-allowed', 'opacity-50');
                    btnProd.classList.add('bg-white', 'hover:bg-gray-50');
                }
                if(txtProd) txtProd.innerText = '-- Klik Untuk Pilih Produk --';

                allProducts.forEach(p => {
                    let sellPrice = p.price;
                    let name = p.name;
                    const code = p.code;

                    // LOGIKA BARU (ICS General): Markup & Rename
                    if(pricingRules[code]) {
                        const r = pricingRules[code];
                        if(typeof r === 'object') {
                            if(r.price) sellPrice += parseInt(r.price);
                            if(r.name) name = r.name;
                        } else {
                            sellPrice += parseInt(r);
                        }
                    } else {
                        sellPrice += 2000; // Default Margin
                    }

                    const isHabis = p.stock === 0 || p.status !== 'available';

                    const div = document.createElement('div');
                    div.className = `p-4 rounded-2xl border ${isHabis ? 'border-red-200 bg-red-50 dark:bg-red-900/10 cursor-not-allowed opacity-70' : 'border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 cursor-pointer transition active:scale-[0.98]'} mb-2 flex justify-between items-center group`;
                    
                    if(!isHabis) {
                        div.onclick = () => window.selectProduct(code, name, sellPrice, p.desc || `Stok: ${p.stock}`, encodeURIComponent(name));
                    }

                    div.innerHTML = `
                        <div class="flex-1 pr-2">
                            <p class="text-xs font-bold text-gray-700 dark:text-gray-200 leading-tight group-hover:text-blue-600 transition">${name}</p>
                            ${isHabis ? '<span class="text-[9px] text-red-500 font-bold">STOK HABIS</span>' : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-blue-600 dark:text-blue-400">Rp ${window.formatRp(sellPrice).replace('Rp', '')}</p>
                        </div>`;
                    listContainer.appendChild(div);
                });
             } else {
                 if(txtProd) txtProd.innerText = 'Gagal Koneksi ';
                 alert('Gagal memuat data : ' + (res.message || 'Unknown'));
             }
             return; // Stop, jangan jalankan logika Khfy
        }

        // --- LOGIKA LAMA: KHFY ---
        if(!globalProducts || globalProducts.length === 0) {
             if(txtProd) txtProd.innerText = 'Data Belum Siap';
             window.initProductData(); 
             return;
        }

        const filtered = globalProducts.filter(p => {
            const code = (p.code || p.kode_produk || p.buyer_sku_code || '').toUpperCase();
            const name = (p.name || p.nama_produk || p.product_name || '').toUpperCase();
            const brand = (p.brand || p.kode_provider || p.operator || '').toUpperCase();
            
                        if (providerCode === 'XDA') return code.startsWith('XDA');
if (providerCode === 'FMX') return (code.startsWith('FMX') || code === 'CFMX') && brand === 'FMAX';
            if (providerCode === 'XLR') return brand === 'XLREGULER';
            if (providerCode === 'PLN') return brand.includes('PLN') || code.includes('PLN') || name.includes('TOKEN');

            return brand.includes(providerCode) || name.includes(providerCode) || code.includes(providerCode);
        });

        if(filtered.length === 0) {
            if(txtProd) txtProd.innerText = `Kosong (${providerCode})`;
            listContainer.innerHTML = `<div class="text-center py-8 text-gray-400 flex flex-col items-center"><i class="fas fa-box-open text-2xl mb-2"></i><p class="text-xs">Tidak ada produk tersedia</p></div>`;
            return;
        }

        if(btnProd) {
            btnProd.classList.remove('cursor-not-allowed', 'opacity-50');
            btnProd.classList.add('bg-white', 'hover:bg-gray-50');
            if(btnProd.classList.contains('bg-gray-100')) btnProd.classList.remove('bg-gray-100');
        }
        
        if(txtProd) txtProd.innerText = '-- Klik Untuk Pilih Produk --';

        filtered.sort((a, b) => {
            const priceA = a.price || a.harga_final || a.buyer_price || 0;
            const priceB = b.price || b.harga_final || b.buyer_price || 0;
            return priceA - priceB;
        });

        filtered.forEach(p => {
            let price = p.price || p.harga_final || p.buyer_price || 0;
            const code = p.code || p.kode_produk || p.buyer_sku_code;
            let name = p.name || p.nama_produk || p.product_name;
            const desc = p.deskripsi || '';
            
            // LOGIKA BARU (KHFY): Support Rename & Markup Object
            if(pricingRules[code]) {
                const r = pricingRules[code];
                if(typeof r === 'object') {
                    if(r.price) price += parseInt(r.price);
                    if(r.name) name = r.name;
                } else {
                    price += parseInt(r);
                }
            }
            
            let isGangguan = false;
            if (p.gangguan == 1) isGangguan = true;
            if (p.kosong == 1) isGangguan = true;
            if (p.buyer_product_status === false || p.buyer_product_status == 0) isGangguan = true;
            if (p.seller_product_status === false || p.seller_product_status == 0) isGangguan = true;
            if (p.stock == 0 && p.unlimited_stock === false) isGangguan = true;

            const isPreorder = !document.getElementById('preorderPage').classList.contains('hide');
            const div = document.createElement('div');
            div.className = `p-4 rounded-2xl border ${isGangguan && !isPreorder ? 'border-red-200 bg-red-50 dark:bg-red-900/10 cursor-not-allowed opacity-70' : 'border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 cursor-pointer transition active:scale-[0.98]'} mb-2 flex justify-between items-center group`;
            
            if(isGangguan && !isPreorder) {
                div.innerHTML = `
                    <div>
                        <p class="text-xs font-bold text-red-500 line-through">${name}</p>
                        <p class="text-[9px] text-red-400 font-bold mt-1">GANGGUAN / KOSONG</p>
                    </div>
                    <div class="text-right opacity-50">
                        <p class="text-sm font-black text-gray-400">Rp ${window.formatRp(price).replace('Rp', '')}</p>
                    </div>`;
            } else {
                div.onclick = () => window.selectProduct(code, name, price, desc, encodeURIComponent(name));
                div.innerHTML = `
                    <div class="flex-1 pr-2">
                        <p class="text-xs font-bold text-gray-700 dark:text-gray-200 leading-tight group-hover:text-blue-600 transition">${name}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-blue-600 dark:text-blue-400">Rp ${window.formatRp(price).replace('Rp', '')}</p>
                        <p class="text-[9px] text-gray-400">Harga</p>
                    </div>`;
            }
            listContainer.appendChild(div);
        });
    };


    window.toggleMultiTrx = () => {
        isMultiTrx = !isMultiTrx;
        const check = document.getElementById('multiTrxCheck');
        const icon = check.querySelector('i');
        const single = document.getElementById('singleNumContainer');
        const multi = document.getElementById('multiNumContainer');
        const btnAdd = document.getElementById('btnAddNum');
        
        if(isMultiTrx) {
            check.className = "w-5 h-5 rounded border border-blue-600 bg-blue-600 flex items-center justify-center text-white transition-colors";
            icon.classList.remove('opacity-0');
            single.classList.add('hide');
            multi.classList.remove('hide');
            btnAdd.classList.remove('hide');
            if(multi.children.length === 0) window.addMultiInput();
        } else {
            check.className = "w-5 h-5 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-white transition-colors";
            icon.classList.add('opacity-0');
            single.classList.remove('hide');
            multi.classList.add('hide');
            btnAdd.classList.add('hide');
        }
    };

    window.addMultiInput = () => {
        const container = document.getElementById('multiNumContainer');
        const div = document.createElement('div');
        div.className = "flex gap-2 animate-fade-in-down";
        div.innerHTML = '<input type="tel" placeholder="Nomor Tujuan..." class="flex-1 h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"><button onclick="this.parentElement.remove()" class="w-12 h-12 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl hover:bg-red-100 transition flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>';
        container.appendChild(div);
    };

    window.executeMultiBatch = async (code, numbers, price, name) => {
        window.showLoader(true);
        const totalRequired = numbers.length * price;

        if (currentBalance < totalRequired) {
            window.showLoader(false);
            return window.showAlert("Saldo Kurang", `Saldo tidak cukup untuk memproses ${numbers.length} transaksi.\nTotal dibutuhkan: ${window.formatRp(totalRequired)}`, "error");
        }

        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < numbers.length; i++) {
            const num = numbers[i].trim();
            if (num.length < 5) continue;

            document.getElementById('loaderText').innerText = `Batch ${i + 1}/${numbers.length}: ${num}`;
            
            const uniqueId = Math.random().toString(36).substring(2, 7).toUpperCase();
            const reffId = `BTCH-${Date.now()}-${uniqueId}`;
            const trxCode = Math.floor(100000 + Math.random() * 900000).toString();

            try {
                await runTransaction(db, async (t) => {
                    const uRef = doc(db, "users", currentUser.uid);
                    const uDoc = await t.get(uRef);
                    const bal = uDoc.data().balance || 0;

                    if (bal < price) throw new Error("Saldo tidak mencukupi");

                    t.update(uRef, { balance: bal - price });
                    t.set(doc(db, "users", currentUser.uid, "history", reffId), {
                        title: `${name} (${num})`,
                        amount: price,
                        type: 'out',
                        date: new Date().toISOString(),
                        status: 'Pending',
                        api_msg: 'Menunggu respon server...',
                        trx_id: reffId,
                        trx_code: trxCode,
                        dest_num: num
                    });
                });

                const result = await callApi('/trx', { produk: code, tujuan: num, reff_id: reffId });
                
                let isOk = false;
                let apiMsg = "Diproses";

                if (result.ok && result.data) {
                    const d = result.data;
                    const dataObj = d.data || d;
                    const rawMsg = String(d.message || d.sn || "").toLowerCase();
                    if (d.status === true || d.success === true || (d.data && d.data.id) || rawMsg.includes('proses') || rawMsg.includes('pending')) {
                        isOk = true;
                        apiMsg = d.message || d.sn || "Transaksi Berhasil Dikirim";
                    }
                }

                if (isOk) {
                    successCount++;
                    await updateDoc(doc(db, "users", currentUser.uid, "history", reffId), {
                        api_msg: apiMsg,
                        raw_json: JSON.stringify(result.data || {})
                    });
                } else {
                    throw new Error(result.data?.message || result.error || "Ditolak Server");
                }

            } catch (e) {
                failCount++;
                await runTransaction(db, async (t) => {
                    const uRef = doc(db, "users", currentUser.uid);
                    const uDoc = await t.get(uRef);
                    t.update(uRef, { balance: (uDoc.data().balance || 0) + price });
                    t.update(doc(db, "users", currentUser.uid, "history", reffId), {
                        status: 'Gagal',
                        api_msg: 'Refund: ' + e.message
                    });
                });
            }
            
            await new Promise(r => setTimeout(r, 2000));
        }

        window.showLoader(false);
        window.showAlert("Selesai", `Berhasil: ${successCount}\nGagal/Refund: ${failCount}`, successCount > 0 ? "success" : "error");
        window.nav('homePage');
    };

            window.processFormTransaction = () => {
        const provider = document.getElementById('formProvider').value;
        const code = document.getElementById('formProduct').value || document.getElementById('icsProductSelect')?.value;
        const name = document.getElementById('selectedProductName').value || document.getElementById('icsProductSelect')?.options[document.getElementById('icsProductSelect').selectedIndex]?.dataset.name;
        const price = parseInt(document.getElementById('selectedProductPrice').value || 0);
        const number = document.getElementById('ppobNumber').value;

        if(!code) return alert('Silakan pilih Produk!');
        if(!code) return alert('Silakan pilih Produk!');

        // FITUR BARU: Cegah Transaksi Ganda ke Nomor Sama jika masih Pending
        const pendingSameNum = transactions.find(t => 
            (t.status === 'Pending' || t.status === 'Proses') && 
            t.dest_num === number
        );

        if (pendingSameNum) {
            return Swal.fire({
                title: 'Transaksi Tertunda',
                text: 'Masih ada transaksi PENDING untuk nomor ' + number + '. Harap tunggu hingga sukses atau gagal sebelum membeli lagi.',
                icon: 'warning'
            });
        }

        // --- HANDLER KHUSUS ICS ---
        if (provider.startsWith('ICS_')) {
            if(!number || number.length < 9) return alert("Nomor HP tidak valid!");
            if(currentBalance < price) return alert("Saldo tidak cukup!");
            
            window.customConfirm('Apakah anda ingin melanjutkan?', `Produk: ${name}\nNomor: ${number}\nHarga: ${window.formatRp(price)}`, async () => {
                window.executeIcsTransaction(code, number, price, name, provider);
            });
            return;
        }

        if (code === 'CEKPLN') {
            window.checkPLN(document.getElementById('ppobNumber').value);
            return;
        }

        if (isMultiTrx) {
            const inputs = document.querySelectorAll('#multiNumContainer input');
            const numbers = [];
            inputs.forEach(i => { if(i.value.length > 5) numbers.push(i.value); });
            
            if(numbers.length === 0) return alert("Masukkan minimal 1 nomor tujuan valid!");
            const total = numbers.length * price;
            if (currentBalance < total) return alert(`Saldo kurang! Butuh Rp ${window.formatRp(total)}`);
            
            window.customConfirm('Multi Transaksi', `Proses ${numbers.length} nomor?\nTotal: Rp ${window.formatRp(total)}`, () => {
                window.executeMultiBatch(code, numbers, price, name);
            });
        } else {
            const destNum = document.getElementById('ppobNumber').value;
            if(destNum.length < 5) return alert('Masukkan Nomor Tujuan yang valid!');
            window.confirmTransaction(code, name, price);
        }
    };


    window.checkPLN = async (num) => {
        window.showLoader(true);
        const reffId = crypto.randomUUID();
        const result = await callApi('/trx', { produk: 'CEKPLN', tujuan: num, reff_id: reffId });
        window.showLoader(false);

        if (result.ok && result.data) {
            const data = result.data.data || result.data;
            const msg = (data.message || data.sn || '').toLowerCase();
            const status = data.status;
            
            const isSuccess = (status === true || status === 'success' || String(data.success) === 'true');
            const isDataFound = msg.includes('tagihan') || msg.includes('lembar') || msg.includes('nama') || msg.includes('tarif');

            if (isSuccess || isDataFound) {
                let displayMsg = (data.message || data.sn).replace(/\//g, '\n');
                window.customConfirm('TAGIHAN DITEMUKAN', `Detail Pelanggan:\n------------------\n${displayMsg}\n\n(Silakan lakukan pembayaran manual)`, () => window.closeConfirm());
            } else {
                window.showAlert("Tidak Ditemukan", "PENGGUNA TIDAK TERDAFTAR\n\nSilakan periksa kembali Nomor ID Pelanggan PLN anda.", "error");
            }
        } else {
            window.showAlert("Gagal Koneksi", "Gagal Terhubung ke Server:\n" + result.error, "error");
        }
    };

    window.showInvoice = (code, name, price, dest, provCode) => {
        const fmtPrice = window.formatRp(price);
        document.getElementById('invTotalMain').innerText = fmtPrice;
        document.getElementById('invTotalBottom').innerText = fmtPrice;
        document.getElementById('invProductName').innerText = name;
        document.getElementById('invDestNum').innerText = dest;
        document.getElementById('invPrice').innerText = fmtPrice;
        
        const btnPay = document.getElementById('btnPayInvoice');
        btnPay.onclick = () => {
            window.closeInvoice();
            window.executeApiTransaction(code, dest, price, name, provCode);
        };

        document.getElementById('invoiceModal').classList.remove('hide');
    };

    window.closeInvoice = () => document.getElementById('invoiceModal').classList.add('hide');

    window.confirmTransaction = (code, name, price) => {
        if(currentBalance < price) return alert('Saldo Aplikasi Kurang! (Top Up Manual dulu)'); 
        const num = document.getElementById('ppobNumber').value;
        const prov = document.getElementById('formProvider').value;
        window.showInvoice(code, name, price, num, prov);
    };

            
        
    window.cancelPreorder = async (trxId) => {
        window.customConfirm("Batalkan Preorder", "Apakah Anda yakin ingin membatalkan preorder ini?\nSaldo akan dikembalikan otomatis.", async () => {
            window.showLoader(true);
            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", currentUser.uid);
                    const trxRef = doc(db, "users", currentUser.uid, "history", trxId);
                    const poRef = doc(db, "preorders", trxId);

                    const userSnap = await transaction.get(userRef);
                    const trxSnap = await transaction.get(trxRef);

                    if (!trxSnap.exists() || trxSnap.data().status !== 'Pending') {
                        throw "Transaksi tidak dapat dibatalkan.";
                    }

                    const refundAmount = trxSnap.data().amount || 0;
                    const currentBal = userSnap.data().balance || 0;

                    transaction.update(userRef, { balance: currentBal + refundAmount });
                    transaction.update(trxRef, {
                        status: 'Dibatalkan',
                        api_msg: 'Dibatalkan oleh pengguna (Auto Refund)',
                        balance_final: currentBal + refundAmount
                    });
                    transaction.delete(poRef);
                });

                window.showLoader(false);
                window.showAlert("Berhasil", "Preorder berhasil dibatalkan dan saldo telah dikembalikan.", "success");
                window.closeTrxDetail();
                window.renderHistoryList();
            } catch (e) {
                window.showLoader(false);
                window.showAlert("Gagal", (typeof e === 'string' ? e : e.message), "error");
            }
        });
    };

window.submitPreorder = async () => {
        const prov = document.getElementById('formProvider').value;
        const code = document.getElementById('formProduct').value;
        const name = document.getElementById('selectedProductName').value;
        const price = parseInt(document.getElementById('selectedProductPrice').value) || parseInt(document.getElementById('icsProductSelect')?.options[document.getElementById('icsProductSelect').selectedIndex]?.dataset.price || 0);
        const num = document.getElementById('poNumber').value;

        if(!code || !num) return alert('Lengkapi data preorder!');
        
        window.showLoader(true);
        try {
            const trxId = 'PO-' + Date.now();
            
            await runTransaction(db, async (transaction) => {
                const userRef = doc(db, "users", currentUser.uid);
                const userSnap = await transaction.get(userRef);
                
                if (!userSnap.exists()) throw "User tidak ditemukan!";
                
                const currentBal = userSnap.data().balance || 0;
                if (currentBal < price) throw "Saldo tidak cukup untuk preorder!";

                const balanceAfter = currentBal - price;

                // 1. Potong Saldo User
                transaction.update(userRef, { balance: balanceAfter });

                                // 2. Tambah ke Antrean Admin
                const poRef = doc(db, "preorders", trxId);
                
                // Deteksi Server Type Otomatis (ICS/KHFY)
                const serverType = prov.startsWith('ICS_') ? 'ICS' : 'KHFY';

                transaction.set(poRef, {
                    uid: currentUser.uid,
                    username: currentUsername,
                    email: currentUser.email,
                    targetNumber: num,
                    provider: code,
                    productName: name,
                    price: price,
                    status: "Pending",
                    historyId: trxId,
                    serverType: serverType, // Data Baru: Identitas Server
                    timestamp: serverTimestamp()
                });

                // 3. Catat di Riwayat User (Status Pending & Saldo Terpotong)
                const historyRef = doc(db, "users", currentUser.uid, "history", trxId);
                transaction.set(historyRef, {
                    title: "Preorder: " + name,
                    amount: price,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Pending',
                    api_msg: 'Pesanan sedang diproses admin',
                    trx_id: trxId,
                    dest_num: num,
                    raw_code: code,
                    balance_before: currentBal,
                    balance_after: balanceAfter
                });
            });

                        // Kirim Notif Telegram Preorder
            if(typeof window.sendTelegramNotif === 'function') {
                 window.sendTelegramNotif('ORDER', { 
                    title: "PREORDER - " + name, 
                    amount: price, 
                    dest: num, 
                    trxId: trxId 
                });
            }

            
window.showLoader(false);
            alert('Pesanan Preorder dikirim! Saldo telah dipotong dan menunggu konfirmasi admin.');
            window.nav('homePage');
        } catch(e) {
            window.showLoader(false);
            alert(typeof e === 'string' ? e : e.message);
        }
    };
    window.executeApiTransaction = async (code, dest, price, name, provCode) => {
        window.showLoader(true);
        // Format Baru: TRX-08xx-JamMenitDetik
        const d = new Date();
        const timeStr = String(d.getHours()).padStart(2, '0') + String(d.getMinutes()).padStart(2, '0') + String(d.getSeconds()).padStart(2, '0');
        const cleanDest = dest.replace(/[^0-9]/g, '');
        const reffId = 'TRX-' + cleanDest + '-' + timeStr;
        
        const trxCode = Math.floor(100000 + Math.random() * 900000).toString();
        const trxRef = doc(db, "users", currentUser.uid, "history", reffId);
        
        try {
            await runTransaction(db, async (t) => {
                const uRef = doc(db, "users", currentUser.uid);
                const uDoc = await t.get(uRef);
                const currentBal = uDoc.data().balance || 0;
                if(currentBal < price) throw "Saldo tidak cukup!";
                
                const balanceBefore = currentBal;
                const balanceAfter = currentBal - price;

                t.update(uRef, { balance: balanceAfter });
                t.set(trxRef, {
                    title: name,
                    amount: price,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Proses',
                    api_msg: 'Menghubungkan ke server...',
                    trx_id: reffId,
                    trx_code: trxCode,
                    provider_id: '', // ID Server (Akan diupdate)
                    provider_code: provCode || '', // Kode Provider App
                    raw_code: code, // Kode Produk
                    dest_num: dest, // Nomor Tujuan
                    balance_before: balanceBefore,
                    balance_after: balanceAfter
                });
            });
        } catch(e) {
            window.showLoader(false);
            return window.showAlert("Gagal", "Gagal memproses transaksi: " + e, "error");
        }

        // Update UI Lokal
        currentBalance -= price;
        if(document.getElementById('displayBalance')) document.getElementById('displayBalance').innerText = window.formatRp(currentBalance);

        // 2. CALL API
        try {
                        const result = await callApi('/trx', { produk: code, tujuan: dest, reff_id: reffId });
            window.showLoader(false);

            // --- FIX BUG FALSE NEGATIVE (Anti Refund saat RTO & Network Glitch) ---
            // UPDATE: Menambahkan deteksi 'Load failed' dan error generik proxy untuk mencegah refund prematur
            const errStr = result.error ? String(result.error) : "";
            const isNetworkError = errStr.includes('Failed to fetch') || 
                                 errStr.includes('NetworkError') || 
                                 errStr.includes('Gagal Koneksi') ||
                                 errStr.includes('Load failed') ||
                                 errStr.includes('upstream') ||
                                 (!result.ok && !result.data && !result.error); // Respon kosong/gelap

            if (!result.ok && isNetworkError) {
                console.warn("Network Error Detected - Holding Refund");
                
                await updateDoc(trxRef, { 
                    status: 'Pending', 
                    api_msg: 'Koneksi Terputus (Verifikasi Otomatis)...',
                    raw_json: JSON.stringify(result)
                });
                
                window.customConfirm(
                    'Koneksi Terganggu',
                    'Sinyal terputus saat kirim data. JANGAN transaksi ulang! Sistem sedang memverifikasi status transaksi Anda ke server.',
                    () => window.manualCheckTrx(reffId, null)
                );

                // Auto Cek Status ke Server Pusat (Delay 3 detik)
                setTimeout(() => window.manualCheckTrx(reffId, null), 3000);
                
                window.nav('homePage');
                return; // STOP: Jangan lanjut ke logika refund!
            }
            // ------------------------------------------------------
            
            let isSuccess = false;
            let msg = 'Tidak ada respon server';

            // UPDATE: Jika semua proxy gagal (misal: HTTP_CLIENT_RESPONSE_BODY_ERR)
            // Paksa pesan jadi 'Server Sedang Sibuk' agar masuk ke logika refund dengan info yang jelas
            if (!result.ok) {
                msg = "Server Sedang Sibuk";
            }
            
            let providerId = '';
            
            // DETEKSI KHUSUS ERROR LOCK_TIMEOUT (Server Busy)
            const rawRes = JSON.stringify(result).toLowerCase();
            const isLockTimeout = rawRes.includes('lock_timeout');

            // --- FIX: Handle Lock Timeout sebagai PENDING (Anti-Refund) ---
            if (isLockTimeout) {
                 console.warn("Lock Timeout Detected - Holding Refund");
                 await updateDoc(trxRef, { 
                    status: 'Pending', 
                    api_msg: 'Server Busy (Lock Timeout). Mengecek status...',
                    raw_json: rawRes
                });
                
                // Auto Cek Status (Delay 3 detik)
                setTimeout(() => window.manualCheckTrx(reffId, null), 3000);

                window.customConfirm(
                    'Server Sedang Sibuk',
                    'Transaksi masuk antrean (Lock Timeout). Sistem akan mengecek status otomatis. Mohon tunggu sebentar.',
                    () => window.manualCheckTrx(reffId, null)
                );
                
                window.nav('homePage');
                return; // STOP: Jangan lanjut ke logika sukses/gagal biasa
            }

            if(result.ok && result.data) {
                 const d = result.data;
                 msg = d.message || d.msg || d.sn || (d.data ? d.data.message : '') || msg;
                 // --- SENSOR DATA SENSITIF (Anti-Leak) ---
                 // Menghapus total parameter kodereseller, password, dan pin agar tidak tampil
                 if(typeof msg === 'string') {
                    // 1. Hapus key=value untuk data sensitif (termasuk & di belakangnya)
                    msg = msg.replace(/(kodereseller|password|pin)=[^&\s#]*&?/gi, "");
                    
                    // 2. Hapus sisa 'trx?' atau '?' di awal string agar rapi (misal: trx?produk=... jadi produk=...)
                    msg = msg.replace(/^(trx)?\?/i, "");
                 }

                 // --- SENSOR DATA SENSITIF (Anti-Leak) ---
                 // Menyembunyikan kodereseller, password, dan pin dari pesan error
                 if(typeof msg === 'string') {
                    msg = msg.replace(/(kodereseller|password|pin)=([^&\s#]*)/gi, '$1=******');
                 }
                 if(d.data && d.data.id) providerId = d.data.id;
                 isSuccess = d.status === true || d.success === true || d.status === 'success' || (d.data && d.data.status === 'Pending') || String(msg).toLowerCase().includes('proses');
            }

            if(isSuccess) {
                let safeMsg = msg;
                if (safeMsg.includes('password=') || safeMsg.includes('pin=')) {
                    safeMsg = safeMsg.split('#').pop() || 'Tujuan Diluar Wilayah';
                }
                await updateDoc(trxRef, { status: 'Pending', api_msg: safeMsg, provider_id: providerId, raw_json: JSON.stringify(result.data || result || {}) });
                
                alert(`Transaksi Berhasil Dikirim!\nInfo: ${msg}`);
                window.nav('homePage');
                        } else {
                // GAGAL DARI RESPON API -> LAKUKAN REFUND OTOMATIS (LEDGER V2)
                // Logic Baru: Bersih & Aman
                const finalMsg = isLockTimeout ? msg : (msg.includes('wilayah') ? 'Gagal Tujuan di luar wilayah' : msg);
                
                // 1. Panggil Sistem Ledger untuk Refund Database
                const refundResult = await window.processSmartRefund(currentUser.uid, reffId, finalMsg);
                
                // 2. Update Tampilan Saldo (Visual Saja)
                currentBalance += price;
                if(document.getElementById('displayBalance')) document.getElementById('displayBalance').innerText = window.formatRp(currentBalance);

                                // 3. Tampilkan Pesan ke User
                // PERBAIKAN: Gunakan 'finalMsg' agar pesan asli server (Misal: Nomor Salah/Suspect) muncul
                const displayMsg = finalMsg || msg || "Transaksi Gagal";
                window.showAlert("Transaksi Gagal", displayMsg + "\n\n" + (refundResult.msg || "Saldo telah dikembalikan otomatis."), "error");
                window.nav('homePage');
            }

                } catch(e) {
            window.showLoader(false);
            // 3. ERROR KONEKSI (Murni jaringan, bukan error logic server)
            await updateDoc(trxRef, { 
                status: 'Pending', 
                api_msg: 'Koneksi Timeout. Klik tombol refresh pada riwayat.',
                error_log: String(e)
            });
            
            window.customConfirm(
                'Koneksi Timeout', 
                'Koneksi terputus saat transaksi. Saldo aman. Silakan cek status untuk memastikan keberhasilan transaksi atau pengembalian saldo.', 
                async () => {
                    window.manualCheckTrx(reffId, null);
                }
            );
        }
    };


    // --- TOP UP LOGIC & SMART BADGE ---
        // --- BACKGROUND SERVICE (AUTO CHECK 5 Detik) ---
    window.autoCheckInterval = null;

            // --- INTELLIGENT WATCHDOG SYSTEM (AUTO-HEALING) ---
    window.startBackgroundService = () => {
        if(window.autoCheckInterval) clearInterval(window.autoCheckInterval);
        
        console.log(" Watchdog System V3: Activated");

        // Interval Pengecekan (Setiap 20 Detik)
        window.autoCheckInterval = setInterval(async () => {
            if(!currentUser) return;

            try {
                // 1. Cari Transaksi yang 'Pending' atau 'Proses' di Database
                // Limit 10 transaksi terakhir untuk efisiensi
                const q = query(
                    collection(db, "users", currentUser.uid, "history"), 
                    where("status", "in", ["Pending", "Proses"]),
                    orderBy("date", "desc"),
                    limit(10)
                );
                
                const snapshot = await getDocs(q);
                if (snapshot.empty) return; // Tidak ada transaksi gantung

                const now = Date.now();

                for (const docSnap of snapshot.docs) {
                    const trx = docSnap.data();
                    const trxTime = new Date(trx.date).getTime();
                    const diffSeconds = (now - trxTime) / 1000;

                    // ATURAN WATCHDOG:
                    // 1. Abaikan transaksi manual/topup (butuh admin)
                    if (trx.provider_id === 'MANUAL' || trx.provider_id === 'MANUAL_SEABANK' || String(trx.trx_id).startsWith('ICS-PO')) continue;
                    
                    // 2. Hanya cek transaksi yang sudah berumur > 60 detik tapi < 24 jam
                    // (Agar tidak bentrok saat animasi loading awal)
                    if (diffSeconds > 60 && diffSeconds < 86400) {
                        console.log(` Watchdog: Checking Stuck Trx ${trx.trx_id}...`);
                        
                        // Panggil Cek Status Manual (Logic Shared)
                        // Fungsi ini sudah tertanam logika 'Smart Refund' di dalamnya
                        await window.manualCheckTrx(trx.trx_id, trx.provider_id);
                    }
                }
            } catch (e) {
                console.warn(" Watchdog Error (Silent):", e);
            }
        }, 20000); // Jalan setiap 20 detik
        };

    window.checkPendingTopUp = () => {
        if(!currentUser) return false;
        const savedData = localStorage.getItem('qios_trx_' + currentUser.uid);
        if (savedData) {
            const ticket = JSON.parse(savedData);
            const now = Date.now();
            const limit = 25 * 60 * 1000;
            if ((now - ticket.created) < limit) return true;
            else localStorage.removeItem('qios_trx_' + currentUser.uid);
        }
        return false;
    };

    window.setTopUpAmount = (amount) => { document.getElementById('qiosInputAmount').value = amount; };

        window.checkPendingTrx = async () => {
        if(!currentUser) return;
        const q = query(collection(db, "users", currentUser.uid, "history"), where("status", "==", "Pending"));
        const snapshot = await getDocs(q);
        
        for (const docSnap of snapshot.docs) {
            const trx = docSnap.data();
            if(trx.provider_id === 'MANUAL' || trx.provider_id === 'ICS' || String(trx.trx_id).startsWith('ICS-')) continue;

            await window.manualCheckTrx(trx.trx_id, trx.provider_id);
        }
    };

    
window.renderTopUpHistory = () => {
        const container = document.getElementById('qiosMiniHistory');
        if(!container) return;
        
        const topups = transactions.filter(t => t.type === 'in' && (t.title.toLowerCase().includes('top') || (t.method && t.method.includes('Qios')))).slice(0, 5);
        
        if(topups.length === 0) {
            container.innerHTML = '<p class="text-[10px] text-center text-gray-400 py-2">Belum ada riwayat Top Up</p>';
            return;
        }

        let html = '';
        topups.forEach(t => {
            let statusColor = 'text-gray-500';
            if(t.status === 'Sukses') statusColor = 'text-green-500';
            else if(t.status === 'Gagal' || t.status.includes('Batal')) statusColor = 'text-red-500';
            else statusColor = 'text-orange-500';

            html += `<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-2 rounded-lg border border-gray-100 dark:border-gray-700">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[10px]"><i class="fas fa-arrow-down"></i></div>
                    <div><p class="text-[10px] font-bold text-gray-800 dark:text-white">Rp ${window.formatRp(t.amount)}</p>                                     <p class="text-[9px] text-gray-400">${new Date(t.date).toLocaleDateString('id-ID', {day:'numeric', month:'short'})}  ${new Date(t.date).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</p></div>
                </div>
                <span class="text-[9px] font-bold ${statusColor}">${t.status}</span>
            </div>`;
        });
        container.innerHTML = html;
    };

    window.updateTopUpBadge = () => {
        const hasPending = window.checkPendingTopUp();
        const b1 = document.getElementById('badge-topup-home');
        const b2 = document.getElementById('badge-topup-nav');
        if(hasPending) {
            if(b1) b1.classList.remove('hide');
            if(b2) b2.classList.remove('hide');
        } else {
            if(b1) b1.classList.add('hide');
            if(b2) b2.classList.add('hide');
        }
    };

        window.checkPendingManualSeabank = async () => {
        if(!currentUser) return false;
        try {
            const q = query(collection(db, "users", currentUser.uid, "history"), 
                where("status", "==", "Pending"), 
                where("provider_id", "==", "MANUAL_SEABANK")
            );
            const snap = await getDocs(q);
            return !snap.empty;
        } catch(e) { return false; }
    };

    window.openTopUpSheet = async () => {
        // 1. Cek Qios (Lokal)
        if(window.checkPendingTopUp()) {
            window.openQios(); 
            return;
        }

        // 2. Cek Manual Seabank (Database)
        // Tampilkan loader sebentar karena butuh koneksi internet
        window.showLoader(true);
        const hasPendingManual = await window.checkPendingManualSeabank();
        window.showLoader(false);

        if(hasPendingManual) {
            window.openManualTopUp();
        } else {
            document.getElementById('topUpSheet').classList.remove('hide');
        }
    };

        window.openManualTopUp = async () => {
        if (topupStatus && topupStatus.manual === false) return window.showAlert("Maintenance", "Layanan Top Up Manual sedang dalam perbaikan.", "error");
        document.getElementById('topUpSheet').classList.add('hide');
        document.getElementById('manualTopUpModal').classList.remove('hide');
        
        const q = query(collection(db, "users", currentUser.uid, "history"), 
            where("status", "==", "Pending"), 
            where("provider_id", "==", "MANUAL_SEABANK")
        );
        const snap = await getDocs(q);
        
        if (!snap.empty) {
            const trx = snap.docs.sort((a,b) => new Date(b.data().date) - new Date(a.data().date))[0].data();
            const trxTime = new Date(trx.date).getTime();
            const now = Date.now();
            const diff = now - trxTime;
            const limit = 3 * 60 * 60 * 1000; 

            if (diff < limit) {
                currentMtTrxId = snap.docs[0].id;
                window.showMtStep2(trx.amount, trxTime + limit);
            } else {
                window.resetMtUI();
            }
        } else {
            window.resetMtUI();
        }
    };
    
    window.closeTopUp = () => document.getElementById('topUpSheet').classList.add('hide');
    
    // Auto Update Badge
    setInterval(window.updateTopUpBadge, 2000);

        window.liveStockInterval = null;

    window.fetchLiveStock = async () => {
        // Hemat resource: Jangan fetch jika tidak di Home Page
        if(document.getElementById('homePage').classList.contains('hide')) return;

        const targetUrl = "https://panel.khfy-store.com/api_v3/cek_stock_akrab";
        let data = null;

        for (const proxy of PROXY_LIST) {
            try {
                const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3500);
                
                const res = await fetch(fullUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if(res.ok) {
                    const json = await res.json();
                    if(json.ok || json.message === "success") {
                        data = json.data;
                        break; 
                    }
                }
            } catch(e) { }
        }

        const container = document.getElementById('liveStockContainer');
        if(!container) return;

        if(data && Array.isArray(data)) {
            let html = '';
                        data.forEach(item => {
                 const isAvail = item.sisa_slot > 0;
                 // Tampilan Super Ringkas (Grid Friendly)
                 html += `<div class="flex justify-between items-center px-2 py-1.5 bg-white dark:bg-gray-900 rounded-lg border border-gray-100 dark:border-gray-800">
                    <div class="flex items-center gap-1.5 overflow-hidden">
                         <div class="w-1.5 h-1.5 shrink-0 rounded-full ${isAvail ? 'bg-green-500' : 'bg-red-500'} "></div>
                         <p class="text-[9px] font-bold text-gray-700 dark:text-gray-300 truncate leading-none">${item.nama}</p>
                    </div>
                    <span class="text-[9px] ${isAvail ? 'text-blue-600 dark:text-blue-400 font-bold' : 'text-gray-300'} shrink-0">${item.sisa_slot}</span>
                 </div>`;
            });
            container.innerHTML = html;
        }
    };

        window.startLiveStock = () => {
        if(window.liveStockInterval) clearInterval(window.liveStockInterval);
        window.fetchLiveStock(); // Fetch awal sekali saja saat load
    };

    window.manualRefreshStock = async () => {
        const btn = document.getElementById('btnRefreshStock');
        const originalContent = '<i class="fas fa-sync-alt text-[10px] text-blue-600 dark:text-blue-400"></i><span class="text-[10px] text-blue-700 dark:text-blue-400 font-bold">Refresh Stok</span>';
        
        // Ubah UI jadi loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin text-[10px] text-blue-600 dark:text-blue-400"></i><span class="text-[10px] text-blue-700 dark:text-blue-400 font-bold">Sedang merefresh...</span>';

        // Tahan 1.5 detik sesuai request
        await new Promise(r => setTimeout(r, 1500));

        // Fetch Data
        await window.fetchLiveStock();

        // Kembalikan UI tombol
        btn.innerHTML = originalContent;
        btn.disabled = false;
    };

    window.checkAkrabStock = async () => {
        window.showLoader(true);
        const targetUrl = "https://panel.khfy-store.com/api_v3/cek_stock_akrab";
        let data = null;

        for (const proxy of PROXY_LIST) {
            try {
                const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const res = await fetch(fullUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if(res.ok) {
                    const json = await res.json();
                    if(json.ok || json.message === "success") {
                        data = json.data;
                        break; 
                    }
                }
            } catch(e) { console.log("Proxy skip:", e); }
        }

        window.showLoader(false);

        if(data && Array.isArray(data)) {
            let html = '';
            data.forEach(item => {
                 const isAvail = item.sisa_slot > 0;
                 html += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                             <p class="text-xs font-bold text-gray-800 dark:text-white uppercase">${item.nama}</p>
                             <span class="text-[9px] px-1.5 py-0.5 rounded ${isAvail ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} font-bold">${item.type}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-black ${isAvail ? 'text-blue-600 dark:text-blue-400' : 'text-gray-300'}">${item.sisa_slot}</p>
                        <p class="text-[9px] text-gray-400">Slot</p>
                    </div>
                 </div>`;
            });
            document.getElementById('stockList').innerHTML = html;
            document.getElementById('stockModal').classList.remove('hide');
        } else {
            window.showAlert("Gagal", "Gagal mengambil data stok. Pastikan koneksi internet stabil.", "error");
        }
    };
    window.closeStockModal = () => document.getElementById('stockModal').classList.add('hide');
                                    // FUNGSI BANTUAN: Format Tampilan Detail
    window.formatDetailInfo = (json) => {
        let d = json.data || json;
        if (Array.isArray(d) && d.length > 0) d = d[0];
        if (!d) return '-';

        return `
        <div class="space-y-1 text-[10px] font-mono">
            <div class="border-b border-blue-200 dark:border-blue-800 pb-1 mb-1">
                <span class="block font-bold text-blue-700 dark:text-blue-300">SN / Token:</span>
                <span class="break-all">${d.sn || d.message || '-'}</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="text-gray-500">Kode:</span> <span class="font-bold">${d.kode_produk || d.code || '-'}</span></div>
                <div><span class="text-gray-500">Tujuan:</span> <span class="font-bold">${d.tujuan || '-'}</span></div>
                
            </div>
            <div class="mt-1 pt-1 border-t border-dashed border-gray-300 dark:border-gray-700">
                <div class="flex justify-between"><span>Masuk:</span> <span>${d.tgl_entri ? d.tgl_entri.replace('T', ' ').split('.')[0] : '-'}</span></div>
                <div class="flex justify-between"><span>Update:</span> <span>${d.tgl_status ? d.tgl_status.replace('T', ' ').split('.')[0] : '-'}</span></div>
            </div>
            ${d.keterangan ? `<div class="mt-1 text-gray-500 italic">Ket: ${d.keterangan}</div>` : ''}
        </div>`;
    };

                    window.openTrxDetail = (trxId) => {
        const cacheKey = `trx_cache_${currentUser.uid}`;
        let cachedData = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        let trx = cachedData.find(t => t.trx_id === trxId) || transactions.find(t => t.trx_id === trxId);
        
        if(!trx) return;

        // FITUR BARU: Redirect ke Modal Topup Manual jika status Pending
        if(trx.provider_id === 'MANUAL_SEABANK' && trx.status === 'Pending') {
            window.openManualTopUp();
            return;
        }

        document.getElementById('dtTitle').innerText = trx.title;
        document.getElementById('dtTrxCode').innerText = trx.trx_code || '------';
        document.getElementById('dtAmount').innerText = window.formatRp(trx.amount);
        document.getElementById('dtDate').innerText = new Date(trx.date).toLocaleString('id-ID');
        
        const statusEl = document.getElementById('dtStatus');
        statusEl.innerText = trx.status;
        statusEl.className = 'text-xs font-bold ' + (trx.status === 'Sukses' ? 'text-green-600' : (trx.status === 'Gagal' ? 'text-red-500' : 'text-orange-500'));
        
        const infoEl = document.getElementById('dtSn');
        infoEl.innerText = trx.api_msg || '-';

        // REFRESH OTOMATIS SAAT DETAIL DIBUKA JIKA STATUS PENDING
                if(trx.status === 'Pending' || trx.status === 'Proses') {
            document.getElementById('btnRefreshStatus').classList.remove('hide');
            document.getElementById('btnRefreshStatus').onclick = () => window.manualCheckTrx(trx.trx_id, trx.provider_id || trx.trx_id);
            if(!trx.trx_id.startsWith('PO-')) window.manualCheckTrx(trx.trx_id, trx.provider_id || trx.trx_id);
        }

        if(trx.trx_id.startsWith('PO-')) {
            const refundInfo = trx.status === 'Gagal' && trx.balance_final ? `<div class="mt-2 p-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-lg text-[9px] font-bold border border-green-200"><i class="fas fa-undo-alt mr-1"></i> Saldo di-refund: ${window.formatRp(trx.balance_final)}</div>` : '';
            infoEl.innerHTML = `
            <div class="space-y-1 text-[10px] font-mono">
                <div class="border-b border-blue-200 dark:border-blue-800 pb-1 mb-1">
                    <span class="block font-bold text-blue-700 dark:text-blue-300">Informasi Preorder:</span>
                    <span>${trx.api_msg || 'Menunggu Admin'}</span>
                </div>
                <div class="grid grid-cols-1 gap-1">
                    <div><span class="text-gray-500">Produk:</span> <span class="font-bold">${trx.title.replace('Preorder: ', '')}</span></div>
                    <div><span class="text-gray-500">Kode:</span> <span class="font-bold">${trx.raw_code || '-'}</span></div>
                    <div><span class="text-gray-500">Tujuan:</span> <span class="font-bold text-blue-600">${trx.dest_num || '-'}</span></div>
                    <div><span class="text-gray-500">Waktu:</span> <span class="font-bold">${new Date(trx.date).toLocaleTimeString('id-ID')} WIB</span></div>
                </div>
                ${refundInfo}
            </div>`;
        } else {
            document.getElementById('btnRefreshStatus').classList.add('hide');
            if (trx.raw_json && trx.raw_json !== '{}') {
                try {
                    const json = JSON.parse(trx.raw_json);
                    infoEl.innerHTML = window.formatDetailInfo(json);
                } catch (e) { console.warn("JSON parse error"); }
            }
        }

        
        const btnCancelPo = document.getElementById('btnCancelPreorder');
        if(trx.trx_id.startsWith('PO-') && trx.status === 'Pending') {
            btnCancelPo.classList.remove('hide');
            btnCancelPo.onclick = () => window.cancelPreorder(trx.trx_id);
        } else {
            btnCancelPo.classList.add('hide');
        }

document.getElementById('detailTrxModal').classList.remove('hide');
    };

            window.manualCheckTrx = async (docId, providerId) => {
        const btn = document.getElementById('btnRefreshStatus');
        if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            // 1. Ambil Data Lokal DULU (Penting untuk Nama Produk & Cek Status Lama)
            const trxRef = doc(db, "users", currentUser.uid, "history", docId);
            const trxSnap = await getDoc(trxRef);
            if(!trxSnap.exists()) return;
            const localData = trxSnap.data();

            // 2. Panggil API History
            const res = await callApi('/history', { refid: docId });
            
            if(res.ok && res.data) {
                let root = res.data;
                let item = root.data;
                if (Array.isArray(item)) item = item[0];
                
                if (item) {
                    const statusText = (item.status_text || '').toUpperCase();
                    const keterangan = item.keterangan || '';
                    const sn = item.sn || '';
                    
                    let freshStatus = 'Pending';
                    if (statusText === 'SUKSES') freshStatus = 'Sukses';
                    else if (statusText === 'GAGAL') freshStatus = 'Gagal';

                    if (freshStatus === 'Gagal') {
                        // Cek agar tidak refund 2x
                        if(localData.status !== 'Gagal') {
                             await window.processSmartRefund(currentUser.uid, docId, 'Refund: ' + (keterangan || 'Transaksi Gagal'));
                        }
                    } else if (freshStatus === 'Sukses') {
                        // FIX DOUBLE NOTIF: Cek ulang status TERBARU dari database tepat sebelum eksekusi
                        // Ini mencegah Race Condition jika ada 2 proses berjalan bersamaan
                        const latestSnap = await getDoc(trxRef);
                        
                        if (latestSnap.exists() && latestSnap.data().status !== 'Sukses') {
                            await updateDoc(trxRef, {
                                status: 'Sukses',
                                api_msg: 'Transaksi Berhasil',
                                sn: sn || keterangan || 'Transaksi Berhasil',
                                raw_json: JSON.stringify(root)
                            });
                            
                            if(typeof window.sendTelegramNotif === 'function') {
                                window.sendTelegramNotif('ORDER', { 
                                    title: localData.title || 'Produk', 
                                    amount: localData.amount || 0, 
                                    dest: localData.dest_num || '', 
                                    trxId: docId 
                                });
                            }
                        }
                    }

                    // Update UI (Visual) tanpa reload
                    const statusEl = document.getElementById('dtStatus');
                    if (statusEl) {
                        statusEl.innerText = freshStatus;
                        statusEl.className = 'text-xs font-bold ' + (freshStatus === 'Sukses' ? 'text-green-600' : (freshStatus === 'Gagal' ? 'text-red-500' : 'text-orange-500'));
                        if(freshStatus !== 'Pending' && document.getElementById('dtSn')) {
                             document.getElementById('dtSn').innerText = (freshStatus === 'Gagal' ? keterangan : sn);
                        }
                    }
                }
            }
        } catch(e) { console.log("Check manual error:", e); }
        
        if(btn) btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
    };


    window.closeTrxDetail = () => document.getElementById('detailTrxModal').classList.add('hide');

    // --- FULL QR PREVIEW ---
    window.openFullQr = () => {
        const src = document.getElementById('qiosQrDisplay').src;
        if(!src) return;
        document.getElementById('fullQrImage').src = src;
        document.getElementById('fullQrModal').classList.remove('hide');
    };
    
    window.closeFullQr = () => {
        document.getElementById('fullQrModal').classList.add('hide');
    };

    // --- QIOSPAY SYSTEM V2 (Timer & History) ---
    let qiosInterval = null;

        let mtInterval = null;
    let currentMtTrxId = null;

    window.openManualTopUp = async () => {
        document.getElementById('topUpSheet').classList.add('hide');
        document.getElementById('manualTopUpModal').classList.remove('hide');
        
        // Cek apakah ada pending trx
        const q = query(collection(db, "users", currentUser.uid, "history"), 
            where("status", "==", "Pending"), 
            where("provider_id", "==", "MANUAL_SEABANK")
        );
        const snap = await getDocs(q);
        
        if (!snap.empty) {
            // Ambil trx terbaru
            const trx = snap.docs.sort((a,b) => new Date(b.data().date) - new Date(a.data().date))[0].data();
            const trxTime = new Date(trx.date).getTime();
            const now = Date.now();
            const diff = now - trxTime;
            const limit = 3 * 60 * 60 * 1000; // 3 Jam

            if (diff < limit) {
                currentMtTrxId = snap.docs[0].id;
                window.showMtStep2(trx.amount, trxTime + limit);
            } else {
                // Expired, auto cancel logic could go here, for now just show input
                window.resetMtUI();
            }
        } else {
            window.resetMtUI();
        }
    };

    window.resetMtUI = () => {
        document.getElementById('mtStep1').classList.remove('hide');
        document.getElementById('mtStep2').classList.add('hide');
        document.getElementById('mtInputAmount').value = '';
        currentMtTrxId = null;
        if(mtInterval) clearInterval(mtInterval);
    };

    window.closeManualTopUp = () => document.getElementById('manualTopUpModal').classList.add('hide');

    window.submitManualTopUp = async () => {
        const amount = parseInt(document.getElementById('mtInputAmount').value);
        if(!amount || amount < 10000) return alert('Minimal top up Rp 10.000');

        const unique = Math.floor(Math.random() * 999);
        const total = amount + unique;
        const trxId = 'MANUAL-' + Date.now();

        try {
            window.showLoader(true);
            const hRef = doc(db, "users", currentUser.uid, "history", trxId);
            await setDoc(hRef, {
                title: "Top Up Manual (Seabank)",
                amount: total,
                type: "in",
                date: new Date().toISOString(),
                status: "Pending",
                method: "Seabank",
                provider_id: "MANUAL_SEABANK",
                trx_id: trxId,
                api_msg: "Menunggu konfirmasi admin"
            });
            
            currentMtTrxId = trxId;
            window.showLoader(false);
            window.showMtStep2(total, Date.now() + (3 * 60 * 60 * 1000));
            
        } catch(e) {
            window.showLoader(false);
            alert("Gagal membuat transaksi: " + e.message);
        }
    };

    window.showMtStep2 = (amount, endTime) => {
        document.getElementById('mtStep1').classList.add('hide');
        document.getElementById('mtStep2').classList.remove('hide');
        document.getElementById('mtTotalDisplay').innerText = window.formatRp(amount);

        if(mtInterval) clearInterval(mtInterval);
        mtInterval = setInterval(() => {
            const now = Date.now();
            const diff = endTime - now;
            if(diff <= 0) {
                clearInterval(mtInterval);
                document.getElementById('mtTimer').innerText = "00:00:00";
                // Bisa tambah auto cancel disini
                return;
            }
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('mtTimer').innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }, 1000);
    };

    window.cancelManualTopUp = async () => {
        if(!currentMtTrxId) return;
        if(!confirm("Batalkan transaksi ini?")) return;

        try {
            window.showLoader(true);
            await updateDoc(doc(db, "users", currentUser.uid, "history", currentMtTrxId), {
                status: "Dibatalkan",
                api_msg: "Dibatalkan oleh User"
            });
            window.showLoader(false);
            alert("Transaksi dibatalkan.");
            window.resetMtUI();
        } catch(e) {
            window.showLoader(false);
            alert("Gagal membatalkan: " + e.message);
        }
    };

window.openQios = () => {
        if (topupStatus && topupStatus.qios === false) return window.showAlert("Maintenance", "Layanan QRIS sedang dalam perbaikan.", "error");
        document.getElementById('topUpSheet').classList.add('hide');
        document.getElementById('qiosModal').classList.remove('hide');
        window.renderTopUpHistory(); 
        
        const savedData = localStorage.getItem('qios_trx_' + currentUser.uid);
        if (savedData) {
            const ticket = JSON.parse(savedData);
            const now = Date.now();
            const limit = 25 * 60 * 1000; 
            
            if ((now - ticket.created) < limit) {
                qiosTicket = ticket;
                window.restoreQiosUI();
                return;
            } else {
                localStorage.removeItem('qios_trx_' + currentUser.uid);
            }
        }
        window.resetQiosStep();
    };
    
    window.closeQios = () => document.getElementById('qiosModal').classList.add('hide');
    
    window.resetQiosStep = () => {
        document.getElementById('qiosStep1').classList.remove('hide');
        document.getElementById('qiosStep2').classList.add('hide');
        document.getElementById('qiosInputAmount').value = '';
        if(qiosInterval) clearInterval(qiosInterval);
        qiosTicket = null;
    };

    window.generateQiosTicket = () => {
        const input = parseInt(document.getElementById('qiosInputAmount').value);
        if(!input || input < 1000) return alert('Minimal Top Up Rp 1.000');
        
        const uniqueCode = Math.floor(Math.random() * 900) + 100;
        const total = input + uniqueCode;
        
        qiosTicket = {
            base: input,
            unique: uniqueCode,
            total: total,
            created: Date.now()
        };
        
        localStorage.setItem('qios_trx_' + currentUser.uid, JSON.stringify(qiosTicket));
        window.restoreQiosUI();
    };

    window.restoreQiosUI = () => {
        document.getElementById('qiosTotalDisplay').innerText = window.formatRp(qiosTicket.total);
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(QIOS_CONFIG.qr_string)}`;
        document.getElementById('qiosQrDisplay').src = qrUrl;

        document.getElementById('qiosStep1').classList.add('hide');
        document.getElementById('qiosStep2').classList.remove('hide');
        window.startQiosTimer();
    };

    window.startQiosTimer = () => {
        if(qiosInterval) clearInterval(qiosInterval);
        
        const tick = () => {
            if(!qiosTicket) return;
            const now = Date.now();
            const endTime = qiosTicket.created + (25 * 60 * 1000);
            const diff = endTime - now;

            if(diff <= 0) {
                clearInterval(qiosInterval);
                document.getElementById('qiosTimerDisplay').innerText = "00:00";
                alert("Waktu pembayaran habis. Transaksi dibatalkan.");
                window.cancelQiosTransaction(true, "Gagal (Timeout)");
                return;
            }

            const m = Math.floor(diff / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('qiosTimerDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        };
        
        tick();
        qiosInterval = setInterval(tick, 1000);
    };

    window.cancelQiosTransaction = async (silent = false, statusLabel = "Dibatalkan") => {
        if(!silent && !confirm("Batalkan transaksi ini?")) return;

        if(qiosTicket) {
            try {
                const hRef = doc(db, "users", currentUser.uid, "history", "TOPUP-FAIL-"+qiosTicket.created);
                await setDoc(hRef, {
                    title: "Top Up " + statusLabel,
                    amount: qiosTicket.total,
                    type: "in",
                    date: new Date().toISOString(),
                    status: statusLabel,
                    method: "QiosPay QRIS"
                });
            } catch(e) { console.error(e); }
        }

        localStorage.removeItem('qios_trx_' + currentUser.uid);
        if(qiosInterval) clearInterval(qiosInterval);
        window.resetQiosStep();
    };

    window.checkQiosStatus = async () => {
        if(!qiosTicket) return;
        const btn = document.getElementById('btnCheckQios');
        const originalText = "SAYA SUDAH BAYAR";
        btn.innerText = "Memverifikasi Dana...";
        btn.disabled = true;

        try {
            const targetUrl = `https://qiospay.id/api/mutasi/qris/${QIOS_CONFIG.merchant_code}/${QIOS_CONFIG.api_key}`;
            let resultData = null;
            let isConnected = false;

            for (const proxy of PROXY_LIST) {
                if(isConnected) break;
                try {
                    const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                    const response = await fetch(fullUrl);
                    if (response.ok) {
                        const text = await response.text();
                        let rawData = JSON.parse(text);
                        // Membongkar data jika dibungkus oleh proxy AllOrigins/CodeTabs
                        let cleanData = rawData.contents ? JSON.parse(rawData.contents) : rawData;
                        if (cleanData && (cleanData.status || cleanData.data)) {
                            resultData = cleanData;
                            isConnected = true;
                        }
                    }
                } catch (e) { console.warn("Proxy skip:", e); }
            }

            if (!isConnected || !resultData) throw new Error("Gagal terhubung ke server mutasi. Pastikan koneksi internet stabil.");

            const mutations = resultData.data || [];
            const targetAmount = parseInt(qiosTicket.total);
            
            // Mencari kecocokan nominal dan tipe kredit (dana masuk)
            const foundTx = mutations.find(tx => {
                const txAmount = parseInt(String(tx.amount).replace(/[^0-9]/g, ''));
                const txType = String(tx.type).toLowerCase();
                return txAmount === targetAmount && (txType === 'cr' || txType === 'credit' || txType === 'masuk');
            });

                        if(foundTx) {
                await runTransaction(db, async (t) => {
                    // 1. Definisikan Referensi Dokumen History DULU
                    const trxId = "TOPUP-" + qiosTicket.created;
                    const hRef = doc(db, "users", currentUser.uid, "history", trxId);
                    
                    // 2. CEK APAKAH SUDAH PERNAH DIKLAIM? (INI KUNCINYA)
                    const hDoc = await t.get(hRef);
                    if (hDoc.exists()) {
                        throw "Transaksi ini sudah diproses sebelumnya!";
                    }

                    const userRef = doc(db, "users", currentUser.uid);
                    const uDoc = await t.get(userRef);
                    if (!uDoc.exists()) throw "User tidak ditemukan";
                    
                    // 3. Tambah Saldo
                    const newBal = (uDoc.data().balance || 0) + targetAmount;
                    t.update(userRef, { balance: newBal });
                    
                    // 4. Catat riwayat sukses
                    t.set(hRef, {
                        title: "Top Up QRIS Berhasil",
                        amount: targetAmount,
                        type: "in",
                        date: new Date().toISOString(),
                        status: "Sukses",
                        method: "QiosPay",
                        trx_id: "QP-" + qiosTicket.created
                    });
                });

                // Kirim Notif Telegram
                window.sendTelegramNotif('TOPUP', { amount: targetAmount, trxId: "QP-" + qiosTicket.created });

                alert(`SUKSES! Saldo Rp ${targetAmount.toLocaleString()} telah masuk ke akun Anda.`);
                localStorage.removeItem('qios_trx_' + currentUser.uid);
                window.closeQios();
                window.nav('homePage');
            } else {
                alert(`Dana Rp ${targetAmount.toLocaleString()} belum ditemukan.\n\nTips:\n1. Pastikan nominal transfer sama persis.\n2. Tunggu 1 menit jika baru saja transfer.`);
            }
        } catch(e) {
            alert("Kendala Sistem: " + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };

        window.copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => alert('Disalin: ' + text));
    };

    // --- SYSTEM LIVE CHAT ---
    let chatListenerUnsub = null;
    
    window.toggleChat = () => {
        const modal = document.getElementById('liveChatModal');
        const isClosed = modal.classList.contains('hide');
        
        if (isClosed) {
            modal.classList.remove('hide');
            document.getElementById('chatBadge').classList.add('hide');
            if(!chatListenerUnsub) initChatListener();
            setTimeout(() => scrollChatBottom(), 100);
        } else {
            modal.classList.add('hide');
        }
    };

    window.initChatListener = () => {
        if (!currentUser) return;
        const msgsRef = collection(db, "chats", currentUser.uid, "messages");
        const q = query(msgsRef, orderBy("timestamp", "asc"));

        chatListenerUnsub = onSnapshot(q, (snapshot) => {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            if(snapshot.empty) {
                container.innerHTML = '<div class="text-center mt-10 opacity-50"><i class="fas fa-comments text-4xl text-gray-300 dark:text-gray-600 mb-2"></i><p class="text-xs text-gray-400">Halo, ada yang bisa kami bantu?</p></div>';
                return;
            }

            let unreadCount = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                const isMe = data.sender === 'user';
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${isMe ? 'chat-me' : 'chat-admin'}`;
                bubble.innerHTML = `${data.text}<br><span class="text-[9px] opacity-70 block text-right mt-1">${formatTime(data.timestamp)}</span>`;
                container.appendChild(bubble);

                // Hitung notifikasi jika window tertutup & pengirim adalah admin
                if(!isMe && document.getElementById('liveChatModal').classList.contains('hide')) {
                    unreadCount++;
                }
            });

            if(unreadCount > 0) {
                 document.getElementById('chatBadge').innerText = unreadCount;
                 document.getElementById('chatBadge').classList.remove('hide');
            }
            scrollChatBottom();
        });
    };

    window.sendChatMessage = async () => {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text || !currentUser) return;

        input.value = ''; // Clear dulu biar responsif
        
        try {
            // 1. Simpan Pesan
            await addDoc(collection(db, "chats", currentUser.uid, "messages"), {
                text: text,
                sender: 'user',
                timestamp: serverTimestamp(),
                isRead: false
            });

            // 2. Update Info Header Chat (Untuk Admin List)
            await setDoc(doc(db, "chats", currentUser.uid), {
                username: currentUsername,
                lastMessage: text,
                lastTimestamp: serverTimestamp(),
                lastSender: 'user',
                isRead: false,
                userEmail: currentUser.email || '-'
            }, { merge: true });

        } catch(e) {
            console.error("Chat Error", e);
            alert("Gagal mengirim pesan.");
        }
    };

    function scrollChatBottom() {
        const el = document.getElementById('chatMessages');
        el.scrollTop = el.scrollHeight;
    }

    function formatTime(ts) {
        if(!ts) return '...';
        return new Date(ts.toDate()).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
    }

    // Tampilkan tombol chat hanya jika login
    onAuthStateChanged(auth, (user) => {
        if(user) {
            document.getElementById('chatFloatBtn').classList.remove('hide');
            initChatListener(); // Listen background untuk notifikasi
        } else {
            document.getElementById('chatFloatBtn').classList.add('hide');
            if(chatListenerUnsub) chatListenerUnsub();
        }
    });

        </script>
</body>
</html>