<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaos Tool - System Guard Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #1a1a1a; color: #e5e5e5; font-family: 'Courier New', monospace; }
        .terminal { border-left: 4px solid #ef4444; }
        .btn-chaos { transition: all 0.2s; }
        .btn-chaos:active { transform: scale(0.95); }
    </style>
</head>
<body class="p-6 max-w-2xl mx-auto">

    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-red-500 mb-2"><i class="fas fa-biohazard mr-2"></i>CHAOS GENERATOR</h1>
        <p class="text-xs text-gray-400">Alat penguji integritas Financial Guard Engine.</p>
        <p class="text-[10px] text-red-400 mt-1 font-bold">PERINGATAN: INI AKAN MERUSAK DATA RIWAYAT ANDA!</p>
    </div>

    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-6 flex justify-between items-center shadow-lg">
        <div>
            <p class="text-[10px] text-gray-400 uppercase">Target Akun (Login Sendiri)</p>
            <h2 id="userStatus" class="font-bold text-lg text-yellow-400">Mendeteksi...</h2>
            <p id="userUid" class="text-[10px] font-mono text-gray-500">UID: -</p>
        </div>
        <div class="h-10 w-10 bg-gray-700 rounded-full flex items-center justify-center">
            <i class="fas fa-user-secret text-xl"></i>
        </div>
    </div>

    <div class="space-y-4">
        
        <div class="bg-gray-900 p-4 rounded-xl border border-red-900/50 hover:border-red-500 transition group relative overflow-hidden">
            <div class="absolute -right-4 -top-4 text-red-900/20 text-9xl font-black select-none group-hover:text-red-900/40 transition">1</div>
            <h3 class="font-bold text-red-400 mb-1"><i class="fas fa-calculator mr-2"></i>Skenario: Selisih Saldo (Math Error)</h3>
            <p class="text-xs text-gray-400 mb-3">Mengubah 'Saldo Akhir' pada transaksi terakhir tanpa mengubah nominal transaksi. Ini membuat hitungan matematika menjadi salah.</p>
            <button onclick="chaosMathError()" class="btn-chaos w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded shadow-lg text-xs uppercase tracking-widest border border-red-500">
                EKSEKUSI KORUPSI DATA
            </button>
        </div>

        <div class="bg-gray-900 p-4 rounded-xl border border-orange-900/50 hover:border-orange-500 transition group relative overflow-hidden">
            <div class="absolute -right-4 -top-4 text-orange-900/20 text-9xl font-black select-none group-hover:text-orange-900/40 transition">2</div>
            <h3 class="font-bold text-orange-400 mb-1"><i class="fas fa-clone mr-2"></i>Skenario: Double Refund</h3>
            <p class="text-xs text-gray-400 mb-3">Menduplikasi ID Transaksi yang sama dengan status 'Gagal' seolah-olah admin menekan tombol Refund dua kali.</p>
            <button onclick="chaosDoubleRefund()" class="btn-chaos w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded shadow-lg text-xs uppercase tracking-widest border border-orange-500">
                DUPLIKASI REFUND
            </button>
        </div>

    </div>

    <div class="mt-8">
        <p class="text-[10px] font-bold text-gray-500 mb-1 uppercase">System Logs</p>
        <div id="consoleLogs" class="terminal bg-black p-3 rounded h-40 overflow-y-auto text-[10px] font-mono text-green-500 shadow-inner">
            > System Ready...<br>
            > Waiting for user authentication...
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Konfigurasi Firebase (Sesuai file Anda)
        const firebaseConfig = {
            apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
            authDomain: "ppob-3ea96.firebaseapp.com",
            projectId: "ppob-3ea96",
            storageBucket: "ppob-3ea96.firebasestorage.app",
            messagingSenderId: "181320175094",
            appId: "1:181320175094:web:306b79071018410b910bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // Logging Function
        function log(msg, type = 'info') {
            const c = document.getElementById('consoleLogs');
            const color = type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-blue-400' : 'text-green-500');
            c.innerHTML += `<span class="${color}">> [${new Date().toLocaleTimeString()}] ${msg}</span><br>`;
            c.scrollTop = c.scrollHeight;
        }

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userStatus').innerText = user.email;
                document.getElementById('userStatus').classList.replace('text-yellow-400', 'text-green-400');
                document.getElementById('userUid').innerText = "UID: " + user.uid;
                log("User authenticated: " + user.email);
            } else {
                document.getElementById('userStatus').innerText = "Belum Login";
                document.getElementById('userStatus').classList.replace('text-green-400', 'text-red-500');
                log("No user detected. Please login at index.html first.", 'error');
                Swal.fire('Login Required', 'Silakan login di index.html atau paneladmin.html dulu (satu browser), lalu refresh halaman ini.', 'warning');
            }
        });

        // --- SKENARIO 1: MATH ERROR ---
        window.chaosMathError = async () => {
            if(!currentUser) return Swal.fire('Error', 'Login dulu', 'error');
            
            try {
                log("Mencari transaksi terakhir...");
                const q = query(collection(db, "users", currentUser.uid, "history"), orderBy("date", "desc"), limit(1));
                const snap = await getDocs(q);

                if(snap.empty) return log("Tidak ada history transaksi untuk dirusak.", 'error');

                const docRef = snap.docs[0].ref;
                const data = snap.docs[0].data();
                const realBalanceAfter = data.balance_after;
                
                // Korupsi data: Kurangi saldo akhir sebanyak 5000 secara paksa tanpa mengubah amount
                const corruptedBalance = realBalanceAfter - 5000;

                await updateDoc(docRef, {
                    balance_after: corruptedBalance,
                    title: data.title + " (CORRUPTED)" // Menandai judul agar terlihat
                });

                log(`SUKSES: Data Transaksi ID ${snap.docs[0].id} telah dirusak!`, 'success');
                log(`Detail: Amount ${data.amount}. Before: ${data.balance_before}. After (Real): ${realBalanceAfter} -> After (Fake): ${corruptedBalance}.`, 'error');
                Swal.fire('Data Dirusak!', 'Sekarang buka Panel Admin > Financial Guard dan jalankan Audit. Sistem harusnya mendeteksi "SELISIH_SALDO".', 'success');

            } catch(e) {
                log("Gagal: " + e.message, 'error');
            }
        };

        // --- SKENARIO 2: DOUBLE REFUND ---
        window.chaosDoubleRefund = async () => {
            if(!currentUser) return Swal.fire('Error', 'Login dulu', 'error');

            try {
                log("Membuat simulasi Double Refund...");
                
                // Kita buat transaksi palsu dulu yang "Gagal"
                const fakeTrxId = "TRX-CHAOS-" + Date.now();
                const amount = 10000;
                const userRef = doc(db, "users", currentUser.uid);
                const userSnap = await getDoc(userRef);
                const currentBal = userSnap.data().balance || 0;

                // 1. Buat Refund Pertama (Legal)
                await addDoc(collection(db, "users", currentUser.uid, "history"), {
                    title: "Pembelian Chaos (Refund 1)",
                    amount: amount,
                    type: "out",
                    status: "Gagal",
                    balance_before: currentBal,
                    balance_after: currentBal, // Tidak berkurang krn gagal
                    balance_final: currentBal, // Refund trigger
                    date: new Date().toISOString(),
                    trx_id: fakeTrxId // ID Transaksi Sama
                });
                log("Refund ke-1 dibuat (Normal).");

                // 2. Buat Refund Kedua (Illegal - Duplikat ID Transaksi yg sama)
                // Ini mensimulasikan seolah saldo dikembalikan lagi
                await addDoc(collection(db, "users", currentUser.uid, "history"), {
                    title: "Pembelian Chaos (Refund 2 - DUPLIKAT)",
                    amount: amount,
                    type: "out",
                    status: "Gagal",
                    balance_before: currentBal,
                    balance_after: currentBal, 
                    balance_final: currentBal + amount, // Seolah nambah saldo lagi
                    date: new Date().toISOString(),
                    trx_id: fakeTrxId // PENTING: ID INI SAMA DENGAN YG DIATAS
                });

                log("Refund ke-2 dibuat (Duplikat TRX ID).", 'success');
                log(`TRX ID Kembar: ${fakeTrxId}`, 'error');
                Swal.fire('Data Diduplikasi!', 'Sekarang buka Panel Admin > Audit. Sistem harusnya mendeteksi "DOUBLE_REFUND" karena ada 2 history refund dengan ID Transaksi yang sama.', 'success');

            } catch(e) {
                log("Gagal: " + e.message, 'error');
            }
        };

    </script>
</body>
</html>