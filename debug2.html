<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools Order Fix (Index Logic)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; }
        .input-box { width: 100%; background: #1e293b; border: 1px solid #334155; padding: 0.75rem; border-radius: 0.5rem; color: white; font-weight: bold; }
        .input-box:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-box:focus { outline: 2px solid #3b82f6; border-color: transparent; }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto min-h-screen flex flex-col">

    <div class="mb-6 border-b border-gray-700 pb-4">
        <h1 class="text-xl font-black text-blue-500"><i class="fas fa-wrench"></i> TOOLS ORDER V3 (FIX)</h1>
        <p class="text-xs text-gray-400">Parsing Logic 100% Clone Index.html</p>
    </div>

    <div id="loginPanel" class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl mb-6">
        <h3 class="font-bold mb-4">Login Admin</h3>
        <input type="email" id="email" placeholder="Email" class="input-box mb-3">
        <input type="password" id="pass" placeholder="Password" class="input-box mb-4">
        <button onclick="authLogin()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold">MASUK</button>
    </div>

    <div id="mainPanel" class="hidden space-y-4">
        <div class="flex justify-between items-center bg-green-900/20 p-2 rounded-lg border border-green-900/50">
            <span class="text-xs text-green-400 font-mono" id="userStatus">Connected</span>
            <button onclick="authLogout()" class="text-[10px] text-red-400 hover:underline">Logout</button>
        </div>

        <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg space-y-4">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2">
                    <label class="text-[10px] text-gray-400 font-bold">TARGET UID</label>
                    <input type="text" id="targetUid" class="input-box text-yellow-400 font-mono text-sm">
                </div>
                <div class="col-span-2 bg-blue-900/20 p-2 rounded border border-blue-800/30">
                    <label class="text-[10px] text-blue-400 font-bold">REFF ID (AUTO/MANUAL)</label>
                    <div class="flex gap-2">
                        <input type="text" id="reffId" class="input-box" placeholder="Ketik ReffID...">
                        <button onclick="autoReffId()" class="bg-gray-700 px-3 rounded text-xs font-bold hover:bg-gray-600"><i class="fas fa-random"></i></button>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-[10px] text-gray-400 font-bold">PILIH PROVIDER</label>
                <select id="providerSelect" class="input-box" onchange="loadProducts()">
                    <option value="" disabled selected>-- Pilih Provider --</option>
                    <optgroup label="Server ICS (Relay)">
                        <option value="ICS_XLA">XL Akrab (XLA)</option>
                        <option value="ICS_XDA">Akrab Fresh (XDA)</option>
                        <option value="ICS_CIRCLE">XL Circle</option>
                        <option value="ICS_FMX">FlexMax (FMX)</option>
                        <option value="ICS_BPA">Bagi Pulsa (BPA)</option>
                    </optgroup>
                    <optgroup label="Server KHFY (Panel)">
                        <option value="XLA">XL Akrab (XLA)</option>
                        <option value="XDA">Akrab Fresh (XDA)</option>
                        <option value="FMX">FlexMax (FMX)</option>
                        <option value="XLR">XL Reguler</option>
                        <option value="PLN">PLN Pascabayar</option>
                    </optgroup>
                </select>
            </div>

            <div>
                <label class="text-[10px] text-gray-400 font-bold">DAFTAR PRODUK (LIVE)</label>
                <select id="productSelect" class="input-box" disabled onchange="selectProduct()">
                    <option>Pilih Provider Dulu...</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] text-gray-400 font-bold">HARGA (RP)</label>
                    <input type="number" id="price" class="input-box text-green-400" value="0">
                    <p class="text-[9px] text-gray-500 mt-1">Ubah ke 0 untuk Gratis (History Only)</p>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold">KODE (READONLY)</label>
                    <input type="text" id="prodCode" class="input-box bg-gray-700 text-gray-300" readonly>
                </div>
            </div>

            <div>
                <label class="text-[10px] text-gray-400 font-bold">NOMOR TUJUAN</label>
                <input type="tel" id="destNum" class="input-box text-lg" placeholder="08xxx">
            </div>

            <button onclick="executeMixedOrder()" id="btnExec" class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 rounded-xl font-black shadow-lg">
                <i class="fas fa-paper-plane"></i> KIRIM ORDER
            </button>
        </div>

        <div id="logs" class="bg-black p-3 rounded-lg font-mono text-[10px] text-green-500 h-32 overflow-y-auto border border-gray-800">
            > System Ready.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
            authDomain: "ppob-3ea96.firebaseapp.com",
            projectId: "ppob-3ea96",
            storageBucket: "ppob-3ea96.firebasestorage.app",
            messagingSenderId: "181320175094",
            appId: "1:181320175094:web:306b79071018410b910bd7",
            measurementId: "G-0K2V796QDX"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ICS_CONFIG = { apiKey: "7274410f84b7e2810795810e879a4e0be8779c451d55e90e29d9bc174547ff77", baseUrl: "https://www.pandawa-digital.store/api/relay" };
        const KHFY_CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };
        
        const PROXY_LIST = [ { url: 'https://corsproxy.io/?' }, { url: 'https://api.codetabs.com/v1/proxy?quest=' }, { url: '' } ];
        let globalKHFYData = [];

        // AUTH
        window.authLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); } catch(e){ alert(e.message); } };
        window.authLogout = () => signOut(auth);
        onAuthStateChanged(auth, u => {
            if(u) { document.getElementById('loginPanel').classList.add('hidden'); document.getElementById('mainPanel').classList.remove('hidden'); document.getElementById('userStatus').innerText = u.email; if(!document.getElementById('targetUid').value) document.getElementById('targetUid').value = u.uid; }
            else { document.getElementById('loginPanel').classList.remove('hidden'); document.getElementById('mainPanel').classList.add('hidden'); }
        });

        // --- CORE LOGIC (DIAMBIL DARI INDEX.HTML) ---
        window.loadProducts = async () => {
            const providerCode = document.getElementById('providerSelect').value;
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option>Memuat Data Server...</option>';
            select.disabled = true;
            log(`Fetching data untuk ${providerCode}...`);

            let products = [];

            try {
                // === LOGIC 1: ICS SERVER (MIRROR INDEX.HTML) ===
                if (providerCode.startsWith('ICS_')) {
                    let icsType = 'xla';
                    if(providerCode === 'ICS_XDA') icsType = 'xda';
                    if(providerCode === 'ICS_CIRCLE') icsType = 'circle';
                    if(providerCode === 'ICS_FMX') icsType = 'fmax';
                    if(providerCode === 'ICS_BPA') icsType = 'bpa';

                    const t = Date.now();
                    const url = `${ICS_CONFIG.baseUrl}?action=listProducts&type=${icsType}&apikey=${ICS_CONFIG.apiKey}&_t=${t}`;
                    const res = await fetch(url);
                    const json = await res.json();

                    // --- PARSING SUPER ROBUST (INDEX.HTML LOGIC) ---
                    // Ini bagian yang memperbaiki "Undefined" dan "Kosong"
                    let allProducts = [];
                    if (json) {
                        if (json.ready && Array.isArray(json.ready)) allProducts = json.ready;
                        else if (json.data && json.data.ready && Array.isArray(json.data.ready)) allProducts = json.data.ready;
                        else if (Array.isArray(json.data)) allProducts = json.data;
                        else if (Array.isArray(json)) allProducts = json;
                    }

                    // --- FILTERING STRICT (INDEX.HTML LOGIC) ---
                    if (providerCode === 'ICS_CIRCLE') {
                        allProducts = allProducts.filter(p => (p.type === 'circle' || (p.code || p.kode_produk || '').toUpperCase().startsWith('XCL')));
                    } 
                    else if (providerCode === 'ICS_XDA') {
                        allProducts = allProducts.filter(p => (p.type === 'xda' || (p.code || p.kode_produk || '').toUpperCase().startsWith('XDA')));
                    }
                    else if (providerCode === 'ICS_XLA') {
                        // Filter XLA tapi BUKAN XDA
                        allProducts = allProducts.filter(p => (p.type === 'xla' || ((p.code || p.kode_produk || '').toUpperCase().startsWith('XLA') && !(p.code || p.kode_produk || '').toUpperCase().startsWith('XDA'))));
                    }
                    else if (providerCode === 'ICS_FMX') {
                        allProducts = allProducts.filter(p => (p.type === 'fmax' || p.type === 'fmx' || (p.code || p.kode_produk || '').toUpperCase().startsWith('FMX') || (p.code || p.kode_produk || '').toUpperCase() === 'CFMX'));
                    }

                    // Mapping Data
                    products = allProducts.map(p => ({
                        // Handle variasi nama field (nama_produk vs name, harga vs price)
                        name: p.nama_produk || p.name || 'Produk Tanpa Nama',
                        code: p.kode_produk || p.code,
                        price: parseInt(p.harga || p.price || 0),
                        is_empty: (p.stok === 0 || p.status === 'empty')
                    }));

                } 
                // === LOGIC 2: KHFY SERVER (MIRROR INDEX.HTML) ===
                else {
                    if(globalKHFYData.length === 0) {
                        log("Load KHFY via Proxy...");
                        globalKHFYData = await fetchKHFY();
                    }

                    products = globalKHFYData.filter(p => {
                        const c = (p.buyer_sku_code || '').toUpperCase();
                        const b = (p.brand || p.operator || '').toUpperCase();
                        
                        if(providerCode === 'XDA') return c.startsWith('XDA') || b.includes('AKRAB FRESH');
                        if(providerCode === 'XLA') return (c.startsWith('XLA') || c.startsWith('XLC')) && !c.startsWith('XDA');
                        if(providerCode === 'FMX') return (c.startsWith('FMX') || c === 'CFMX') || b === 'FMAX';
                        if(providerCode === 'XLR') return ['FMX50', 'FMX65', 'FMX80', 'FMX150'].includes(c);
                        if(providerCode === 'PLN') return b.includes('PLN');
                        return b.includes(providerCode);
                    }).map(p => ({
                        name: p.product_name,
                        code: p.buyer_sku_code,
                        price: p.buyer_price,
                        is_empty: (p.buyer_product_status === false || p.seller_product_status === false || p.stock === 0)
                    }));
                }

                renderSelect(products);

            } catch(e) {
                console.error(e);
                select.innerHTML = '<option>Error: Lihat Console</option>';
                log("Error: " + e.message);
            }
        };

        async function fetchKHFY() {
            const endpoint = `${KHFY_CONFIG.baseUrl}/list_product?api_key=${KHFY_CONFIG.apiKey}&_t=${Date.now()}`;
            for (const proxy of PROXY_LIST) {
                try {
                    const res = await fetch(proxy.url + encodeURIComponent(endpoint));
                    if(res.ok) {
                        const txt = await res.text();
                        const json = JSON.parse(txt);
                        return json.data || [];
                    }
                } catch(e) {}
            }
            return [];
        }

        function renderSelect(products) {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="" disabled selected>-- Pilih Produk --</option>';
            
            if(products.length === 0) {
                select.innerHTML = '<option>Produk Kosong / Filter Tidak Cocok</option>';
                return;
            }

            products.sort((a,b) => a.price - b.price);

            products.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.code;
                opt.dataset.price = p.price;
                opt.dataset.name = p.name;
                
                if(p.is_empty) {
                    opt.text = `âŒ ${p.name} (GANGGUAN)`;
                    opt.disabled = true;
                } else {
                    opt.text = `${p.name} - Rp ${parseInt(p.price).toLocaleString()}`;
                }
                select.appendChild(opt);
            });
            select.disabled = false;
            log(`Sukses memuat ${products.length} produk.`);
        }

        window.selectProduct = () => {
            const s = document.getElementById('productSelect');
            const opt = s.options[s.selectedIndex];
            if(opt && opt.value) {
                document.getElementById('prodCode').value = opt.value;
                document.getElementById('price').value = opt.dataset.price;
            }
        };

        window.executeMixedOrder = async () => {
            const uid = document.getElementById('targetUid').value;
            const reffId = document.getElementById('reffId').value;
            const prov = document.getElementById('providerSelect').value;
            const code = document.getElementById('prodCode').value;
            const price = parseInt(document.getElementById('price').value) || 0;
            const dest = document.getElementById('destNum').value;

            if(!uid || !reffId || !code || !dest) return alert("Data Belum Lengkap!");
            
            if(!confirm(`Kirim Order?\n\nTarget: ${dest}\nProduk: ${code}\nServer: ${prov}`)) return;

            log("Memproses...");
            document.getElementById('btnExec').disabled = true;

            try {
                // 1. Catat History
                await runTransaction(db, async (t) => {
                    const hRef = doc(db, "users", uid, "history", reffId);
                    t.set(hRef, {
                        trx_id: reffId, trx_code: Math.floor(Math.random()*900000).toString(),
                        title: "Manual Order " + code, amount: price, type: 'out',
                        date: new Date().toISOString(), status: 'Proses',
                        provider_code: prov, raw_code: code, dest_num: dest,
                        api_msg: "Sending...", balance_after: 0
                    });
                });

                // 2. Tembak API
                let res = {};
                if(prov.startsWith('ICS_')) {
                    const p = new URLSearchParams({ action: 'createTransaction', apikey: ICS_CONFIG.apiKey, kode_produk: code, nomor_tujuan: dest, refid: reffId });
                    const r = await fetch(`${ICS_CONFIG.baseUrl}?${p}`);
                    res = await r.json();
                } else {
                    // KHFY Dummy hit (Since CORS usually blocks direct hit from browser)
                    // Disini kita simpan history saja, asumsikan sukses manual atau via backend lain
                    res = { success: true, message: "Order KHFY via Tools (Check Panel)" };
                }

                // 3. Update Status
                const status = (res.success || res.status===true || res.data?.status==='Pending') ? 'Pending' : 'Gagal';
                await setDoc(doc(db, "users", uid, "history", reffId), {
                    status: status, api_msg: res.message || res.data?.message || "Processed",
                    raw_json: JSON.stringify(res)
                }, { merge: true });

                log("Selesai: " + status);
                alert("Status: " + status);

            } catch(e) {
                log("Error: " + e.message);
                alert("Error: " + e.message);
            } finally {
                document.getElementById('btnExec').disabled = false;
            }
        };

        window.log = (m) => { const l = document.getElementById('logs'); l.innerHTML+=`> ${m}<br>`; l.scrollTop=l.scrollHeight; };
        window.autoReffId = () => { document.getElementById('reffId').value = `TRX-${Date.now()}`; };
    </script>
</body>
</html>