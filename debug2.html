<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools Order V3.5 (Auto JSON Logs)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; }
        .input-box { width: 100%; background: #1e293b; border: 1px solid #334155; padding: 0.75rem; border-radius: 0.5rem; color: white; font-weight: bold; }
        .input-box:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Styling Log agar JSON rapi */
        #logs { font-family: 'Consolas', 'Monaco', monospace; font-size: 10px; white-space: pre-wrap; word-wrap: break-word; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #334155; padding-bottom: 4px; }
        .log-json { color: #4ade80; background: #022c22; padding: 5px; border-radius: 4px; margin-top: 2px; display: block; }
        .log-time { color: #94a3b8; font-size: 9px; }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto min-h-screen flex flex-col">

    <div class="mb-6 border-b border-gray-700 pb-4">
        <h1 class="text-xl font-black text-blue-500"><i class="fas fa-robot"></i> TOOLS AUTO CHECK V3.5</h1>
        <p class="text-xs text-gray-400">Full Raw JSON Logs & Auto Refresh (6s)</p>
    </div>

    <div id="loginPanel" class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl mb-6">
        <h3 class="font-bold mb-4">Login Admin</h3>
        <input type="email" id="email" placeholder="Email" class="input-box mb-3">
        <input type="password" id="pass" placeholder="Password" class="input-box mb-4">
        <button onclick="authLogin()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold">MASUK</button>
    </div>

    <div id="mainPanel" class="hidden space-y-4">
        <div class="flex justify-between items-center bg-green-900/20 p-2 rounded-lg border border-green-900/50">
            <span class="text-xs text-green-400 font-mono" id="userStatus">Connected</span>
            <button onclick="authLogout()" class="text-[10px] text-red-400 hover:underline">Logout</button>
        </div>

        <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg space-y-4">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2">
                    <label class="text-[10px] text-gray-400 font-bold">TARGET UID</label>
                    <input type="text" id="targetUid" class="input-box text-yellow-400 font-mono text-sm">
                </div>
                <div class="col-span-2 bg-blue-900/20 p-2 rounded border border-blue-800/30">
                    <label class="text-[10px] text-blue-400 font-bold">REFF ID (AUTO/MANUAL)</label>
                    <div class="flex gap-2">
                        <input type="text" id="reffId" class="input-box" placeholder="Ketik ReffID...">
                        <button onclick="autoReffId()" class="bg-gray-700 px-3 rounded text-xs font-bold hover:bg-gray-600"><i class="fas fa-random"></i></button>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-[10px] text-gray-400 font-bold">PILIH PROVIDER</label>
                <select id="providerSelect" class="input-box" onchange="loadProducts()">
                    <option value="" disabled selected>-- Pilih Provider --</option>
                    <optgroup label="Server ICS (Relay)">
                        <option value="ICS_XLA">XL Akrab (XLA)</option>
                        <option value="ICS_XDA">Akrab Fresh (XDA)</option>
                        <option value="ICS_CIRCLE">XL Circle</option>
                        <option value="ICS_FMX">FlexMax (FMX)</option>
                        <option value="ICS_BPA">Bagi Pulsa (BPA)</option>
                    </optgroup>
                    <optgroup label="Server KHFY (Panel)">
                        <option value="XLA">XL Akrab (XLA)</option>
                        <option value="XDA">Akrab Fresh (XDA)</option>
                        <option value="FMX">FlexMax (FMX)</option>
                        <option value="XLR">XL Reguler</option>
                        <option value="PLN">PLN Pascabayar</option>
                    </optgroup>
                </select>
            </div>

            <div>
                <label class="text-[10px] text-gray-400 font-bold">DAFTAR PRODUK (LIVE)</label>
                <select id="productSelect" class="input-box" disabled onchange="selectProduct()">
                    <option>Pilih Provider Dulu...</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] text-gray-400 font-bold">HARGA (RP)</label>
                    <input type="number" id="price" class="input-box text-green-400" value="0">
                    <p class="text-[9px] text-gray-500 mt-1">Ubah ke 0 untuk Gratis</p>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold">KODE (READONLY)</label>
                    <input type="text" id="prodCode" class="input-box bg-gray-700 text-gray-300" readonly>
                </div>
            </div>

            <div>
                <label class="text-[10px] text-gray-400 font-bold">NOMOR TUJUAN</label>
                <input type="tel" id="destNum" class="input-box text-lg" placeholder="08xxx">
            </div>

            <button onclick="executeMixedOrder()" id="btnExec" class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 rounded-xl font-black shadow-lg">
                <i class="fas fa-paper-plane"></i> KIRIM ORDER & AUTO MONITOR
            </button>
        </div>

        <div class="bg-black p-3 rounded-lg border border-gray-800 h-64 flex flex-col">
            <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                <span class="text-xs font-bold text-gray-400">SERVER LOGS</span>
                <button onclick="document.getElementById('logs').innerHTML=''" class="text-[9px] text-red-500 hover:text-red-400">Clear Logs</button>
            </div>
            <div id="logs" class="flex-1 overflow-y-auto custom-scroll text-green-500">
                > System Ready...
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, runTransaction, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
            authDomain: "ppob-3ea96.firebaseapp.com",
            projectId: "ppob-3ea96",
            storageBucket: "ppob-3ea96.firebasestorage.app",
            messagingSenderId: "181320175094",
            appId: "1:181320175094:web:306b79071018410b910bd7",
            measurementId: "G-0K2V796QDX"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONFIG API ---
        const ICS_CONFIG = { apiKey: "7274410f84b7e2810795810e879a4e0be8779c451d55e90e29d9bc174547ff77", baseUrl: "https://www.pandawa-digital.store/api/relay" };
        const KHFY_CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };
        
        const PROXY_LIST = [ { url: 'https://corsproxy.io/?' }, { url: 'https://api.codetabs.com/v1/proxy?quest=' }, { url: '' } ];
        let globalKHFYData = [];

        // --- AUTH ---
        window.authLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); } catch(e){ alert(e.message); } };
        window.authLogout = () => signOut(auth);
        onAuthStateChanged(auth, u => {
            if(u) { document.getElementById('loginPanel').classList.add('hidden'); document.getElementById('mainPanel').classList.remove('hidden'); document.getElementById('userStatus').innerText = u.email; if(!document.getElementById('targetUid').value) document.getElementById('targetUid').value = u.uid; }
            else { document.getElementById('loginPanel').classList.remove('hidden'); document.getElementById('mainPanel').classList.add('hidden'); }
        });

        // --- LOG FUNCTION (PRETTY JSON) ---
        window.log = (msg, jsonData = null) => { 
            const l = document.getElementById('logs'); 
            const time = new Date().toLocaleTimeString();
            let html = `<div class="log-entry"><span class="log-time">[${time}]</span> ${msg}`;
            
            if(jsonData) {
                // Pretty Print JSON
                const jsonStr = JSON.stringify(jsonData, null, 2);
                html += `<code class="log-json">${jsonStr}</code>`;
            }
            html += `</div>`;
            
            l.innerHTML += html; 
            l.scrollTop = l.scrollHeight; 
        };

        // --- FETCH PRODUCT LOGIC (SAME AS INDEX.HTML) ---
        window.loadProducts = async () => {
            const providerCode = document.getElementById('providerSelect').value;
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option>Memuat Data Server...</option>';
            select.disabled = true;
            log(`Fetching data produk: ${providerCode}...`);

            try {
                let products = [];
                // LOGIC 1: ICS
                if (providerCode.startsWith('ICS_')) {
                    let icsType = 'xla';
                    if(providerCode.includes('XDA')) icsType = 'xda';
                    if(providerCode.includes('CIRCLE')) icsType = 'circle';
                    if(providerCode.includes('FMX')) icsType = 'fmax';
                    if(providerCode.includes('BPA')) icsType = 'bpa';

                    const url = `${ICS_CONFIG.baseUrl}?action=listProducts&type=${icsType}&apikey=${ICS_CONFIG.apiKey}&_t=${Date.now()}`;
                    const res = await fetch(url);
                    const json = await res.json();

                    // Full Parsing Logic
                    let allProducts = [];
                    if (json) {
                        if (json.ready && Array.isArray(json.ready)) allProducts = json.ready;
                        else if (json.data && json.data.ready && Array.isArray(json.data.ready)) allProducts = json.data.ready;
                        else if (Array.isArray(json.data)) allProducts = json.data;
                        else if (Array.isArray(json)) allProducts = json;
                    }

                    // Strict Filter
                    if (providerCode === 'ICS_CIRCLE') allProducts = allProducts.filter(p => (p.type === 'circle' || (p.code || p.kode_produk || '').toUpperCase().startsWith('XCL')));
                    else if (providerCode === 'ICS_XDA') allProducts = allProducts.filter(p => (p.type === 'xda' || (p.code || p.kode_produk || '').toUpperCase().startsWith('XDA')));
                    else if (providerCode === 'ICS_XLA') allProducts = allProducts.filter(p => (p.type === 'xla' || ((p.code || p.kode_produk || '').toUpperCase().startsWith('XLA') && !(p.code || p.kode_produk || '').toUpperCase().startsWith('XDA'))));
                    else if (providerCode === 'ICS_FMX') allProducts = allProducts.filter(p => (p.type === 'fmax' || p.type === 'fmx' || (p.code || p.kode_produk || '').toUpperCase().startsWith('FMX') || (p.code || p.kode_produk || '').toUpperCase() === 'CFMX'));

                    products = allProducts.map(p => ({
                        name: p.nama_produk || p.name, code: p.kode_produk || p.code, price: parseInt(p.harga || p.price || 0), is_empty: (p.stok === 0 || p.status === 'empty')
                    }));
                } 
                // LOGIC 2: KHFY
                else {
                    if(globalKHFYData.length === 0) globalKHFYData = await fetchKHFY();
                    products = globalKHFYData.filter(p => {
                        const c = (p.buyer_sku_code || '').toUpperCase();
                        const b = (p.brand || p.operator || '').toUpperCase();
                        if(providerCode === 'XDA') return c.startsWith('XDA') || b.includes('AKRAB FRESH');
                        if(providerCode === 'XLA') return (c.startsWith('XLA') || c.startsWith('XLC')) && !c.startsWith('XDA');
                        if(providerCode === 'FMX') return (c.startsWith('FMX') || c === 'CFMX') || b === 'FMAX';
                        if(providerCode === 'XLR') return ['FMX50', 'FMX65', 'FMX80', 'FMX150'].includes(c);
                        if(providerCode === 'PLN') return b.includes('PLN');
                        return b.includes(providerCode);
                    }).map(p => ({
                        name: p.product_name, code: p.buyer_sku_code, price: p.buyer_price, is_empty: (p.buyer_product_status === false || p.stock === 0)
                    }));
                }
                renderSelect(products);
            } catch(e) { select.innerHTML = '<option>Error</option>'; log("Error Load: " + e.message); }
        };

        async function fetchKHFY() {
            const endpoint = `${KHFY_CONFIG.baseUrl}/list_product?api_key=${KHFY_CONFIG.apiKey}&_t=${Date.now()}`;
            for (const proxy of PROXY_LIST) {
                try {
                    const res = await fetch(proxy.url + encodeURIComponent(endpoint));
                    if(res.ok) { const txt = await res.text(); return JSON.parse(txt).data || []; }
                } catch(e) {}
            } return [];
        }

        function renderSelect(products) {
            const s = document.getElementById('productSelect'); s.innerHTML = '<option value="" disabled selected>-- Pilih Produk --</option>';
            if(products.length === 0) { s.innerHTML = '<option>Kosong</option>'; return; }
            products.sort((a,b)=>a.price-b.price).forEach(p => {
                const opt = document.createElement('option'); opt.value = p.code; opt.dataset.price = p.price; opt.text = `${p.name} - Rp ${p.price}`; if(p.is_empty) opt.disabled=true; s.appendChild(opt);
            }); s.disabled = false;
        }

        window.selectProduct = () => {
            const s = document.getElementById('productSelect'); const o = s.options[s.selectedIndex];
            if(o && o.value) { document.getElementById('prodCode').value = o.value; document.getElementById('price').value = o.dataset.price; }
        };

        // --- CORE ORDER LOGIC (AUTO REFRESH) ---
        window.executeMixedOrder = async () => {
            const uid = document.getElementById('targetUid').value;
            const reffId = document.getElementById('reffId').value;
            const prov = document.getElementById('providerSelect').value;
            const code = document.getElementById('prodCode').value;
            const price = parseInt(document.getElementById('price').value) || 0;
            const dest = document.getElementById('destNum').value;

            if(!uid || !reffId || !code) return alert("Data Kurang!");
            if(!confirm(`Kirim ke ${dest}?`)) return;

            log(`MENGIRIM ORDER: ${code} ke ${dest}...`);
            document.getElementById('btnExec').disabled = true;

            const isICS = prov.startsWith('ICS_');

            try {
                // 1. Catat History
                await runTransaction(db, async (t) => {
                    const hRef = doc(db, "users", uid, "history", reffId);
                    t.set(hRef, {
                        trx_id: reffId, trx_code: Math.floor(Math.random()*900000).toString(),
                        title: `Manual ${code}`, amount: price, type: 'out',
                        date: new Date().toISOString(), status: 'Proses',
                        provider_code: prov, raw_code: code, dest_num: dest,
                        api_msg: "Requesting...", balance_after: 0
                    });
                });

                // 2. Hit API
                let res = {};
                let fullResponse = null;

                if(isICS) {
                    const p = new URLSearchParams({ action: 'createTransaction', apikey: ICS_CONFIG.apiKey, kode_produk: code, nomor_tujuan: dest, refid: reffId });
                    const r = await fetch(`${ICS_CONFIG.baseUrl}?${p}`);
                    fullResponse = await r.json();
                } else {
                    // KHFY Dummy (karena CORS)
                    fullResponse = { success: true, message: "Order KHFY via Tools (Cek Panel)", data: { status: 'Pending', sn: 'Menunggu...' } };
                }

                // TAMPILKAN RAW JSON DI LOG!
                log("RESPON SERVER (AWAL):", fullResponse);

                // 3. Update Status
                const status = (fullResponse.success || fullResponse.status===true || fullResponse.data?.status==='Pending') ? 'Pending' : 'Gagal';
                
                await updateDoc(doc(db, "users", uid, "history", reffId), {
                    status: status,
                    api_msg: fullResponse.message || fullResponse.data?.message || "Processed",
                    raw_json: JSON.stringify(fullResponse)
                });

                // --- AUTO REFRESH LOGIC ---
                if(status === 'Pending') {
                    log(`âš ï¸ STATUS PENDING. Menunggu 6 detik untuk RE-CHECK JSON ASLI...`);
                    
                    setTimeout(() => {
                        autoCheckStatus(reffId, isICS, uid);
                    }, 6000); // 6 Detik
                } else {
                    log(`Selesai. Status Akhir: ${status}`);
                    alert(`Selesai: ${status}`);
                }

            } catch(e) {
                log("ERROR FATAL: " + e.message);
                alert("Error: " + e.message);
            } finally {
                document.getElementById('btnExec').disabled = false;
            }
        };

        // --- FUNGSI AUTO CHECK (6 DETIK) ---
        window.autoCheckStatus = async (reffId, isICS, uid) => {
            log(`ðŸ”„ MEMULAI AUTO REFRESH UNTUK ${reffId}...`);
            
            try {
                let checkRes = null;

                if (isICS) {
                    // ICS Check Transaction
                    const url = `${ICS_CONFIG.baseUrl}?action=checkTransaction&apikey=${ICS_CONFIG.apiKey}&refid=${reffId}&_t=${Date.now()}`;
                    const r = await fetch(url);
                    checkRes = await r.json();
                } else {
                    // KHFY History Check
                    const endpoint = `${KHFY_CONFIG.baseUrl}/history?api_key=${KHFY_CONFIG.apiKey}&reff_id=${reffId}&_t=${Date.now()}`;
                    // Gunakan proxy karena KHFY sering CORS
                    for (const proxy of PROXY_LIST) {
                         try {
                             const r = await fetch(proxy.url + encodeURIComponent(endpoint));
                             if(r.ok) {
                                 const txt = await r.text();
                                 checkRes = JSON.parse(txt);
                                 break;
                             }
                         } catch(e) {}
                    }
                }

                if (!checkRes) {
                    log("âŒ Gagal mengambil data terbaru dari server (Koneksi/Null).");
                    return;
                }

                // TAMPILKAN RAW JSON BARU
                log("âœ… RESPON SERVER TERBARU (6 Detik Kemudian):", checkRes);

                // Update DB dengan JSON Terbaru
                let newStatus = 'Pending';
                let newMsg = 'Menunggu...';
                
                // Analisa Status Baru
                if(isICS) {
                    const st = (checkRes.data?.status || checkRes.status || '').toLowerCase();
                    if(st === 'sukses' || st === 'success') newStatus = 'Sukses';
                    else if(st === 'gagal' || st === 'failed') newStatus = 'Gagal';
                    newMsg = checkRes.data?.message || checkRes.message || checkRes.data?.sn || '';
                } else {
                    const d = checkRes.data?.data?.[0] || checkRes.data;
                    if(d) {
                        const st = (d.status_text || '').toUpperCase();
                        if(st === 'SUKSES') newStatus = 'Sukses';
                        else if(st === 'GAGAL') newStatus = 'Gagal';
                        newMsg = d.sn || d.keterangan || '';
                    }
                }

                // Update Firestore
                await updateDoc(doc(db, "users", uid, "history", reffId), {
                    status: newStatus,
                    api_msg: newMsg,
                    raw_json: JSON.stringify(checkRes) // SIMPAN JSON MENTAH BARU
                });

                log(`ðŸ“Œ UPDATE DB SELESAI. Status Sekarang: ${newStatus}`);

                if(newStatus !== 'Pending') {
                    alert(`STATUS UPDATE: ${newStatus}\nSN: ${newMsg}`);
                } else {
                    log("â„¹ï¸ Masih Pending. Silakan cek manual nanti.");
                }

            } catch(e) {
                log("âŒ ERROR SAAT RE-CHECK: " + e.message);
            }
        };

        window.autoReffId = () => { document.getElementById('reffId').value = `TRX-${Date.now()}`; };
    </script>
</body>
</html>