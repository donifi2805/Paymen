<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaje Store - Official</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
        .app-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .header { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 25px 20px; border-radius: 0 0 25px 25px; }
        .saldo-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; padding: 15px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; }
        .menu-item { text-align: center; padding: 10px; border-radius: 12px; transition: 0.2s; cursor: pointer; border: 1px solid #f0f0f0; }
        .menu-item:hover, .menu-item.active { background: #eef2ff; border-color: #2a5298; color: #2a5298; }
        .product-list { padding: 0 20px 20px; }
        .product-card { border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; background: white; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: #2a5298; }
        .price { color: #2a5298; font-weight: 700; font-size: 1.1em; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold"><i class="fas fa-bolt me-2"></i>Kaje Store</h5>
            <button class="btn btn-sm btn-light rounded-circle text-primary" onclick="cekSaldo()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <div class="saldo-card">
            <div>
                <small class="text-white-50">Saldo Tersedia</small>
                <h3 class="mb-0 fw-bold" id="saldoText">Rp -</h3>
            </div>
            <i class="fas fa-wallet fa-2x text-white-50"></i>
        </div>
    </div>

    <div class="p-4 pb-0">
        <label class="fw-bold text-secondary small mb-2">NOMOR TUJUAN</label>
        <div class="input-group input-group-lg mb-3">
            <span class="input-group-text bg-white"><i class="fas fa-phone text-primary"></i></span>
            <input type="tel" id="nomorHP" class="form-control border-start-0 ps-0" placeholder="08xx xxxx xxxx">
        </div>
    </div>

    <div class="menu-grid">
        <div class="menu-item active" onclick="filterProduk('tsel')">
            <i class="fas fa-signal fa-lg mb-2 text-danger"></i><br><small>Tsel</small>
        </div>
        <div class="menu-item" onclick="filterProduk('isat')">
            <i class="fas fa-globe fa-lg mb-2 text-warning"></i><br><small>Isat</small>
        </div>
        <div class="menu-item" onclick="filterProduk('xl')">
            <i class="fas fa-bolt fa-lg mb-2 text-primary"></i><br><small>XL</small>
        </div>
        <div class="menu-item" onclick="filterProduk('tri')">
            <i class="fas fa-infinity fa-lg mb-2 text-dark"></i><br><small>Tri</small>
        </div>
    </div>

    <div class="product-list" id="productList">
        <div class="text-center text-muted mt-5">Silakan pilih kategori</div>
    </div>
</div>

<div class="loading-overlay" id="loading">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <span class="fw-bold text-secondary">Memproses...</span>
</div>

<div class="modal fade" id="modalConfirm" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Konfirmasi Beli</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="bg-light p-3 rounded mb-3">
                    <h6 class="text-muted mb-1" id="confirmName">Nama Produk</h6>
                    <h3 class="text-primary fw-bold" id="confirmPrice">Rp 0</h3>
                </div>
                <p class="mb-1">Nomor Tujuan:</p>
                <h5 class="fw-bold" id="confirmPhone">-</h5>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary w-100 rounded-pill py-2" onclick="prosesTransaksi()">
                    <i class="fas fa-check-circle me-2"></i>BAYAR SEKARANG
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // URL Backend Anda (Relay)
    // Jika dijalankan di localhost port 3000, gunakan http://localhost:3000/api/relaykaje
    // Jika file relay ada di folder yang sama di server statis, gunakan 'api/relaykaje.js' (Tapi js harus dijalankan node)
    
    // Asumsi: Anda menjalankan server backend di path relative /api/relaykaje
    const RELAY_URL = '/api/relaykaje'; 

    document.addEventListener('DOMContentLoaded', () => {
        cekSaldo();
        filterProduk('tsel'); // Default view
    });

    // 1. FUNGSI CEK SALDO (Via Relay)
    async function cekSaldo() {
        const display = document.getElementById('saldoText');
        display.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const res = await fetch(RELAY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'saldo' }) // Mengirim instruksi ke Relay
            });
            
            const result = await res.json();
            
            if (result.success && result.data) {
                display.innerText = result.data.formatted;
            } else {
                display.innerText = "Gagal";
                console.error(result);
            }
        } catch (e) {
            console.error(e);
            display.innerText = "Error";
        }
    }

    // 2. DATA DUMMY (Menunggu API Pricelist)
    const dbProduk = {
        tsel: [
            { code: 'S1', name: 'Telkomsel 1GB', price: 15000 },
            { code: 'S5', name: 'Telkomsel 5GB', price: 55000 }
        ],
        isat: [
            { code: 'I1', name: 'Indosat 1GB', price: 12000 }
        ],
        xl: [],
        tri: []
    };

    let selectedItem = null;

    // 3. Render Produk
    function filterProduk(kategori) {
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        const list = document.getElementById('productList');
        list.innerHTML = '';
        
        const items = dbProduk[kategori] || [];
        if(items.length === 0) {
            list.innerHTML = '<div class="text-center text-muted mt-4">Produk belum tersedia</div>';
            return;
        }

        items.forEach(item => {
            list.innerHTML += `
                <div class="product-card" onclick="bukaModal('${item.code}', '${item.name}', ${item.price})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold text-dark">${item.name}</div>
                            <small class="text-muted">Kode: ${item.code}</small>
                        </div>
                        <div class="price">Rp ${item.price.toLocaleString('id-ID')}</div>
                    </div>
                </div>
            `;
        });
    }

    function bukaModal(code, name, price) {
        const hp = document.getElementById('nomorHP').value;
        if(hp.length < 10) {
            Swal.fire('Eits!', 'Masukkan nomor HP yang benar dulu ya.', 'warning');
            return;
        }
        selectedItem = { code, name, price };
        document.getElementById('confirmName').innerText = name;
        document.getElementById('confirmPrice').innerText = 'Rp ' + price.toLocaleString('id-ID');
        document.getElementById('confirmPhone').innerText = hp;
        new bootstrap.Modal(document.getElementById('modalConfirm')).show();
    }

    // 4. TRANSAKSI (Logic siap konek ke Relay)
    async function prosesTransaksi() {
        bootstrap.Modal.getInstance(document.getElementById('modalConfirm')).hide();
        document.getElementById('loading').style.display = 'flex';

        // Disini nanti kita panggil Relay lagi dengan action: 'transaksi'
        // Saat ini hanya simulasi sukses
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            Swal.fire('Berhasil!', 'Permintaan sedang diproses.', 'success');
            cekSaldo(); // Refresh saldo
        }, 2000);
    }
</script>

</body>
</html>