<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandawa API Debugger Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Consolas', 'Monaco', monospace; background-color: #0f172a; color: #e2e8f0; }
        .json-key { color: #93c5fd; }
        .json-string { color: #86efac; }
        .json-number { color: #fca5a5; }
        .json-boolean { color: #f9a8d4; }
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto mb-8 flex justify-between items-center border-b border-gray-700 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-white"><i class="fas fa-bug text-red-500 mr-2"></i>Pandawa API Debugger</h1>
            <p class="text-xs text-gray-400 mt-1">Mengambil Data JSON Mentah (ICS & KHFY)</p>
        </div>
        <div class="text-right">
            <span class="px-3 py-1 bg-blue-900 text-blue-200 rounded text-xs font-bold" id="statusBadge">Siap</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
            <h2 class="font-bold text-lg mb-2 text-blue-400">1. Server ICS (Relay)</h2>
            <p class="text-[10px] text-gray-400 mb-3">Target: xla, xda, circle, fmax</p>
            <div class="flex gap-2">
                <button onclick="fetchICS()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold transition">
                    <i class="fas fa-download mr-1"></i> Ambil Data ICS
                </button>
                <button onclick="copyData('outputICS')" class="px-3 bg-gray-700 hover:bg-gray-600 rounded text-white" title="Copy JSON">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
            <h2 class="font-bold text-lg mb-2 text-purple-400">2. Server KHFY (Direct/Proxy)</h2>
            <p class="text-[10px] text-gray-400 mb-3">Target: /list_product</p>
            <div class="flex gap-2">
                <button onclick="fetchKHFY()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded font-bold transition">
                    <i class="fas fa-download mr-1"></i> Ambil Data KHFY
                </button>
                <button onclick="copyData('outputKHFY')" class="px-3 bg-gray-700 hover:bg-gray-600 rounded text-white" title="Copy JSON">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 h-[600px]">
        
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center mb-2 px-2">
                <span class="text-xs font-bold text-gray-400">Output ICS</span>
                <span class="text-[10px] text-gray-500" id="countICS">0 Items</span>
            </div>
            <textarea id="outputICS" class="w-full h-full bg-gray-900 text-xs p-4 rounded-xl border border-gray-700 font-mono custom-scroll focus:outline-none focus:border-blue-500 text-green-400" placeholder="Menunggu request..." readonly></textarea>
        </div>

        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center mb-2 px-2">
                <span class="text-xs font-bold text-gray-400">Output KHFY</span>
                <span class="text-[10px] text-gray-500" id="countKHFY">0 Items</span>
            </div>
            <textarea id="outputKHFY" class="w-full h-full bg-gray-900 text-xs p-4 rounded-xl border border-gray-700 font-mono custom-scroll focus:outline-none focus:border-purple-500 text-green-400" placeholder="Menunggu request..." readonly></textarea>
        </div>

    </div>

    <script>
        // --- KONFIGURASI DARI KODE SUMBER ---
        const ICS_CONFIG = { 
            apiKey: "7274410f84b7e2810795810e879a4e0be8779c451d55e90e29d9bc174547ff77", 
            baseUrl: "https://www.pandawa-digital.store/api/relay" 
        };

        const KHFY_CONFIG = { 
            apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", 
            baseUrl: "https://panel.khfy-store.com/api_v2" 
        };

        const PROXY_LIST = [
            { name: 'CorsProxyIO', url: 'https://corsproxy.io/?' },
            { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
            { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' },
            { name: 'AllOrigins', url: 'https://api.allorigins.win/raw?url=' }
        ];

        // --- FUNGSI BANTUAN ---
        function setStatus(msg, type = 'info') {
            const badge = document.getElementById('statusBadge');
            badge.innerText = msg;
            if(type === 'loading') badge.className = "px-3 py-1 bg-yellow-600 text-white rounded text-xs font-bold animate-pulse";
            else if(type === 'success') badge.className = "px-3 py-1 bg-green-600 text-white rounded text-xs font-bold";
            else if(type === 'error') badge.className = "px-3 py-1 bg-red-600 text-white rounded text-xs font-bold";
            else badge.className = "px-3 py-1 bg-blue-900 text-blue-200 rounded text-xs font-bold";
        }

        async function fetchWithProxy(targetUrl) {
            let lastError = null;
            for (const proxy of PROXY_LIST) {
                try {
                    const fullUrl = proxy.url + encodeURIComponent(targetUrl);
                    console.log(`Trying proxy: ${proxy.name}`);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

                    const res = await fetch(fullUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (res.ok) {
                        const text = await res.text();
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            // Kadang proxy mengembalikan JSON dalam string
                            if(typeof text === 'string' && text.startsWith('{')) return JSON.parse(text);
                            continue;
                        }
                    }
                } catch (e) {
                    lastError = e;
                    console.warn(`Proxy ${proxy.name} failed`, e);
                }
            }
            throw new Error("Semua Proxy Gagal. Cek Koneksi.");
        }

        function displayResult(elementId, data, countId) {
            const el = document.getElementById(elementId);
            el.value = JSON.stringify(data, null, 2);
            
            // Hitung item
            let count = 0;
            if (Array.isArray(data)) count = data.length;
            else if (data.data && Array.isArray(data.data)) count = data.data.length;
            else if (data.ready && Array.isArray(data.ready)) count = data.ready.length;
            else if (typeof data === 'object') count = Object.keys(data).length;

            document.getElementById(countId).innerText = count + " Items / Keys";
        }

        function copyData(elementId) {
            const el = document.getElementById(elementId);
            el.select();
            document.execCommand('copy');
            alert('JSON berhasil disalin ke clipboard!');
        }

        // --- FUNGSI UTAMA ICS ---
        async function fetchICS() {
            setStatus('Mengambil Data ICS...', 'loading');
            const types = ['xla', 'xda', 'circle', 'fmax'];
            const results = {};

            try {
                // Fetch paralel semua tipe
                const promises = types.map(async (type) => {
                    const url = `${ICS_CONFIG.baseUrl}?action=listProducts&apikey=${ICS_CONFIG.apiKey}&type=${type}&_t=${Date.now()}`;
                    try {
                        const res = await fetch(url);
                        const json = await res.json();
                        return { type, data: json };
                    } catch (e) {
                        return { type, error: e.message };
                    }
                });

                const responses = await Promise.all(promises);
                
                responses.forEach(r => {
                    results[r.type] = r.data || r.error;
                });

                displayResult('outputICS', results, 'countICS');
                setStatus('ICS Berhasil', 'success');

            } catch (e) {
                console.error(e);
                document.getElementById('outputICS').value = "Error: " + e.message;
                setStatus('Gagal Fetch ICS', 'error');
            }
        }

        // --- FUNGSI UTAMA KHFY ---
        async function fetchKHFY() {
            setStatus('Mengambil Data KHFY (via Proxy)...', 'loading');
            
            // Endpoint list_product
            const targetUrl = `${KHFY_CONFIG.baseUrl}/list_product?api_key=${KHFY_CONFIG.apiKey}`;

            try {
                // KHFY butuh proxy karena CORS
                const data = await fetchWithProxy(targetUrl);
                
                // Normalisasi Data (Kadang dibungkus dalam 'contents' oleh proxy tertentu)
                let cleanData = data;
                if(data.contents) {
                    try { cleanData = JSON.parse(data.contents); } catch(e){}
                }

                displayResult('outputKHFY', cleanData, 'countKHFY');
                setStatus('KHFY Berhasil', 'success');
            } catch (e) {
                console.error(e);
                document.getElementById('outputKHFY').value = "Gagal mengambil data KHFY.\nError: " + e.message + "\n\nTips: Coba gunakan ekstensi browser 'Allow CORS' jika proxy bawaan gagal.";
                setStatus('Gagal Fetch KHFY', 'error');
            }
        }

    </script>
</body>
</html>