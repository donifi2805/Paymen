<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DompetKu - Khfy API Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* --- Base Styles --- */
        body { font-family: 'Inter', 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-container {
            max-width: 480px; margin: 0 auto; min-height: 100vh;
            position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); overflow-x: hidden; padding-bottom: 90px;
        }
        
        /* Theme Colors */
        body { background-color: #f8fafc; }
        .app-container { background-color: #ffffff; }
        html.dark body { background-color: #111827; } 
        html.dark .app-container { background-color: #030712; box-shadow: 0 0 25px rgba(0,0,0,0.5); } 
        
        /* Utilities */
        .hide { display: none !important; }
        .page { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bg-gradient-brand { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        html.dark .bg-gradient-brand { background: linear-gradient(135deg, #1d4ed8 0%, #172554 100%); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .input-group { position: relative; }
        .input-group i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; z-index: 10;}
        .input-group input:focus + i { color: #2563eb; }
        .input-group input { padding-left: 44px; transition: all 0.3s; }
        html.dark .input-group i { color: #6b7280; }
        html.dark .input-group input:focus + i { color: #60a5fa; }

        /* ATM Card */
        .atm-card {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            border-radius: 20px; color: white; position: relative; overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        /* QRIS Button */
        .qris-btn-container { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .qris-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3);
            border: 2px solid white;
        }
        html.dark .qris-btn { border-color: #1f2937; }

        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Action Buttons */
        .action-btn { width: 48px; height: 48px; margin: 0 auto 8px; background-color: #eff6ff; color: #2563eb; border-radius: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        html.dark .action-btn { background-color: rgba(30, 58, 138, 0.2); color: #60a5fa; }
        .group:hover .action-btn { background-color: #2563eb; color: white; }
        html.dark .group:hover .action-btn { background-color: #3b82f6; color: white; }
        .action-text { font-size: 11px; font-weight: 600; color: #4b5563; }
        html.dark .action-text { color: #9ca3af; }
    </style>
</head>
<body>

<div class="app-container transition-colors duration-300">

    <div id="globalLoader" class="hide fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 p-5 rounded-2xl flex flex-col items-center shadow-2xl">
            <div class="loader mb-3"></div>
            <p class="text-xs font-bold text-gray-600 dark:text-gray-300">Menghubungkan API...</p>
        </div>
    </div>

    <div id="customConfirmModal" class="hide fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-question text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1" id="confirmTitle">Konfirmasi</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400" id="confirmMessage">Apakah anda yakin?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 font-semibold text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition">Batal</button>
                <button id="confirmYesBtn" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-semibold text-sm shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <div id="topUpSheet" class="hide fixed inset-0 z-50 flex flex-col justify-end bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-full rounded-t-[30px] p-6 modal-enter max-w-[480px] mx-auto">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Pilih Metode Top Up</h3>
            <div class="space-y-3">
                <div onclick="processTopUp('manual')" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition">
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="flex-1"><h4 class="font-bold text-gray-800 dark:text-white text-sm">Manual (Simulasi)</h4><p class="text-xs text-gray-500">Isi saldo instan untuk testing</p></div><i class="fas fa-chevron-right text-gray-300"></i>
                </div>
                <div onclick="processTopUp('qris')" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition">
                    <div class="w-10 h-10 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><i class="fas fa-qrcode"></i></div>
                    <div class="flex-1"><h4 class="font-bold text-gray-800 dark:text-white text-sm">QRIS Otomatis</h4><p class="text-xs text-gray-500">Scan QRIS dari merchant lain</p></div><i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            </div>
            <button onclick="closeTopUp()" class="mt-6 w-full py-3 text-gray-500 dark:text-gray-400 font-semibold text-sm">Tutup</button>
        </div>
    </div>

    <section id="loginPage" class="page flex flex-col justify-between min-h-screen bg-white dark:bg-gray-950 relative z-50">
        <div class="absolute top-0 left-0 w-full h-[45vh] bg-gradient-brand rounded-b-[50px] z-0"></div>
        <div class="relative z-10 px-8 pt-20 w-full">
            <div class="text-center mb-8 text-white">
                <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg border border-white/30">
                    <i class="fas fa-wallet text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold tracking-tight">DompetKu</h1>
                <p class="text-blue-100 text-sm mt-1">Super Payment App</p>
            </div>
            <div class="bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-xl shadow-blue-900/10 dark:shadow-black/30">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6 text-center">Masuk Akun</h2>
                <div class="space-y-4">
                    <div class="input-group">
                        <input type="text" id="usernameInput" value="Dev User" placeholder="Username" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="input-group">
                        <input type="password" id="passwordInput" value="password" placeholder="Kata Sandi" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium">
                        <i class="fas fa-lock"></i>
                    </div>
                    <button onclick="handleLogin()" class="w-full bg-blue-600 dark:bg-blue-500 text-white h-12 rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-transform hover:bg-blue-700 mt-2">MASUK</button>
                </div>
            </div>
        </div>
    </section>

    <section id="homePage" class="page hide bg-gray-50/50 dark:bg-gray-950">
        <div class="bg-gradient-brand text-white pt-8 pb-24 px-6 rounded-b-[40px] shadow-lg relative overflow-hidden">
            <div class="flex justify-between items-center mb-6 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border-2 border-white/30 p-0.5"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full rounded-full bg-white dark:bg-gray-800"></div>
                    <div><p class="text-xs text-blue-100">Selamat Pagi,</p><p class="font-bold text-lg leading-tight" id="headerUsername">Dev User</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur flex items-center justify-center hover:bg-white/30 transition active:scale-95"><i id="themeIcon" class="fas fa-moon text-white"></i></button>
                    <div class="relative"><i class="fas fa-bell text-xl"></i><span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-blue-600 dark:border-blue-800"></span></div>
                </div>
            </div>
        </div>

        <div class="mx-6 -mt-20 relative z-20">
            <div class="bg-white dark:bg-gray-900 rounded-3xl p-5 shadow-xl shadow-blue-900/5 dark:shadow-black/20">
                <div class="flex justify-between items-start mb-2">
                    <div><p class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Total Saldo</p><h2 class="text-3xl font-extrabold text-gray-800 dark:text-white mt-1" id="displayBalance">Rp 0</h2></div>
                    <div class="w-8 h-8 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg flex items-center justify-center"><i class="fas fa-wallet text-sm"></i></div>
                </div>
                <div class="flex justify-between mt-6 border-t border-gray-100 dark:border-gray-800 pt-5">
                    <div class="text-center group cursor-pointer" onclick="openTopUpSheet()"><div class="action-btn"><i class="fas fa-plus"></i></div><span class="action-text">Top Up</span></div>
                    <div class="text-center group cursor-pointer" onclick="alert('Fitur Kirim (P2P) belum terhubung API')"><div class="action-btn"><i class="fas fa-paper-plane"></i></div><span class="action-text">Kirim</span></div>
                    <div class="text-center group cursor-pointer" onclick="alert('Fitur Minta belum terhubung API')"><div class="action-btn"><i class="fas fa-arrow-down"></i></div><span class="action-text">Minta</span></div>
                    <div class="text-center group cursor-pointer" onclick="alert('Lainnya...')"><div class="action-btn"><i class="fas fa-grid-2"></i></div><span class="action-text">Lainnya</span></div>
                </div>
            </div>
        </div>

        <div class="mt-6 px-6">
            <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm">Layanan API (Khfy Store)</h3>
            <div class="grid grid-cols-4 gap-4">
                
                <div class="text-center group cursor-pointer" onclick="openPPOB('pulsa')">
                    <div class="bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-800 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center shadow-sm dark:shadow-gray-800 mb-2 group-hover:border-orange-200 transition-all"><i class="fas fa-mobile-alt text-orange-500 text-xl"></i></div><span class="text-[10px] font-medium text-gray-600 dark:text-gray-400">Pulsa</span>
                </div>
                
                <div class="text-center group cursor-pointer" onclick="openPPOB('akrab')">
                    <div class="bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-800 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center shadow-sm dark:shadow-gray-800 mb-2 group-hover:border-blue-200 transition-all"><i class="fas fa-users text-blue-600 text-xl"></i></div><span class="text-[10px] font-medium text-gray-600 dark:text-gray-400">XL Akrab</span>
                </div>

                <div class="text-center group cursor-pointer" onclick="alert('Segera Hadir')">
                    <div class="bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-800 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center shadow-sm dark:shadow-gray-800 mb-2 group-hover:border-emerald-200"><i class="fas fa-comment-dots text-emerald-500 text-xl"></i></div><span class="text-[10px] font-medium text-gray-600 dark:text-gray-400">Paket Data</span>
                </div>

                <div class="text-center group cursor-pointer" onclick="nav('historyPage')">
                    <div class="bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-800 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center shadow-sm dark:shadow-gray-800 mb-2 group-hover:border-indigo-200"><i class="fas fa-file-invoice-dollar text-indigo-500 text-xl"></i></div><span class="text-[10px] font-medium text-gray-600 dark:text-gray-400">Mutasi</span>
                </div>
            </div>
        </div>
        
        <div class="mt-8 bg-white dark:bg-gray-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)] dark:shadow-[0_-5px_20px_rgba(0,0,0,0.2)] p-6 min-h-[300px]">
            <div class="flex justify-between items-end mb-4">
                <h3 class="font-bold text-gray-800 dark:text-white">Transaksi Terakhir</h3>
                <span class="text-xs text-blue-600 dark:text-blue-400 font-semibold cursor-pointer" onclick="nav('historyPage')">Lihat Semua</span>
            </div>
            <div id="miniHistory" class="space-y-4"></div>
        </div>
    </section>

    <section id="ppobPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="closePPOB()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white" id="ppobTitle">Isi Pulsa (Live API)</h2>
        </div>
                <div class="p-4 pb-24">
            <div id="inputSection" class="transition-all duration-300">
                <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                    
                    
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Provider</label>
                        <div class="relative">
                            <select id="formProvider" onchange="updateProductDropdown()" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none font-bold">
                                <option value="" disabled selected>-- Pilih Provider --</option>
                                <optgroup label="Khfy Produk">
                                    <option value="XDA">Akrab Fresh (XDA)</option>
                                    <option value="XLA">Akrab Fresh (XLA)</option>
                                    <option value="FMX">FlexMax (FMX)</option>
                                    <option value="PLN">PLN Pascabayar</option>
                                </optgroup>
                                <optgroup label="Operator Reguler">
                                    <option value="TELKOMSEL">Telkomsel</option>
                                    <option value="INDOSAT">Indosat</option>
                                    <option value="XL">XL Axiata</option>
                                    <option value="AXIS">Axis</option>
                                    <option value="TRI">Three (3)</option>
                                    <option value="SMARTFREN">Smartfren</option>
                                </optgroup>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>

                    
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Produk</label>
                        <div class="relative">
                            <select id="formProduct" disabled class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 text-sm rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none font-medium transition-colors">
                                <option value="">Menunggu Provider...</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="priceDisplay"></p>
                    </div>

                    
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
                        <div class="input-group">
                            <input type="tel" id="ppobNumber" placeholder="Nomor HP / ID Pelanggan" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold">
                            <i class="fas fa-address-book text-gray-400"></i>
                        </div>
                    </div>

                    
                    <button onclick="processFormTransaction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2">
                        <span>Beli Paket</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>

                    
                    <div class="flex items-center gap-2 mt-4">
                        <div class="w-4 h-4 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800"></div>
                        <span class="text-xs text-gray-500">Aktifkan Multi Transaksi</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>

    <section id="historyPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-10 shadow-sm dark:shadow-gray-800 flex justify-between items-center">
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">Riwayat</h2>
            <button onclick="clearHistory()" class="text-xs text-red-500 font-bold"><i class="fas fa-trash mr-1"></i> Reset</button>
        </div>
        <div id="fullHistory" class="p-4 space-y-3 pb-24"></div>
    </section>

    <section id="walletPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-10 shadow-sm dark:shadow-gray-800 transition-colors">
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">Dompet Saya</h2>
        </div>
        <div class="p-6 pb-24">
            <div class="atm-card p-6 mb-8 transform transition hover:scale-[1.02] duration-300">
                <div class="flex justify-between items-start mb-8"><i class="fas fa-sim-card text-3xl opacity-80"></i><i class="fas fa-wifi text-2xl opacity-50 rotate-90"></i></div>
                <p class="text-xl tracking-widest font-mono mb-4 font-bold drop-shadow-md">4200 1234 5678 9010</p>
                <div class="flex justify-between items-end"><div><p class="text-[9px] opacity-70 uppercase tracking-wider mb-1">Card Holder</p><p class="text-sm font-bold uppercase" id="cardHolder">DEV USER</p></div><div><p class="text-[9px] opacity-70 uppercase tracking-wider mb-1">Expires</p><p class="text-sm font-bold">12/28</p></div></div>
            </div>
        </div>
    </section>

    <section id="profilePage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="bg-gradient-brand text-white p-6 pb-12 rounded-b-[40px] text-center shadow-lg relative transition-colors">
            <div class="w-24 h-24 bg-white dark:bg-gray-900 p-1 rounded-full mx-auto mb-4 shadow-xl transition-colors"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full rounded-full bg-gray-100 dark:bg-gray-800"></div>
            <h2 class="text-xl font-bold" id="profileName">Dev User</h2><p class="text-blue-200 text-sm" id="profilePhone">0812-3456-7890</p>
            <div class="mt-4 inline-flex items-center bg-blue-800/50 dark:bg-blue-900/50 backdrop-blur px-4 py-1.5 rounded-full text-xs font-semibold border border-blue-400/30"><i class="fas fa-crown text-yellow-400 mr-2"></i> API Connected</div>
        </div>
        <div class="px-6 -mt-6 pb-24 relative z-10">
            <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-black/30 overflow-hidden transition-colors">
                 <div onclick="handleLogout()" class="p-4 flex items-center gap-4 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer transition-colors group"><div class="w-9 h-9 rounded-full bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400 group-hover:bg-red-100 dark:group-hover:bg-red-900/50 flex items-center justify-center transition-colors"><i class="fas fa-sign-out-alt text-sm"></i></div><div class="flex-1 text-sm font-bold text-red-500 dark:text-red-400">Keluar</div></div>
            </div>
        </div>
    </section>

    <section id="scanPage" class="page hide bg-black min-h-screen text-white flex flex-col fixed top-0 w-full max-w-[480px] z-50">
        <div class="flex justify-between items-center p-4 absolute top-0 w-full z-10">
            <button onclick="stopScan()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-times"></i></button>
            <h2 class="font-bold">Scan QRIS</h2>
            <button class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-bolt"></i></button>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div id="reader" class="rounded-3xl overflow-hidden border-2 border-white/50 shadow-2xl"></div>
            <div class="absolute bottom-32 text-center pointer-events-none"><p class="text-sm font-medium bg-black/40 px-4 py-1 rounded-full">Arahkan kamera ke kode QRIS</p></div>
        </div>
    </section>

    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 flex justify-around items-end pb-4 pt-3 text-[10px] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-40 hide rounded-t-3xl">
        <div class="text-center cursor-pointer w-1/5 nav-item text-blue-600 dark:text-blue-400 group" id="nav-home" onclick="nav('homePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-home text-xl"></i></div><p class="font-medium">Beranda</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-history" onclick="nav('historyPage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-history text-xl"></i></div><p class="font-medium">Riwayat</p></div>
        <div class="text-center w-1/5 qris-btn-container cursor-pointer" onclick="startScan()"><div class="qris-btn w-11 h-11 rounded-full flex items-center justify-center mx-auto text-white transform transition hover:scale-105 hover:rotate-90 active:scale-95 mb-1"><i class="fas fa-qrcode text-lg"></i></div><p class="font-bold text-gray-700 dark:text-gray-400">Scan</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-wallet" onclick="nav('walletPage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-wallet text-xl"></i></div><p class="font-medium">Dompet</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-profile" onclick="nav('profilePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-user text-xl"></i></div><p class="font-medium">Saya</p></div>
    </nav>
</div>

<script>
    // --- KONFIGURASI API ---
    const CONFIG = {
        apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", 
        baseUrl: "https://panel.khfy-store.com/api_v2",
        useCorsProxy: true, 
        corsProxyUrl: "https://api.allorigins.win/raw?url=" // Menggunakan AllOrigins yang lebih stabil
    };

    // --- STATE ---
    let balance = 500000; 
    let transactions = JSON.parse(localStorage.getItem('trx_history_api')) || [];
    let activeCategory = 'pulsa'; 

    // --- API HANDLER (Improved) ---
    async function callApi(endpoint, params = {}) {
        params['api_key'] = CONFIG.apiKey;
        const queryParams = new URLSearchParams(params).toString();
        let targetUrl = `${CONFIG.baseUrl}${endpoint}?${queryParams}`;

        if (CONFIG.useCorsProxy) {
            targetUrl = CONFIG.corsProxyUrl + encodeURIComponent(targetUrl);
        }

        console.log(`[API CALL] Requesting ->`, targetUrl);
        
        try {
            const response = await fetch(targetUrl);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            
            const data = await response.json();
            return { ok: true, data: data };
        } catch (error) {
            console.error("API Error:", error);
            return { ok: false, error: error.message }; 
        }
    }

        // --- LOGIKA UTAMA (FORMULIR BARU) ---
    let globalProducts = []; // Simpan data produk disini

    // 1. Init Data (Dipanggil saat buka menu)
    async function initProductData() {
        const pSelect = document.getElementById('formProduct');
        pSelect.innerHTML = '<option>Sedang memuat data...</option>';
        
        const result = await callApi('/list_product');
        if (result.ok && result.data) {
            // Normalisasi Data
            if (result.data.data && Array.isArray(result.data.data)) globalProducts = result.data.data;
            else if (Array.isArray(result.data)) globalProducts = result.data;
            else if (result.data.products) globalProducts = result.data.products;
            
            pSelect.innerHTML = '<option value="">-- Pilih Provider Dahulu --</option>';
        } else {
            pSelect.innerHTML = '<option>Gagal Load Data</option>';
            alert('Gagal mengambil data produk: ' + result.error);
        }
    }

    // 2. Filter Produk berdasarkan Provider
    function updateProductDropdown() {
        const providerCode = document.getElementById('formProvider').value;
        const productSelect = document.getElementById('formProduct');
        const priceDisplay = document.getElementById('priceDisplay');
        
        // Reset UI Dropdown
        productSelect.innerHTML = '';
        productSelect.disabled = false;
        productSelect.className = 'w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none font-medium transition-colors';
        priceDisplay.innerText = '';

        // Logika Filter
        const filtered = globalProducts.filter(p => {
            const code = (p.code || p.buyer_sku_code || '').toUpperCase();
            const name = (p.name || p.product_name || '').toUpperCase();
            const brand = (p.brand || p.operator || '').toUpperCase();
            
            // Kategori Khusus (XDA/XLA/FMX/PLN)
            if(['XDA', 'XLA', 'FMX', 'PLN'].includes(providerCode)) {
                return code.startsWith(providerCode) || name.includes(providerCode);
            }
            // Operator Biasa (TELKOMSEL, dll)
            return brand.includes(providerCode) || name.includes(providerCode);
        });

        if(filtered.length === 0) {
            productSelect.innerHTML = `<option>Produk Kosong / Tidak Ditemukan</option>`;
            productSelect.disabled = true;
            return;
        }

        // Urutkan Harga
        filtered.sort((a, b) => (a.price || a.buyer_price) - (b.price || b.buyer_price));

        // Render Option
        productSelect.innerHTML = '<option value="" selected disabled>-- Pilih Produk --</option>';
        filtered.forEach(p => {
            const price = p.price || p.harga || p.buyer_price || 0;
            const code = p.code || p.buyer_sku_code;
            const name = p.name || p.product_name;
            const status = p.status || p.buyer_product_status || true;
            const isGangguan = (status.toString() === '0' || status === false || status === 'gangguan');
            
            const opt = document.createElement('option');
            opt.value = code;
            opt.text = name + (isGangguan ? ' (GANGGUAN)' : '');
            opt.dataset.price = price;
            opt.dataset.name = name;
            if(isGangguan) opt.disabled = true;
            productSelect.appendChild(opt);
        });

        // Event Ganti Produk
        productSelect.onchange = function() {
             const selectedOpt = this.options[this.selectedIndex];
             priceDisplay.innerText = `Harga: Rp ${formatRp(selectedOpt.dataset.price)}`;
        };
    }

    // 3. Proses Transaksi
    function processFormTransaction() {
        const productSelect = document.getElementById('formProduct');
        const destNum = document.getElementById('ppobNumber').value;

        if(!productSelect.value) return alert('Silakan pilih Produk!');
        if(destNum.length < 5) return alert('Masukkan Nomor Tujuan yang valid!');

        const selectedOpt = productSelect.options[productSelect.selectedIndex];
        confirmTransaction(productSelect.value, selectedOpt.dataset.name, parseInt(selectedOpt.dataset.price));
    }

    // --- TRANSAKSI ---
    function confirmTransaction(code, name, price) {
        const num = document.getElementById('ppobNumber').value;
        if(balance < price) return alert('Saldo Aplikasi Kurang! (Top Up Manual dulu)'); 

        customConfirm('Beli Produk?', `${name}\nNo: ${num}\nHarga: Rp ${formatRp(price)}`, () => {
            executeApiTransaction(code, num, price, name);
        });
    }

    async function executeApiTransaction(code, dest, price, name) {
        showLoader(true);
        const reffId = crypto.randomUUID();

        // HIT API TRX
        const result = await callApi('/trx', {
            produk: code,
            tujuan: dest,
            reff_id: reffId
        });

        showLoader(false);

        if(result.ok && result.data) {
            const msg = result.data.message || (result.data.data ? result.data.data.message : 'Diproses');
            const isSuccess = result.data.status === true || result.data.success === true || (result.data.data && result.data.data.status === 'Pending');

            if(isSuccess || msg) { 
                balance -= price;
                const newTrx = {
                    title: name,
                    dest: dest,
                    amount: price,
                    date: new Date().toLocaleString(),
                    type: 'out',
                    status: 'Pending',
                    reff_id: reffId,
                    api_msg: msg
                };
                transactions.unshift(newTrx);
                saveHistory();
                updateUI();
                closePPOB();
                alert(`Sukses!\nID: ${reffId}\nInfo: ${msg}`);
            } else {
                alert(`Gagal: ${msg}`);
            }
        } else {
            alert(`Gagal Koneksi: ${result.error}`);
        }
    }

    // --- NAVIGATION & UI ---
        function openPPOB(category) { 
        activeCategory = category;
        document.getElementById('homePage').classList.add('hide'); 
        document.getElementById('ppobPage').classList.remove('hide'); 
        document.getElementById('bottomNav').classList.add('hide'); 
        
        // Reset Form UI
        document.getElementById('ppobNumber').value = ''; 
        if(document.getElementById('priceDisplay')) document.getElementById('priceDisplay').innerText = '';
        document.getElementById('formProvider').selectedIndex = 0;
        document.getElementById('formProduct').innerHTML = '<option value="">Menunggu Provider...</option>';
        document.getElementById('formProduct').disabled = true;
        document.getElementById('formProduct').className = 'w-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 text-sm rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none font-medium transition-colors';
        
        document.getElementById('ppobTitle').innerText = category === 'akrab' ? 'XL Akrab & Paket' : 'Isi Pulsa / Data';
        
        // Load Data API
        initProductData();
    }
    
    function closePPOB() { document.getElementById('ppobPage').classList.add('hide'); nav('homePage'); }

    // --- HELPER STANDARD ---
    function formatRp(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }
    function showLoader(show) { document.getElementById('globalLoader').classList.toggle('hide', !show); }
    function toggleDarkMode() { document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); document.getElementById('themeIcon').className = isDark ? 'fas fa-sun text-white' : 'fas fa-moon text-white'; localStorage.setItem('theme', isDark ? 'dark' : 'light'); }
    if(localStorage.getItem('theme') === 'dark') toggleDarkMode();

    let confirmCallback = null;
    function customConfirm(title, message, callback) { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMessage').innerText = message; document.getElementById('customConfirmModal').classList.remove('hide'); confirmCallback = callback; }
    function closeConfirm(result) { document.getElementById('customConfirmModal').classList.add('hide'); if (result && confirmCallback) confirmCallback(); confirmCallback = null; }
    document.getElementById('confirmYesBtn').onclick = () => closeConfirm(true);

    function nav(pageId) {
        document.querySelectorAll('.page').forEach(el => { el.classList.add('hide'); });
        document.getElementById(pageId).classList.remove('hide');
        document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-blue-600', 'dark:text-blue-400'); el.classList.add('text-gray-400', 'dark:text-gray-500'); });
        const navId = 'nav-' + pageId.replace('Page','');
        if(document.getElementById(navId)) { document.getElementById(navId).classList.remove('text-gray-400', 'dark:text-gray-500'); document.getElementById(navId).classList.add('text-blue-600', 'dark:text-blue-400'); }
        if(pageId === 'loginPage') document.getElementById('bottomNav').classList.add('hide'); else document.getElementById('bottomNav').classList.remove('hide');
        updateUI();
    }

    function openTopUpSheet() { document.getElementById('topUpSheet').classList.remove('hide'); }
    function closeTopUp() { document.getElementById('topUpSheet').classList.add('hide'); }
    function processTopUp(m) { closeTopUp(); if(m==='manual'){ balance+=50000; alert('Saldo Dummy +50rb'); updateUI(); } else if(m==='qris'){ startScan(); } }

    function saveHistory() { localStorage.setItem('trx_history_api', JSON.stringify(transactions)); }
    function clearHistory() { if(confirm('Hapus Data Lokal?')) { transactions = []; saveHistory(); updateUI(); } }

    function updateUI() {
        document.getElementById('displayBalance').innerText = formatRp(balance);
        let html = '';
        if(transactions.length === 0) html = '<div class="text-center text-gray-400 text-xs py-4">Belum ada transaksi</div>';
        else {
            transactions.forEach(t => {
                html += `
                <div class="flex justify-between items-center bg-white dark:bg-gray-900 p-3 rounded-2xl border border-gray-50 dark:border-gray-800 shadow-sm mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-100 text-blue-600"><i class="fas fa-receipt"></i></div>
                        <div><p class="font-bold text-sm text-gray-800 dark:text-white">${t.title}</p><p class="text-[10px] text-gray-400">${t.date}</p></div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-gray-800 dark:text-white">- ${formatRp(t.amount)}</p>
                        <p class="text-[10px] ${String(t.api_msg).includes('Sukses')?'text-green-500':'text-orange-500'}">${t.api_msg}</p>
                    </div>
                </div>`;
            });
        }
        document.getElementById('miniHistory').innerHTML = html;
        document.getElementById('fullHistory').innerHTML = html;
    }

    let scanner = null;
    function startScan() { nav('scanPage'); scanner = new Html5QrcodeScanner("reader", {fps:10, qrbox:250}, false); scanner.render((t)=>{ alert('QR Code: '+t); stopScan(); }, ()=>{}); document.getElementById('bottomNav').classList.add('hide');}
    function stopScan() { if(scanner) scanner.clear(); nav('homePage'); }
    function handleLogin() { nav('homePage'); }
    function handleLogout() { nav('loginPage'); }

    updateUI();
</script>
</body>
</html>