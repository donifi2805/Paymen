[
  {
    "snippet": "window.loginWithGoogle = async () => {\n    window.showLoader(true);\n    const provider = new GoogleAuthProvider();\n    provider.addScope('profile');\n    provider.addScope('email');\n    // FIX: Paksa select_account untuk merefresh sesi dan menghindari error 'missing initial state' di WebView\n    provider.setCustomParameters({ prompt: 'select_account' });\n\n    try {\n        // Menggunakan signInWithPopup (Modal Mengambang) agar tidak terjadi redirect halaman\n        const result = await signInWithPopup(auth, provider);\n        const user = result.user;\n        \n        const userDocRef = doc(db, \"users\", user.uid);\n        const userDoc = await getDoc(userDocRef);\n\n        if (userDoc.exists()) {\n            console.log(\"User lama login via Google\");\n            // Tidak perlu aksi, onAuthStateChanged akan menangani navigasi\n        } else {\n            await setDoc(userDocRef, {\n                email: user.email,\n                balance: 0,\n                profile_pic: user.photoURL, \n                createdAt: new Date().toISOString(),\n                authMethod: 'google'\n            }, { merge: true });\n\n            document.getElementById('setupProfileModal').classList.remove('hide');\n            const setupPreview = document.getElementById('setupProfilePreview');\n            if(setupPreview) {\n                setupPreview.src = user.photoURL;\n                setupPreview.style.display = 'block';\n                document.getElementById('setupUploadPlaceholder').style.display = 'none';\n            }\n            window.showLoader(false);\n        }\n    } catch (error) {\n        window.showLoader(false);\n        console.error(\"Google Login Error:\", error);\n        if (error.code === 'auth/account-exists-with-different-credential') { \n            alert(\"Email ini sudah terdaftar. Silakan login menggunakan Password.\"); \n        } else if (error.code === 'auth/popup-closed-by-user') { \n            alert(\"Login dibatalkan.\"); \n        } else { \n            alert(\"Gagal Login Google: \" + error.message); \n        }\n    }\n};",
    "target": "window\\.loginWithGoogle\\s*=\\s*async\\s*\\(\\)\\s*=>\\s*\\{[\\s\\S]*?else\\s*alert\\(\"Gagal Login Google: \"\\s*\\+\\s*error\\.message\\);\\s*\\}\\s*};",
    "action": "replace",
    "regex": true,
    "global": false
  }
]