<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DompetKu - Final Features</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); overflow-x: hidden; padding-bottom: 90px; }
        body { background-color: #f8fafc; }
        .app-container { background-color: #ffffff; }
        html.dark body { background-color: #111827; } 
        html.dark .app-container { background-color: #030712; box-shadow: 0 0 25px rgba(0,0,0,0.5); } 
        .hide { display: none !important; }
        .page { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        .bg-gradient-brand { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        html.dark .bg-gradient-brand { background: linear-gradient(135deg, #1d4ed8 0%, #172554 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .input-group { position: relative; }
        .input-group i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; z-index: 10;}
        .input-group input:focus + i { color: #2563eb; }
        .input-group input { padding-left: 44px; transition: all 0.3s; }
        .input-group select { padding-left: 44px; transition: all 0.3s; appearance: none; }
        html.dark .input-group i { color: #6b7280; }
        html.dark .input-group input:focus + i { color: #60a5fa; }
        .qris-btn-container { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .qris-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3); border: 2px solid white; }
        html.dark .qris-btn { border-color: #1f2937; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Profile Upload Style */
        .profile-upload { width: 100px; height: 100px; margin: 0 auto; position: relative; cursor: pointer; border-radius: 50%; border: 3px dashed #cbd5e1; overflow: hidden; transition: all 0.3s; }
        .profile-upload:hover { border-color: #2563eb; }
        .profile-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .profile-upload .upload-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #94a3b8; pointer-events: none; }
    </style>
</head>
<body>

<div class="app-container transition-colors duration-300">

    <div id="globalLoader" class="hide fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 p-5 rounded-2xl flex flex-col items-center shadow-2xl">
            <div class="loader mb-3"></div>
            <p class="text-xs font-bold text-gray-600 dark:text-gray-300" id="loaderText">Memuat Data...</p>
        </div>
    </div>

        <div id="setupProfileModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl overflow-hidden">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Selamat Datang!</h3>
                <p class="text-xs text-gray-500">Lengkapi data diri Anda untuk melanjutkan.</p>
            </div>
            <div class="space-y-4">
                <div class="text-center mb-4">
                    <label for="setupProfilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800"><img id="setupProfilePreview" src="" alt="Profile"><div class="upload-placeholder" id="setupUploadPlaceholder"><i class="fas fa-camera text-2xl mb-1"></i><p class="text-[9px]">Foto (Wajib)</p></div></label>
                    <input type="file" id="setupProfilePicInput" accept="image/*" class="hidden" onchange="previewImage(this, 'setup')">
                </div>
                <div class="input-group"><input type="text" id="setupUsername" placeholder="Buat Username" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white"><i class="fas fa-user"></i></div>
                <div class="flex gap-2">
                    <div class="input-group w-1/2"><select id="setupGender" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-xs"><option value="" disabled selected>Gender</option><option value="Laki-laki">Pria</option><option value="Perempuan">Wanita</option></select><i class="fas fa-venus-mars"></i></div>
                    <div class="input-group w-1/2"><input type="date" id="setupDob" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-xs"><i class="fas fa-calendar"></i></div>
                </div>
                <button onclick="saveProfileSetup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg mt-2">SIMPAN & LANJUTKAN</button>
            </div>
        </div>
    </div>

    <div id="passwordPromptModal" class="hide fixed inset-0 z-[130] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 text-center">Konfirmasi Keamanan</h3>
            <p class="text-xs text-gray-500 text-center mb-4">Masukkan kata sandi untuk melanjutkan transaksi.</p>
            <div class="input-group mb-4">
                <input type="password" id="confirmPasswordInput" placeholder="Kata Sandi" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11">
                <i class="fas fa-lock"></i>
            </div>
            <div class="flex gap-2">
                <button onclick="closePasswordPrompt(false)" class="flex-1 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 font-bold text-xs">Batal</button>
                <button id="btnConfirmPassword" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg">Konfirmasi</button>
            </div>
        </div>
    </div>

    <div id="incomingRequestModal" class="hide fixed inset-0 z-[140] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-orange-500"></div>
            <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"><i class="fas fa-hand-holding-usd"></i></div>
            <h3 class="text-lg font-black text-gray-800 dark:text-white uppercase tracking-tight">Permintaan Dana</h3>
            <div class="my-4 py-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 mb-1">Dari Pengguna</p>
                <p class="text-base font-bold text-gray-800 dark:text-white mb-2" id="reqSenderName">-</p>
                <p class="text-xs text-gray-500 mb-1">Jumlah</p>
                <p class="text-2xl font-black text-blue-600 dark:text-blue-400" id="reqAmount">Rp 0</p>
            </div>
            <div class="flex gap-3">
                <button onclick="rejectRequest()" class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-red-500 font-bold text-xs hover:bg-gray-200">Tolak</button>
                <button onclick="approveRequest()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg shadow-blue-500/30">Setujui & Bayar</button>
            </div>
        </div>
    </div>

        <div id="customConfirmModal" class="hide fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2rem] p-6 shadow-2xl border border-white/20 dark:border-gray-800 transform transition-all scale-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-brand"></div>
            <div class="text-center mb-6 mt-2">
                <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm ring-4 ring-blue-50/50 dark:ring-blue-900/20"><i class="fas fa-info-circle text-3xl"></i></div>
                <h3 class="text-xl font-black text-gray-800 dark:text-white mb-2 tracking-tight" id="confirmTitle">Konfirmasi</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed px-4" id="confirmMessage">Apakah anda yakin?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-3.5 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-bold text-xs hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-transparent hover:border-gray-200 dark:hover:border-gray-700">Batal</button>
                <button id="confirmYesBtn" class="flex-1 py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-xs shadow-lg shadow-blue-600/20 hover:shadow-blue-600/40 transition transform active:scale-95">Ya, Proses</button>
            </div>
        </div>
    </div>

        <div id="stockModal" class="hide fixed inset-0 z-[120] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">Stok XL Akrab</h3>
                <button onclick="closeStockModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="stockList" class="overflow-y-auto pr-1 space-y-2 flex-1 no-scrollbar">
                
            </div>
            <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-800 text-center">
                 <p class="text-[10px] text-gray-400">Data Realtime Server v3</p>
            </div>
        </div>
    </div>


    <div id="invoiceModal" class="hide fixed inset-0 z-[150] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2rem] overflow-hidden shadow-2xl relative border border-white/20">
            <div class="bg-gradient-brand p-8 text-center relative overflow-hidden">
                <div class="absolute -top-10 -left-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <i class="fas fa-receipt text-5xl text-white/40 mb-3 transform -rotate-12"></i>
                <p class="text-blue-100 text-[10px] font-bold uppercase tracking-widest mb-1">Total Tagihan</p>
                <h2 class="text-3xl font-black text-white tracking-tight" id="invTotalMain">Rp 0</h2>
            </div>
            <div class="p-6 relative bg-white dark:bg-gray-900">
                <div class="absolute top-0 left-0 w-full -mt-2 flex justify-between px-2 overflow-hidden">
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                   <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
                </div>
                
                <div class="space-y-4 mt-4">
                    <div class="flex justify-between items-start">
                        <span class="text-xs text-gray-500 font-medium">Produk</span>
                        <span class="text-xs font-bold text-gray-800 dark:text-white text-right max-w-[60%] leading-tight" id="invProductName">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-medium">Nomor Tujuan</span>
                        <span class="text-xs font-bold text-gray-800 dark:text-white font-mono bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded" id="invDestNum">-</span>
                    </div>
                    <div class="my-4 border-t-2 border-dashed border-gray-100 dark:border-gray-800"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-medium">Harga</span>
                        <span class="text-xs font-bold text-gray-800 dark:text-white" id="invPrice">Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-medium">Biaya Admin</span>
                        <span class="text-[10px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full">GRATIS</span>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-sm font-bold text-gray-800 dark:text-white">Total Bayar</span>
                        <span class="text-lg font-black text-blue-600 dark:text-blue-400" id="invTotalBottom">Rp 0</span>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="closeInvoice()" class="flex-1 py-3.5 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-bold text-xs hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-transparent hover:border-gray-200 dark:hover:border-gray-700">Batal</button>
                    <button id="btnPayInvoice" class="flex-1 py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-xs shadow-lg shadow-blue-600/30 hover:shadow-blue-600/50 transition transform active:scale-95">Konfirmasi Bayar</button>
                </div>
            </div>
        </div>
    </div>


<div id="topUpSheet" class="hide fixed inset-0 z-50 flex flex-col justify-end bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-full rounded-t-[30px] p-6 modal-enter max-w-[480px] mx-auto">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Pilih Metode Top Up</h3>
            <div class="space-y-3">
                <div onclick="processTopUp('manual')" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition">
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="flex-1"><h4 class="font-bold text-gray-800 dark:text-white text-sm">Manual (Simulasi)</h4><p class="text-xs text-gray-500">Isi saldo +50.000 (Firestore)</p></div><i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            </div>
            <button onclick="closeTopUp()" class="mt-6 w-full py-3 text-gray-500 dark:text-gray-400 font-semibold text-sm">Tutup</button>
        </div>
    </div>

    <section id="loginPage" class="page flex flex-col justify-between min-h-screen bg-white dark:bg-gray-950 relative z-50">
        <div class="absolute top-0 left-0 w-full h-[45vh] bg-gradient-brand rounded-b-[50px] z-0"></div>
        <div class="relative z-10 px-8 pt-20 w-full">
            <div class="text-center mb-6 text-white">
                <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg border border-white/30"><i class="fas fa-wallet text-4xl text-white"></i></div>
                <h1 class="text-3xl font-bold tracking-tight">DompetKu</h1>
                <p class="text-blue-100 text-sm mt-1">Firebase Edition</p>
            </div>
            
            <div class="bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-xl shadow-blue-900/10 dark:shadow-black/30 transition-all duration-300">
                <h2 id="authTitle" class="text-xl font-bold text-gray-800 dark:text-white text-center mb-6">Masuk Akun</h2>
                <div id="authTabs" class="flex bg-gray-100 dark:bg-gray-800 rounded-xl p-1 mb-6">
                    <button id="tabEmail" onclick="switchLoginMethod('email')" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400 transition-all">Email</button>
                    <button id="tabPhone" onclick="switchLoginMethod('phone')" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">No. HP</button>
                </div>
                <div id="loginFormContainer" class="space-y-4">
                    <div id="registerFields" class="hide space-y-4 animate-fade-in-down">
                        <div class="text-center mb-4">
                            <label for="profilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800"><img id="profilePreview" src="" alt="Profile"><div class="upload-placeholder" id="uploadPlaceholder"><i class="fas fa-camera text-2xl mb-1"></i><p class="text-[9px]">Upload Foto (Wajib)</p></div></label>
                            <input type="file" id="profilePicInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                        </div>
                        <div class="input-group"><input type="text" id="regUsername" placeholder="Username" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11"><i class="fas fa-user" style="color: #94a3b8;"></i></div>
                        <div class="flex gap-2">
                            <div class="input-group w-1/2"><select id="regGender" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11"><option value="" disabled selected>Gender</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select><i class="fas fa-venus-mars" style="color: #94a3b8;"></i></div>
                            <div class="input-group w-1/2"><input type="date" id="regDob" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-100 text-xs font-medium pl-11"><i class="fas fa-calendar" style="color: #94a3b8;"></i></div>
                        </div>
                    </div>
                    <div class="input-group"><input type="email" id="emailInput" placeholder="Email" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11"><i class="fas fa-envelope" id="loginIcon"></i></div>
                    <div class="relative" id="passContainer"><div class="input-group"><input type="password" id="passwordInput" placeholder="Kata Sandi" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11 pr-10"><i class="fas fa-lock"></i></div><button type="button" id="togglePassBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 z-20 outline-none"><i class="fas fa-eye"></i></button></div>
                    <div id="extraOptions" class="flex justify-between items-center text-xs mt-2"><label class="flex items-center gap-2 text-gray-500 dark:text-gray-400 cursor-pointer select-none"><input type="checkbox" id="rememberMe" class="rounded text-blue-600 focus:ring-blue-500 bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-700"><span>Ingat Saya</span></label><button onclick="setAuthMode('forgot')" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Lupa Sandi?</button></div>
                    <div id="otpContainer" class="hide space-y-4"><div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 text-xs text-blue-800 dark:text-blue-300">Kode OTP dikirim. Masukkan kode 6 digit.</div><input type="number" id="otpInput" placeholder="123456" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg font-bold tracking-widest"></div>
                    <div id="recaptcha-container"></div>
                                        <button id="btnAuthAction" class="w-full bg-blue-600 dark:bg-blue-500 text-white h-12 rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-transform hover:bg-blue-700 mt-2">MASUK</button>
                    <button onclick="loginWithGoogle()" class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 h-12 rounded-xl font-bold shadow-sm active:scale-95 transition-transform hover:bg-gray-50 dark:hover:bg-gray-700 mt-3 flex items-center justify-center gap-3">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                        <span class="text-sm">Masuk dengan Google</span>
                    </button>
                    <button id="btnVerifyOtp" class="hide w-full bg-green-600 text-white h-12 rounded-xl font-bold shadow-lg shadow-green-500/30 active:scale-95 transition-transform hover:bg-green-700 mt-2">VERIFIKASI OTP</button>
                </div>
                <div id="authFooter" class="text-center mt-6 text-xs text-gray-500 dark:text-gray-400">Belum punya akun? <button onclick="setAuthMode('register')" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Daftar Sekarang</button></div>
                <div id="backToLoginContainer" class="hide text-center mt-6 text-xs"><button onclick="setAuthMode('login')" class="text-gray-500 dark:text-gray-400 font-bold hover:text-gray-800 dark:hover:text-white"><i class="fas fa-arrow-left mr-1"></i> Kembali ke Login</button></div>
                <p class="text-center text-[10px] text-gray-400 mt-4" id="statusMessage">Aman & Terenkripsi</p>
            </div>
        </div>
    </section>

    <section id="homePage" class="page hide bg-gray-50/50 dark:bg-gray-950">
        <div class="bg-gradient-brand text-white pt-8 pb-24 px-6 rounded-b-[40px] shadow-lg relative overflow-hidden">
            <div class="flex justify-between items-center mb-6 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border-2 border-white/30 p-0.5 overflow-hidden"><img id="headerProfileImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover rounded-full bg-white dark:bg-gray-800"></div>
                    <div><p class="text-xs text-blue-100">Selamat Pagi,</p><p class="font-bold text-lg leading-tight" id="headerUsername">Loading...</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur flex items-center justify-center hover:bg-white/30 transition active:scale-95"><i id="themeIcon" class="fas fa-moon text-white"></i></button>
                </div>
            </div>
        </div>
        <div class="mx-6 -mt-24 relative z-20">
            <div class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl rounded-[2.5rem] p-5 shadow-[0_20px_40px_-15px_rgba(37,99,235,0.2)] dark:shadow-none border border-white/50 dark:border-gray-700 relative overflow-hidden group">
                <div class="flex justify-between items-start mb-3 relative">
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-1 flex items-center gap-1.5"><i class="fas fa-wallet text-blue-500"></i> Total Saldo</p>
                        <h2 class="text-[2.2rem] font-black text-gray-800 dark:text-white leading-none tracking-tight" id="displayBalance">Rp 0</h2>
                    </div>
                    <button onclick="initProductData()" class="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-800 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center shadow-sm"><i class="fas fa-sync-alt text-xs"></i></button>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div class="text-center group/btn cursor-pointer" onclick="openTopUpSheet()"><div class="w-11 h-11 mx-auto bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-600/30 mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-plus text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Top Up</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="nav('sendPage')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-paper-plane text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Kirim</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="nav('requestPage')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-arrow-down text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Minta</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="alert('Lainnya...')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-qrcode text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Lainnya</span></div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 px-6">
            <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm">Layanan</h3>
            <div class="grid grid-cols-4 gap-4">
                <div class="text-center group cursor-pointer" onclick="openPPOB('akrab')"><div class="bg-blue-100 dark:bg-blue-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-users text-blue-600 dark:text-blue-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">XL Akrab</span></div>
                <div class="text-center group cursor-pointer" onclick="alert('Menu Paket OTP Segera Hadir')"><div class="bg-emerald-100 dark:bg-emerald-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-key text-emerald-600 dark:text-emerald-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Paket OTP</span></div>
                <div class="text-center group cursor-pointer" onclick="alert('Menu Pre-Order Segera Hadir')"><div class="bg-purple-100 dark:bg-purple-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-clock text-purple-600 dark:text-purple-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Pre-Order</span></div>
                <div class="text-center group cursor-pointer" onclick="checkAkrabStock()"><div class="bg-orange-100 dark:bg-orange-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-cubes text-orange-600 dark:text-orange-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Stok Akrab</span></div>
                <div class="text-center group cursor-pointer" onclick="alert('Menu Login OTP Segera Hadir')"><div class="bg-rose-100 dark:bg-rose-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-lock text-rose-600 dark:text-rose-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Login OTP</span></div>
                <div class="text-center group cursor-pointer" onclick="nav('historyPage')"><div class="bg-indigo-100 dark:bg-indigo-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-history text-indigo-600 dark:text-indigo-400 text-2xl"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Riwayat</span></div>
            </div>
        </div>

        <div class="mt-8 bg-white dark:bg-gray-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)] dark:shadow-[0_-5px_20px_rgba(0,0,0,0.2)] p-6 min-h-[300px]">
            <div class="flex justify-between items-end mb-4"><h3 class="font-bold text-gray-800 dark:text-white">Transaksi Terakhir</h3><span class="text-xs text-blue-600 dark:text-blue-400 font-semibold cursor-pointer" onclick="nav('historyPage')">Lihat Semua</span></div>
            <div id="miniHistory" class="space-y-4"></div>
        </div>
    </section>

    <section id="sendPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="nav('homePage')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">Kirim Saldo</h2>
        </div>
        <div class="p-6">
            <div class="bg-white dark:bg-gray-900 p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Username Penerima</label>
                    <div class="input-group">
                        <input type="text" id="sendTargetUser" placeholder="Contoh: user123" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nominal Transfer</label>
                    <div class="input-group">
                        <input type="number" id="sendAmount" placeholder="0" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <button onclick="initiateSend()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Lanjut</span><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </section>

    <section id="requestPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="nav('homePage')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">Minta Saldo</h2>
        </div>
        <div class="p-6">
            <div class="bg-white dark:bg-gray-900 p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl mb-6 border border-orange-100 dark:border-orange-800">
                    <p class="text-xs text-orange-600 dark:text-orange-400">Notifikasi permintaan akan muncul langsung di layar temanmu jika mereka sedang online.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Minta ke Username</label>
                    <div class="input-group">
                        <input type="text" id="reqTargetUser" placeholder="Contoh: sultan99" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white">
                        <i class="fas fa-hand-holding"></i>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nominal Diminta</label>
                    <div class="input-group">
                        <input type="number" id="reqAmountInput" placeholder="0" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
                        <i class="fas fa-tag"></i>
                    </div>
                </div>
                <button onclick="initiateRequest()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Kirim Permintaan</span><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </section>

    <section id="ppobPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="closePPOB()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white" id="ppobTitle">Isi Pulsa (Live API)</h2>
        </div>
        <div class="p-4 pb-24">
            <div id="inputSection" class="transition-all duration-300">
                <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1"><label class="block text-xs font-bold text-gray-500 ml-1">Provider</label><button onclick="initProductData()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100"><i class="fas fa-sync-alt mr-1"></i> Refresh Data</button></div>
                        <div class="relative">
                            <select id="formProvider" onchange="updateProductDropdown()" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold"><option value="" disabled selected>-- Pilih Provider --</option><option value="XDA">Akrab Fresh (XDA)</option><option value="XLA">Akrab Fresh (XLA)</option><option value="FMX">FlexMax (FMX)</option><option value="PLN">PLN Pascabayar</option></select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Produk</label>
                        <div class="relative">
                            <select id="formProduct" disabled class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 text-sm rounded-xl px-4 py-3 appearance-none font-medium transition-colors"><option value="">Menunggu Provider...</option></select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="priceDisplay"></p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
                        <div class="input-group" id="singleNumContainer">
                            <input type="tel" id="ppobNumber" placeholder="Nomor HP / ID Pelanggan" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
                            <i class="fas fa-address-book text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 z-10"></i>
                        </div>
                        <div id="multiNumContainer" class="hide space-y-2 mt-2"></div>
                        <button id="btnAddNum" onclick="addMultiInput()" class="hide mt-2 w-full py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl text-xs font-bold border border-blue-200 dark:border-blue-800 border-dashed hover:bg-blue-100 dark:hover:bg-blue-900/40 transition"><i class="fas fa-plus mr-1"></i> Tambah Nomor Tujuan</button>
                    </div>
                    <button onclick="processFormTransaction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span><i class="fas fa-arrow-right"></i></button>
                    <div class="flex items-center gap-2 mt-4 cursor-pointer p-1" onclick="toggleMultiTrx()">
                        <div id="multiTrxCheck" class="w-5 h-5 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-white transition-colors"><i class="fas fa-check text-[10px] opacity-0 transition-opacity"></i></div>
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400 select-none">Aktifkan Multi Transaksi (Banyak Nomor)</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="historyPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-10 shadow-sm dark:shadow-gray-800">
            <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg text-gray-800 dark:text-white">Riwayat</h2><div class="flex gap-2"><button onclick="downloadHistoryPDF()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition"><i class="fas fa-file-pdf mr-1"></i> PDF</button></div></div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1"><button onclick="filterHistory('all')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white shadow-md" id="filter-all">Semua</button><button onclick="filterHistory('today')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-gray-100 text-gray-500" id="filter-today">Hari Ini</button><button onclick="filterHistory('week')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-gray-100 text-gray-500" id="filter-week">Minggu Ini</button></div>
        </div>
        <div id="fullHistory" class="p-4 space-y-3 pb-24"></div>
    </section>

    <section id="profilePage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="bg-gradient-brand text-white p-6 pb-12 rounded-b-[40px] text-center shadow-lg relative transition-colors">
            <div class="w-24 h-24 bg-white dark:bg-gray-900 p-1 rounded-full mx-auto mb-4 shadow-xl transition-colors overflow-hidden"><img id="profilePageImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover"></div>
            <h2 class="text-xl font-bold" id="profileName">Dev User</h2><p class="text-blue-200 text-sm" id="profilePhone">-</p>
            <div class="mt-4 inline-flex items-center bg-blue-800/50 dark:bg-blue-900/50 backdrop-blur px-4 py-1.5 rounded-full text-xs font-semibold border border-blue-400/30"><i class="fas fa-crown text-yellow-400 mr-2"></i> Pelanggan Setia</div>
        </div>
        <div class="px-6 -mt-6 pb-24 relative z-10">
            <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-black/30 overflow-hidden transition-colors">
                 <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center"><span class="text-xs text-gray-500">Gender</span><span class="text-sm font-bold dark:text-white" id="profileGender">-</span></div>
                 <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center"><span class="text-xs text-gray-500">Tgl. Lahir</span><span class="text-sm font-bold dark:text-white" id="profileDob">-</span></div>
                 <div onclick="handleLogout()" class="p-4 flex items-center gap-4 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer transition-colors group"><div class="w-9 h-9 rounded-full bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400 group-hover:bg-red-100 dark:group-hover:bg-red-900/50 flex items-center justify-center transition-colors"><i class="fas fa-sign-out-alt text-sm"></i></div><div class="flex-1 text-sm font-bold text-red-500 dark:text-red-400">Keluar</div></div>
            </div>
        </div>
    </section>

    <section id="scanPage" class="page hide bg-black min-h-screen text-white flex flex-col fixed top-0 w-full max-w-[480px] z-50">
        <div class="flex justify-between items-center p-4 absolute top-0 w-full z-10">
            <button onclick="stopScan()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-times"></i></button>
            <h2 class="font-bold">Scan QRIS</h2>
            <button class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-bolt"></i></button>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div id="reader" class="rounded-3xl overflow-hidden border-2 border-white/50 shadow-2xl"></div>
            <div class="absolute bottom-32 text-center pointer-events-none"><p class="text-sm font-medium bg-black/40 px-4 py-1 rounded-full">Arahkan kamera ke kode QRIS</p></div>
        </div>
    </section>

    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 flex justify-around items-end pb-4 pt-3 text-[10px] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-40 hide rounded-t-3xl">
        <div class="text-center cursor-pointer w-1/5 nav-item text-blue-600 dark:text-blue-400 group" id="nav-home" onclick="nav('homePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-home text-xl"></i></div><p class="font-medium">Beranda</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-buy" onclick="openPPOB('akrab')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-shopping-cart text-xl"></i></div><p class="font-medium">Beli</p></div>
        <div class="text-center w-1/5 qris-btn-container cursor-pointer" onclick="openTopUpSheet()"><div class="qris-btn w-11 h-11 rounded-full flex items-center justify-center mx-auto text-white transform transition hover:scale-105 active:scale-95 mb-1"><i class="fas fa-plus text-lg"></i></div><p class="font-bold text-gray-700 dark:text-gray-400">Top Up</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-preorder" onclick="nav('sendPage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-paper-plane text-xl"></i></div><p class="font-medium">Kirim</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-profile" onclick="nav('profilePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-user text-xl"></i></div><p class="font-medium">Saya</p></div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        sendPasswordResetEmail,
        signInWithPhoneNumber, 
        RecaptchaVerifier, 
        signOut, 
        onAuthStateChanged,
        EmailAuthProvider,
                        reauthenticateWithCredential,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, where, getDocs, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC7vP4QUhxPM3wG_jsnA2Z8dsTYd2IJ1KA",
        authDomain: "server-ppob-xl.firebaseapp.com",
        projectId: "server-ppob-xl",
        storageBucket: "server-ppob-xl.firebasestorage.app",
        messagingSenderId: "197244150476",
        appId: "1:197244150476:web:23b3448b65ea5dc66c5869",
        measurementId: "G-55M9H4WRGY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    auth.languageCode = 'id';

    // VARIABLES
    let currentUser = null;
    let currentBalance = 0;
    let currentUsername = "";
    let transactions = [];
    let globalProducts = [];
    let pendingTrxData = null;
    let pendingTransferData = null; // { targetUid, targetName, amount, type: 'send'|'request_approve' }
    let activeRequestDocId = null; // Untuk handle approve/reject
    let confirmationResult = null;
    let loginMethod = 'email';
    let authMode = 'login';
    let base64ProfilePic = '';
    let isMultiTrx = false;
    let currentFilter = 'all';
    let scanner = null;
    let pricingRules = {}; // Cache Aturan Harga
    let passwordPromptCallback = null;

    const CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };
        const PROXY_LIST = [
        { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
        { name: 'CorsProxy', url: 'https://corsproxy.io/?' },
        { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' },
        { name: 'AllOrigins', url: 'https://api.allorigins.win/raw?url=' },
        { name: 'Direct', url: '' }
    ];

        // Handle Redirect Result (Mencegah stuck di login page)
    getRedirectResult(auth).then((result) => {
        if (result) console.log("Redirect Sukses");
    }).catch((error) => {
        console.error("Redirect Error:", error);
        window.showLoader(false);
    });

    // AUTH & DATA
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            console.log("Logged In:", user.uid);
            setupUserData(user);
            setupRequestListener(user);
            window.nav('homePage');
        } else {
            currentUser = null;
            console.log("Logged Out");
            window.nav('loginPage');
                        window.showLoader(false);
        }
    });

    function setupUserData(user) {
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // LOGIK BARU: Cek kelengkapan data (Google Login)
                if (!data.username || !data.dob) {
                     document.getElementById('setupProfileModal').classList.remove('hide');
                     return;
                }
                document.getElementById('setupProfileModal').classList.add('hide');

                currentBalance = data.balance || 0;
                currentUsername = data.username || "User";
                if(document.getElementById('displayBalance')) document.getElementById('displayBalance').innerText = window.formatRp(currentBalance);
                
                const name = data.username || user.displayName || "Pengguna";
                document.getElementById('headerUsername').innerText = name.length > 15 ? name.substring(0,12)+'...' : name;
                document.getElementById('profileName').innerText = name;
                document.getElementById('profilePhone').innerText = user.email || user.phoneNumber;
                document.getElementById('profileGender').innerText = data.gender || '-';
                document.getElementById('profileDob').innerText = data.dob || '-';
                if(data.profile_pic) {
                    document.getElementById('headerProfileImg').src = data.profile_pic;
                    document.getElementById('profilePageImg').src = data.profile_pic;
                }
            } else {
                // User Baru (Login Google pertama kali) -> Tampilkan Modal
                document.getElementById('setupProfileModal').classList.remove('hide');
            }
        });

        const historyRef = collection(db, "users", user.uid, "history");
        const q = query(historyRef, orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            transactions = [];
            snapshot.forEach((doc) => transactions.push(doc.data()));
            renderHistoryList();
        });
    }

    // LISTENER PERMINTAAN DANA (REALTIME)
    function setupRequestListener(user) {
        const requestsRef = collection(db, "requests");
        const q = query(requestsRef, where("targetUid", "==", user.uid), where("status", "==", "pending"));
        
        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const reqData = change.doc.data();
                    showIncomingRequest(change.doc.id, reqData);
                }
            });
        });
    }

    // GLOBAL NAV
        window.handleLogout = () => {
        window.customConfirm('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar dari aplikasi?', async () => {
            window.showLoader(true);
            try {
                await signOut(auth);
                // Loader akan hilang saat onAuthStateChanged redirect ke login
            } catch(e) {
                window.showLoader(false);
                alert('Gagal keluar: ' + e.message);
            }
        });
    };


window.nav = (pageId) => {
        document.querySelectorAll('.page').forEach(el => el.classList.add('hide'));
        document.getElementById(pageId).classList.remove('hide');
        document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-blue-600', 'dark:text-blue-400'); el.classList.add('text-gray-400', 'dark:text-gray-500'); });
        const navId = 'nav-' + pageId.replace('Page','');
        if(document.getElementById(navId)) { document.getElementById(navId).classList.remove('text-gray-400', 'dark:text-gray-500'); document.getElementById(navId).classList.add('text-blue-600', 'dark:text-blue-400'); }
        if(pageId === 'loginPage' || pageId === 'scanPage') document.getElementById('bottomNav').classList.add('hide'); else document.getElementById('bottomNav').classList.remove('hide');
        if(pageId === 'homePage') renderHistoryList();
    };

    // --- FITUR KIRIM (TRANSFER) ---
    window.initiateSend = async () => {
        const username = document.getElementById('sendTargetUser').value;
        const amount = parseInt(document.getElementById('sendAmount').value);

        if(!username) return alert("Masukkan username tujuan!");
        if(!amount || amount < 1000) return alert("Minimal transfer Rp 1.000");
        if(amount > currentBalance) return alert("Saldo tidak cukup!");

        window.showLoader(true);
        const targetUser = await findUserByUsername(username);
        window.showLoader(false);

        if(!targetUser) return alert("Username tidak ditemukan!");
        if(targetUser.uid === currentUser.uid) return alert("Tidak bisa transfer ke diri sendiri!");

        pendingTransferData = { targetUid: targetUser.uid, targetName: targetUser.username, amount: amount, type: 'send' };
        
        // Minta Password untuk konfirmasi
        openPasswordPrompt((password) => {
            verifyPasswordAndExecute(password);
        });
    };

    // --- FITUR MINTA (REQUEST) ---
    window.initiateRequest = async () => {
        const username = document.getElementById('reqTargetUser').value;
        const amount = parseInt(document.getElementById('reqAmountInput').value);

        if(!username) return alert("Masukkan username tujuan!");
        if(!amount || amount < 1000) return alert("Minimal minta Rp 1.000");

        window.showLoader(true);
        const targetUser = await findUserByUsername(username);
        window.showLoader(false);

        if(!targetUser) return alert("Username tidak ditemukan!");
        if(targetUser.uid === currentUser.uid) return alert("Tidak bisa minta ke diri sendiri!");

        try {
            await addDoc(collection(db, "requests"), {
                senderUid: currentUser.uid,
                senderName: currentUsername,
                targetUid: targetUser.uid,
                amount: amount,
                status: "pending",
                timestamp: new Date().toISOString()
            });
            alert("Permintaan berhasil dikirim ke " + targetUser.username);
            window.nav('homePage');
        } catch(e) {
            alert("Gagal mengirim permintaan: " + e.message);
        }
    };

    // --- NOTIFIKASI MINTA (RECEIVER SIDE) ---
    function showIncomingRequest(docId, data) {
        activeRequestDocId = docId;
        pendingTransferData = { 
            targetUid: data.senderUid, // Kita transfer balik ke pengirim request
            targetName: data.senderName, 
            amount: data.amount,
            type: 'request_approve'
        };
        
        document.getElementById('reqSenderName').innerText = data.senderName;
        document.getElementById('reqAmount').innerText = window.formatRp(data.amount);
        document.getElementById('incomingRequestModal').classList.remove('hide');
    }

    window.rejectRequest = async () => {
        if(activeRequestDocId) {
            await deleteDoc(doc(db, "requests", activeRequestDocId));
            document.getElementById('incomingRequestModal').classList.add('hide');
            alert("Permintaan ditolak.");
        }
    };

    window.approveRequest = () => {
        document.getElementById('incomingRequestModal').classList.add('hide');
        // Langsung tampilkan invoice / konfirmasi password
        openPasswordPrompt((password) => {
            verifyPasswordAndExecute(password);
        });
    };

    // --- LOGIKA TRANSFER & PASSWORD ---
    
    // Helper: Cari User by Username
    async function findUserByUsername(username) {
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", username));
        const querySnapshot = await getDocs(q);
        if(!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            return { uid: doc.id, ...doc.data() };
        }
        return null;
    }

    // Helper: Password Prompt
    window.openPasswordPrompt = (callback) => {
        document.getElementById('confirmPasswordInput').value = '';
        document.getElementById('passwordPromptModal').classList.remove('hide');
        passwordPromptCallback = callback;
    }
    
    window.closePasswordPrompt = () => {
        document.getElementById('passwordPromptModal').classList.add('hide');
        passwordPromptCallback = null;
    }

    document.getElementById('btnConfirmPassword').addEventListener('click', () => {
        const pass = document.getElementById('confirmPasswordInput').value;
        if(!pass) return alert("Masukkan password!");
        if(passwordPromptCallback) passwordPromptCallback(pass);
    });

    // Verifikasi Auth & Eksekusi Transfer
    async function verifyPasswordAndExecute(password) {
        window.showLoader(true);
        const cred = EmailAuthProvider.credential(currentUser.email, password);
        
        try {
            // Re-authenticate untuk memastikan password benar
            await reauthenticateWithCredential(currentUser, cred);
            window.closePasswordPrompt();
            
            // Eksekusi Transfer
            await executeTransfer();
            
        } catch(error) {
            window.showLoader(false);
            console.error(error);
            alert("Password Salah!");
        }
    }

    async function executeTransfer() {
        const { targetUid, targetName, amount, type } = pendingTransferData;
        const senderRef = doc(db, "users", currentUser.uid);
        const receiverRef = doc(db, "users", targetUid);
        const trxId = 'TRX-' + Date.now();

        try {
            await runTransaction(db, async (transaction) => {
                const senderDoc = await transaction.get(senderRef);
                if (!senderDoc.exists()) throw "User tidak ditemukan!";
                
                const senderBalance = senderDoc.data().balance || 0;
                if (senderBalance < amount) throw "Saldo tidak cukup!";

                const receiverDoc = await transaction.get(receiverRef);
                if (!receiverDoc.exists()) throw "Penerima tidak valid!";
                const receiverBalance = receiverDoc.data().balance || 0;

                // 1. Kurangi Saldo Pengirim
                transaction.update(senderRef, { balance: senderBalance - amount });
                
                // 2. Tambah Saldo Penerima
                transaction.update(receiverRef, { balance: receiverBalance + amount });

                // 3. Catat History Pengirim
                const senderHistoryRef = doc(db, "users", currentUser.uid, "history", trxId);
                transaction.set(senderHistoryRef, {
                    title: `Kirim ke ${targetName}`,
                    amount: amount,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Sukses',
                    api_msg: 'Transfer Sesama',
                    trx_id: trxId
                });

                // 4. Catat History Penerima
                const receiverHistoryRef = doc(db, "users", targetUid, "history", trxId);
                transaction.set(receiverHistoryRef, {
                    title: `Terima dari ${currentUsername}`,
                    amount: amount,
                    type: 'in',
                    date: new Date().toISOString(),
                    status: 'Sukses',
                    api_msg: 'Transfer Masuk',
                    trx_id: trxId
                });

                // 5. Jika ini Approval Request, hapus requestnya
                if(type === 'request_approve' && activeRequestDocId) {
                    const reqRef = doc(db, "requests", activeRequestDocId);
                    transaction.delete(reqRef);
                }
            });

            window.showLoader(false);
            alert("Transfer Berhasil!");
            window.nav('homePage');

        } catch (e) {
            window.showLoader(false);
            alert("Transfer Gagal: " + e);
        }
    }

    // --- EXISTING CODE (AUTH, UI, ETC) ---
    // (Kode login, register, UI handling, PPOB tetap sama seperti sebelumnya, 
    // hanya ditambahkan helper function showLoader yang global)

    window.formatRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    window.showLoader = (show) => document.getElementById('globalLoader').classList.toggle('hide', !show);
    window.toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); };
    window.customConfirm = (t, m, c) => { document.getElementById('confirmTitle').innerText = t; document.getElementById('confirmMessage').innerText = m; document.getElementById('customConfirmModal').classList.remove('hide'); window.confirmCallback = c; };
    window.closeConfirm = (r) => { document.getElementById('customConfirmModal').classList.add('hide'); if(r && window.confirmCallback) window.confirmCallback(); };
    document.getElementById('confirmYesBtn').onclick = () => window.closeConfirm(true);

    // ... (Code PPOB, Auth UI Handlers lainnya tetap ada di sini - disalin dari versi sebelumnya) ...
    // AUTH LOGIC (Copied & Minimized for brevity, FULL logic included in HTML file above)
    



            window.loginWithGoogle = async () => {
        window.showLoader(true);
        const provider = new GoogleAuthProvider();
        try {
            await signInWithRedirect(auth, provider);
        } catch (error) {
            window.showLoader(false);
            alert("Gagal Login Google: " + error.message);
        }
    };

    window.saveProfileSetup = async () => {
        const username = document.getElementById('setupUsername').value;
        const gender = document.getElementById('setupGender').value;
        const dob = document.getElementById('setupDob').value;

        if(!username || !gender || !dob) return alert("Mohon lengkapi semua data!");
        
        window.showLoader(true);
        try {
            await setDoc(doc(db, "users", currentUser.uid), {
                email: currentUser.email,
                username: username,
                gender: gender,
                dob: dob,
                balance: 0,
                profile_pic: base64ProfilePic || currentUser.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
                createdAt: new Date().toISOString(),
                authMethod: 'google'
            }, { merge: true });
            
            document.getElementById('setupProfileModal').classList.add('hide');
            window.showLoader(false);
            alert("Profil berhasil disimpan!");
        } catch(e) {
            window.showLoader(false);
            alert("Gagal menyimpan: " + e.message);
        }
    };

    window.switchLoginMethod = (method) => { 
        loginMethod = method;
        const tabEmail = document.getElementById('tabEmail');
        const tabPhone = document.getElementById('tabPhone');
        const input = document.getElementById('emailInput');
        const icon = document.getElementById('loginIcon');
        
        if(method === 'email') {
            tabEmail.className = 'flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400 transition-all';
            tabPhone.className = 'flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all';
            input.placeholder = 'Alamat Email';
            input.type = 'email';
            icon.className = 'fas fa-envelope';
        } else {
             alert('Login No. HP sedang pemeliharaan. Silakan gunakan Email.');
        }
    };

    window.setAuthMode = (mode) => {
        authMode = mode;
        const title = document.getElementById('authTitle');
        const btn = document.getElementById('btnAuthAction');
        const regFields = document.getElementById('registerFields');
        const passContainer = document.getElementById('passContainer');
        const extras = document.getElementById('extraOptions');
        const footer = document.getElementById('authFooter');
        const backBtn = document.getElementById('backToLoginContainer');
        const status = document.getElementById('statusMessage');
        
        status.innerText = 'Aman & Terenkripsi';

        if (mode === 'login') {
            title.innerText = 'Masuk Akun';
            btn.innerText = 'MASUK';
            regFields.classList.add('hide');
            passContainer.classList.remove('hide');
            extras.classList.remove('hide');
            footer.classList.remove('hide');
            backBtn.classList.add('hide');
        } else if (mode === 'register') {
            title.innerText = 'Daftar Akun Baru';
            btn.innerText = 'DAFTAR SEKARANG';
            regFields.classList.remove('hide');
            passContainer.classList.remove('hide');
            extras.classList.add('hide');
            footer.classList.add('hide');
            backBtn.classList.remove('hide');
        } else if (mode === 'forgot') {
            title.innerText = 'Reset Kata Sandi';
            btn.innerText = 'KIRIM LINK RESET';
            regFields.classList.add('hide');
            passContainer.classList.add('hide');
            extras.classList.add('hide');
            footer.classList.add('hide');
            backBtn.classList.remove('hide');
        }
    };
    
    // API CALLER
        // --- API HANDLER (ANTI-BLOKIR & AUTO-SWITCH DARI INDEX 41) ---
    async function callApi(endpoint, params = {}) {
        params['api_key'] = CONFIG.apiKey;
        const queryString = new URLSearchParams(params).toString();
        const targetUrl = `${CONFIG.baseUrl}${endpoint}?${queryString}`;
        
        let lastError = '';

        // Loop semua proxy sampai ada yang berhasil
        for (const proxy of PROXY_LIST) {
            console.log(`[API] Mencoba via ${proxy.name}...`);
            const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 detik timeout

                const response = await fetch(fullUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (response.ok) {
                    const text = await response.text();
                    try {
                        const data = JSON.parse(text);
                        console.log(`[API] SUKSES via ${proxy.name}`);
                        return { ok: true, data: data };
                    } catch (e) {
                        console.warn(`[API] Response bukan JSON via ${proxy.name}`);
                        continue;
                    }
                } else {
                    console.warn(`[API] Gagal HTTP ${response.status} via ${proxy.name}`);
                }
            } catch (error) {
                console.warn(`[API] Error Koneksi via ${proxy.name}:`, error.message);
                lastError = `${proxy.name}: ${error.message}`;
            }
        }
        return { ok: false, error: `Gagal Koneksi (Semua Jalur). Detail: ${lastError}` };
    }

    // Initialize
    window.updateUI = () => {}; 
    
    // Auth Event Listeners (Register, Login, etc)
        // Fix: Toggle Password Visibility
    document.getElementById('togglePassBtn').addEventListener('click', () => {
        const input = document.getElementById('passwordInput');
        const icon = document.querySelector('#togglePassBtn i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });


        document.getElementById('btnAuthAction').addEventListener('click', async () => {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        const status = document.getElementById('statusMessage');

        if(!email) return alert("Mohon isi Email!");
        status.innerText = "Memproses...";

        // 1. HANDLER LUPA SANDI
        if(authMode === 'forgot') {
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Link reset password telah dikirim ke: " + email + "\nSilakan cek inbox/spam email Anda.");
                window.setAuthMode('login');
                status.innerText = "Email Terkirim";
            } catch(e) {
                status.innerText = "Gagal Kirim";
                alert("Gagal: " + e.message);
            }
            return;
        }

        // 2. VALIDASI PASSWORD (Login & Register Butuh Password)
        if(!password) {
            status.innerText = "Menunggu Input";
            return alert("Mohon isi Kata Sandi!");
        }

        // 3. HANDLER LOGIN
        if(authMode === 'login') {
            try { 
                await signInWithEmailAndPassword(auth, email, password);
            } catch(e) { 
                status.innerText = "Gagal Login";
                alert("Login Gagal: " + e.message); 
            }
        
        // 4. HANDLER REGISTER
        } else if (authMode === 'register') {
            const username = document.getElementById('regUsername').value;
            const gender = document.getElementById('regGender').value;
            const dob = document.getElementById('regDob').value;

            if(!username || !gender || !dob) return alert("Mohon lengkapi Username, Gender, dan Tanggal Lahir!");

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), {
                    email: email, 
                    balance: 0, 
                    username: username,
                    gender: gender,
                    dob: dob,
                    profile_pic: base64ProfilePic || `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
                    createdAt: new Date().toISOString()
                });
                alert("Pendaftaran Berhasil! Silakan Masuk.");
            } catch(e) { 
                status.innerText = "Gagal Daftar";
                alert("Gagal Daftar: " + e.message); 
            }
        }
    });

                window.previewImage = (input, type = 'reg') => { 
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                if(type === 'setup') {
                     const el = document.getElementById('setupProfilePreview');
                     if(el) { el.src = e.target.result; el.style.display = 'block'; }
                     const ph = document.getElementById('setupUploadPlaceholder');
                     if(ph) ph.style.display = 'none';
                } else {
                     document.getElementById('profilePreview').src = e.target.result;
                     document.getElementById('profilePreview').style.display = 'block';
                     document.getElementById('uploadPlaceholder').style.display = 'none';
                }
                
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); canvas.width = 400; canvas.height = 400;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 400, 400);
                    base64ProfilePic = canvas.toDataURL('image/jpeg', 0.7);
                };
                img.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    };

    // HISTORY & PDF
    window.downloadHistoryPDF = () => { /* ... existing PDF logic ... */ };
    window.filterHistory = (t) => { currentFilter=t; renderHistoryList(); };
    function renderHistoryList() { /* ... existing render logic ... */ 
        const filtered = transactions; // Simplifikasi, gunakan logic filter asli
        let html = '';
        if(filtered.length === 0) html = '<div class="text-center text-gray-400 text-xs py-10">Belum ada transaksi</div>';
        else {
            filtered.forEach(t => {
                const isOut = t.type === 'out';
                html += `<div class="flex justify-between items-center bg-white dark:bg-gray-900 p-3 rounded-2xl border border-gray-50 dark:border-gray-800 shadow-sm mb-2"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${isOut?'bg-blue-100 text-blue-600':'bg-green-100 text-green-600'}"><i class="fas ${isOut?'fa-arrow-up':'fa-arrow-down'}"></i></div><div><p class="font-bold text-sm text-gray-800 dark:text-white">${t.title}</p><p class="text-[10px] text-gray-400">${t.date}</p></div></div><div class="text-right"><p class="text-sm font-bold ${isOut?'text-gray-800 dark:text-white':'text-green-600'}">${isOut?'-':'+'} ${window.formatRp(t.amount)}</p><p class="text-[10px] text-gray-400">${t.status}</p></div></div>`;
            });
        }
                document.getElementById('fullHistory').innerHTML = html;

        // UPDATE MINI HISTORY (HOME PAGE)
        if(document.getElementById('miniHistory')) {
            let miniHtml = '';
            if(filtered.length === 0) miniHtml = '<div class="text-center text-gray-400 text-[10px] py-4">Belum ada transaksi</div>';
            else {
                // Ambil 3 transaksi teratas untuk Home
                filtered.slice(0, 3).forEach(t => {
                    const isOut = t.type === 'out';
                    miniHtml += `<div class="flex justify-between items-center border-b border-gray-50 dark:border-gray-800 pb-3 last:border-0 last:pb-0"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full flex items-center justify-center ${isOut?'bg-blue-50 text-blue-600':'bg-green-50 text-green-600'}"><i class="fas ${isOut?'fa-arrow-up':'fa-arrow-down'} text-xs"></i></div><div><p class="font-bold text-xs text-gray-800 dark:text-white line-clamp-1">${t.title}</p><p class="text-[9px] text-gray-400">${t.date.split('T')[0]}</p></div></div><p class="text-xs font-bold ${isOut?'text-gray-800 dark:text-white':'text-green-600'}">${isOut?'-':'+'} ${window.formatRp(t.amount)}</p></div>`;
                });
            }
            document.getElementById('miniHistory').innerHTML = miniHtml;
        }
    }

    // PPOB Logic (Tetap ada)
    window.openPPOB = async (cat) => { 
        document.getElementById('homePage').classList.add('hide'); 
        document.getElementById('ppobPage').classList.remove('hide'); 
        document.getElementById('bottomNav').classList.add('hide');
        
        // Reset Provider
        const pSelect = document.getElementById('formProvider');
        if(pSelect) pSelect.value = "";

        // Load Data Produk
        await window.initProductData();

        // Logika Auto-Select Kategori
        if (cat === 'akrab' && pSelect) {
            // Prioritas pilih XDA, jika tidak ada fallback ke XLA
            const optXDA = pSelect.querySelector('option[value="XDA"]');
            pSelect.value = optXDA ? 'XDA' : 'XLA';
            
            // Trigger update tampilan produk
            window.updateProductDropdown();
            
            // Ubah Judul Header
            const tEl = document.getElementById('ppobTitle');
            if(tEl) tEl.innerText = 'Paket XL Akrab';
        } else {
            const tEl = document.getElementById('ppobTitle');
            if(tEl) tEl.innerText = 'Isi Pulsa (Live API)';
        }
    };
    window.closePPOB = () => window.nav('homePage');
        window.initProductData = async () => {
        const pSelect = document.getElementById('formProduct');
        if(!pSelect) return;
        
                // Load Aturan Harga dari Database (Admin)
        try {
            const settingsSnap = await getDoc(doc(db, "settings", "pricing"));
            if (settingsSnap.exists()) pricingRules = settingsSnap.data().rules || {};
        } catch(e) { console.log("Gagal load harga custom", e); }

        pSelect.innerHTML = '<option>Sedang mencari jalur koneksi...</option>';
        pSelect.disabled = true;
        
        const result = await callApi('/list_product');
        
        if (result.ok && result.data) {
            // Normalisasi Data (Handle berbagai struktur JSON)
            if (result.data.data && Array.isArray(result.data.data)) globalProducts = result.data.data;
            else if (Array.isArray(result.data)) globalProducts = result.data;
            else if (result.data.products) globalProducts = result.data.products;
            
            console.log("Total Produk Dimuat:", globalProducts.length);

            if (globalProducts.length > 0) {
                pSelect.innerHTML = '<option value="">-- Pilih Provider Dahulu --</option>';
                // Jika provider sudah dipilih, langsung refresh list
                if(document.getElementById('formProvider').value) window.updateProductDropdown();
            } else {
                pSelect.innerHTML = '<option>Data Produk Kosong</option>';
            }
        } else {
            pSelect.innerHTML = '<option>Gagal Load Data</option>';
            alert('Gagal mengambil data produk (Koneksi Bermasalah).\n' + result.error);
        }
    };

            window.updateProductDropdown = () => {
        const providerCode = document.getElementById('formProvider').value;
        const productSelect = document.getElementById('formProduct');
        const priceDisplay = document.getElementById('priceDisplay');
        
        // Reset UI Dropdown
        productSelect.innerHTML = '';
        productSelect.disabled = false;
        priceDisplay.innerText = '';

        // Cek Data API
        if(!globalProducts || globalProducts.length === 0) {
             productSelect.innerHTML = '<option>Data Belum Siap (Cek Koneksi)</option>';
             window.initProductData(); 
             return;
        }

        // LOGIKA FILTER PINTAR (DARI INDEX 41)
        const filtered = globalProducts.filter(p => {
            // MAPPING DATA API KHFY
            const code = (p.code || p.kode_produk || p.buyer_sku_code || '').toUpperCase();
            const name = (p.name || p.nama_produk || p.product_name || '').toUpperCase();
            const brand = (p.brand || p.kode_provider || p.operator || '').toUpperCase();
            
            // 1. FILTER KHUSUS
            if (providerCode === 'XDA') return code.includes('XDA') || name.includes('XDA') || (name.includes('AKRAB') && name.includes('XTRA'));
                        if (providerCode === 'XLA') return (code.includes('XLA') || name.includes('XLA') || (name.includes('AKRAB') && !name.includes('XTRA'))) && !name.toUpperCase().includes('HARI');
            if (providerCode === 'FMX') return code.includes('FMX') || name.includes('FLEX') || name.includes('UNLIMITED');
            if (providerCode === 'PLN') return brand.includes('PLN') || code.includes('PLN') || name.includes('TOKEN');

            // 2. FILTER UMUM
            return brand.includes(providerCode) || name.includes(providerCode) || code.includes(providerCode);
        });

        if(filtered.length === 0) {
            productSelect.innerHTML = `<option>Produk Tidak Ditemukan (${providerCode})</option>`;
            productSelect.disabled = true;
            return;
        }

        // Urutkan Harga
        filtered.sort((a, b) => {
            const priceA = a.price || a.harga_final || a.buyer_price || 0;
            const priceB = b.price || b.harga_final || b.buyer_price || 0;
            return priceA - priceB;
        });

                // Render Option
        productSelect.innerHTML = '<option value="" selected disabled>-- Pilih Produk --</option>';
        filtered.forEach(p => {
            let price = p.price || p.harga_final || p.buyer_price || 0;
            const code = p.code || p.kode_produk || p.buyer_sku_code;
            const name = p.name || p.nama_produk || p.product_name;
            
            // LOGIKA MODIFIKASI: Terapkan Markup Admin
            if(pricingRules[code]) {
                price += parseInt(pricingRules[code]);
            }
            
            let isGangguan = false;
            if (p.gangguan === 1 || p.gangguan === '1') isGangguan = true;
            if (p.kosong === 1 || p.kosong === '1') isGangguan = true;
            if (String(p.buyer_product_status) === '0') isGangguan = true;
            
            const opt = document.createElement('option');
            opt.value = code;
            opt.text = `${name} - Rp ${window.formatRp(price)}`;
            opt.dataset.price = price;
            opt.dataset.name = name;
            
            if(isGangguan) {
                opt.text += ' (GANGGUAN)';
                opt.disabled = true;
                opt.style.color = 'red';
            }
            productSelect.appendChild(opt);
        });

        // Event Ganti Produk
        productSelect.onchange = function() {
             const selectedOpt = this.options[this.selectedIndex];
             priceDisplay.innerText = `Harga: Rp ${window.formatRp(selectedOpt.dataset.price)}`;
        };
    };
        const priceDisplay = document.getElementById('priceDisplay');
        

        window.processFormTransaction = () => {
        const productSelect = document.getElementById('formProduct');
        const destNum = document.getElementById('ppobNumber').value;

        if(!productSelect.value) return alert('Silakan pilih Produk!');
        if(destNum.length < 5) return alert('Masukkan Nomor Tujuan yang valid!');

        const selectedOpt = productSelect.options[productSelect.selectedIndex];
        const code = productSelect.value;
        const name = selectedOpt.dataset.name;
        const price = parseInt(selectedOpt.dataset.price);

        // LOGIKA KHUSUS CEK PLN
        if (code === 'CEKPLN') {
            window.checkPLN(destNum);
            return;
        }

        window.confirmTransaction(code, name, price);
    };

    window.checkPLN = async (num) => {
        window.showLoader(true);
        const reffId = crypto.randomUUID();
        const result = await callApi('/trx', { produk: 'CEKPLN', tujuan: num, reff_id: reffId });
        window.showLoader(false);

        if (result.ok && result.data) {
            const data = result.data.data || result.data;
            const msg = (data.message || data.sn || '').toLowerCase();
            const status = data.status;
            
            // Logika Deteksi Valid/Invalid
            const isSuccess = (status === true || status === 'success' || String(data.success) === 'true');
            const isDataFound = msg.includes('tagihan') || msg.includes('lembar') || msg.includes('nama') || msg.includes('tarif');

            if (isSuccess || isDataFound) {
                let displayMsg = (data.message || data.sn).replace(/\//g, '\n');
                window.customConfirm('TAGIHAN DITEMUKAN', `Detail Pelanggan:\n------------------\n${displayMsg}\n\n(Saldo aman, ini hanya pengecekan)`, () => {});
            } else {
                alert('PENGGUNA TIDAK TERDAFTAR\n\nSilakan periksa kembali Nomor ID Pelanggan PLN anda.');
            }
        } else {
            alert('Gagal Terhubung ke Server:\n' + result.error);
        }
    };

    window.confirmTransaction = (code, name, price) => {
        if(currentBalance < price) return alert('Saldo Aplikasi Kurang! (Top Up Manual dulu)'); 

        window.customConfirm('Beli Produk?', `${name}\nHarga: ${window.formatRp(price)}`, () => {
            const num = document.getElementById('ppobNumber').value;
            window.executeApiTransaction(code, num, price, name);
        });
    };

        window.showInvoice = (code, name, price, dest) => {
        const fmtPrice = window.formatRp(price);
        document.getElementById('invTotalMain').innerText = fmtPrice;
        document.getElementById('invTotalBottom').innerText = fmtPrice;
        document.getElementById('invProductName').innerText = name;
        document.getElementById('invDestNum').innerText = dest;
        document.getElementById('invPrice').innerText = fmtPrice;
        
        const btnPay = document.getElementById('btnPayInvoice');
        // Bersihkan event listener lama dengan clone node jika perlu, atau cukup reassign onclick
        btnPay.onclick = () => {
            window.closeInvoice();
            window.executeApiTransaction(code, dest, price, name);
        };

        document.getElementById('invoiceModal').classList.remove('hide');
    };

    window.closeInvoice = () => document.getElementById('invoiceModal').classList.add('hide');

    // Redefine confirmTransaction untuk menggunakan Invoice
    window.confirmTransaction = (code, name, price) => {
        if(currentBalance < price) return alert('Saldo Aplikasi Kurang! (Top Up Manual dulu)'); 
        const num = document.getElementById('ppobNumber').value;
        window.showInvoice(code, name, price, num);
    };


window.executeApiTransaction = async (code, dest, price, name) => {
        window.showLoader(true);
        const reffId = crypto.randomUUID();

        // HIT API TRX
        const result = await callApi('/trx', {
            produk: code,
            tujuan: dest,
            reff_id: reffId
        });

        window.showLoader(false);

        if(result.ok && result.data) {
            const d = result.data;
            // AMBIL PESAN MENTAH
            let msg = d.message || d.msg || d.sn || d.error || (d.data ? (d.data.message || d.data.msg || d.data.sn) : null) || 'Tidak ada respon server';
            
            // CLEANUP PESAN (Hapus URL parameter sensitif)
            // Jika formatnya: "url... #PesanError @Tanggal"
            if (typeof msg === 'string') {
                if (msg.includes('#')) {
                    msg = msg.split('#')[1]; // Ambil setelah tanda pagar
                }
                if (msg.includes('@')) {
                    msg = msg.split('@')[0]; // Hapus tanggal di belakang
                }
                msg = msg.trim();
            }
            
            // CEK STATUS SUKSES
            const isSuccess = d.status === true || d.success === true || d.status === 'success' || (d.data && d.data.status === 'Pending');

            if(isSuccess) { 
                // UPDATE BALANCE
                const newBal = currentBalance - price;
                updateDoc(doc(db, "users", currentUser.uid), { balance: newBal });
                
                // SAVE HISTORY
                addDoc(collection(db, "users", currentUser.uid, "history"), {
                    title: name,
                    amount: price,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Sukses',
                    api_msg: msg,
                    trx_id: reffId
                });

                alert(`Sukses!\nInfo: ${msg}`);
                window.nav('homePage');
            } else {
                // TAMPILKAN PESAN BERSIH
                alert(`Transaksi Gagal!\nAlasan: ${msg}`);
            }
        } else {
            alert(`Gagal Koneksi: ${result.error}`);
        }
    };

    // Topup Logic
    window.openTopUpSheet = () => document.getElementById('topUpSheet').classList.remove('hide');
    window.closeTopUp = () => document.getElementById('topUpSheet').classList.add('hide');
        window.checkAkrabStock = async () => {
        window.showLoader(true);
        const targetUrl = "https://panel.khfy-store.com/api_v3/cek_stock_akrab";
        let data = null;

        // Loop Proxy untuk menembus blokir/cors (Menggunakan PROXY_LIST global)
        for (const proxy of PROXY_LIST) {
            try {
                const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const res = await fetch(fullUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if(res.ok) {
                    const json = await res.json();
                    if(json.ok || json.message === "success") {
                        data = json.data;
                        break; // Berhasil, stop loop
                    }
                }
            } catch(e) { console.log("Proxy skip:", e); }
        }

        window.showLoader(false);

        if(data && Array.isArray(data)) {
            let html = '';
            data.forEach(item => {
                 const isAvail = item.sisa_slot > 0;
                 html += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                             <p class="text-xs font-bold text-gray-800 dark:text-white uppercase">${item.nama}</p>
                             <span class="text-[9px] px-1.5 py-0.5 rounded ${isAvail ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} font-bold">${item.type}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-black ${isAvail ? 'text-blue-600 dark:text-blue-400' : 'text-gray-300'}">${item.sisa_slot}</p>
                        <p class="text-[9px] text-gray-400">Slot</p>
                    </div>
                 </div>`;
            });
            document.getElementById('stockList').innerHTML = html;
            document.getElementById('stockModal').classList.remove('hide');
        } else {
            alert("Gagal mengambil data stok. Pastikan koneksi internet stabil.");
        }
    };
    window.closeStockModal = () => document.getElementById('stockModal').classList.add('hide');


window.processTopUp = (method) => {
        window.closeTopUp();
        if(method === 'manual') {
            const newBal = currentBalance + 50000;
            updateDoc(doc(db, "users", currentUser.uid), { balance: newBal });
            alert("Top Up Berhasil +50.000");
        }
    };

</script>
</body>
</html>