<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DompetKu - Firebase Full UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- Base Styles --- */
        body { font-family: 'Inter', 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); overflow-x: hidden; padding-bottom: 90px; }
        
        /* Theme Colors */
        body { background-color: #f8fafc; }
        .app-container { background-color: #ffffff; }
        html.dark body { background-color: #111827; } 
        html.dark .app-container { background-color: #030712; box-shadow: 0 0 25px rgba(0,0,0,0.5); } 
        
        /* Utilities */
        .hide { display: none !important; }
        .page { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }

        .bg-gradient-brand { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        html.dark .bg-gradient-brand { background: linear-gradient(135deg, #1d4ed8 0%, #172554 100%); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .input-group { position: relative; }
        .input-group i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; z-index: 10;}
        .input-group input:focus + i { color: #2563eb; }
        .input-group input { padding-left: 44px; transition: all 0.3s; }
        html.dark .input-group i { color: #6b7280; }
        html.dark .input-group input:focus + i { color: #60a5fa; }

        /* QRIS Button */
        .qris-btn-container { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .qris-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3); border: 2px solid white; }
        html.dark .qris-btn { border-color: #1f2937; }

        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-container transition-colors duration-300">

    <div id="globalLoader" class="hide fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 p-5 rounded-2xl flex flex-col items-center shadow-2xl">
            <div class="loader mb-3"></div>
            <p class="text-xs font-bold text-gray-600 dark:text-gray-300">Memuat Data...</p>
        </div>
    </div>

    <div id="customConfirmModal" class="hide fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fas fa-question text-2xl"></i></div>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1" id="confirmTitle">Konfirmasi</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400" id="confirmMessage">Apakah anda yakin?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 font-semibold text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition">Batal</button>
                <button id="confirmYesBtn" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-semibold text-sm shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <div id="invoiceModal" class="hide fixed inset-0 z-[120] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-enter">
        <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden relative">
            <div class="p-6 relative bg-white">
                <div class="text-center mb-6">
                    <div class="w-12 h-12 bg-gray-900 text-white rounded-full flex items-center justify-center mx-auto mb-3 text-xl shadow-lg"><i class="fas fa-receipt"></i></div>
                    <h3 class="font-black text-gray-800 text-xl tracking-wider uppercase">INVOICE</h3>
                    <p class="text-[10px] text-gray-400 font-mono mt-1" id="invDate">DD/MM/YYYY HH:MM</p>
                </div>
                <div class="border-b-2 border-dashed border-gray-300 mb-5"></div>
                <div class="space-y-3 mb-5">
                    <div class="flex justify-between text-xs"><span class="text-gray-500 font-medium">Produk</span><span class="font-bold text-gray-800 text-right w-3/5 leading-tight" id="invProduct">-</span></div>
                    <div class="flex justify-between text-xs"><span class="text-gray-500 font-medium">Harga Satuan</span><span class="font-bold text-gray-800" id="invPrice">-</span></div>
                    <div class="flex justify-between text-xs"><span class="text-gray-500 font-medium">Jml. Nomor</span><span class="font-bold text-gray-800" id="invCount">-</span></div>
                </div>
                <div class="bg-gray-50 rounded-xl p-3 mb-5 border border-gray-100 max-h-32 overflow-y-auto no-scrollbar">
                     <div class="flex justify-between items-center mb-2"><p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Daftar Tujuan</p><p class="text-[10px] font-bold text-blue-500" id="invStatusHeader">PENDING</p></div>
                     <div id="invNumList" class="space-y-2 text-xs font-mono text-gray-600"></div>
                </div>
                <div class="border-t-2 border-dashed border-gray-300 pt-4 mb-6">
                     <div class="flex justify-between items-end"><span class="text-xs font-bold text-gray-500">TOTAL BAYAR</span><span class="text-2xl font-black text-gray-900" id="invTotal">Rp 0</span></div>
                </div>
                <div id="invActionBtns">
                    <button onclick="processFinalPayment()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition-transform active:scale-95 flex justify-center items-center gap-2"><span>BAYAR SEKARANG</span> <i class="fas fa-check-circle"></i></button>
                    <button onclick="closeInvoice()" class="w-full mt-3 text-gray-400 text-xs font-bold hover:text-gray-600 py-2">Batal Transaksi</button>
                </div>
                <div id="invCloseBtn" class="hide">
                     <button onclick="closeInvoice()" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg transition-transform active:scale-95">Tutup / Cetak Struk</button>
                </div>
            </div>
            <div class="h-2 bg-[repeating-linear-gradient(45deg,#fff,#fff_10px,#f3f4f6_10px,#f3f4f6_20px)]"></div>
        </div>
    </div>

    <div id="topUpSheet" class="hide fixed inset-0 z-50 flex flex-col justify-end bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-full rounded-t-[30px] p-6 modal-enter max-w-[480px] mx-auto">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Pilih Metode Top Up</h3>
            <div class="space-y-3">
                <div onclick="processTopUp('manual')" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition">
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="flex-1"><h4 class="font-bold text-gray-800 dark:text-white text-sm">Manual (Simulasi)</h4><p class="text-xs text-gray-500">Isi saldo +50.000 (Firebase)</p></div><i class="fas fa-chevron-right text-gray-300"></i>
                </div>
                <div onclick="processTopUp('qris')" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition">
                    <div class="w-10 h-10 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><i class="fas fa-qrcode"></i></div>
                    <div class="flex-1"><h4 class="font-bold text-gray-800 dark:text-white text-sm">QRIS Scan</h4><p class="text-xs text-gray-500">Scan QR Code</p></div><i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            </div>
            <button onclick="closeTopUp()" class="mt-6 w-full py-3 text-gray-500 dark:text-gray-400 font-semibold text-sm">Tutup</button>
        </div>
    </div>

    <section id="loginPage" class="page flex flex-col justify-between min-h-screen bg-white dark:bg-gray-950 relative z-50">
        <div class="absolute top-0 left-0 w-full h-[45vh] bg-gradient-brand rounded-b-[50px] z-0"></div>
        <div class="relative z-10 px-8 pt-20 w-full">
            <div class="text-center mb-8 text-white">
                <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg border border-white/30"><i class="fas fa-wallet text-4xl text-white"></i></div>
                <h1 class="text-3xl font-bold tracking-tight">DompetKu</h1>
                <p class="text-blue-100 text-sm mt-1">Firebase Edition</p>
            </div>
            
            <div class="bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-xl shadow-blue-900/10 dark:shadow-black/30">
                <div class="flex bg-gray-100 dark:bg-gray-800 rounded-xl p-1 mb-6">
                    <button id="tabEmail" onclick="switchLoginMode('email')" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400 transition-all">Email</button>
                    <button id="tabPhone" onclick="switchLoginMode('phone')" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">No. HP</button>
                </div>

                <div id="loginFormContainer" class="space-y-4">
                    <div class="input-group">
                        <input type="email" id="emailInput" placeholder="Email" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11">
                        <i class="fas fa-envelope" id="loginIcon"></i>
                    </div>
                    <div class="input-group" id="passContainer">
                        <input type="password" id="passwordInput" placeholder="Kata Sandi" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11">
                        <i class="fas fa-lock"></i>
                    </div>
                    <div id="otpContainer" class="hide space-y-4">
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 text-xs text-blue-800 dark:text-blue-300">Kode OTP dikirim. Masukkan kode 6 digit.</div>
                        <input type="number" id="otpInput" placeholder="123456" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg font-bold tracking-widest">
                    </div>

                    <div id="recaptcha-container"></div>
                    <button id="btnLogin" class="w-full bg-blue-600 dark:bg-blue-500 text-white h-12 rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-transform hover:bg-blue-700 mt-2">MASUK</button>
                    <button id="btnVerifyOtp" class="hide w-full bg-green-600 text-white h-12 rounded-xl font-bold shadow-lg shadow-green-500/30 active:scale-95 transition-transform hover:bg-green-700 mt-2">VERIFIKASI OTP</button>
                </div>
                <p class="text-center text-xs text-gray-400 mt-6" id="statusMessage">Aman & Terenkripsi oleh Firebase</p>
            </div>
        </div>
    </section>

    <section id="homePage" class="page hide bg-gray-50/50 dark:bg-gray-950">
        <div class="bg-gradient-brand text-white pt-8 pb-24 px-6 rounded-b-[40px] shadow-lg relative overflow-hidden">
            <div class="flex justify-between items-center mb-6 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border-2 border-white/30 p-0.5"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full rounded-full bg-white dark:bg-gray-800"></div>
                    <div><p class="text-xs text-blue-100">Selamat Pagi,</p><p class="font-bold text-lg leading-tight" id="headerUsername">Loading...</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur flex items-center justify-center hover:bg-white/30 transition active:scale-95"><i id="themeIcon" class="fas fa-moon text-white"></i></button>
                </div>
            </div>
        </div>
        <div class="mx-6 -mt-24 relative z-20">
            <div class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl rounded-[2.5rem] p-5 shadow-[0_20px_40px_-15px_rgba(37,99,235,0.2)] dark:shadow-none border border-white/50 dark:border-gray-700 relative overflow-hidden group">
                <div class="flex justify-between items-start mb-3 relative">
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-1 flex items-center gap-1.5"><i class="fas fa-wallet text-blue-500"></i> Total Saldo</p>
                        <h2 class="text-[2.2rem] font-black text-gray-800 dark:text-white leading-none tracking-tight" id="displayBalance">Rp 0</h2>
                    </div>
                    <button onclick="initProductData()" class="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-800 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center shadow-sm"><i class="fas fa-sync-alt text-xs"></i></button>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div class="text-center group/btn cursor-pointer" onclick="openTopUpSheet()"><div class="w-11 h-11 mx-auto bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-600/30 mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-plus text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Top Up</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="alert('Segera Hadir')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-paper-plane text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Kirim</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="alert('Segera Hadir')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-arrow-down text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Minta</span></div>
                    <div class="text-center group/btn cursor-pointer" onclick="alert('Lainnya...')"><div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fas fa-qrcode text-base"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Lainnya</span></div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 px-6">
            <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm">Layanan</h3>
            <div class="grid grid-cols-4 gap-4">
                <div class="text-center group cursor-pointer" onclick="openPPOB('akrab')">
                    <div class="bg-blue-100 dark:bg-blue-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-users text-blue-600 dark:text-blue-400 text-2xl"></i></div>
                    <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">XL Akrab</span>
                </div>
                
                <div class="text-center group cursor-pointer" onclick="alert('Menu Paket OTP Segera Hadir')">
                    <div class="bg-emerald-100 dark:bg-emerald-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-key text-emerald-600 dark:text-emerald-400 text-2xl"></i></div>
                    <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Paket OTP</span>
                </div>
                
                <div class="text-center group cursor-pointer" onclick="alert('Menu Pre-Order Segera Hadir')">
                    <div class="bg-purple-100 dark:bg-purple-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-clock text-purple-600 dark:text-purple-400 text-2xl"></i></div>
                    <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Pre-Order</span>
                </div>
                
                <div class="text-center group cursor-pointer" onclick="alert('Menu Reg. Kartu Segera Hadir')">
                    <div class="bg-orange-100 dark:bg-orange-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-id-card text-orange-600 dark:text-orange-400 text-2xl"></i></div>
                    <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Reg. Kartu</span>
                </div>
                
                <div class="text-center group cursor-pointer" onclick="alert('Menu Login OTP Segera Hadir')">
                    <div class="bg-rose-100 dark:bg-rose-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-lock text-rose-600 dark:text-rose-400 text-2xl"></i></div>
                    <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Login OTP</span>
                </div>
                
                <div class="text-center group cursor-pointer" onclick="nav('historyPage')">
                    <div class="bg-indigo-100 dark:bg-indigo-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fas fa-history text-indigo-600 dark:text-indigo-400 text-2xl"></i></div>
                    <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Riwayat</span>
                </div>
            </div>
        </div>

        <div class="mt-8 bg-white dark:bg-gray-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)] dark:shadow-[0_-5px_20px_rgba(0,0,0,0.2)] p-6 min-h-[300px]">
            <div class="flex justify-between items-end mb-4"><h3 class="font-bold text-gray-800 dark:text-white">Transaksi Terakhir</h3><span class="text-xs text-blue-600 dark:text-blue-400 font-semibold cursor-pointer" onclick="nav('historyPage')">Lihat Semua</span></div>
            <div id="miniHistory" class="space-y-4"></div>
        </div>
    </section>

    <section id="ppobPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
            <button onclick="closePPOB()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fas fa-arrow-left text-gray-800 dark:text-white"></i></button>
            <h2 class="font-bold text-lg text-gray-800 dark:text-white" id="ppobTitle">Isi Pulsa (Live API)</h2>
        </div>
        <div class="p-4 pb-24">
            <div id="inputSection" class="transition-all duration-300">
                <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1"><label class="block text-xs font-bold text-gray-500 ml-1">Provider</label><button onclick="initProductData()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100"><i class="fas fa-sync-alt mr-1"></i> Refresh Data</button></div>
                        <div class="relative">
                            <select id="formProvider" onchange="updateProductDropdown()" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold"><option value="" disabled selected>-- Pilih Provider --</option><option value="XDA">Akrab Fresh (XDA)</option><option value="XLA">Akrab Fresh (XLA)</option><option value="FMX">FlexMax (FMX)</option><option value="PLN">PLN Pascabayar</option></select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Produk</label>
                        <div class="relative">
                            <select id="formProduct" disabled class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 text-sm rounded-xl px-4 py-3 appearance-none font-medium transition-colors"><option value="">Menunggu Provider...</option></select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="priceDisplay"></p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
                        <div class="input-group" id="singleNumContainer">
                            <input type="tel" id="ppobNumber" placeholder="Nomor HP / ID Pelanggan" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
                            <i class="fas fa-address-book text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 z-10"></i>
                        </div>
                        <div id="multiNumContainer" class="hide space-y-2 mt-2"></div>
                        <button id="btnAddNum" onclick="addMultiInput()" class="hide mt-2 w-full py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl text-xs font-bold border border-blue-200 dark:border-blue-800 border-dashed hover:bg-blue-100 dark:hover:bg-blue-900/40 transition"><i class="fas fa-plus mr-1"></i> Tambah Nomor Tujuan</button>
                    </div>
                    <button onclick="processFormTransaction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span><i class="fas fa-arrow-right"></i></button>
                    <div class="flex items-center gap-2 mt-4 cursor-pointer p-1" onclick="toggleMultiTrx()">
                        <div id="multiTrxCheck" class="w-5 h-5 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-white transition-colors"><i class="fas fa-check text-[10px] opacity-0 transition-opacity"></i></div>
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400 select-none">Aktifkan Multi Transaksi (Banyak Nomor)</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="historyPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-10 shadow-sm dark:shadow-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg text-gray-800 dark:text-white">Riwayat (Firebase)</h2>
                <div class="flex gap-2">
                    <button onclick="downloadHistoryPDF()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                </div>
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="filterHistory('all')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white shadow-md" id="filter-all">Semua</button>
                <button onclick="filterHistory('today')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-gray-100 text-gray-500" id="filter-today">Hari Ini</button>
                <button onclick="filterHistory('week')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-gray-100 text-gray-500" id="filter-week">Minggu Ini</button>
            </div>
        </div>
        <div id="fullHistory" class="p-4 space-y-3 pb-24"></div>
    </section>

    <section id="profilePage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
        <div class="bg-gradient-brand text-white p-6 pb-12 rounded-b-[40px] text-center shadow-lg relative transition-colors">
            <div class="w-24 h-24 bg-white dark:bg-gray-900 p-1 rounded-full mx-auto mb-4 shadow-xl transition-colors"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full rounded-full bg-gray-100 dark:bg-gray-800"></div>
            <h2 class="text-xl font-bold" id="profileName">Dev User</h2><p class="text-blue-200 text-sm" id="profilePhone">-</p>
            <div class="mt-4 inline-flex items-center bg-blue-800/50 dark:bg-blue-900/50 backdrop-blur px-4 py-1.5 rounded-full text-xs font-semibold border border-blue-400/30"><i class="fas fa-crown text-yellow-400 mr-2"></i> Firebase Connected</div>
        </div>
        <div class="px-6 -mt-6 pb-24 relative z-10">
            <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-black/30 overflow-hidden transition-colors">
                 <div onclick="handleLogout()" class="p-4 flex items-center gap-4 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer transition-colors group"><div class="w-9 h-9 rounded-full bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400 group-hover:bg-red-100 dark:group-hover:bg-red-900/50 flex items-center justify-center transition-colors"><i class="fas fa-sign-out-alt text-sm"></i></div><div class="flex-1 text-sm font-bold text-red-500 dark:text-red-400">Keluar</div></div>
            </div>
        </div>
    </section>

    <section id="scanPage" class="page hide bg-black min-h-screen text-white flex flex-col fixed top-0 w-full max-w-[480px] z-50">
        <div class="flex justify-between items-center p-4 absolute top-0 w-full z-10">
            <button onclick="stopScan()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-times"></i></button>
            <h2 class="font-bold">Scan QRIS</h2>
            <button class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-bolt"></i></button>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div id="reader" class="rounded-3xl overflow-hidden border-2 border-white/50 shadow-2xl"></div>
            <div class="absolute bottom-32 text-center pointer-events-none"><p class="text-sm font-medium bg-black/40 px-4 py-1 rounded-full">Arahkan kamera ke kode QRIS</p></div>
        </div>
    </section>

    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 flex justify-around items-end pb-4 pt-3 text-[10px] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-40 hide rounded-t-3xl">
        <div class="text-center cursor-pointer w-1/5 nav-item text-blue-600 dark:text-blue-400 group" id="nav-home" onclick="nav('homePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-home text-xl"></i></div><p class="font-medium">Beranda</p></div>
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-buy" onclick="openPPOB('akrab')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-shopping-cart text-xl"></i></div><p class="font-medium">Beli</p></div>
        <div class="text-center w-1/5 qris-btn-container cursor-pointer" onclick="openTopUpSheet()"><div class="qris-btn w-11 h-11 rounded-full flex items-center justify-center mx-auto text-white transform transition hover:scale-105 active:scale-95 mb-1"><i class="fas fa-plus text-lg"></i></div><p class="font-bold text-gray-700 dark:text-gray-400">Top Up</p></div>
        
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-preorder" onclick="alert('Menu PreOrder Segera Hadir')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-clipboard-list text-xl"></i></div><p class="font-medium">PreOrder</p></div>
        
        <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-profile" onclick="nav('profilePage')"><div class="mb-1 transition group-hover:-translate-y-1"><i class="fas fa-user text-xl"></i></div><p class="font-medium">Saya</p></div>
    </nav>
</div>

<script type="module">
    // --- IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInWithPhoneNumber, RecaptchaVerifier, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyC7vP4QUhxPM3wG_jsnA2Z8dsTYd2IJ1KA",
        authDomain: "server-ppob-xl.firebaseapp.com",
        projectId: "server-ppob-xl",
        storageBucket: "server-ppob-xl.firebasestorage.app",
        messagingSenderId: "197244150476",
        appId: "1:197244150476:web:23b3448b65ea5dc66c5869",
        measurementId: "G-55M9H4WRGY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    auth.languageCode = 'id';

    // --- VARIABLES STATE ---
    let currentUser = null;
    let currentBalance = 0;
    let transactions = [];
    let globalProducts = [];
    let pendingTrxData = null;
    let confirmationResult = null; // OTP
    let loginMode = 'email';
    let isMultiTrx = false;
    let currentFilter = 'all';
    let scanner = null;

    // --- API CONFIG ---
    const CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };
    const PROXY_LIST = [{ name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' }, { name: 'CorsProxy', url: 'https://corsproxy.io/?' }, { name: 'Direct', url: '' }];

    // --- AUTH OBSERVER (AUTO LOGIN) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            console.log("Logged In:", user.uid);
            setupUserData(user);
            window.nav('homePage');
        } else {
            currentUser = null;
            console.log("Logged Out");
            window.nav('loginPage');
        }
    });

    // --- DATABASE LISTENER (REALTIME) ---
    function setupUserData(user) {
        // 1. Listen Saldo
        onValue(ref(db, 'users/' + user.uid + '/info/balance'), (snapshot) => {
            currentBalance = snapshot.val() || 0;
            if(document.getElementById('displayBalance')) document.getElementById('displayBalance').innerText = window.formatRp(currentBalance);
        });

        // 2. Listen Riwayat
        onValue(ref(db, 'users/' + user.uid + '/history'), (snapshot) => {
            const data = snapshot.val();
            transactions = data ? Object.values(data) : [];
            // Sort Date Descending
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderHistoryList();
            
            const displayName = user.displayName || user.email || user.phoneNumber || "Pengguna";
            document.getElementById('headerUsername').innerText = displayName.length > 15 ? displayName.substring(0,12)+'...' : displayName;
            document.getElementById('profileName').innerText = displayName;
            document.getElementById('profilePhone').innerText = user.email || user.phoneNumber;
        });
    }

    // --- WINDOW FUNCTIONS (GLOBAL ACCESS) ---
    
    // 1. Navigation
    window.nav = (pageId) => {
        document.querySelectorAll('.page').forEach(el => el.classList.add('hide'));
        document.getElementById(pageId).classList.remove('hide');
        document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-blue-600', 'dark:text-blue-400'); el.classList.add('text-gray-400', 'dark:text-gray-500'); });
        const navId = 'nav-' + pageId.replace('Page','');
        if(document.getElementById(navId)) { document.getElementById(navId).classList.remove('text-gray-400', 'dark:text-gray-500'); document.getElementById(navId).classList.add('text-blue-600', 'dark:text-blue-400'); }
        if(pageId === 'loginPage' || pageId === 'scanPage') document.getElementById('bottomNav').classList.add('hide'); else document.getElementById('bottomNav').classList.remove('hide');
        if(pageId === 'homePage') renderHistoryList();
    };

    // 2. Login Logic
    window.switchLoginMode = (mode) => {
        loginMode = mode;
        const btn = document.getElementById('btnLogin');
        const emailIn = document.getElementById('emailInput');
        const passCont = document.getElementById('passContainer');
        const icon = document.getElementById('loginIcon');
        const tabEmail = document.getElementById('tabEmail');
        const tabPhone = document.getElementById('tabPhone');
        
        tabEmail.className = mode === 'email' ? 'flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600' : 'flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200';
        tabPhone.className = mode === 'phone' ? 'flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600' : 'flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200';

        if(mode === 'email'){
            emailIn.placeholder = "Email"; emailIn.type = "email"; icon.className="fas fa-envelope";
            passCont.classList.remove('hide'); btn.innerText = "MASUK";
        } else {
            emailIn.placeholder = "No. HP (+628...)"; emailIn.type = "tel"; icon.className="fas fa-phone";
            passCont.classList.add('hide'); btn.innerText = "KIRIM OTP";
            if(!window.recaptchaVerifier) window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
        }
    };

    document.getElementById('btnLogin').addEventListener('click', async () => {
        const inputVal = document.getElementById('emailInput').value;
        const passVal = document.getElementById('passwordInput').value;
        const status = document.getElementById('statusMessage');

        if(!inputVal) return alert("Isi data login!");
        status.innerText = "Memproses...";

        if(loginMode === 'email') {
            if(!passVal) return alert("Isi password!");
            try { await signInWithEmailAndPassword(auth, inputVal, passVal); }
            catch(e) { alert("Login Gagal: " + e.message); status.innerText = "Gagal"; }
        } else {
            let phone = inputVal.startsWith('0') ? '+62' + inputVal.slice(1) : inputVal;
            try {
                confirmationResult = await signInWithPhoneNumber(auth, phone, window.recaptchaVerifier);
                document.getElementById('otpContainer').classList.remove('hide');
                document.getElementById('btnLogin').classList.add('hide');
                document.getElementById('btnVerifyOtp').classList.remove('hide');
                status.innerText = "OTP Terkirim";
            } catch(e) { alert("Gagal Kirim OTP: " + e.message); status.innerText = "Error"; window.recaptchaVerifier.clear(); }
        }
    });

    document.getElementById('btnVerifyOtp').addEventListener('click', async () => {
        const code = document.getElementById('otpInput').value;
        try { await confirmationResult.confirm(code); } 
        catch(e) { alert("OTP Salah!"); }
    });

    window.handleLogout = () => { if(confirm("Keluar akun?")) signOut(auth); };

    // 3. Top Up Logic (Firebase Write + History)
    window.openTopUpSheet = () => document.getElementById('topUpSheet').classList.remove('hide');
    window.closeTopUp = () => document.getElementById('topUpSheet').classList.add('hide');
    
    window.processTopUp = (method) => {
        window.closeTopUp();
        if(!currentUser) return;
        if(method === 'qris') { window.startScan(); return; }

        if (method === 'manual') {
            const amount = 50000;
            const newBal = currentBalance + amount;
            const trxId = 'TOPUP-' + Date.now();
            
            // Update Saldo
            update(ref(db, 'users/' + currentUser.uid + '/info'), { balance: newBal });
            
            // Update Riwayat (Pastikan tipe 'in')
            push(ref(db, 'users/' + currentUser.uid + '/history'), {
                title: 'Top Up Manual', amount: amount, type: 'in', date: new Date().toISOString(), status: 'Sukses', api_msg: 'Simulasi via Firebase', trx_id: trxId
            });
            alert('Top Up Berhasil (+50rb) & Tersimpan di Riwayat');
        }
    };

    // 4. API & Transaction Logic
    window.openPPOB = (cat) => {
        document.getElementById('homePage').classList.add('hide');
        document.getElementById('ppobPage').classList.remove('hide');
        document.getElementById('bottomNav').classList.add('hide');
        document.getElementById('ppobNumber').value = ''; 
        if(document.getElementById('priceDisplay')) document.getElementById('priceDisplay').innerText = '';
        document.getElementById('formProvider').selectedIndex = 0;
        document.getElementById('formProduct').innerHTML = '<option value="">Menunggu Provider...</option>';
        document.getElementById('formProduct').disabled = true;
        document.getElementById('ppobTitle').innerText = cat === 'akrab' ? 'XL Akrab & Paket' : 'Isi Pulsa / Data';
        isMultiTrx = true; window.toggleMultiTrx(); // Force reset
        window.initProductData();
    };
    window.closePPOB = () => window.nav('homePage');

    window.initProductData = async () => {
        const pSelect = document.getElementById('formProduct');
        pSelect.innerHTML = '<option>Loading...</option>';
        const res = await callApi('/list_product');
        if(res.ok) {
             globalProducts = res.data.data || res.data || res.data.products;
             pSelect.innerHTML = '<option value="">-- Pilih Provider Dulu --</option>';
             if(document.getElementById('formProvider').value) window.updateProductDropdown();
        } else { pSelect.innerHTML = '<option>Gagal Load</option>'; }
    };

    window.updateProductDropdown = () => {
        const provider = document.getElementById('formProvider').value;
        const select = document.getElementById('formProduct');
        const priceDisplay = document.getElementById('priceDisplay');
        const filtered = globalProducts.filter(p => {
            const name = (p.product_name || p.nama_produk || p.name || '').toUpperCase();
            const code = (p.buyer_sku_code || p.kode_produk || p.code || '').toUpperCase();
            const brand = (p.brand || p.kode_provider || '').toUpperCase();
            if(provider === 'XDA') return code.includes('XDA');
            if(provider === 'XLA') return code.includes('XLA');
            if(provider === 'PLN') return code.includes('PLN') || brand.includes('PLN');
            return name.includes(provider) || code.includes(provider);
        });
        select.innerHTML = '<option value="" disabled selected>-- Pilih Produk --</option>';
        select.disabled = false;
        filtered.sort((a,b) => (a.buyer_price || a.price) - (b.buyer_price || b.price));
        filtered.forEach(p => {
            const price = p.buyer_price || p.price;
            const opt = document.createElement('option');
            opt.value = p.buyer_sku_code || p.kode_produk || p.code;
            opt.text = `${p.product_name || p.nama_produk || p.name} - ${window.formatRp(price)}`;
            opt.dataset.price = price;
            opt.dataset.name = p.product_name || p.nama_produk || p.name;
            select.appendChild(opt);
        });
        select.onchange = function() {
             const opt = this.options[this.selectedIndex];
             priceDisplay.innerText = `Harga: ${window.formatRp(opt.dataset.price)}`;
             if(this.value === 'CEKPLN') {
                 const btn = document.querySelector('button[onclick="processFormTransaction()"]');
                 btn.innerHTML = '<span>Cek Tagihan</span> <i class="fas fa-search"></i>';
             }
        };
    };

    window.toggleMultiTrx = () => {
        isMultiTrx = !isMultiTrx;
        const check = document.getElementById('multiTrxCheck');
        const icon = check.querySelector('i');
        const single = document.getElementById('singleNumContainer');
        const multi = document.getElementById('multiNumContainer');
        const btnAdd = document.getElementById('btnAddNum');
        if(isMultiTrx) {
            check.className = 'w-5 h-5 rounded border border-blue-500 bg-blue-500 flex items-center justify-center text-white transition-colors';
            icon.classList.remove('opacity-0');
            single.classList.add('hide'); multi.classList.remove('hide'); btnAdd.classList.remove('hide');
            if(multi.children.length === 0) { window.addMultiInput(); window.addMultiInput(); }
        } else {
            check.className = 'w-5 h-5 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-white transition-colors';
            icon.classList.add('opacity-0');
            single.classList.remove('hide'); multi.classList.add('hide'); btnAdd.classList.add('hide');
        }
    };

    window.addMultiInput = () => {
        const div = document.createElement('div');
        div.className = 'input-group relative animate-fade-in-down mb-2';
        div.innerHTML = `<input type="tel" placeholder="Nomor Tujuan..." class="multi-num-input w-full h-10 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs font-bold pl-9"><i class="fas fa-phone-alt text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 text-xs"></i><i onclick="this.parentElement.remove()" class="fas fa-times absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 cursor-pointer"></i>`;
        document.getElementById('multiNumContainer').appendChild(div);
    };

    window.processFormTransaction = () => {
        const select = document.getElementById('formProduct');
        if(!select.value) return alert("Pilih Produk!");
        
        if (select.value === 'CEKPLN') {
            const dest = document.getElementById('ppobNumber').value;
            if(dest.length < 5) return alert('Isi No. Pelanggan!');
            window.checkPLN(dest);
            return;
        }

        const opt = select.options[select.selectedIndex];
        const price = parseInt(opt.dataset.price);
        let numbers = [];
        if (isMultiTrx) {
            document.querySelectorAll('.multi-num-input').forEach(inp => { if(inp.value.length >= 5) numbers.push(inp.value); });
            if(numbers.length === 0) return alert('Isi minimal 1 nomor!');
        } else {
            const single = document.getElementById('ppobNumber').value;
            if(single.length < 5) return alert('Isi Nomor!');
            numbers.push(single);
        }
        
        pendingTrxData = { code: select.value, name: opt.dataset.name, price: price, numbers: numbers };
        
        // Show Invoice
        document.getElementById('invProduct').innerText = opt.dataset.name;
        document.getElementById('invPrice').innerText = window.formatRp(price);
        document.getElementById('invCount').innerText = numbers.length + ' Nomor';
        document.getElementById('invTotal').innerText = window.formatRp(price * numbers.length);
        const listContainer = document.getElementById('invNumList');
        listContainer.innerHTML = '';
        numbers.forEach(num => { listContainer.innerHTML += `<div class="flex justify-between items-center bg-white border border-gray-200 p-2 rounded"><span>${num}</span><i class="fas fa-clock text-orange-400 status-icon"></i></div>`; });
        document.getElementById('invStatusHeader').innerText = 'MENUNGGU PEMBAYARAN';
        document.getElementById('invActionBtns').classList.remove('hide');
        document.getElementById('invCloseBtn').classList.add('hide');
        document.getElementById('invoiceModal').classList.remove('hide');
    };

    window.closeInvoice = () => document.getElementById('invoiceModal').classList.add('hide');

    window.processFinalPayment = async () => {
        if(!currentUser || !pendingTrxData) return;
        const { code, name, price, numbers } = pendingTrxData;
        const total = price * numbers.length;
        if(currentBalance < total) return alert("Saldo tidak cukup!");

        const btn = document.querySelector('#invActionBtns button');
        btn.innerHTML = 'Memproses...'; btn.disabled = true;

        const listItems = document.getElementById('invNumList').children;
        let successCount = 0;
        let processedBalance = currentBalance;

        for (let i = 0; i < numbers.length; i++) {
            const num = numbers[i];
            const statusIcon = listItems[i].querySelector('.status-icon');
            const reffId = crypto.randomUUID();
            const res = await callApi('/trx', { produk: code, tujuan: num, reff_id: reffId });
            
            let trxStatus = 'Gagal';
            let msg = 'Koneksi Error';
            
            if(res.ok && (res.data.status || res.data.success)) {
                trxStatus = 'Pending'; 
                msg = res.data.message || 'Sukses API';
                processedBalance -= price;
                statusIcon.className = 'fas fa-check-circle text-green-500 status-icon';
                successCount++;
            } else {
                msg = res.data ? (res.data.message || 'Gagal') : res.error;
                statusIcon.className = 'fas fa-times-circle text-red-500 status-icon';
            }

            // Save to Firebase History
            push(ref(db, 'users/' + currentUser.uid + '/history'), {
                title: name, amount: price, type: 'out', date: new Date().toISOString(), status: trxStatus, dest: num, api_msg: msg, trx_id: reffId
            });
        }
        
        // Update Final Balance to Firebase
        update(ref(db, 'users/' + currentUser.uid + '/info'), { balance: processedBalance });
        
        document.getElementById('invStatusHeader').innerText = 'SELESAI DIPROSES';
        document.getElementById('invActionBtns').classList.add('hide');
        document.getElementById('invCloseBtn').classList.remove('hide');
        btn.innerHTML = 'BAYAR SEKARANG'; btn.disabled = false;
    };

    // 5. Check PLN Logic
    window.checkPLN = async (num) => {
        window.showLoader(true);
        const res = await callApi('/trx', { produk: 'CEKPLN', tujuan: num, reff_id: crypto.randomUUID() });
        window.showLoader(false);
        if (res.ok && res.data) {
            const data = res.data.data || res.data;
            const msg = (data.message || data.sn || '').toLowerCase();
            if ((data.status === true || String(data.success) === 'true') || msg.includes('tagihan')) {
                 window.customConfirm('TAGIHAN DITEMUKAN', (data.message || data.sn).replace(/\//g, '\n'), () => {});
            } else { alert('PENGGUNA TIDAK TERDAFTAR'); }
        } else { alert('Gagal Koneksi: ' + res.error); }
    };

    // --- UTILS (QR, PDF, ETC) ---
    window.formatRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    window.showLoader = (show) => document.getElementById('globalLoader').classList.toggle('hide', !show);
    window.toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); };
    window.customConfirm = (t, m, c) => { document.getElementById('confirmTitle').innerText = t; document.getElementById('confirmMessage').innerText = m; document.getElementById('customConfirmModal').classList.remove('hide'); window.confirmCallback = c; };
    window.closeConfirm = (r) => { document.getElementById('customConfirmModal').classList.add('hide'); if(r && window.confirmCallback) window.confirmCallback(); };
    document.getElementById('confirmYesBtn').onclick = () => window.closeConfirm(true);

    // API Caller
    async function callApi(endpoint, params = {}) {
        params['api_key'] = CONFIG.apiKey;
        const qs = new URLSearchParams(params).toString();
        const target = `${CONFIG.baseUrl}${endpoint}?${qs}`;
        for(const proxy of PROXY_LIST) {
            try {
                const res = await fetch(proxy.url + encodeURIComponent(target));
                if(res.ok) return { ok: true, data: await res.json() };
            } catch(e) {}
        }
        return { ok: false, error: "Gagal Koneksi" };
    }

    // QR Logic
    window.startScan = () => { window.nav('scanPage'); scanner = new Html5QrcodeScanner("reader", {fps:10, qrbox:250}, false); scanner.render((t)=>{ alert('QR Code: '+t); window.stopScan(); }, ()=>{}); };
    window.stopScan = () => { if(scanner) scanner.clear(); window.nav('homePage'); };

    // History & PDF
    window.filterHistory = (type) => {
        currentFilter = type;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.className = 'filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-gray-100 text-gray-500');
        document.getElementById('filter-'+type).className = 'filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white shadow-md';
        renderHistoryList();
    };

    function renderHistoryList() {
        const now = new Date();
        const filtered = transactions.filter(t => {
            const d = new Date(t.date);
            if(currentFilter === 'today') return d.toDateString() === now.toDateString();
            if(currentFilter === 'week') return d >= new Date(now.setDate(now.getDate() - 7));
            return true;
        });
        
        let html = '';
        if(filtered.length === 0) html = '<div class="text-center text-gray-400 text-xs py-10">Belum ada transaksi</div>';
        else {
            filtered.forEach(t => {
                const isOut = t.type === 'out';
                const dateStr = new Date(t.date).toLocaleDateString() + ' ' + new Date(t.date).toLocaleTimeString();
                html += `<div class="flex justify-between items-center bg-white dark:bg-gray-900 p-3 rounded-2xl border border-gray-50 dark:border-gray-800 shadow-sm mb-2"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${isOut?'bg-blue-100 text-blue-600':'bg-green-100 text-green-600'}"><i class="fas ${isOut?'fa-shopping-cart':'fa-plus'}"></i></div><div><p class="font-bold text-sm text-gray-800 dark:text-white">${t.title}</p><p class="text-[10px] text-gray-400">${dateStr}</p></div></div><div class="text-right"><p class="text-sm font-bold ${isOut?'text-gray-800 dark:text-white':'text-green-600'}">${isOut?'-':'+'} ${window.formatRp(t.amount)}</p><p class="text-[10px] ${String(t.api_msg).includes('Sukses')?'text-green-500':'text-orange-500'}">${t.status || t.api_msg}</p></div></div>`;
            });
        }
        document.getElementById('fullHistory').innerHTML = html;
        if(document.getElementById('miniHistory')) document.getElementById('miniHistory').innerHTML = html;
    }

    window.downloadHistoryPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Laporan Mutasi DompetKu", 14, 20);
        doc.setFontSize(10);
        doc.text(`User: ${currentUser?.email || '-'} | Tgl: ${new Date().toLocaleString()}`, 14, 28);
        const data = transactions.map(t => [new Date(t.date).toLocaleString(), t.title, window.formatRp(t.amount), t.status]);
        doc.autoTable({ head: [['Tanggal', 'Ket', 'Nominal', 'Status']], body: data, startY: 35 });
        doc.save("Mutasi_DompetKu.pdf");
    };

    // Init
    window.updateUI = () => {}; 
</script>
</body>
</html>