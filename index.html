<!DOCTYPE html>
<html lang="id" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pandawa Store</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
        tailwind.config = { darkMode: 'class' }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); overflow-x: hidden; padding-bottom: 90px; }
        body { background-color: #f8fafc; }
        .app-container { background-color: #ffffff; }
        html.dark body { background-color: #111827; } 
        html.dark .app-container { background-color: #030712; box-shadow: 0 0 25px rgba(0,0,0,0.5); } 
        .hide { display: none !important; }
        .page { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes pop-in { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
  @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        .bg-gradient-brand { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        html.dark .bg-gradient-brand { background: linear-gradient(135deg, #1d4ed8 0%, #172554 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .input-group { position: relative; }
        .input-group i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; z-index: 10;}
        .input-group input:focus + i { color: #2563eb; }
        .input-group input { padding-left: 44px; transition: all 0.3s; }
        .input-group select { padding-left: 44px; transition: all 0.3s; appearance: none; }
        html.dark .input-group i { color: #6b7280; }
        html.dark .input-group input:focus + i { color: #60a5fa; }
        .qris-btn-container { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .qris-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3); border: 2px solid white; }
        html.dark .qris-btn { border-color: #1f2937; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Profile Upload Style */
        .profile-upload { width: 100px; height: 100px; margin: 0 auto; position: relative; cursor: pointer; border-radius: 50%; border: 3px dashed #cbd5e1; overflow: hidden; transition: all 0.3s; }
        .profile-upload:hover { border-color: #2563eb; }
        .profile-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .profile-upload .upload-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #94a3b8; pointer-events: none; }
            /* LIVE CHAT STYLES */
        .chat-float-btn { position: fixed; bottom: 65px; left: 90%; transform: translateX(-50%); z-index: 50; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); transition: all 0.3s; }
        .chat-float-btn:active { transform: scale(0.9); }
        @keyframes floatBounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } }
        
        .chat-window { position: fixed; bottom: 100px; right: 20px; width: 320px; height: 450px; background: white; z-index: 46; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transform-origin: bottom right; transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); border: 1px solid #e2e8f0; }
        html.dark .chat-window { background: #111827; border-color: #374151; }
        .chat-window.hide { transform: scale(0); opacity: 0; pointer-events: none; }
        
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; background-color: #f8fafc; }
        html.dark .chat-body { background-color: #0f172a; }
        
        .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 12px; line-height: 1.4; position: relative; word-wrap: break-word; margin-bottom: 8px; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .chat-me { align-self: flex-end; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-bottom-right-radius: 2px; margin-left: auto; }
        .chat-admin { align-self: flex-start; background: #e2e8f0; color: #1e293b; border-bottom-left-radius: 2px; margin-right: auto; }
        html.dark .chat-admin { background: #374151; color: #f3f4f6; }
            .prov-maintenance { filter: grayscale(100%); opacity: 0.8; background-color: #f3f4f6 !important; border-color: #e5e7eb !important; cursor: not-allowed !important; pointer-events: none; } 
        html.dark .prov-maintenance { background-color: #1f2937 !important; border-color: #374151 !important; } 
        .mt-badge { display: none; font-size: 9px; background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 8px; } 
        .prov-maintenance .mt-badge { display: inline-block; } 
        .prov-maintenance .fa-chevron-right { display: none; }
  </style>
</head>
<body>
  <div class="app-container transition-colors duration-300">
    <div id="toastContainer" class="fixed top-5 right-5 z-[300] flex flex-col gap-2 pointer-events-none transition-all duration-300"></div>
    <div id="customAlertModal" class="hide fixed inset-0 z-[300] flex items-center justify-center bg-black/60 backdrop-blur-sm p-6">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl border border-white/20 dark:border-gray-800 transform transition-all animate-pop-in relative overflow-hidden">
        <div id="alertIconContainer" class="w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <i id="alertIcon" class="text-4xl text-white"></i>
        </div>
        <div class="text-center">
          <h3 id="alertTitle" class="text-xl font-black text-gray-800 dark:text-white mb-2 tracking-tight uppercase"></h3>
          <p id="alertMessage" class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-8 px-2"></p><button onclick="closeAlert()" class="w-full py-4 bg-gradient-brand text-white font-black rounded-2xl shadow-xl shadow-blue-600/30 active:scale-95 transition-all uppercase tracking-wider text-xs">Oke, Mengerti</button>
        </div>
      </div>
    </div>
    <div id="updateNoticeModal" class="hide fixed inset-0 z-[300] flex items-center justify-center bg-black/80 backdrop-blur-md p-6">
      <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl relative border-2 border-orange-500 animate-pop-in">
        <div class="bg-orange-500 p-6 text-center">
          <h3 class="text-xl font-black text-white leading-tight uppercase">PEMBERITAHUAN UPDATE!!</h3>
        </div>
        <div class="p-8">
          <div class="space-y-4 text-sm leading-relaxed">
            <p class="text-gray-600 dark:text-gray-300 font-medium text-center">Dikarenakan server down, sistem telah diperbarui ke server baru.</p>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800">
              <p class="text-blue-700 dark:text-blue-300 text-xs font-bold">User Google:</p>
              <p class="text-gray-600 dark:text-gray-400 text-xs mt-1">Aman. Silakan masuk menggunakan email yang biasa digunakan untuk login.</p>
            </div>
            <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-2xl border-2 border-dashed border-red-200 dark:border-red-800">
              <p class="text-red-600 dark:text-red-400 text-xs font-black uppercase">User Email & Sandi:</p>
              <p class="text-gray-800 dark:text-gray-200 text-xs mt-2 font-bold">Harap DAFTARKAN AKUN ANDA KEMBALI menggunakan <span class="text-red-600 underline">EMAIL YANG SAMA</span> seperti sebelumnya agar saldo tersinkronisasi otomatis.</p>
            </div>
          </div><button onclick="closeUpdateNotice()" class="mt-8 w-full py-4 bg-orange-500 hover:bg-orange-600 text-white font-black rounded-2xl shadow-lg shadow-orange-500/30 transition-all active:scale-95 uppercase tracking-wider text-sm">Saya Mengerti</button>
        </div>
      </div>
    </div>
    <div id="globalNotifModal" class="hide fixed inset-0 z-[250] flex items-center justify-center bg-black/80 backdrop-blur-sm p-6 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative animate-pop-in">
        <div id="gNotifImageArea" class="hide w-full flex justify-center items-center bg-gray-50 dark:bg-gray-800 rounded-xl mb-4 overflow-hidden"><img id="gNotifImg" src="" class="w-auto h-auto max-w-full max-h-[60vh] object-contain shadow-sm rounded-lg" alt=""></div>
        <div class="p-6 text-center">
          <h3 id="gNotifTitle" class="text-xl font-black text-gray-800 dark:text-white mb-2 leading-tight"></h3>
          <p id="gNotifBody" class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed max-h-40 overflow-y-auto custom-scroll"></p><button onclick="closeGlobalNotif()" class="mt-6 w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition">Tutup</button>
        </div>
      </div>
    </div>
    <div id="globalLoader" class="hide fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm">
      <div class="bg-white dark:bg-gray-900 p-5 rounded-2xl flex flex-col items-center shadow-2xl">
        <div class="loader mb-3"></div>
        <p class="text-xs font-bold text-gray-600 dark:text-gray-300" id="loaderText">Memuat Data...</p>
      </div>
    </div>
    <div id="setupProfileModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl overflow-hidden">
        <div class="text-center mb-6">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white">Selamat Datang!</h3>
          <p class="text-xs text-gray-500">Lengkapi data diri Anda untuk melanjutkan.</p>
        </div>
        <div class="space-y-4">
          <div class="text-center mb-4">
            <label for="setupProfilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800"><img id="setupProfilePreview" src="" alt="Profile"></label>
            <div class="upload-placeholder" id="setupUploadPlaceholder">
              <p class="text-[9px]"><label for="setupProfilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800">Foto (Wajib)</label></p>
            </div><input type="file" id="setupProfilePicInput" accept="image/*" class="hidden" onchange="previewImage(this, 'setup')">
          </div>
          <div class="input-group">
            <input type="text" id="setupUsername" placeholder="Buat Username" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white">
          </div>
          <div class="flex gap-2">
            <div class="input-group w-1/2">
              <select id="setupGender" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-xs">
                <option value="" disabled selected>
                  Gender
                </option>
                <option value="Laki-laki">
                  Pria
                </option>
                <option value="Perempuan">
                  Wanita
                </option>
              </select>
            </div>
            <div class="input-group w-1/2">
              <input type="date" id="setupDob" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-xs">
            </div>
          </div><button type="button" onclick="saveProfileSetup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg mt-2">SIMPAN & LANJUTKAN</button>
        </div>
      </div>
    </div>
    <div id="passwordPromptModal" class="hide fixed inset-0 z-[130] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 text-center">Konfirmasi Transaksi</h3>
        <p class="text-xs text-gray-500 text-center mb-4">Ketik <b>"ya"</b> (kecil semua) untuk melanjutkan.</p>
        <div class="input-group mb-4">
          <input type="text" id="confirmPasswordInput" placeholder="Ketik: ya" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-lg font-bold text-center uppercase">
        </div>
        <div class="flex gap-2">
          <button onclick="closePasswordPrompt(false)" class="flex-1 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 font-bold text-xs">Batal</button> <button id="btnConfirmPassword" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg">PROSES</button>
        </div>
      </div>
    </div>
    <div id="incomingRequestModal" class="hide fixed inset-0 z-[140] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-orange-500"></div>
        <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"></div>
        <h3 class="text-lg font-black text-gray-800 dark:text-white uppercase tracking-tight">Permintaan Dana</h3>
        <div class="my-4 py-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
          <p class="text-xs text-gray-500 mb-1">Dari Pengguna</p>
          <p class="text-base font-bold text-gray-800 dark:text-white mb-2" id="reqSenderName">-</p>
          <p class="text-xs text-gray-500 mb-1">Jumlah</p>
          <p class="text-2xl font-black text-blue-600 dark:text-blue-400" id="reqAmount">Rp 0</p>
        </div>
        <div class="flex gap-3">
          <button onclick="rejectRequest()" class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-red-500 font-bold text-xs hover:bg-gray-200">Tolak</button> <button onclick="approveRequest()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg shadow-blue-500/30">Setujui & Bayar</button>
        </div>
      </div>
    </div>
    <div id="customConfirmModal" class="hide fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2rem] p-6 shadow-2xl border border-white/20 dark:border-gray-800 transform transition-all scale-100 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-brand"></div>
        <div class="text-center mb-6 mt-2">
          <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm ring-4 ring-blue-50/50 dark:ring-blue-900/20"></div>
          <h3 class="text-xl font-black text-gray-800 dark:text-white mb-2 tracking-tight" id="confirmTitle">Konfirmasi</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed px-4" id="confirmMessage">Apakah anda yakin?</p>
        </div>
        <div class="flex gap-3">
          <button onclick="closeConfirm(false)" class="flex-1 py-3.5 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-bold text-xs hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-transparent hover:border-gray-200 dark:hover:border-gray-700">Batal</button> <button id="confirmYesBtn" class="flex-1 py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-xs shadow-lg shadow-blue-600/20 hover:shadow-blue-600/40 transition transform active:scale-95">Ya, Proses</button>
        </div>
      </div>
    </div>
    <div id="detailTrxModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-blue-500"></div>
        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-2xl mb-4 text-center border border-blue-100 dark:border-blue-800">
          <p class="text-[10px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-widest">Kode Transaksi</p>
          <p class="text-lg font-mono font-black text-gray-800 dark:text-white" id="dtTrxCode">------</p>
        </div>
        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Detail Transaksi</h3>
        <div class="space-y-3">
          <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
            <p class="text-[10px] text-gray-500 mb-1">Produk / Layanan</p>
            <p class="text-sm font-bold text-gray-800 dark:text-white leading-tight" id="dtTitle">-</p>
          </div>
          <div class="flex gap-3">
            <div class="flex-1 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 relative">
              <div class="flex justify-between items-center mb-1">
                <p class="text-[10px] text-gray-500">Status</p><button id="btnRefreshStatus" onclick="" class="hide px-2 py-0.5 bg-blue-100 text-blue-700 rounded-md text-[9px] font-bold hover:bg-blue-200 transition-colors shadow-sm flex items-center gap-1">Refresh</button>
              </div>
              <p class="text-xs font-bold" id="dtStatus">-</p>
            </div>
            <div class="flex-1 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
              <p class="text-[10px] text-gray-500 mb-1">Nominal</p>
              <p class="text-xs font-bold text-gray-800 dark:text-white" id="dtAmount">-</p>
            </div>
          </div>
          <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
            <p class="text-[10px] text-blue-600 dark:text-blue-400 mb-1 font-bold flex items-center gap-1">Pesan Server / Info</p>
            <p class="text-xs text-gray-700 dark:text-gray-300 font-mono break-words leading-relaxed" id="dtSn">-</p>
          </div>
          <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
            <p class="text-[10px] text-gray-500 mb-1">Waktu Transaksi</p>
            <p class="text-xs font-bold text-gray-800 dark:text-white" id="dtDate">-</p>
          </div>
          <div class="mt-2">
            <details class="group" style="display:none!important">
              <summary class="flex justify-between items-center cursor-pointer list-none p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-[10px] font-bold text-gray-500 hover:text-blue-600 select-none">
                <span>Lihat Data Mentah (JSON)</span>
              </summary>
              <div class="mt-2 p-3 bg-gray-900 rounded-xl overflow-x-auto border border-gray-700 shadow-inner max-h-40 custom-scroll">
                <pre id="dtRawJson" class="text-[9px] font-mono text-green-400 whitespace-pre-wrap leading-tight">Klik tombol refresh (ikon sync) di atas untuk memuat data mentah dari server...</pre>
              </div>
            </details>
          </div>
        </div>
        <div class="flex gap-2 mt-4">
          <button onclick="copyToClipboard(document.getElementById('dtSn').innerText)" class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-bold text-xs hover:bg-gray-200">Salin Info</button> <button id="btnCancelPreorder" onclick="" class="hide flex-1 py-3 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-bold text-xs hover:bg-red-200 transition">Batalkan PO</button> <button onclick="closeTrxDetail()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs shadow-lg">Tutup</button>
        </div>
      </div>
    </div>
    <div id="stockModal" class="hide fixed inset-0 z-[120] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl flex flex-col max-h-[80vh]">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-800 dark:text-white">Stok XL Akrab</h3>
        </div>
        <div id="stockList" class="overflow-y-auto pr-1 space-y-2 flex-1 no-scrollbar"></div>
        <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-800 text-center">
          <p class="text-[10px] text-gray-400">Data Realtime Server v3</p>
        </div>
      </div>
    </div>
    <div id="invoiceModal" class="hide fixed inset-0 z-[150] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-[2rem] overflow-hidden shadow-2xl relative border border-white/20">
        <div class="bg-gradient-brand p-8 text-center relative overflow-hidden">
          <div class="absolute -top-10 -left-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
          <div class="absolute top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
          <p class="text-blue-100 text-[10px] font-bold uppercase tracking-widest mb-1">Total Tagihan</p>
          <h2 class="text-3xl font-black text-white tracking-tight" id="invTotalMain">Rp 0</h2>
        </div>
        <div class="p-6 relative bg-white dark:bg-gray-900">
          <div class="absolute top-0 left-0 w-full -mt-2 flex justify-between px-2 overflow-hidden">
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
            <div class="w-4 h-4 bg-gray-100 dark:bg-gray-950 rounded-full"></div>
          </div>
          <div class="space-y-4 mt-4">
            <div class="flex justify-between items-start">
              <span class="text-xs text-gray-500 font-medium">Produk</span> <span class="text-xs font-bold text-gray-800 dark:text-white text-right max-w-[60%] leading-tight" id="invProductName">-</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs text-gray-500 font-medium">Nomor Tujuan</span> <span class="text-xs font-bold text-gray-800 dark:text-white font-mono bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded" id="invDestNum">-</span>
            </div>
            <div class="my-4 border-t-2 border-dashed border-gray-100 dark:border-gray-800"></div>
            <div class="flex justify-between items-center">
              <span class="text-xs text-gray-500 font-medium">Harga</span> <span class="text-xs font-bold text-gray-800 dark:text-white" id="invPrice">Rp 0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs text-gray-500 font-medium">Biaya Admin</span> <span class="text-[10px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full">GRATIS</span>
            </div>
            <div class="flex justify-between items-center pt-2">
              <span class="text-sm font-bold text-gray-800 dark:text-white">Total Bayar</span> <span class="text-lg font-black text-blue-600 dark:text-blue-400" id="invTotalBottom">Rp 0</span>
            </div>
          </div>
          <div class="flex gap-3 mt-8">
            <button onclick="closeInvoice()" class="flex-1 py-3.5 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-bold text-xs hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-transparent hover:border-gray-200 dark:hover:border-gray-700">Batal</button> <button id="btnPayInvoice" class="flex-1 py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-xs shadow-lg shadow-blue-600/30 hover:shadow-blue-600/50 transition transform active:scale-95">Konfirmasi Bayar</button>
          </div>
        </div>
      </div>
    </div>
    <div id="fullQrModal" class="hide fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-md p-6 fade-enter">
      <div class="relative w-full max-w-xs flex flex-col items-center">
        <div class="bg-white p-4 rounded-3xl shadow-2xl w-full">
          <img id="fullQrImage" src="" class="w-full h-auto object-contain rounded-xl" alt="">
          <div class="text-center mt-4">
            <p class="text-lg font-black text-gray-800">Scan QRIS</p>
            <p class="text-xs text-gray-500">Pastikan nama merchant sesuai</p>
          </div>
        </div>
      </div>
    </div>
    <div id="qiosModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl relative">
        <div id="qiosStep1">
          <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">Top Up Saldo</h3>
          <p class="text-xs text-gray-500 mb-4">Pilih nominal instan atau manual</p>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="setTopUpAmount(50000)" class="py-3 rounded-xl bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold border border-blue-100 dark:border-blue-800 hover:bg-blue-100 transition shadow-sm">50.000</button> <button onclick="setTopUpAmount(100000)" class="py-3 rounded-xl bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold border border-blue-100 dark:border-blue-800 hover:bg-blue-100 transition shadow-sm">100.000</button>
          </div>
          <div class="input-group mb-4">
            <input type="number" id="qiosInputAmount" placeholder="Nominal Lain (Min 1.000)" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
          </div><button onclick="generateQiosTicket()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg mb-4">LANJUTKAN PEMBAYARAN</button>
          <div class="pt-3 border-t border-gray-100 dark:border-gray-800">
            <div class="flex justify-between items-center mb-2">
              <p class="text-[10px] font-bold text-gray-500">Riwayat Top Up Terakhir</p><span class="text-[9px] text-blue-500 cursor-pointer" onclick="nav('historyPage')">Lihat Semua</span>
            </div>
            <div id="qiosMiniHistory" class="space-y-2 max-h-32 overflow-y-auto no-scrollbar">
              <p class="text-[10px] text-center text-gray-400 py-2">Memuat riwayat...</p>
            </div>
          </div>
        </div>
        <div id="qiosStep2" class="hide text-center">
          <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Scan & Bayar</h3>
          <div class="bg-white p-2 rounded-xl border border-gray-200 inline-block mb-2">
            <img id="qiosQrDisplay" src="" class="w-48 h-48 object-contain cursor-pointer hover:opacity-90 transition" onclick="openFullQr()" alt="">
            <p class="text-[9px] text-gray-400 mt-1">(Klik gambar untuk memperbesar)</p>
          </div>
          <p class="text-xs text-gray-500">Total Transfer (Wajib Sama):</p>
          <div class="flex justify-center items-center gap-2 mb-2">
            <h2 class="text-2xl font-black text-blue-600 dark:text-blue-400" id="qiosTotalDisplay">Rp 0</h2>
          </div>
          <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-2 mb-3 border border-red-100 dark:border-red-800">
            <p class="text-[10px] text-red-600 dark:text-red-400 mb-0">Batas Waktu Pembayaran</p>
            <div id="qiosTimerDisplay" class="text-xl font-mono font-bold text-red-600 dark:text-red-400">
              25:00
            </div>
          </div>
          <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-xl border border-yellow-100 dark:border-yellow-800 mb-3">
            <p class="text-[10px] text-left text-yellow-700 dark:text-yellow-400 leading-tight"><b>PENTING:</b><br>
            1. Transfer nominal persis sampai 3 digit terakhir.<br>
            2. Saldo masuk otomatis setelah transfer berhasil.</p>
          </div>
          <div class="flex flex-col gap-2">
            <button onclick="checkQiosStatus()" id="btnCheckQios" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition">SAYA SUDAH BAYAR</button> <button onclick="cancelQiosTransaction()" class="w-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 text-gray-500 hover:text-red-500 font-bold py-3 rounded-xl transition">Batalkan Transaksi</button>
          </div>
        </div>
      </div>
    </div>
    <div id="manualTopUpModal" class="hide fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 fade-enter">
      <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl relative">
        <div id="mtStep1">
          <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">Top Up Manual</h3>
          <p class="text-xs text-gray-500 mb-4">Metode Transfer Bank (Cek Manual)</p>
          <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800 mb-4 text-center">
            <p class="text-[10px] text-gray-500">Bank Tujuan</p><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOXd7uJlgyXODfLIhtY64i_e5FRtHLSIE7KwhQ9c_MZg&amp;s=10" class="h-6 mx-auto my-1" alt="images">
            <p class="text-sm font-bold text-gray-800 dark:text-white">901338749488</p>
            <p class="text-[10px] text-gray-600 dark:text-gray-400 font-medium">a.n Denissa Ermadianis Tarisna Dewi</p><button onclick="copyToClipboard('901338749488')" class="mt-2 text-[10px] text-blue-600 font-bold bg-white dark:bg-gray-800 px-2 py-1 rounded border shadow-sm">Salin No. Rek</button>
          </div>
          <div class="input-group mb-4">
            <input type="number" id="mtInputAmount" placeholder="Masukkan Nominal (Min 10.000)" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
          </div><button onclick="submitManualTopUp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg mb-2">LANJUTKAN</button>
        </div>
        <div id="mtStep2" class="hide">
          <div class="text-center mb-6">
            <div class="w-20 h-20 bg-white rounded-full shadow-lg mx-auto flex items-center justify-center -mt-10 mb-3 relative z-10 border-4 border-white dark:border-gray-800"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOXd7uJlgyXODfLIhtY64i_e5FRtHLSIE7KwhQ9c_MZg&amp;s=10" alt="Seabank" class="w-16"></div>
            <h3 class="text-xl font-black text-gray-800 dark:text-white">Menunggu Pembayaran</h3>
            <p class="text-xs text-gray-500">Selesaikan pembayaran sebelum waktu habis</p>
          </div>
          <div class="bg-orange-50 dark:bg-orange-900/20 rounded-2xl p-4 mb-4 border border-orange-100 dark:border-orange-800 flex justify-between items-center">
            <span class="text-xs text-orange-600 dark:text-orange-400 font-bold">Sisa Waktu</span> <span id="mtTimer" class="text-lg font-mono font-black text-orange-600 dark:text-orange-400">03:00:00</span>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-5 border border-gray-100 dark:border-gray-700 space-y-4 mb-6">
            <div>
              <p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold mb-1">Total Transfer (Wajib Sama)</p>
              <div class="flex justify-between items-end">
                <h2 class="text-3xl font-black text-blue-600 dark:text-blue-400 leading-none" id="mtTotalDisplay">Rp 0</h2><button onclick="copyToClipboard(document.getElementById('mtTotalDisplay').innerText.replace(/[^0-9]/g,''))" class="text-xs font-bold text-blue-600 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-lg transition">Salin</button>
              </div>
              <p class="text-[10px] text-red-400 italic mt-1">*Termasuk kode unik 3 digit terakhir</p>
            </div>
            <div class="border-t border-dashed border-gray-200 dark:border-gray-600"></div>
            <div>
              <p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold mb-1">Rekening Tujuan</p>
              <div class="flex items-center gap-3">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOXd7uJlgyXODfLIhtY64i_e5FRtHLSIE7KwhQ9c_MZg&amp;s=10" class="h-8" alt="images">
                <div class="flex-1">
                  <p class="text-sm font-bold text-gray-800 dark:text-white">901338749488</p>
                  <p class="text-[10px] text-gray-500">a.n Denissa Ermadianis Tarisna Dewi</p>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-3">
            <button onclick="closeManualTopUp()" class="w-full py-3.5 rounded-xl bg-gradient-brand text-white font-bold text-sm shadow-lg shadow-blue-600/30 active:scale-95 transition-transform">Saya Sudah Transfer</button> <button onclick="cancelManualTopUp()" class="w-full py-3.5 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-red-500 font-bold text-xs transition">Batalkan Transaksi</button>
          </div>
        </div>
      </div>
    </div>
    <div id="topUpSheet" class="hide fixed inset-0 z-50 flex flex-col justify-end bg-black/60 backdrop-blur-sm">
      <div class="bg-white dark:bg-gray-900 w-full rounded-t-[30px] p-6 modal-enter max-w-[480px] mx-auto">
        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Pilih Metode Top Up</h3>
        <div class="space-y-3">
          <div onclick="openManualTopUp()" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition mb-3">
            <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center"></div>
            <div class="flex-1">
              <h4 class="font-bold text-gray-800 dark:text-white text-sm">Seabank (Manual)</h4>
              <p class="text-xs text-gray-500">Konfirmasi Admin (Max 3 Jam)</p>
            </div>
          </div>
          <div onclick="openQios()" class="flex items-center gap-4 p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition mb-3">
            <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"></div>
            <div class="flex-1">
              <h4 class="font-bold text-gray-800 dark:text-white text-sm">QRIS (Otomatis)</h4>
              <p class="text-xs text-gray-500">Metode QiosPay (Cek Otomatis)</p>
            </div>
          </div>
        </div><button onclick="closeTopUp()" class="mt-6 w-full py-3 text-gray-500 dark:text-gray-400 font-semibold text-sm">Tutup</button>
      </div>
    </div>
    <section id="loginPage" class="page flex flex-col justify-between min-h-screen bg-white dark:bg-gray-950 relative z-50">
      <div class="absolute top-0 left-0 w-full h-[45vh] bg-gradient-brand rounded-b-[50px] z-0"></div>
      <div class="relative z-10 px-8 pt-20 w-full">
        <div class="text-center mb-10 text-white relative z-10">
          <div class="w-24 h-24 bg-white rounded-[2.2rem] flex items-center justify-center mx-auto mb-6 shadow-[0_20px_50px_rgba(0,0,0,0.2)] border-4 border-white/30 overflow-hidden transform hover:scale-105 transition-transform duration-500">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0fosGjHRqeGRj63MDerdrDw8AHgrP9qLpKg8f21SFnCQPjpHiQjUifDF8pMZwEPpVX7KWzLjgiMUHUmnzgSRRK4xjDa1ukm3Vwn6cZUARnuepXtSGHlXgsASE5UpoF4nKVLjMamAj7qR0wcP6qxR0UqIjw30OSUIhsjnrzwj8kE9HrgpE6cGMqvRRSLM/s1600/play_store_512.png" class="w-20 h-20 object-contain" alt="Logo">
          </div>
          <h1 class="text-4xl font-black tracking-tighter mb-1">PANDAWA STORE</h1>
          <p class="text-blue-100 text-xs font-bold uppercase tracking-widest opacity-80">Premium Digital Provider</p>
          <div class="mt-4 inline-flex items-center gap-2 bg-white/10 backdrop-blur-md px-3 py-1 rounded-full border border-white/10">
            <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
            <span class="text-[10px] font-mono text-blue-100 tracking-tighter" id="versionDisplay">v3.6 SECURED</span>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-xl shadow-blue-900/10 dark:shadow-black/30 transition-all duration-300">
          <h2 id="authTitle" class="text-xl font-bold text-gray-800 dark:text-white text-center mb-6">Masuk Akun</h2>
          <div id="authTabs" class="flex bg-gray-100 dark:bg-gray-800 rounded-xl p-1 mb-6">
            <button id="tabEmail" onclick="switchLoginMethod('email')" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400 transition-all">Email</button> <button id="tabPhone" onclick="switchLoginMethod('phone')" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">No. HP</button>
          </div>
          <div id="loginFormContainer" class="space-y-4">
            <div id="registerFields" class="hide space-y-4 animate-fade-in-down">
              <div class="text-center mb-4">
                <label for="profilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800"><img id="profilePreview" src="" alt="Profile"></label>
                <div class="upload-placeholder" id="uploadPlaceholder">
                  <p class="text-[9px]"><label for="profilePicInput" class="profile-upload block bg-gray-50 dark:bg-gray-800">Upload Foto (Wajib)</label></p>
                </div><input type="file" id="profilePicInput" accept="image/*" class="hidden" onchange="previewImage(this)">
              </div>
              <div class="input-group">
                <input type="text" id="regUsername" placeholder="Username" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11">
              </div>
              <div class="flex gap-2">
                <div class="input-group w-1/2">
                  <select id="regGender" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11">
                    <option value="" disabled selected>
                      Gender
                    </option>
                    <option value="Laki-laki">
                      Laki-laki
                    </option>
                    <option value="Perempuan">
                      Perempuan
                    </option>
                  </select>
                </div>
                <div class="input-group w-1/2">
                  <input type="date" id="regDob" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-100 text-xs font-medium pl-11">
                </div>
              </div>
            </div>
            <div class="input-group">
              <input type="email" id="emailInput" placeholder="Email" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11"><i class="fas fa-envelope" id="loginIcon"></i>
            </div>
            <div class="relative" id="passContainer">
              <div class="input-group">
                <input type="password" id="passwordInput" placeholder="Kata Sandi" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm font-medium pl-11 pr-10">
              </div><button type="button" id="togglePassBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 z-20 outline-none"></button>
            </div>
            <div id="extraOptions" class="flex justify-between items-center text-xs mt-2">
              <label class="flex items-center gap-2 text-gray-500 dark:text-gray-400 cursor-pointer select-none"><input type="checkbox" id="rememberMe" class="rounded text-blue-600 focus:ring-blue-500 bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-700"><span>Ingat Saya</span></label><button onclick="setAuthMode('forgot')" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Lupa Sandi?</button>
            </div>
            <div id="otpContainer" class="hide space-y-4">
              <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 text-xs text-blue-800 dark:text-blue-300">
                Kode OTP dikirim. Masukkan kode 6 digit.
              </div><input type="number" id="otpInput" placeholder="123456" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg font-bold tracking-widest">
            </div>
            <div id="recaptcha-container"></div><button id="btnAuthAction" class="w-full bg-blue-600 dark:bg-blue-500 text-white h-12 rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-transform hover:bg-blue-700 mt-2">MASUK</button> <button onclick="loginWithGoogle()" class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 h-12 rounded-xl font-bold shadow-sm active:scale-95 transition-transform hover:bg-gray-50 dark:hover:bg-gray-700 mt-3 flex items-center justify-center gap-3"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google"> <span class="text-sm">Masuk dengan Google</span></button> <button id="btnVerifyOtp" class="hide w-full bg-green-600 text-white h-12 rounded-xl font-bold shadow-lg shadow-green-500/30 active:scale-95 transition-transform hover:bg-green-700 mt-2">VERIFIKASI OTP</button>
          </div>
          <div id="authFooter" class="text-center mt-6 text-xs text-gray-500 dark:text-gray-400">
            Belum punya akun? <button onclick="setAuthMode('register')" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Daftar Sekarang</button>
          </div>
          <div id="backToLoginContainer" class="hide text-center mt-6 text-xs">
            <button onclick="setAuthMode('login')" class="text-gray-500 dark:text-gray-400 font-bold hover:text-gray-800 dark:hover:text-white">Kembali ke Login</button>
          </div>
          <p class="text-center text-[10px] text-gray-400 mt-4" id="statusMessage">Aman & Terenkripsi</p>
        </div>
      </div>
    </section>
    <section id="akrabV2Page" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
      <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
        <h2 class="font-bold text-lg text-gray-800 dark:text-white">Akrab v2 (Premium)</h2>
      </div>
      <div class="p-4 pb-24">
        <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
          <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Kategori / Provider</label>
            <div onclick="openIcsSheet()" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span id="icsProviderDisplay">XL Akrab (XLA)</span>
            </div>
          </div>
          <div class="mb-4">
            <div class="flex justify-between items-center mb-1">
              <label class="block text-xs font-bold text-gray-500 ml-1">Pilih Paket</label> <button onclick="initAkrabV2Data()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100">Refresh</button>
            </div><select id="icsProductSelect" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 px-3 text-sm font-bold dark:text-white" onchange="updateIcsPriceDisplay()">
              <option value="" disabled selected>
                -- Memuat Data... --
              </option>
            </select>
            <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="icsPriceDisplay">Harga: -</p>
          </div>
          <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
            <div class="input-group">
              <input type="tel" id="icsNumberInput" placeholder="Nomor HP" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
            </div>
          </div><button onclick="processAkrabV2Transaction()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-cyan-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span></button>
          <p class="text-[10px] text-gray-400 mt-4 text-center">Powered by Official API</p>
        </div>
      </div>
    </section>
    <section id="homePage" class="page hide bg-gray-50/50 dark:bg-gray-950">
      <div class="bg-gradient-brand text-white pt-8 pb-24 px-6 rounded-b-[40px] shadow-lg relative overflow-hidden">
        <div class="flex justify-between items-center mb-6 relative z-10">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full border-2 border-white/30 p-0.5 overflow-hidden"><img id="headerProfileImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover rounded-full bg-white dark:bg-gray-800"></div>
            <div>
              <p class="text-xs text-blue-100">Selamat Datang,</p>
              <p class="font-bold text-lg leading-tight" id="headerUsername">Loading...</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur flex items-center justify-center hover:bg-white/30 transition active:scale-95"><i id="themeIcon" class="fas fa-moon text-white"></i></button>
          </div>
        </div>
      </div>
      <div class="mx-6 -mt-24 relative z-20">
        <div class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl rounded-[2.5rem] p-5 shadow-[0_20px_40px_-15px_rgba(37,99,235,0.2)] dark:shadow-none border border-white/50 dark:border-gray-700 relative overflow-hidden group">
          <div class="flex justify-between items-start mb-3 relative">
            <div>
              <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-1 flex items-center gap-1.5">Total Saldo</p>
              <h2 class="text-[2.2rem] font-black text-gray-800 dark:text-white leading-none tracking-tight" id="displayBalance">Rp 0</h2>
            </div>
          </div>
          <div class="grid grid-cols-4 gap-2">
            <div class="text-center group/btn cursor-pointer" onclick="openTopUpSheet()">
              <div class="w-11 h-11 mx-auto bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-600/30 mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300 relative"><i class="fa-solid fa-wallet text-lg"></i>
                <div id="badge-topup-home" class="hide absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white rounded-full flex items-center justify-center text-[9px] font-bold">
                  1
                </div>
              </div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Top Up</span>
            </div>
            <div class="text-center group/btn cursor-pointer" onclick="nav('sendPage')">
              <div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fa-solid fa-paper-plane text-lg"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Kirim</span>
            </div>
            <div class="text-center group/btn cursor-pointer" onclick="nav('requestPage')">
              <div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fa-solid fa-hand-holding-dollar text-lg"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Minta</span>
            </div>
            <div class="text-center group/btn cursor-pointer" onclick="startScan()">
              <div class="w-11 h-11 mx-auto bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center shadow-sm mb-1.5 transform group-hover/btn:scale-110 transition-all duration-300"><i class="fa-solid fa-qrcode text-lg"></i></div><span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Scan</span>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-6 px-6">
        <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm">Layanan</h3>
        <div class="grid grid-cols-4 gap-4">
          <div class="text-center group cursor-pointer" onclick="openPPOB('akrab')">
            <div class="bg-blue-100 dark:bg-blue-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fa-solid fa-mobile-screen-button text-2xl text-blue-600"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Data</span>
          </div>
          <div class="text-center group cursor-pointer" onclick="window.showAlert('Informasi', 'Paket OTP Segera Hadir', 'info')">
            <div class="bg-emerald-100 dark:bg-emerald-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fa-solid fa-key text-2xl text-emerald-600"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Paket OTP</span>
          </div>
          <div class="text-center group cursor-pointer" onclick="nav('preorderPage')">
            <div class="bg-purple-100 dark:bg-purple-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fa-solid fa-clock-rotate-left text-2xl text-purple-600"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Pre-Order</span>
          </div>
          <div class="text-center group cursor-pointer" onclick="checkAkrabStock()">
            <div class="bg-orange-100 dark:bg-orange-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fa-solid fa-boxes-stacked text-2xl text-orange-600"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Stok Akrab</span>
          </div>
          <div class="text-center group cursor-pointer" onclick="window.showAlert('Informasi', 'Login OTP Segera Hadir', 'info')">
            <div class="bg-rose-100 dark:bg-rose-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fa-solid fa-shield-halved text-2xl text-rose-600"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Login OTP</span>
          </div>
          <div class="text-center group cursor-pointer" onclick="nav('historyPage')">
            <div class="bg-indigo-100 dark:bg-indigo-900/30 w-14 h-14 rounded-2xl mx-auto flex items-center justify-center mb-2 transition-transform group-active:scale-95"><i class="fa-solid fa-list-check text-2xl text-indigo-600"></i></div><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Riwayat</span>
          </div>
        </div>
      </div>
      <div class="mt-6 px-6 mb-2">
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-bold text-gray-800 dark:text-white text-sm">Live Stok Akrab</h3><button id="btnRefreshStock" onclick="manualRefreshStock()" class="flex items-center gap-1 bg-blue-100 dark:bg-blue-900/30 px-3 py-1 rounded-lg active:scale-95 transition hover:bg-blue-200 dark:hover:bg-blue-800"><span class="text-[10px] text-blue-700 dark:text-blue-400 font-bold">Refresh Stok</span></button>
        </div>
        <div id="liveStockContainer" class="grid grid-cols-2 gap-2">
          <div class="text-center text-[10px] text-gray-400 py-4 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-200 dark:border-gray-800">
            Memuat Data Stok...
          </div>
        </div>
      </div>
      <div class="mt-2 bg-white dark:bg-gray-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)] dark:shadow-[0_-5px_20px_rgba(0,0,0,0.2)] p-6 min-h-[300px]">
        <div class="flex justify-between items-end mb-4">
          <h3 class="font-bold text-gray-800 dark:text-white">Transaksi Terakhir</h3><span class="text-xs text-blue-600 dark:text-blue-400 font-semibold cursor-pointer" onclick="nav('historyPage')">Lihat Semua</span>
        </div>
        <div id="miniHistory" class="space-y-4"></div>
      </div>
    </section>
    <section id="sendPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
      <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
        <h2 class="font-bold text-lg text-gray-800 dark:text-white">Kirim Saldo</h2>
      </div>
      <div class="p-6">
        <div class="bg-white dark:bg-gray-900 p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
          <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Username Penerima</label>
            <div class="input-group">
              <input type="text" id="sendTargetUser" placeholder="Contoh: user123" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white">
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nominal Transfer</label>
            <div class="input-group">
              <input type="number" id="sendAmount" placeholder="0" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
            </div>
          </div><button onclick="initiateSend()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Lanjut</span></button>
        </div>
      </div>
    </section>
    <section id="requestPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
      <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
        <h2 class="font-bold text-lg text-gray-800 dark:text-white">Minta Saldo</h2>
      </div>
      <div class="p-6">
        <div class="bg-white dark:bg-gray-900 p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
          <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl mb-6 border border-orange-100 dark:border-orange-800">
            <p class="text-xs text-orange-600 dark:text-orange-400">Notifikasi permintaan akan muncul langsung di layar temanmu jika mereka sedang online.</p>
          </div>
          <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Minta ke Username</label>
            <div class="input-group">
              <input type="text" id="reqTargetUser" placeholder="Contoh: sultan99" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white">
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nominal Diminta</label>
            <div class="input-group">
              <input type="number" id="reqAmountInput" placeholder="0" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 pl-11 dark:text-white text-lg font-bold">
            </div>
          </div><button onclick="initiateRequest()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Kirim Permintaan</span></button>
        </div>
      </div>
    </section>
    <section id="preorderPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
      <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
        <h2 class="font-bold text-lg text-gray-800 dark:text-white">Layanan Preorder</h2>
      </div>
      <div class="p-4 pb-24">
        <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
          <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Pilih Provider</label>
            <div onclick="openSheet('provider')" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer">
              <span id="displayProviderPO">-- Pilih Provider --</span>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Pilih Produk</label>
            <div onclick="openSheet('product')" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer">
              <span id="displayProductPO">-- Pilih Produk --</span>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label> <input type="tel" id="poNumber" placeholder="08xxxx" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 text-sm font-bold dark:text-white">
          </div><button onclick="submitPreorder()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg">Kirim Pesanan (PO)</button>
        </div>
      </div>
    </section>
    <section id="ppobPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
      <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
        <h2 class="font-bold text-lg text-gray-800 dark:text-white" id="ppobTitle">Isi Pulsa (Live API)</h2>
      </div>
      <div class="p-4 pb-24">
        <div id="inputSection" class="transition-all duration-300">
          <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
            <div class="mb-4">
              <div class="flex justify-between items-center mb-1">
                <label class="block text-xs font-bold text-gray-500 ml-1">Provider</label> <button onclick="initProductData()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100">Refresh Data</button>
              </div>
              <div onclick="openSheet('provider')" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-white text-sm rounded-xl px-4 py-3 font-bold flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <span id="displayProvider">-- Pilih Provider --</span>
              </div><input type="hidden" id="formProvider" onchange="updateProductDropdown()">
            </div>
            <div class="mb-4">
              <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Produk</label>
              <div onclick="openSheet('product')" id="btnProductTrigger" class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 text-sm rounded-xl px-4 py-3 font-medium flex justify-between items-center cursor-not-allowed transition">
                <span id="displayProduct">Menunggu Provider...</span>
              </div><input type="hidden" id="formProduct"> <input type="hidden" id="selectedProductName"> <input type="hidden" id="selectedProductPrice">
              <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="priceDisplay"></p>
            </div>
            <div class="mb-6">
              <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
              <div class="input-group" id="singleNumContainer">
                <input type="tel" id="ppobNumber" placeholder="Nomor HP / ID Pelanggan" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
              </div>
              <div id="productDescription" class="hide mt-2 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-xs text-gray-600 dark:text-gray-300 border border-blue-100 dark:border-blue-800 leading-relaxed transition-all animate-fade-in-down"></div>
            </div><button onclick="processFormTransaction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span></button>
          </div>
        </div>
      </div>
    </section>
    <section id="akrabV2Page" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen z-40 absolute top-0 w-full max-w-[480px]">
      <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-20 shadow-sm flex items-center gap-4">
        <h2 class="font-bold text-lg text-gray-800 dark:text-white">Akrab v2 (Premium)</h2>
      </div>
      <div class="p-4 pb-24">
        <div class="bg-white dark:bg-gray-900 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800">
          <div class="mb-4">
            <div class="flex justify-between items-center mb-1">
              <label class="block text-xs font-bold text-gray-500 ml-1">Pilih Paket</label> <button onclick="initAkrabV2Data()" class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100">Refresh</button>
            </div><select id="icsProductSelect" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 px-3 text-sm font-bold dark:text-white" onchange="updateIcsPriceDisplay()">
              <option value="" disabled selected>
                -- Memuat Data... --
              </option>
            </select>
            <p class="text-[10px] text-blue-500 mt-1 text-right font-bold" id="icsPriceDisplay">Harga: -</p>
          </div>
          <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nomor Tujuan</label>
            <div class="input-group">
              <input type="tel" id="icsNumberInput" placeholder="Nomor HP" class="w-full h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-800 dark:text-white text-sm font-bold pl-11">
            </div>
          </div><button onclick="processAkrabV2Transaction()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-cyan-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Beli Paket</span></button>
          <p class="text-[10px] text-gray-400 mt-4 text-center">Powered by Official API</p>
        </div>
      </div>
    </section>
    <section id="historyPage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
      <div class="p-4 bg-white dark:bg-gray-900 sticky top-0 z-10 shadow-sm dark:shadow-gray-800">
        <div class="flex justify-between items-center mb-4">
          <h2 class="font-bold text-lg text-gray-800 dark:text-white">Riwayat</h2>
          <div class="flex gap-2">
            <button onclick="downloadHistoryPDF()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition">PDF</button>
          </div>
        </div>
        <div class="flex gap-2 items-center bg-gray-50 dark:bg-gray-800 p-2 rounded-xl border border-gray-100 dark:border-gray-700 mt-2">
          <span class="text-[10px] font-bold text-gray-500 ml-1">Pilih Tanggal:</span> <input type="date" id="historyDateFilter" onchange="filterHistoryByDate(this.value)" class="flex-1 bg-transparent text-xs font-bold text-blue-600 focus:outline-none">
        </div>
      </div>
      <div id="fullHistory" class="p-4 space-y-3 pb-24"></div>
    </section>
    <section id="profilePage" class="page hide bg-gray-50 dark:bg-gray-950 min-h-screen">
      <div class="bg-gradient-brand text-white p-6 pb-12 rounded-b-[40px] text-center shadow-lg relative transition-colors">
        <div class="w-24 h-24 bg-white dark:bg-gray-900 p-1 rounded-full mx-auto mb-4 shadow-xl transition-colors overflow-hidden"><img id="profilePageImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover"></div>
        <h2 class="text-xl font-bold" id="profileName">Dev User</h2>
        <p class="text-blue-200 text-sm" id="profilePhone">-</p>
        <div class="mt-4 inline-flex items-center bg-blue-800/50 dark:bg-blue-900/50 backdrop-blur px-4 py-1.5 rounded-full text-xs font-semibold border border-blue-400/30">
          Pelanggan Setia
        </div>
      </div>
      <div class="px-6 -mt-6 pb-24 relative z-10">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-black/30 overflow-hidden transition-colors">
          <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
            <span class="text-xs text-gray-500">Gender</span><span class="text-sm font-bold dark:text-white" id="profileGender">-</span>
          </div>
          <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
            <span class="text-xs text-gray-500">Tgl. Lahir</span><span class="text-sm font-bold dark:text-white" id="profileDob">-</span>
          </div>
          <div onclick="handleLogout()" class="p-4 flex items-center gap-4 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer transition-colors group">
            <div class="w-9 h-9 rounded-full bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400 group-hover:bg-red-100 dark:group-hover:bg-red-900/50 flex items-center justify-center transition-colors"></div>
            <div class="flex-1 text-sm font-bold text-red-500 dark:text-red-400">
              Keluar
            </div>
          </div>
        </div>
      </div>
    </section>
    <section id="scanPage" class="page hide bg-black min-h-screen text-white flex flex-col fixed top-0 w-full max-w-[480px] z-50">
      <div class="flex justify-between items-center p-4 absolute top-0 w-full z-10">
        <h2 class="font-bold">Scan QRIS</h2>
      </div>
      <div class="flex-1 flex flex-col justify-center items-center relative">
        <div id="reader" class="rounded-3xl overflow-hidden border-2 border-white/50 shadow-2xl"></div>
        <div class="absolute bottom-32 text-center pointer-events-none">
          <p class="text-sm font-medium bg-black/40 px-4 py-1 rounded-full">Arahkan kamera ke kode QRIS</p>
        </div>
      </div>
    </section>
    <div id="liveChatContainer">
      <div id="liveChatModal" class="chat-window hide">
        <div class="bg-blue-600 p-4 flex justify-between items-center shadow-md shrink-0">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white"></div>
            <div>
              <h4 class="text-white font-bold text-sm leading-tight">Admin Support</h4>
              <p class="text-blue-100 text-[10px]">Online  Membalas cepat</p>
            </div>
          </div>
        </div>
        <div id="chatMessages" class="chat-body flex flex-col gap-2 custom-scroll">
          <div class="text-center mt-10 opacity-50">
            <p class="text-xs text-gray-400">Mulai percakapan dengan Admin.</p>
          </div>
        </div>
        <div class="p-3 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 shrink-0">
          <form onsubmit="event.preventDefault(); sendChatMessage();" class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Tulis pesan..." class="flex-1 bg-gray-100 dark:bg-gray-800 border-0 rounded-xl px-4 py-3 text-xs focus:ring-2 focus:ring-blue-500 dark:text-white">
          </form>
        </div>
      </div>
    </div>
    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 flex justify-around items-end pb-4 pt-3 text-[10px] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-40 hide rounded-t-3xl">
      <div class="text-center cursor-pointer w-1/5 nav-item text-blue-600 dark:text-blue-400 group" id="nav-home" onclick="nav('homePage')">
        <div class="mb-1 transition group-hover:-translate-y-1"><i class="fa-solid fa-house text-lg"></i></div>
        <p class="font-medium">Beranda</p>
      </div>
      <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-buy" onclick="openPPOB('akrab')">
        <div class="mb-1 transition group-hover:-translate-y-1"><i class="fa-solid fa-bag-shopping text-lg"></i></div>
        <p class="font-medium">Beli</p>
      </div>
      <div class="text-center w-1/5 qris-btn-container cursor-pointer" onclick="openTopUpSheet()">
        <div class="qris-btn w-11 h-11 rounded-full flex items-center justify-center mx-auto text-white transform transition hover:scale-105 active:scale-95 mb-1 relative"><i class="fa-solid fa-qrcode text-xl"></i>
          <div id="badge-topup-nav" class="hide absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white dark:border-gray-900 rounded-full flex items-center justify-center text-[9px] font-bold">
            1
          </div>
        </div>
        <p class="font-bold text-gray-700 dark:text-gray-400">Top Up</p>
      </div>
      <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-preorder" onclick="nav('sendPage')">
        <div class="mb-1 transition group-hover:-translate-y-1"><i class="fa-solid fa-paper-plane text-lg"></i></div>
        <p class="font-medium">Kirim</p>
      </div>
      <div class="text-center cursor-pointer w-1/5 nav-item text-gray-400 dark:text-gray-500 group" id="nav-profile" onclick="nav('profilePage')">
        <div class="mb-1 transition group-hover:-translate-y-1"><i class="fa-solid fa-user-gear text-lg"></i></div>
        <p class="font-medium">Saya</p>
      </div>
      <div class="absolute -top-8 right-[7%] z-50">
        <button onclick="toggleChat()" id="chatFloatBtn" class="hide w-11 h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-600/40 border-2 border-white dark:border-gray-800 transition-transform active:scale-95"><i class="fa-solid fa-comment-dots text-lg"></i></button>
        <div id="chatBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white rounded-full text-[9px] font-bold flex items-center justify-center hide">
          <button onclick="toggleChat()" id="chatFloatBtn" class="hide w-11 h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-600/40 border-2 border-white dark:border-gray-800 transition-transform active:scale-95">!</button>
        </div>
      </div>
    </nav>
  </div>
  <div id="sheetOverlay" onclick="closeAllSheets()" class="hide fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm fade-enter"></div>
  <div id="sheetProvider" class="hide fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-gray-900 rounded-t-[2rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.3)] max-w-[480px] mx-auto transition-transform duration-300 transform translate-y-0">
    <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800 dark:text-white">Pilih Provider</h3>
    </div>
    <div class="space-y-2 max-h-[60vh] overflow-y-auto no-scrollbar pb-8">
      <div id="prov_ICS_XDA" onclick="checkProv('ICS_XDA') &amp;&amp; selectProvider('ICS_XDA', 'Akrab Fresh (XDA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab Fresh (XDA)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_ICS_CIRCLE" onclick="checkProv('ICS_CIRCLE') &amp;&amp; selectProvider('ICS_CIRCLE', 'XL Circle')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Circle</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_XDA" onclick="checkProv('XDA') &amp;&amp; selectProvider('XDA', 'Akrab V2 (XDA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab V2 (XDA)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_XLA" onclick="checkProv('XLA') &amp;&amp; selectProvider('XLA', 'Akrab Fresh (XLA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab Fresh (XLA)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_FMX" onclick="checkProv('FMX') &amp;&amp; selectProvider('FMX', 'FlexMax (FMX)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">FlexMax (FMX)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_XLR" onclick="checkProv('XLR') &amp;&amp; selectProvider('XLR', 'XL Reguler (XLR)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Reguler (XLR)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_PLN" onclick="checkProv('PLN') &amp;&amp; selectProvider('PLN', 'PLN Pascabayar')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">PLN Pascabayar</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
    </div>
  </div>
  <div id="sheetIcsProvider" class="hide fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-gray-900 rounded-t-[2rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.3)] max-w-[480px] mx-auto transition-transform duration-300 transform translate-y-0">
    <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800 dark:text-white">Pilih Kategori</h3>
    </div>
    <div class="space-y-2 max-h-[60vh] overflow-y-auto no-scrollbar pb-8">
      <div id="prov_ICS_xla" onclick="checkProv('xla') &amp;&amp; setIcsProvider('xla', 'XL Akrab (XLA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Akrab (XLA)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_ICS_xda" onclick="checkProv('xda') &amp;&amp; setIcsProvider('xda', 'Akrab Fresh (XDA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Akrab Fresh (XDA)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_ICS_fmax" onclick="checkProv('fmax') &amp;&amp; setIcsProvider('fmax', 'FlexMax (FMAX)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">FlexMax (FMAX)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_ICS_circle" onclick="checkProv('circle') &amp;&amp; setIcsProvider('circle', 'XL Circle')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">XL Circle</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
      <div id="prov_ICS_bpa" onclick="checkProv('bpa') &amp;&amp; setIcsProvider('bpa', 'Bagi Pulsa (BPA)')" class="p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer flex justify-between items-center group transition">
        <div class="flex items-center">
          <span class="font-bold text-gray-700 dark:text-gray-200 group-hover:text-blue-600">Bagi Pulsa (BPA)</span><span class="mt-badge">GANGGUAN</span>
        </div>
      </div>
    </div>
  </div>
  <div id="sheetProduct" class="hide fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-gray-900 rounded-t-[2rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.3)] max-w-[480px] mx-auto transition-transform duration-300">
    <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800 dark:text-white">Pilih Produk</h3>
    </div>
    <div id="sheetProductList" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar pb-8">
      <div class="text-center text-gray-400 py-10">
        Silakan pilih provider terlebih dahulu
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        sendPasswordResetEmail,
        signInWithPhoneNumber, 
        RecaptchaVerifier, 
        signOut, 
        onAuthStateChanged,
        EmailAuthProvider,
        reauthenticateWithCredential,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, where, getDocs, runTransaction, deleteDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
        authDomain: "ppob-3ea96.firebaseapp.com",
        projectId: "ppob-3ea96",
        storageBucket: "ppob-3ea96.firebasestorage.app",
        messagingSenderId: "181320175094",
        appId: "1:181320175094:web:306b79071018410b910bd7",
        measurementId: "G-0K2V796QDX"
    };

    const app = initializeApp(firebaseConfig);

    // --- FITUR AUTO UPDATE & PWA ---
        const APP_VERSION_CODE = 'v3.6'; // Versi saat ini

    // Update Label Versi di Login
    setTimeout(() => {
        const vEl = document.getElementById('versionDisplay');
        if(vEl) vEl.innerText = APP_VERSION_CODE;
    }, 500);

    // Fungsi Cek Update ke Firebase
    async function checkSystemUpdate() {
        console.log("Checking system update...");
        try {
            const db = getFirestore(app);
            const docRef = doc(db, "settings", "app_info");
            const snapshot = await getDoc(docRef);

            if (snapshot.exists()) {
                const serverData = snapshot.data();
                const serverVersion = serverData.version; // Field 'version' di Firebase

                if (serverVersion && serverVersion !== APP_VERSION_CODE) {
                    console.warn(`Update Ditemukan: ${APP_VERSION_CODE} -> ${serverVersion}`);
                    
                    // Tampilkan Loader
                    const loader = document.getElementById('globalLoader');
                    if(loader) {
                        document.getElementById('loaderText').innerText = `Update Sistem ke ${serverVersion}...`;
                        loader.classList.remove('hide');
                    }

                    // Hapus Service Worker (PWA Cache)
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                        }
                    }

                    // Hapus Cache Storage
                    if ('caches' in window) {
                        const keys = await caches.keys();
                        await Promise.all(keys.map(key => caches.delete(key)));
                    }

                    // Paksa Reload dari Server (True)
                    setTimeout(() => window.location.reload(true), 2000);
                } else {
                    console.log("Sistem sudah versi terbaru.");
                }
            }
        } catch (e) {
            console.error("Gagal cek update:", e);
        }
    }

    // Jalankan Pengecekan
    checkSystemUpdate();

    // Register Service Worker (Template PWA)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW Ready:', reg.scope))
                .catch(err => console.log('SW Fail:', err));
        });
    }


    // 1. PROXY LIST (Global)
        // 1. PROXY LIST (Global) - Prioritaskan CorsProxyIO untuk POST Request
        // 1. PROXY LIST (Global) - Update dengan CodeTabs sebagai cadangan handal
        // 1. PROXY LIST (Global) - Update dengan CodeTabs (Paling Stabil)
        const PROXY_LIST = [
        { name: 'CorsProxyIO', url: 'https://corsproxy.io/?' },
        { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
        { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' },
        { name: 'AllOrigins', url: 'https://api.allorigins.win/raw?url=' },
        { name: 'Direct', url: '' }
    ];

        // 3. TELEGRAM NOTIFICATION SYSTEM
    const TELEGRAM_CONFIG = {
        token: "7507761189:AAGUCYltzj_IMuDRgjUzUPiZDz4nbVXvOME",
        chatId: "-1002997407612"
    };

                            window.sendTelegramNotif = async (type, data) => {
        let message = "";
        let topicId = null;
        const now = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const formattedDate = now.toLocaleDateString('id-ID', options).replace(/ pukul /g, ' | ');

        let safeDest = data.dest || "-";
        if (safeDest && safeDest.length > 4) {
             safeDest = safeDest.substring(0, safeDest.length - 4) + "****";
        }

        let safeTrxId = data.trxId || "-";
        try {
            const parts = safeTrxId.split('-');
            if (parts.length >= 3 && (parts[0] === 'TRX' || parts[0] === 'ICS')) {
                const phoneSegment = parts[1];
                if (phoneSegment.length > 4 && /^\d+$/.test(phoneSegment)) {
                    const maskedPhone = phoneSegment.substring(0, phoneSegment.length - 4) + "****";
                    parts[1] = maskedPhone;
                    safeTrxId = parts.join('-');
                }
            }
        } catch (e) { console.log("Masking TRX Error", e); }

        if (type === 'TOPUP') {
            topicId = 7;
            message = ` DEPOSIT BERHASIL \n` +
                      `\n` +
                      ` Jumlah : Rp ${window.formatRp(data.amount).replace('Rp', '').trim()}\n` +
                      ` Waktu : ${formattedDate}\n` +
                      ` User ID : ${currentUsername}\n` +
                      ` Status : BERHASIL\n` +
                      ` ID Transaksi :\n` +
                      `${safeTrxId}\n` +
                      `\n` +
                      ` PANDAWA SYSTEM\n` +
                      `https://www.pandawa-digital.store`;
        } else {
            topicId = 6;
            message = ` TRANSAKSI BERHASIL \n` +
                      `\n` +
                      ` Produk : ${data.title}\n` +
                      ` Tujuan : ${safeDest}\n` +
                      ` Harga : Rp ${window.formatRp(data.amount).replace('Rp', '').trim()}\n` +
                      ` Waktu : ${formattedDate}\n` +
                      ` User : ${currentUsername}\n` +
                      ` TRX ID : ${safeTrxId}\n` +
                      `\n` +
                      ` PANDAWA SYSTEM\n` +
                      `https://www.pandawa-digital.store`;
        }

        // METODE GET + URL PARAMETERS (FIX PROXY)
        const baseUrl = `https://api.telegram.org/bot${TELEGRAM_CONFIG.token}/sendMessage`;
        const params = new URLSearchParams({
            chat_id: TELEGRAM_CONFIG.chatId,
            text: message,
            message_thread_id: topicId
        });
        
        const targetUrl = `${baseUrl}?${params.toString()}`;

        for (const proxy of PROXY_LIST) {
            try {
                const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                const res = await fetch(fullUrl);
                if(res.ok) {
                    console.log("Telegram Notif Sent via " + proxy.name);
                    break;
                }
            } catch (e) { console.warn("Telegram Proxy Error via " + proxy.name, e); }
        }
    };

  // 2. ICS STORE INTEGRATION
        // 2. ICS STORE INTEGRATION (VERCEL DIRECT)
    const ICS_CONFIG = { 
        apiKey: "7274410f84b7e2810795810e879a4e0be8779c451d55e90e29d9bc174547ff77", 
        baseUrl: "https://www.pandawa-digital.store/api/relay" 
    };

        let currentIcsType = 'xla';

    window.openIcsSheet = () => {
        document.getElementById('sheetIcsProvider').classList.remove('hide');
        document.getElementById('sheetOverlay').classList.remove('hide');
        document.body.style.overflow = 'hidden';
    };

    window.closeIcsSheet = () => {
        document.getElementById('sheetIcsProvider').classList.add('hide');
        document.getElementById('sheetOverlay').classList.add('hide');
        document.body.style.overflow = '';
    };

    window.setIcsProvider = (type, name) => {
        currentIcsType = type;
        document.getElementById('icsProviderDisplay').innerText = name;
        window.closeIcsSheet();
        window.initAkrabV2Data();
    };

  window.openAkrabV2 = () => {
        window.nav('akrabV2Page');
        window.initAkrabV2Data();
    };

                                                async function callIcsApi(action, params = {}, method = 'GET', attempt = 1) {
        // [FIX] Gunakan timestamp untuk bypass cache
        const t = Date.now();
        let targetUrl = `${ICS_CONFIG.baseUrl}?action=${action}&apikey=${ICS_CONFIG.apiKey}&_t=${t}`;
        
        const options = {
            method: method,
            headers: { 'Accept': 'application/json' }
        };

        if (method === 'GET') {
            const qs = new URLSearchParams(params).toString();
            if(qs) targetUrl += `&${qs}`;
        } else if (method === 'POST') {
             options.headers['Content-Type'] = 'application/json';
             options.body = JSON.stringify(params);
        }

        // [PENTING] Direct Fetch ke Domain Sendiri (Tanpa Proxy)
        try {
            if(attempt === 1) console.log("[ICS] Calling Relay:", targetUrl);
            else console.log(`[ICS] Retry Attempt ${attempt}...`);

            const res = await fetch(targetUrl, options);
            const text = await res.text();

            if (!res.ok) {
                // Retry on Server Busy (502/504)
                if ((res.status === 504 || res.status === 502) && attempt < 3) {
                    await new Promise(r => setTimeout(r, 1500));
                    return callIcsApi(action, params, method, attempt + 1);
                }
                return { success: false, message: `HTTP Error ${res.status}: ${res.statusText}`, raw: text };
            }

            try { 
                return JSON.parse(text); 
            } catch (e) { 
                console.error("Parse Error:", text);
                return { success: false, message: 'Respon Relay bukan JSON valid.', raw: text }; 
            }
        } catch (e) {
            console.error(`Network Error (Attempt ${attempt}):`, e);
            
            // Auto Retry Logic (Max 3x)
            if (attempt < 3) {
                console.warn("Mencoba menghubungkan ulang ke Relay...");
                await new Promise(r => setTimeout(r, 1000));
                return callIcsApi(action, params, method, attempt + 1);
            }

            return { success: false, message: 'Gagal koneksi ke Relay (Cek Internet/Domain)' };
        }
    }



        window.initAkrabV2Data = async () => {
        const select = document.getElementById('icsProductSelect');
        select.innerHTML = '<option>Memuat...</option>';
        
        // Muat Aturan Harga & Nama Custom
        try {
            const settingsSnap = await getDoc(doc(db, "settings", "pricing"));
            if (settingsSnap.exists()) pricingRules = settingsSnap.data().rules || {};
        } catch(e) { console.log("Load pricing rules error", e); }

        const res = await callIcsApi('listProducts', { type: currentIcsType });
        select.innerHTML = '';

        // PERBAIKAN: Handle Respon Sukses (Gabung Ready + Empty)
        if (res.success && res.data) {
            const readyItems = res.data.ready || [];
            const emptyItems = res.data.empty || [];
            // 1. Gabungkan kedua array
            const allProducts = [...readyItems, ...emptyItems];

            if(allProducts.length === 0) {
                 select.innerHTML = '<option value="" disabled>Produk Kosong</option>';
                 return;
            }

            // 2. Urutkan dari harga termurah
            allProducts.sort((a, b) => a.harga - b.harga);

            select.innerHTML = '<option value="" disabled selected>-- Pilih Produk --</option>';
            
            allProducts.forEach(p => {
                let sellPrice = p.harga;
                let name = p.nama_produk;
                const code = p.kode_produk;

                // LOGIKA BARU: Markup & Rename (Akrab V2)
                if(pricingRules[code]) {
                    const r = pricingRules[code];
                    if(typeof r === 'object') {
                        if(r.price) sellPrice += parseInt(r.price);
                        if(r.name) name = r.name;
                    } else {
                        sellPrice += parseInt(r);
                    }
                } else {
                    sellPrice += 2000; // Default Margin
                }
                
                // Cek apakah produk ini berasal dari list 'empty' atau stoknya 0
                const isHabis = p.stok === 0 || p.stok === '0' || emptyItems.includes(p);

                const opt = document.createElement('option');
                opt.value = code;
                opt.dataset.name = name;
                opt.dataset.price = sellPrice;
                opt.dataset.rawPrice = p.harga;
                
                if (isHabis) {
                    opt.innerHTML = ` ${name} (Habis) - Rp ${window.formatRp(sellPrice)}`;
                    opt.disabled = true;
                    opt.style.color = '#ef4444'; // Warna Merah
                } else {
                    opt.innerHTML = `${name} - Rp ${window.formatRp(sellPrice)}`;
                }
                
                select.appendChild(opt);
            });
        } else {
            select.innerHTML = '<option value="" disabled>Gagal Memuat</option>';
            alert('Gagal memuat produk : ' + (res.message || 'Unknown Error'));
        }
    };



    window.updateIcsPriceDisplay = () => {
        const select = document.getElementById('icsProductSelect');
        const opt = select.options[select.selectedIndex];
        if(opt && opt.dataset.price) {
            document.getElementById('icsPriceDisplay').innerText = `Harga: ${window.formatRp(parseInt(opt.dataset.price))}`;
        }
    };

                // Fungsi Monitoring Otomatis (Auto-Check selama 60 detik)
    window.monitorNewTrx = (trxId) => {
        console.log("Mulai memantau transaksi:", trxId);
        let attempt = 0;
        const maxAttempts = 20; // Cek 20x (1 menit)
        
        const interval = setInterval(async () => {
            attempt++;
            // Cek status diam-diam (background)
                        // Cek status diam-diam (background)
            await window.manualCheckTrx(trxId, 'ICS', true);
            
            // Cek apakah status sudah berubah final di database lokal?
            // Kita ambil data terbaru dari cache/db untuk memutus loop jika sudah selesai
            const cacheKey = `trx_cache_${currentUser.uid}`;
            let cachedData = JSON.parse(localStorage.getItem(cacheKey) || '[]');
            let trx = cachedData.find(t => t.trx_id === trxId);
            
            if (trx && (trx.status === 'Sukses' || trx.status === 'Gagal')) {
                console.log("Transaksi Selesai! Stop monitoring.");
                clearInterval(interval);
            }
            
            if (attempt >= maxAttempts) clearInterval(interval);
        }, 3000); // Cek setiap 3 detik
    };

    window.executeIcsTransaction = async (code, number, price, name, provCode) => {
        window.showLoader(true);
        // Format Baru ICS: ICS-08xx-JamMenitDetik
        const d = new Date();
        const timeStr = String(d.getHours()).padStart(2, '0') + String(d.getMinutes()).padStart(2, '0') + String(d.getSeconds()).padStart(2, '0');
        const cleanNum = number.replace(/[^0-9]/g, '');
        const reffId = 'ICS-' + cleanNum + '-' + timeStr;

        const trxCode = Math.floor(100000 + Math.random() * 900000).toString();
        
        try {
            await runTransaction(db, async (t) => {
                const uRef = doc(db, "users", currentUser.uid);
                const uDoc = await t.get(uRef);
                const bal = uDoc.data().balance || 0;
                if(bal < price) throw "Saldo kurang";
                
                                                                const balanceAfter = bal - price;
                t.update(uRef, { balance: balanceAfter });
                window.logDoniGuardAudit(t, currentUser.uid, 'OUT', price, bal, balanceAfter, reffId, 'Purchase ICS Data');

                const hRef = doc(db, "users", currentUser.uid, "history", reffId);
                t.set(hRef, {
                    title: name,
                    amount: price,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Proses',
                    api_msg: 'Menghubungkan ke server...',
                    trx_id: reffId,
                    trx_code: trxCode,
                    provider_id: 'ICS',
                    provider_code: provCode || 'ICS',
                    raw_code: code,
                    dest_num: number,
                    balance_before: bal,
                    balance_after: balanceAfter
                });
            });
        } catch(e) {
            window.showLoader(false);
            return alert("Gagal proses database: " + e);
        }
        
        // 2. Panggil API ICS
        const apiRes = await callIcsApi('createTransaction', { kode_produk: code, nomor_tujuan: number, refid: reffId }, 'POST');

        window.showLoader(false);

        if(apiRes.success) {
            await updateDoc(doc(db, "users", currentUser.uid, "history", reffId), {
                status: 'Pending',
                api_msg: apiRes.message || 'Sedang diproses',
                supplier_id: apiRes.supplier_trxid || '-',
                raw_json: JSON.stringify(apiRes)
            });
                        
            alert("Transaksi Berhasil Dikirim!\nSistem akan mengecek status otomatis...\nSilakan tunggu sebentar.");
            window.nav('homePage');
            
            // [BARU] Jalankan Auto-Monitor Segera!
            window.monitorNewTrx(reffId);
            
        } else {
            // --- FIX BUG FALSE NEGATIVE ICS (Anti Refund saat RTO) ---
            const errStr = (apiRes.error || apiRes.message || "").toString();
            const isNetworkError = errStr.includes('Failed to fetch') || 
                                 errStr.includes('NetworkError') || 
                                 errStr.includes('Gagal koneksi') ||
                                 errStr.includes('timeout') ||
                                 errStr.includes('upstream');

            if (isNetworkError) {
                console.warn("ICS Network Error - Holding Refund");
                await updateDoc(doc(db, "users", currentUser.uid, "history", reffId), {
                    status: 'Pending',
                    api_msg: 'Koneksi Terputus (Menunggu Konfirmasi)...',
                    raw_json: JSON.stringify(apiRes)
                });
                
                // Trigger auto check manual via existing function logic
                setTimeout(() => window.checkIcsStatus(
                    { trx_id: reffId, amount: price }, 
                    { ref: doc(db, "users", currentUser.uid, "history", reffId) }
                ), 3000);
                
                alert("Koneksi Terputus! Transaksi dianggap PENDING.\nSistem akan mengecek status otomatis.");
                window.nav('homePage');
                        } else {
                // Refund Otomatis (Hanya jika error murni dari server) - LEDGER V2
                // Fungsi ini sudah otomatis mengembalikan saldo & update status ke Gagal
                const refundResult = await window.processSmartRefund(currentUser.uid, reffId, 'Refund: ' + errStr);
                
                alert("Transaksi Gagal: " + errStr + "\n" + (refundResult.msg || "Saldo dikembalikan."));
                window.nav('homePage');
            }
        }
    };




    
    const auth = getAuth(app);
    const db = getFirestore(app);
                // --- DONIGUARD SYSTEM CORE (v3.6) ---
        window.logDoniGuardAudit = (transaction, uid, type, amount, before, after, trxId, note) => {
            const auditId = 'DG-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            const auditRef = doc(db, "doniguard_audit", auditId);
            transaction.set(auditRef, {
                uid: uid, type: type, amount: amount,
                balance_before: before, balance_after: after,
                trx_id: trxId, timestamp: serverTimestamp(), note: note
            });
        };

        window.processSmartRefund = async (uid, trxId, reason = "Refund Sistem") => {
            const userRef = doc(db, "users", uid);
            const historyRef = doc(db, "users", uid, "history", trxId);
            try {
                await runTransaction(db, async (t) => {
                    const trxDoc = await t.get(historyRef);
                    const userDoc = await t.get(userRef);
                    if (!trxDoc.exists() || !userDoc.exists()) throw "Data tidak ditemukan";

                    const trxData = trxDoc.data();
                    const currentBal = userDoc.data().balance || 0;
                    const amountTrx = parseInt(trxData.amount) || 0;
                    const expectedOriginal = trxData.balance_before || (currentBal - amountTrx);

                    // DONIGUARD INTEGRITY CHECK
                    if (trxData.doniguard_status === 'REFUNDED') {
                        if (currentBal > expectedOriginal) {
                            // AUTO SYNC: Deteksi Saldo Ghaib
                            t.update(userRef, { balance: expectedOriginal });
                            window.logDoniGuardAudit(t, uid, 'SYNC', currentBal - expectedOriginal, currentBal, expectedOriginal, trxId, 'DoniGuard: Auto Sync Balanced (Double Refund Blocked)');
                            throw "DoniGuard: Saldo tidak sinkron. Sistem telah memulihkan akun Anda ke titik aman.";
                        }
                        throw "DoniGuard: Transaksi ini sudah dikembalikan sebelumnya.";
                    }

                    const newBalance = currentBal + amountTrx;
                    t.update(userRef, { balance: newBalance });
                    t.update(historyRef, {
                        status: 'Gagal',
                        api_msg: reason,
                        doniguard_status: 'REFUNDED',
                        is_refunded: true,
                        refund_date: new Date().toISOString()
                    });
                    window.logDoniGuardAudit(t, uid, 'REFUND', amountTrx, currentBal, newBalance, trxId, reason);
                });
                return { success: true, msg: "DoniGuard: Saldo diproteksi & dikembalikan." };
            } catch (e) {
                console.warn("DoniGuard Alert:", e);
                return { success: false, msg: typeof e === 'string' ? e : e.message };
            }
        };

    // FIX: Handle Google Redirect Result (Wajib untuk signInWithRedirect)
    getRedirectResult(auth).then(async (result) => {
        if (result && result.user) {
            console.log("Google Redirect Success:", result.user.email);
            // Tampilkan loader, biarkan onAuthStateChanged menangani navigasi
            window.showLoader(true);
        }
    }).catch((error) => {
        window.showLoader(false);
        console.error("Google Redirect Error:", error);
        window.showAlert("Gagal Login", "Gagal memproses login Google: " + error.message, "error");
    });


    // Provider Maintenance Logic
    let providerStatus = {};

    let topupStatus = { manual: true, qios: true };
    function initTopupSettingsListener() {
        onSnapshot(doc(db, "settings", "topup"), (docSnap) => {
            if (docSnap.exists()) topupStatus = docSnap.data();
        });
    }
    window.checkProv = (code) => {
        if(providerStatus[code] === true) {
            alert('Layanan sedang dalam perbaikan (Maintenance).\nSilakan coba lagi nanti.');
            return false;
        }
        return true;
    };

    function initProviderListener() {
        onSnapshot(doc(db, "settings", "providers"), (docSnap) => {
            if (docSnap.exists()) {
                providerStatus = docSnap.data();
                // Update UI
                Object.keys(providerStatus).forEach(key => {
                    // Cek ID Main (prov_KEY) dan ID ICS (prov_ICS_KEY)
                    const el = document.getElementById('prov_' + key) || document.getElementById('prov_ICS_' + key);
                    if(el) {
                        if(providerStatus[key]) el.classList.add('prov-maintenance');
                        else el.classList.remove('prov-maintenance');
                    }
                });
            }
        });
    }
    initProviderListener();
  initTopupSettingsListener();

    auth.languageCode = 'id';

    // Fungsi Notifikasi Update Manual
    window.closeUpdateNotice = () => {
        document.getElementById('updateNoticeModal').classList.add('hide');
    };

    function checkUpdateNotice() {
        const storageKey = 'update_notice_count';
        let count = parseInt(localStorage.getItem(storageKey) || '0');
        
        if (count < 4) {
            setTimeout(() => {
                document.getElementById('updateNoticeModal').classList.remove('hide');
                localStorage.setItem(storageKey, (count + 1).toString());
            }, 2000);
        }
    }
    checkUpdateNotice();

    // VARIABLES
    let currentUser = null;
    let currentBalance = 0;
    let currentUsername = "";
    let transactions = [];
    let globalProducts = [];
    let pendingTrxData = null;
    let pendingTransferData = null; // { targetUid, targetName, amount, type: 'send'|'request_approve' }
    let activeRequestDocId = null; // Untuk handle approve/reject
    let confirmationResult = null;
    let loginMethod = 'email';
    let authMode = 'login';
    let base64ProfilePic = '';
    let isMultiTrx = false;
    let currentFilter = 'all';
    let scanner = null;

    window.startScan = () => {
        window.nav('scanPage');
        if(!scanner) {
             scanner = new Html5Qrcode("reader");
        }
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            window.stopScan();
            // Cek apakah hasil scan adalah angka (Nomor HP/ID Pelanggan)
            if (/^\d+$/.test(decodedText)) {
                window.openPPOB('akrab');
                setTimeout(() => {
                    document.getElementById('ppobNumber').value = decodedText;
                    alert("Nomor Terdeteksi: " + decodedText);
                }, 500);
            } else {
                alert("Hasil Scan: " + decodedText + "\n(Fitur QRIS Pembayaran belum aktif)");
                window.nav('homePage');
            }
        }).catch(err => {
            console.error(err);
            alert("Gagal akses kamera: " + err);
            window.nav('homePage');
        });
    };

    window.stopScan = () => {
        if(scanner) {
            scanner.stop().then(() => {
                 scanner.clear();
                 window.nav('homePage');
            }).catch(err => {
                 console.log("Stop error", err);
                 window.nav('homePage');
            });
        } else {
            window.nav('homePage');
        }
    };
    let pricingRules = {}; // Cache Aturan Harga
    let passwordPromptCallback = null;

    const QIOS_CONFIG = {
        merchant_code: "QP036963",
        api_key: "812feff6d5e883a1b0bb860bb2af215b5cbde41d937ba0e0814edb88334dd5df",
        qr_string: "00020101021126670016COM.NOBUBANK.WWW01189360050300000907180214600239684104160303UMI51440014ID.CO.QRIS.WWW0215ID20254442075210303UMI5204541153033605802ID5919Mini Market Pandawa6011KARANGANYAR61055711162070703A016304DA77",
        base_url: "https://qiospay.com/api" 
    };
    let qiosTicket = null;

    const CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };

    // AUTH & DATA
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            console.log("Logged In:", user.uid);
            setupUserData(user);
            window.nav('homePage');
                        setupRequestListener(user);
            setupGlobalNotificationListener(user);
            startBackgroundService();
        } else {
            currentUser = null;
            console.log("Logged Out");
            window.nav('loginPage');
                        window.showLoader(false);
            if(window.autoCheckInterval) clearInterval(window.autoCheckInterval);
        }
    });

        async function setupUserData(user) {
        const userRef = doc(db, "users", user.uid);
        try {
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                startUserDataListener(user.uid);
            } else {
                window.showLoader(true);
                // Cek email untuk migrasi data lama
                let oldDataFound = false;
                if (user.email) {
                    const q = query(collection(db, "users"), where("email", "==", user.email));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        oldDataFound = true;
                        const oldDoc = querySnapshot.docs[0];
                        const oldData = oldDoc.data();

                        // Pindahkan data ke UID baru
                        await setDoc(userRef, {
                            ...oldData,
                            uid: user.uid,
                            lastLogin: new Date().toISOString()
                        });

                        // Hapus dokumen lama jika ID berbeda
                        if (oldDoc.id !== user.uid) {
                            await deleteDoc(doc(db, "users", oldDoc.id));
                        }
                        startUserDataListener(user.uid);
                    }
                }
                
                if (!oldDataFound) {
                    // User benar-benar baru
                    document.getElementById('setupProfileModal').classList.remove('hide');
                }
                window.showLoader(false);
            }
        } catch (e) {
            console.error(e);
            window.showLoader(false);
            alert("Error memuat data pengguna: " + e.message);
        }
    }

    function startUserDataListener(uid) {
        onSnapshot(doc(db, "users", uid), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Jika data profil (username/dob) belum lengkap, tampilkan modal
                if (!data.username || !data.dob) {
                    document.getElementById('setupProfileModal').classList.remove('hide');
                    return;
                }

                document.getElementById('setupProfileModal').classList.add('hide');
                                window.nav('homePage');
                window.showLoader(false);
                window.startLiveStock(); // Mulai Auto Refresh Stok

                currentBalance = data.balance || 0;
                currentUsername = data.username || "User";
                
                if(document.getElementById('displayBalance')) 
                    document.getElementById('displayBalance').innerText = window.formatRp(currentBalance);
                
                const name = data.username || "Pengguna";
                document.getElementById('headerUsername').innerText = name.length > 15 ? name.substring(0,12)+'...' : name;
                document.getElementById('profileName').innerText = name;
                document.getElementById('profilePhone').innerText = currentUser.email || currentUser.phoneNumber || '-';
                document.getElementById('profileGender').innerText = data.gender || '-';
                document.getElementById('profileDob').innerText = data.dob || '-';
                
                if(data.profile_pic) {
                    document.getElementById('headerProfileImg').src = data.profile_pic;
                    document.getElementById('profilePageImg').src = data.profile_pic;
                }
            } else {
                document.getElementById('setupProfileModal').classList.remove('hide');
            }
        });

        // Listener Riwayat Transaksi
        const historyRef = collection(db, "users", uid, "history");
        const qH = query(historyRef, orderBy("date", "desc"));
        onSnapshot(qH, (snapshot) => {
            transactions = [];
            snapshot.forEach((doc) => transactions.push(doc.data()));

            // Sinkronkan data Firebase ke Cache Lokal setiap ada perubahan
            const cacheKey = `trx_cache_${currentUser.uid}`;
            localStorage.setItem(cacheKey, JSON.stringify(transactions));
            renderHistoryList();
        });
    }

        let activeNotifTimestamp = 0;
    let notifMaxViews = 0;

    function setupGlobalNotificationListener(user) {
        // Realtime Listener untuk Notifikasi Publik
        onSnapshot(doc(db, "global_notif", "active"), (snap) => {
            if(!snap.exists()) return;
            const data = snap.data();
            
            if (data.isActive) {
                // Cek apakah user sudah melihat notif ini sebanyak batas limit
                // Key local storage unik berdasarkan Timestamp Notif
                const storageKey = `notif_view_${data.timestamp}_${user.uid}`;
                const currentViews = parseInt(localStorage.getItem(storageKey) || '0');

                if (currentViews < data.maxViews) {
                    // Simpan state untuk diproses saat close
                    activeNotifTimestamp = data.timestamp;
                    notifMaxViews = data.maxViews;
                    
                    // Render UI
                    if(data.image) {
                        document.getElementById('gNotifImg').src = data.image;
                        document.getElementById('gNotifImageArea').classList.remove('hide');
                    } else {
                        document.getElementById('gNotifImageArea').classList.add('hide');
                    }
                    
                    document.getElementById('gNotifTitle').innerText = data.title || '';
                    document.getElementById('gNotifBody').innerText = data.body || '';
                    
                    // Tampilkan Modal dengan sedikit delay agar transisi halus
                    setTimeout(() => {
                        document.getElementById('globalNotifModal').classList.remove('hide');
                    }, 1500);
                }
            } else {
                // Jika notif dinonaktifkan admin saat user melihat, tutup paksa
                document.getElementById('globalNotifModal').classList.add('hide');
            }
        });
    }

    window.closeGlobalNotif = () => {
        const modal = document.getElementById('globalNotifModal');
        if(!modal.classList.contains('hide')) {
            modal.classList.add('hide');
            // Increment Counter View di LocalStorage saat ditutup
            if(activeNotifTimestamp > 0 && currentUser) {
                const storageKey = `notif_view_${activeNotifTimestamp}_${currentUser.uid}`;
                const currentViews = parseInt(localStorage.getItem(storageKey) || '0');
                localStorage.setItem(storageKey, (currentViews + 1).toString());
            }
        }
    };

  // LISTENER PERMINTAAN DANA (REALTIME)
    function setupRequestListener(user) {
        const requestsRef = collection(db, "requests");
        const q = query(requestsRef, where("targetUid", "==", user.uid), where("status", "==", "pending"));
        
        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const reqData = change.doc.data();
                    showIncomingRequest(change.doc.id, reqData);
                }
            });
        });
    }

    // GLOBAL NAV
    window.handleLogout = () => {
        window.customConfirm('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar dari aplikasi?', async () => {
            window.showLoader(true);
            try {
                await signOut(auth);
            } catch(e) {
                window.showLoader(false);
                alert('Gagal keluar: ' + e.message);
            }
        });
    };

    window.nav = (pageId) => {
        document.querySelectorAll('.page').forEach(el => el.classList.add('hide'));
        document.getElementById(pageId).classList.remove('hide');
        document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-blue-600', 'dark:text-blue-400'); el.classList.add('text-gray-400', 'dark:text-gray-500'); });
        const navId = 'nav-' + pageId.replace('Page','');
        if(document.getElementById(navId)) { document.getElementById(navId).classList.remove('text-gray-400', 'dark:text-gray-500'); document.getElementById(navId).classList.add('text-blue-600', 'dark:text-blue-400'); }
        if(pageId === 'loginPage' || pageId === 'scanPage') document.getElementById('bottomNav').classList.add('hide'); else document.getElementById('bottomNav').classList.remove('hide');
        if(pageId === 'homePage') renderHistoryList();
    };

    // --- FITUR KIRIM (TRANSFER) ---
    window.initiateSend = async () => {
        try {
            const username = document.getElementById('sendTargetUser').value;
            const amount = parseInt(document.getElementById('sendAmount').value);

            if(!username) return alert("Masukkan username tujuan!");
            if(!amount || amount < 1000) return alert("Minimal transfer Rp 1.000");
            if(amount > currentBalance) return alert("Saldo tidak cukup!");

            window.showLoader(true);
            const targetUser = await findUserByUsername(username);
            window.showLoader(false);

            if(!targetUser) return alert("Username tidak ditemukan!");
            if(targetUser.uid === currentUser.uid) return alert("Tidak bisa transfer ke diri sendiri!");

            pendingTransferData = { targetUid: targetUser.uid, targetName: targetUser.username, amount: amount, type: 'send' };
            
            // Minta Password untuk konfirmasi
            openPasswordPrompt((password) => {
                verifyPasswordAndExecute(password);
            });
        } catch (e) {
            window.showLoader(false);
            alert("Terjadi kesalahan: " + e.message);
        }
    };

    // --- FITUR MINTA (REQUEST) ---
    window.initiateRequest = async () => {
        try {
            const username = document.getElementById('reqTargetUser').value;
            const amount = parseInt(document.getElementById('reqAmountInput').value);

            if(!username) return alert("Masukkan username tujuan!");
            if(!amount || amount < 1000) return alert("Minimal minta Rp 1.000");

            window.showLoader(true);
            const targetUser = await findUserByUsername(username);
            window.showLoader(false);

            if(!targetUser) return alert("Username tidak ditemukan!");
            if(targetUser.uid === currentUser.uid) return alert("Tidak bisa minta ke diri sendiri!");

            await addDoc(collection(db, "requests"), {
                senderUid: currentUser.uid,
                senderName: currentUsername,
                targetUid: targetUser.uid,
                amount: amount,
                status: "pending",
                timestamp: new Date().toISOString()
            });
            window.showAlert("Berhasil", "Permintaan berhasil dikirim ke " + targetUser.username, "success");
            window.nav('homePage');
        } catch(e) {
            window.showLoader(false);
            alert("Gagal mengirim permintaan: " + e.message);
        }
    };

    // --- NOTIFIKASI MINTA (RECEIVER SIDE) ---
    function showIncomingRequest(docId, data) {
        activeRequestDocId = docId;
        pendingTransferData = { 
            targetUid: data.senderUid, // Kita transfer balik ke pengirim request
            targetName: data.senderName, 
            amount: data.amount,
            type: 'request_approve'
        };
        
        document.getElementById('reqSenderName').innerText = data.senderName;
        document.getElementById('reqAmount').innerText = window.formatRp(data.amount);
        document.getElementById('incomingRequestModal').classList.remove('hide');
    }

    window.rejectRequest = async () => {
        if(activeRequestDocId) {
            await deleteDoc(doc(db, "requests", activeRequestDocId));
            document.getElementById('incomingRequestModal').classList.add('hide');
            alert("Permintaan ditolak.");
        }
    };

    window.approveRequest = () => {
        document.getElementById('incomingRequestModal').classList.add('hide');
        // Langsung tampilkan invoice / konfirmasi password
        openPasswordPrompt((password) => {
            verifyPasswordAndExecute(password);
        });
    };

    // --- LOGIKA TRANSFER & PASSWORD ---
    
    // Helper: Cari User by Username
    async function findUserByUsername(username) {
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", username));
        const querySnapshot = await getDocs(q);
        if(!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            return { uid: doc.id, ...doc.data() };
        }
        return null;
    }

    // Helper: Simple Confirmation Prompt (Updated)
    window.openPasswordPrompt = (callback) => {
        document.getElementById('confirmPasswordInput').value = '';
        document.getElementById('passwordPromptModal').classList.remove('hide');
        passwordPromptCallback = callback;
        setTimeout(() => document.getElementById('confirmPasswordInput').focus(), 100);
    }
    
    window.closePasswordPrompt = () => {
        document.getElementById('passwordPromptModal').classList.add('hide');
        passwordPromptCallback = null;
    }

    document.getElementById('btnConfirmPassword').addEventListener('click', () => {
        const input = document.getElementById('confirmPasswordInput').value.trim().toLowerCase();
        if(input !== 'ya') return alert("Ketik 'ya' untuk konfirmasi!");
        if(passwordPromptCallback) {
             const callback = passwordPromptCallback;
             window.closePasswordPrompt();
             callback();
        }
    });

    // Verifikasi Auth & Eksekusi Transfer (Tanpa Password)
    async function verifyPasswordAndExecute(ignored) {
        await executeTransfer();
    }

    async function executeTransfer() {
        window.showLoader(true);
        const { targetUid, targetName, amount, type } = pendingTransferData;
        const senderRef = doc(db, "users", currentUser.uid);
        const receiverRef = doc(db, "users", targetUid);
        const trxId = 'TRX-' + Date.now();

        try {
            await runTransaction(db, async (transaction) => {
                const senderDoc = await transaction.get(senderRef);
                if (!senderDoc.exists()) throw "User tidak ditemukan!";
                
                const senderBalance = senderDoc.data().balance || 0;
                if (senderBalance < amount) throw "Saldo tidak cukup!";

                const receiverDoc = await transaction.get(receiverRef);
                const receiverBalance = receiverDoc.data().balance || 0;

                const balanceBefore = senderBalance;
                const balanceAfter = senderBalance - amount;

                // 1. Kurangi Saldo Pengirim
                transaction.update(senderRef, { balance: senderBalance - amount });
                
                // 2. Tambah Saldo Penerima
                transaction.update(receiverRef, { balance: receiverBalance + amount });

                                // 3. Catat History Pengirim
                const senderHistoryRef = doc(db, "users", currentUser.uid, "history", trxId);
                transaction.set(senderHistoryRef, {
                    title: `Kirim ke ${targetName}`,
                    amount: amount,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Sukses',
                    api_msg: 'Transfer Sesama',
                    trx_id: trxId,
                    balance_before: balanceBefore,
                    balance_after: balanceAfter
                });

                // 4. Catat History Penerima
                const receiverHistoryRef = doc(db, "users", targetUid, "history", trxId);
                transaction.set(receiverHistoryRef, {
                    title: `Terima dari ${currentUsername}`,
                    amount: amount,
                    type: 'in',
                    date: new Date().toISOString(),
                    status: 'Sukses',
                    api_msg: 'Transfer Masuk',
                    trx_id: trxId
                });

                // 5. Jika ini Approval Request, hapus requestnya
                if(type === 'request_approve' && activeRequestDocId) {
                    const reqRef = doc(db, "requests", activeRequestDocId);
                    transaction.delete(reqRef);
                }
            });

            window.showLoader(false);
            alert("Transfer Berhasil!");
            window.nav('homePage');

        } catch (e) {
            window.showLoader(false);
            alert("Transfer Gagal: " + e);
        }
    }

    // --- EXISTING CODE (AUTH, UI, ETC) ---

    
    
    // --- TOAST NOTIFICATION SYSTEM ---
    window.showToast = (message, type = 'info') => {
        const container = document.getElementById('toastContainer');
        if(!container) return;
        const toast = document.createElement('div');
        
        let bgClass = 'bg-gray-800';
        let icon = '<i class="fas fa-info-circle"></i>';
        
        if(type === 'success') { bgClass = 'bg-green-600'; icon = '<i class="fas fa-check-circle"></i>'; }
        if(type === 'error') { bgClass = 'bg-red-600'; icon = '<i class="fas fa-exclamation-circle"></i>'; }
        if(type === 'warning') { bgClass = 'bg-orange-500'; icon = '<i class="fas fa-clock"></i>'; }

        toast.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-xl text-white text-xs font-bold transform transition-all duration-300 translate-x-10 opacity-0 ${bgClass}`;
        toast.innerHTML = `${icon} <span>${message}</span>`;

        container.appendChild(toast);

        requestAnimationFrame(() => {
            toast.classList.remove('translate-x-10', 'opacity-0');
        });

        setTimeout(() => {
            toast.classList.add('translate-x-10', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

  window.showAlert = (title, message, type = 'info') => {
        const modal = document.getElementById('customAlertModal');
        const iconContainer = document.getElementById('alertIconContainer');
        const icon = document.getElementById('alertIcon');
        const titleEl = document.getElementById('alertTitle');
        const msgEl = document.getElementById('alertMessage');

        titleEl.innerText = title;
        msgEl.innerText = message;

        iconContainer.className = 'w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg ';
        
        if (type === 'success') {
            iconContainer.classList.add('bg-green-500', 'shadow-green-500/30');
            icon.className = 'fas fa-check-circle text-4xl text-white';
        } else if (type === 'error') {
            iconContainer.classList.add('bg-red-500', 'shadow-red-500/30');
            icon.className = 'fas fa-exclamation-triangle text-4xl text-white';
        } else {
            iconContainer.classList.add('bg-blue-600', 'shadow-blue-600/30');
            icon.className = 'fas fa-info-circle text-4xl text-white';
        }

        modal.classList.remove('hide');
    };

    window.closeAlert = () => {
        document.getElementById('customAlertModal').classList.add('hide');
    };

    // Override default alert browser
    const nativeAlert = window.alert;
    window.alert = (msg) => {
        let title = 'Informasi';
        let type = 'info';
        const lowMsg = String(msg).toLowerCase();

        if (lowMsg.includes('berhasil') || lowMsg.includes('sukses')) {
            title = 'Berhasil';
            type = 'success';
        } else if (lowMsg.includes('gagal') || lowMsg.includes('kurang') || lowMsg.includes('salah') || lowMsg.includes('tidak') || lowMsg.includes('error')) {
            title = 'Perhatian';
            type = 'error';
        }

        window.showAlert(title, msg, type);
    };
  window.formatRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    window.showLoader = (show) => document.getElementById('globalLoader').classList.toggle('hide', !show);
    window.toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); };
    window.customConfirm = (t, m, c) => { document.getElementById('confirmTitle').innerText = t; document.getElementById('confirmMessage').innerText = m; document.getElementById('customConfirmModal').classList.remove('hide'); window.confirmCallback = c; };
    window.closeConfirm = (r) => { document.getElementById('customConfirmModal').classList.add('hide'); if(r && window.confirmCallback) window.confirmCallback(); };
    document.getElementById('confirmYesBtn').onclick = () => window.closeConfirm(true);

    // AUTH LOGIC
    window.loginWithGoogle = async () => {
    window.showLoader(true);
    const provider = new GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');

    try {
        // PERBAIKAN: Menggunakan signInWithPopup (Sesuai patokan.html)
        // Metode ini membuka jendela login tanpa me-refresh halaman utama
        // sehingga state aplikasi terjaga dan langsung masuk menu utama
        await signInWithPopup(auth, provider);
        console.log("Login Google Berhasil (Popup Mode)");
        
    } catch (error) {
        window.showLoader(false);
        console.error("Google Login Error:", error);
        
        if (error.code === 'auth/popup-closed-by-user') {
            window.showAlert("Batal", "Proses login dibatalkan.", "info");
        } else {
            window.showAlert("Gagal Login", error.message, "error");
        }
    }
  };


        window.saveProfileSetup = async () => {
        const username = document.getElementById('setupUsername').value;
        const gender = document.getElementById('setupGender').value;
        const dob = document.getElementById('setupDob').value;

        if(!username || !gender || !dob) return window.showAlert("Lengkapi Data", "Mohon lengkapi semua data!", "error");
        
        window.showLoader(true);
        try {
            let finalBalance = 0;
            // Setup URL Foto Profil default dengan benar
            let defaultPic = "https://api.dicebear.com/7.x/avataaars/svg?seed=" + encodeURIComponent(username);
            let finalProfilePic = base64ProfilePic || currentUser.photoURL || defaultPic;

            // Cek ulang email di database untuk migrasi susulan (Jaga-jaga)
            if (currentUser.email) {
                const q = query(collection(db, "users"), where("email", "==", currentUser.email));
                const querySnapshot = await getDocs(q);
                
                for (const oldDoc of querySnapshot.docs) {
                    if (oldDoc.id !== currentUser.uid) {
                        const oldData = oldDoc.data();
                        finalBalance = (finalBalance || 0) + (oldData.balance || 0);
                        if (oldData.profile_pic) finalProfilePic = oldData.profile_pic;
                        await deleteDoc(doc(db, "users", oldDoc.id));
                    }
                }
            }

            await setDoc(doc(db, "users", currentUser.uid), {
                email: currentUser.email,
                username: username,
                gender: gender,
                dob: dob,
                balance: finalBalance,
                profile_pic: finalProfilePic,
                createdAt: new Date().toISOString(),
                authMethod: 'email'
            }, { merge: true });
            
            document.getElementById('setupProfileModal').classList.add('hide');
            window.showLoader(false);
            alert("Profil berhasil disimpan dan disinkronkan.");
            window.nav('homePage');
        } catch(e) {
            window.showLoader(false);
            alert("Gagal menyimpan profil: " + e.message);
        }
    };

    window.switchLoginMethod = (method) => { 
        loginMethod = method;
        const tabEmail = document.getElementById('tabEmail');
        const tabPhone = document.getElementById('tabPhone');
        const input = document.getElementById('emailInput');
        const icon = document.getElementById('loginIcon');
        
        if(method === 'email') {
            tabEmail.className = 'flex-1 py-2 rounded-lg text-xs font-bold bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400 transition-all';
            tabPhone.className = 'flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all';
            input.placeholder = 'Alamat Email';
            input.type = 'email';
            icon.className = 'fas fa-envelope';
        } else {
             alert('Login No. HP sedang pemeliharaan. Silakan gunakan Email.');
        }
    };

    window.setAuthMode = (mode) => {
        authMode = mode;
        const title = document.getElementById('authTitle');
        const btn = document.getElementById('btnAuthAction');
        const regFields = document.getElementById('registerFields');
        const passContainer = document.getElementById('passContainer');
        const extras = document.getElementById('extraOptions');
        const footer = document.getElementById('authFooter');
        const backBtn = document.getElementById('backToLoginContainer');
        const status = document.getElementById('statusMessage');
        
        status.innerText = 'Aman & Terenkripsi';

        if (mode === 'login') {
            title.innerText = 'Masuk Akun';
            btn.innerText = 'MASUK';
            regFields.classList.add('hide');
            passContainer.classList.remove('hide');
            extras.classList.remove('hide');
            footer.classList.remove('hide');
            backBtn.classList.add('hide');
        } else if (mode === 'register') {
            title.innerText = 'Daftar Akun Baru';
            btn.innerText = 'DAFTAR SEKARANG';
            regFields.classList.remove('hide');
            passContainer.classList.remove('hide');
            extras.classList.add('hide');
            footer.classList.add('hide');
            backBtn.classList.remove('hide');
        } else if (mode === 'forgot') {
            title.innerText = 'Reset Kata Sandi';
            btn.innerText = 'KIRIM LINK RESET';
            regFields.classList.add('hide');
            passContainer.classList.add('hide');
            extras.classList.add('hide');
            footer.classList.add('hide');
            backBtn.classList.remove('hide');
        }
    };
    
    // API CALLER
    // Lokasi file relaykhfy.js (Sesuaikan jika path berbeda)
  const KHFY_RELAY_URL = "/api/relaykhfy"; // Format Vercel Serverless Function

  async function callApi(endpoint, params = {}, attempt = 1) {
    // 1. Setup Parameter Dasar
    params['api_key'] = CONFIG.apiKey;
    params['_t'] = Date.now();

    // 2. PRIORITAS UTAMA: Coba Via Relay Sendiri (relaykhfy.js)
    try {
        if(attempt === 1) console.log("[API] Mencoba via Relay KHFY...");
        
        const relayParams = new URLSearchParams({ endpoint: endpoint, ...params }).toString();
        const relayUrl = `${KHFY_RELAY_URL}?${relayParams}`;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);

        const res = await fetch(relayUrl, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (res.ok) {
            const text = await res.text();
            if (text && !text.trim().startsWith('<')) {
                try {
                    const json = JSON.parse(text);
                    return { ok: true, data: json };
                } catch(e) { console.warn("[API] Relay JSON Invalid"); }
            }
        } else {
             // Jika Server Relay 502/504 (Cold Boot), Retry Internal Relay
             if((res.status === 502 || res.status === 504) && attempt < 3) {
                 console.log("Relay Cold Boot detected, retrying...");
                 await new Promise(r => setTimeout(r, 1500));
                 return callApi(endpoint, params, attempt + 1);
             }
        }
    } catch (e) {
        console.warn("[API] Relay Gagal, beralih ke jalur cadangan...", e);
    }

    // 3. JALUR CADANGAN: Public Proxy Loop
    // Jika Relay Gagal total, baru kita masuk sini
    const queryString = new URLSearchParams(params).toString();
    const targetUrl = `${CONFIG.baseUrl}${endpoint}?${queryString}`;
    
    let lastError = '';

    for (const proxy of PROXY_LIST) {
        console.log(`[API] Mencoba via ${proxy.name}...`);
        const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            const response = await fetch(fullUrl, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (response.ok) {
                const text = await response.text();
                if (!text || text.trim().startsWith('<')) continue;
                
                try {
                    const data = JSON.parse(text);
                    return { ok: true, data: data };
                } catch (e) { continue; }
            }
        } catch (error) {
            lastError = error.message;
        }
    }

    // FINAL RETRY LOGIC (Jika semua jalur gagal)
    if (attempt < 3) {
        console.warn(`[API] Gagal Total (Percobaan ${attempt}), Mengulang...`);
        await new Promise(r => setTimeout(r, 1000));
        return callApi(endpoint, params, attempt + 1);
    }

    return { ok: false, error: `Gagal Koneksi (Semua Jalur). Detail: ${lastError}` };
  }

    // Initialize
    window.updateUI = () => {}; 
    
    // Auth Event Listeners (Register, Login, etc)
    document.getElementById('togglePassBtn').addEventListener('click', () => {
        const input = document.getElementById('passwordInput');
        const icon = document.querySelector('#togglePassBtn i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

                    document.getElementById('btnAuthAction').addEventListener('click', async () => {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        const status = document.getElementById('statusMessage');

        if(!email) return window.showAlert("Lengkapi Data", "Mohon isi Email!", "error");
        status.innerText = "Memproses...";

        // 1. HANDLER LUPA SANDI
        if(authMode === 'forgot') {
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Link reset password telah dikirim ke: " + email + "\nSilakan cek inbox/spam email Anda.");
                window.setAuthMode('login');
                status.innerText = "Email Terkirim";
            } catch(e) {
                status.innerText = "Gagal Kirim";
                alert("Gagal: " + e.message);
            }
            return;
        }

        // 2. VALIDASI PASSWORD
        if(!password) {
            status.innerText = "Menunggu Input";
            return alert("Mohon isi Kata Sandi!");
        }

        window.showLoader(true);

        // 3. HANDLER LOGIN
        if(authMode === 'login') {
            try { 
                await signInWithEmailAndPassword(auth, email, password);
            } catch(e) {
                window.showLoader(false);
                status.innerText = "Gagal Login";
                if (e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    alert("Login Gagal: Email tidak ditemukan atau Kata Sandi salah.");
                } else {
                    alert("Login Gagal: " + e.message);
                }
            }
        
        // 4. HANDLER REGISTER (LOGIKA AUTO-MIGRASI)
        } else if (authMode === 'register') {
            const username = document.getElementById('regUsername').value;
            const gender = document.getElementById('regGender').value;
            const dob = document.getElementById('regDob').value;

            if(!username || !gender || !dob) {
                window.showLoader(false);
                return alert("Mohon lengkapi Username, Gender, dan Tanggal Lahir!");
            }

            try {
                // A. BUAT AKUN AUTH
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const newUid = cred.user.uid;

                // B. CEK DATABASE (AUTO TRANSFER)
                try {
                    const q = query(collection(db, "users"), where("email", "==", email));
                    const querySnapshot = await getDocs(q);
                    const oldDoc = querySnapshot.docs.find(doc => doc.id !== newUid);

                    if (oldDoc) {
                        // === ADA DATA LAMA -> EKSEKUSI LANGSUNG ===
                        const oldData = oldDoc.data();
                        
                        try {
                            // 1. Salin data ke UID baru
                            await setDoc(doc(db, "users", newUid), {
                                ...oldData,
                                uid: newUid,
                                email: email,
                                migratedAt: new Date().toISOString(),
                                lastLogin: new Date().toISOString()
                            });

                            // 2. Hapus data lama
                            await deleteDoc(doc(db, "users", oldDoc.id));

                            window.showLoader(false);
                            
                            // 3. Notifikasi Sukses (Hanya Tombol OK)
                            alert("AKUN LAMA DITEMUKAN!\n\nData & Saldo Anda berhasil dipindahkan otomatis ke akun baru.\nSilakan klik OK untuk masuk.");
                            
                            document.getElementById('setupProfileModal').classList.add('hide');
                            window.nav('homePage');
                            
                        } catch (migrasiErr) {
                            console.error("Migrasi Error:", migrasiErr);
                            window.showLoader(false);
                            // Penanganan Error Permission
                            if(String(migrasiErr).includes("permission")) {
                                alert("Data berhasil disalin, namun data lama gagal dihapus otomatis (Masalah Izin).\nSilakan hubungi Admin untuk pembersihan data duplikat.");
                            } else {
                                alert("Gagal Transfer Otomatis: " + migrasiErr.message);
                            }
                            window.nav('homePage');
                        }
                    } else {
                        // === TIDAK ADA DATA LAMA ===
                        await createNewUserProfile(newUid, email, username, gender, dob);
                    }
                } catch (dbErr) {
                    console.error("DB Check Error:", dbErr);
                    await createNewUserProfile(newUid, email, username, gender, dob);
                }

            } catch(e) { 
                window.showLoader(false);
                status.innerText = "Gagal Daftar";
                if (e.code === 'auth/email-already-in-use') {
                    alert("Email ini SUDAH TERDAFTAR.\nSilakan LOGIN saja untuk mengakses saldo lama Anda.");
                    window.setAuthMode('login');
                } else {
                    alert("Gagal Daftar: " + e.message); 
                }
            }
        }
    });

    async function createNewUserProfile(uid, email, username, gender, dob) {
        await setDoc(doc(db, "users", uid), {
            email: email, 
            balance: 0, 
            username: username,
            gender: gender,
            dob: dob,
            profile_pic: base64ProfilePic || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(username)}`,
            createdAt: new Date().toISOString(),
            authMethod: 'email'
        });
        window.showLoader(false);
        alert("Pendaftaran Berhasil!");
        document.getElementById('setupProfileModal').classList.add('hide');
        window.nav('homePage');
    }

    window.previewImage = (input, type = 'reg') => { 
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                if(type === 'setup') {
                     const el = document.getElementById('setupProfilePreview');
                     if(el) { el.src = e.target.result; el.style.display = 'block'; }
                     const ph = document.getElementById('setupUploadPlaceholder');
                     if(ph) ph.style.display = 'none';
                } else {
                     document.getElementById('profilePreview').src = e.target.result;
                     document.getElementById('profilePreview').style.display = 'block';
                     document.getElementById('uploadPlaceholder').style.display = 'none';
                }
                
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); canvas.width = 400; canvas.height = 400;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 400, 400);
                    base64ProfilePic = canvas.toDataURL('image/jpeg', 0.7);
                };
                img.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    };

    // HISTORY & PDF
    window.downloadHistoryPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Ambil data lengkap dari cache
        const cacheKey = `trx_cache_${currentUser.uid}`;
        let allData = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        
        if (allData.length === 0) {
            alert("Tidak ada data transaksi untuk diunduh.");
            return;
        }

        // Judul PDF
        doc.setFontSize(18);
        doc.text("Laporan Riwayat Transaksi - Pandawa Store", 14, 20);
        doc.setFontSize(11);
        doc.text(`Nama Pengguna: ${currentUsername}`, 14, 30);
        doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, 14, 37);

        // Persiapkan baris tabel
        const rows = allData.map(t => [
            new Date(t.date).toLocaleString('id-ID'),
            t.title,
            t.dest_num || "-",
            window.formatRp(t.amount),
            t.status
        ]);

        // Generate Tabel
        doc.autoTable({
            startY: 45,
            head: [['Tanggal', 'Produk/Layanan', 'Tujuan', 'Nominal', 'Status']],
            body: rows,
            theme: 'striped',
            headStyles: { fillColor: [37, 99, 235] },
            styles: { fontSize: 9 }
        });

        const fileName = `Riwayat_PandawaStore_${currentUsername}.pdf`;

        // DETEKSI APAKAH DI DALAM APLIKASI ANDROID (AIDE)?
        if (window.AndroidApp && window.AndroidApp.savePdfFromBase64) {
             // JIKA DI APLIKASI: Kirim data PDF (Base64) ke Java untuk disimpan
             const pdfData = doc.output('datauristring');
             window.AndroidApp.savePdfFromBase64(pdfData, fileName);
        } else {
             // JIKA DI BROWSER BIASA: Download normal
             doc.save(fileName);
        }
    };
    window.filterHistory = (t) => { currentFilter=t; renderHistoryList(); };
        window.filterHistoryByDate = (selectedDate) => {
        if(!selectedDate) return;
        renderHistoryList(selectedDate);
    };

    window.renderHistoryList = (filterDate = null) => {
        const cacheKey = `trx_cache_${currentUser.uid}`;
        let cachedData = JSON.parse(localStorage.getItem(cacheKey) || '[]');

        if (cachedData.length === 0 && transactions.length > 0) {
            cachedData = [...transactions];
            localStorage.setItem(cacheKey, JSON.stringify(cachedData));
        }

        // Default ke hari ini jika tidak ada filter
        const today = new Date().toISOString().split('T')[0];
        const dateToFilter = filterDate || today;
        
        // Update UI Input Date agar sinkron
        const dateInput = document.getElementById('historyDateFilter');
        if(dateInput) dateInput.value = dateToFilter;

        // Filter data berdasarkan tanggal (YYYY-MM-DD)
        const filtered = cachedData.filter(t => {
            const trxDate = new Date(t.date).toISOString().split('T')[0];
            return trxDate === dateToFilter;
        });

        // --- RENDER FULL HISTORY (PAGE RIWAYAT) ---
        let html = '';
        if(filtered.length === 0) html = '<div class="text-center text-gray-400 text-xs py-10">Belum ada riwayat</div>';
        else {
            filtered.forEach(t => {
                const isOut = t.type === 'out';
                let statusClass = t.status === 'Sukses' ? 'text-green-600 bg-green-50 border-green-100' : (t.status === 'Gagal' || String(t.status).includes('Batal') ? 'text-red-500 bg-red-50 border-red-100' : 'text-orange-500 bg-orange-50 border-orange-100');
                let statusIcon = t.status === 'Sukses' ? '<i class="fas fa-check-circle"></i>' : (t.status === 'Gagal' || String(t.status).includes('Batal') ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-clock"></i>');

                html += `<div onclick="openTrxDetail('${t.trx_id}')" class="cursor-pointer active:scale-[0.98] transition-transform bg-white dark:bg-gray-900 p-3 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${isOut?'bg-blue-100 text-blue-600':'bg-green-100 text-green-600'}"><i class="fas ${isOut?'fa-arrow-up':'fa-arrow-down'}"></i></div>
                            <div><p class="font-bold text-sm text-gray-800 dark:text-white">${t.title}</p><p class="text-[10px] text-gray-400">${new Date(t.date).toLocaleString('id-ID')}</p></div>
                        </div>
                        <div class="text-right"><p class="text-sm font-bold ${isOut?'text-gray-800 dark:text-white':'text-green-600'}">${isOut?'-':'+'} ${window.formatRp(t.amount)}</p><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[9px] font-bold border ${statusClass}">${statusIcon} ${t.status}</span></div>
                    </div>
                </div>`;
            });
        }
        const fullHistEl = document.getElementById('fullHistory');
        if(fullHistEl) fullHistEl.innerHTML = html;

        // --- RENDER MINI HISTORY (HOME) - LIMIT 5 ---
        const miniHistEl = document.getElementById('miniHistory');
        if(miniHistEl) {
            let miniHtml = '';
            const miniData = cachedData.slice(0, 5);
            if(miniData.length === 0) miniHtml = '<div class="text-center text-gray-400 text-[10px] py-4">Belum ada transaksi</div>';
            else {
                miniData.forEach(t => {
                    const isOut = t.type === 'out';
                    let statusColor = t.status === 'Sukses' ? 'text-green-600' : (t.status === 'Gagal' ? 'text-red-500' : 'text-orange-500');
                    miniHtml += `<div onclick="openTrxDetail('${t.trx_id}')" class="cursor-pointer active:scale-[0.98] transition-transform flex justify-between items-center border-b border-gray-50 dark:border-gray-800 pb-3 last:border-0 last:pb-0">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full flex items-center justify-center ${isOut?'bg-blue-50 text-blue-600':'bg-green-50 text-green-600'}"><i class="fas ${isOut?'fa-arrow-up':'fa-arrow-down'} text-xs"></i></div>
                            <div class="flex-1 min-w-0"><p class="font-bold text-xs text-gray-800 dark:text-white line-clamp-1">${t.title}</p><div class="flex items-center gap-2"><p class="text-[9px] text-gray-400">${new Date(t.date).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</p><span class="text-[8px] font-bold px-1.5 py-0.5 rounded border border-gray-100 dark:border-gray-700 ${statusColor}">${t.status}</span></div></div>
                        </div>
                        <p class="text-xs font-bold ${isOut?'text-gray-800 dark:text-white':'text-green-600'}">${isOut?'-':'+'} ${window.formatRp(t.amount)}</p>
                    </div>`;
                });
            }
            miniHistEl.innerHTML = miniHtml;
        }
        
        if(window.renderTopUpHistory) window.renderTopUpHistory();
        if(window.checkPendingTrx) window.checkPendingTrx();
    }

    // PPOB Logic
    window.openPPOB = async (cat) => { 
        document.getElementById('homePage').classList.add('hide'); 
        document.getElementById('ppobPage').classList.remove('hide'); 
        document.getElementById('bottomNav').classList.add('hide');
        
        const pSelect = document.getElementById('formProvider');
        if(pSelect) pSelect.value = "";

        await window.initProductData();

        if (cat === 'akrab' && pSelect) {
            const optXDA = pSelect.querySelector('option[value="XDA"]');
            pSelect.value = optXDA ? 'XDA' : 'XLA';
            window.updateProductDropdown();
            const tEl = document.getElementById('ppobTitle');
            if(tEl) tEl.innerText = 'Paket XL Akrab';
        } else {
            const tEl = document.getElementById('ppobTitle');
            if(tEl) tEl.innerText = 'Isi Pulsa (Live API)';
        }
    };
    window.closePPOB = () => window.nav('homePage');
    
        // --- CUSTOM SHEET LOGIC ---
        // --- CUSTOM SHEET LOGIC (FIXED) ---
    window.openSheet = (type) => {
        if(type === 'product') {
             const prov = document.getElementById('formProvider').value;
             if(!prov) return alert('Pilih Provider dulu!');
             if(document.getElementById('btnProductTrigger').classList.contains('cursor-not-allowed')) return;
             document.getElementById('sheetProduct').classList.remove('hide');
        } else {
             document.getElementById('sheetProvider').classList.remove('hide');
        }
        document.getElementById('sheetOverlay').classList.remove('hide');
        document.body.style.overflow = 'hidden';
    };

    window.closeAllSheets = () => {
        document.getElementById('sheetProvider').classList.add('hide');
        document.getElementById('sheetProduct').classList.add('hide');
        if(document.getElementById('sheetIcsProvider')) document.getElementById('sheetIcsProvider').classList.add('hide');
        document.getElementById('sheetOverlay').classList.add('hide');
        document.body.style.overflow = '';
    };

    window.selectProvider = (code, name) => {
        const isPreorder = !document.getElementById('preorderPage').classList.contains('hide');
        if (isPreorder) {
            document.getElementById('displayProviderPO').innerText = name;
            document.getElementById('formProvider').value = code;
        } else {
            document.getElementById('formProvider').value = code;
            document.getElementById('displayProvider').innerText = name;
        }
        
        if (!isPreorder) {
            document.getElementById('formProduct').value = '';
            document.getElementById('displayProduct').innerText = 'Memuat Produk...';
            document.getElementById('priceDisplay').innerText = '';
            document.getElementById('productDescription').classList.add('hide');
        } else {
            document.getElementById('displayProductPO').innerText = '-- Pilih Produk --';
            document.getElementById('formProduct').value = '';
        }
        
        closeAllSheets();
        window.updateProductDropdown();
    };

    window.selectProduct = (code, name, price, desc, encodedName) => {
        const isPreorder = !document.getElementById('preorderPage').classList.contains('hide');
        const finalName = encodedName ? decodeURIComponent(encodedName) : name;
        
        if (isPreorder) {
            document.getElementById('displayProductPO').innerText = finalName;
        } else {
            document.getElementById('displayProduct').innerText = finalName;
        }

        document.getElementById('formProduct').value = code;
        document.getElementById('selectedProductName').value = finalName;
        document.getElementById('selectedProductPrice').value = price;
        
        if (!isPreorder) {
            document.getElementById('priceDisplay').innerText = `Harga: Rp ${window.formatRp(price)}`;
            const descBox = document.getElementById('productDescription');
            if(desc && desc !== 'undefined' && desc.trim() !== '') {
                 descBox.innerHTML = '<div class="font-bold mb-1 text-blue-600 dark:text-blue-400"><i class="fas fa-info-circle mr-1"></i>Detail Paket:</div>' + desc.replace(/\r?\n/g, '<br>');
                 descBox.classList.remove('hide');
            } else {
                 descBox.classList.add('hide');
            }
        }

        closeAllSheets();
    };

    window.initProductData = async () => {
        const btnProd = document.getElementById('btnProductTrigger');
        const txtProd = document.getElementById('displayProduct');
        
        try {
            const settingsSnap = await getDoc(doc(db, "settings", "pricing"));
            if (settingsSnap.exists()) pricingRules = settingsSnap.data().rules || {};
        } catch(e) { console.log("Gagal load harga custom", e); }

        if(txtProd) txtProd.innerText = 'Menghubungkan Server...';
        if(btnProd) btnProd.classList.add('cursor-not-allowed', 'opacity-50');
        
        const result = await callApi('/list_product');
        
        if (result.ok && result.data) {
            if (result.data.data && Array.isArray(result.data.data)) globalProducts = result.data.data;
            else if (Array.isArray(result.data)) globalProducts = result.data;
            else if (result.data.products) globalProducts = result.data.products;
            
            console.log("Total Produk Dimuat:", globalProducts.length);

            if (globalProducts.length > 0) {
                if(document.getElementById('formProvider').value) {
                    window.updateProductDropdown();
                } else {
                    if(txtProd) txtProd.innerText = 'Pilih Provider Dahulu';
                }
            } else {
                if(txtProd) txtProd.innerText = 'Produk Kosong';
            }
        } else {
            if(txtProd) txtProd.innerText = 'Gagal Koneksi';
            alert('Gagal mengambil data produk (Koneksi Bermasalah).\n' + result.error);
        }
    };

        window.updateProductDropdown = async () => {
        const providerCode = document.getElementById('formProvider').value;
        const listContainer = document.getElementById('sheetProductList');
        const btnProd = document.getElementById('btnProductTrigger');
        const txtProd = document.getElementById('displayProduct');
        
        if(!listContainer) return;
        listContainer.innerHTML = '';

        // --- LOGIKA BARU: ICS HANDLER (FIXED) ---
        if (providerCode.startsWith('ICS_')) {
             if(txtProd) txtProd.innerText = 'Memuat Dari Server...';
             if(btnProd) btnProd.classList.add('cursor-not-allowed', 'opacity-50');

             let icsType = 'xda';
             if(providerCode === 'ICS_CIRCLE') icsType = 'circle';
             if(providerCode === 'ICS_XLA') icsType = 'xla';

             // Panggil API
             const res = await callIcsApi('listProducts', { type: icsType });
             
             // LOGIKA CERDAS: Deteksi berbagai format respon ICS
             let allProducts = [];
             if (res) {
                if (res.ready && Array.isArray(res.ready)) allProducts = res.ready;
                else if (res.data && res.data.ready && Array.isArray(res.data.ready)) allProducts = res.data.ready;
                else if (Array.isArray(res.data)) allProducts = res.data;
                else if (Array.isArray(res)) allProducts = res;
             }

             // --- FILTER SYSTEM V2 (STRICT) ---
             if (providerCode === 'ICS_CIRCLE') {
                 allProducts = allProducts.filter(p => (p.type === 'circle' || (p.code || p.kode_produk || '').toUpperCase().startsWith('XCL')));
             } 
             else if (providerCode === 'ICS_XDA') {
                 allProducts = allProducts.filter(p => (p.type === 'xda' || (p.code || p.kode_produk || '').toUpperCase().startsWith('XDA')));
             }
             else if (providerCode === 'ICS_XLA') {
                 allProducts = allProducts.filter(p => (p.type === 'xla' || ((p.code || p.kode_produk || '').toUpperCase().startsWith('XLA') && !(p.code || p.kode_produk || '').toUpperCase().startsWith('XDA'))));
             }
             else if (providerCode === 'ICS_FMX' || providerCode === 'ICS_FMAX') {
                 allProducts = allProducts.filter(p => (p.type === 'fmax' || p.type === 'fmx' || (p.code || p.kode_produk || '').toUpperCase().startsWith('FMX') || (p.code || p.kode_produk || '').toUpperCase() === 'CFMX'));
             }

             if (allProducts.length > 0) {
                if(btnProd) {
                    btnProd.classList.remove('cursor-not-allowed', 'opacity-50');
                    btnProd.classList.add('bg-white', 'hover:bg-gray-50');
                }
                if(txtProd) txtProd.innerText = '-- Klik Untuk Pilih Produk --';

                // Urutkan termurah
                allProducts.sort((a, b) => (parseInt(a.harga || a.price || 0) - (parseInt(b.harga || b.price || 0))));

                allProducts.forEach(p => {
                    let rawPrice = parseInt(p.harga || p.price || 0);
                    let price = rawPrice;
                    let name = p.nama_produk || p.name || 'Produk Tanpa Nama';
                    const code = p.kode_produk || p.code;
                    
                    // Logic Status/Stok V2
                    let stockCount = p.stock || p.stok || 0;
                    const isStatusEmpty = (p.status === 'empty');
                    if (!isStatusEmpty && stockCount > 0) stockCount = p.stock || p.stok; 
                    
                    // --- MODIFIKASI: BYPASS STOK UTK PREORDER (XDA & CIRCLE) ---
                    const isPreorderPage = !document.getElementById('preorderPage').classList.contains('hide');
                    let isHabis = isStatusEmpty || stockCount == 0;

                    if (isPreorderPage && (providerCode === 'ICS_XDA' || providerCode === 'ICS_CIRCLE')) {
                        isHabis = false; 
                    }
                    // ----------------------------------------------------------

                    const stockInfo = isHabis ? 'KOSONG / GANGGUAN' : (stockCount > 900 ? 'Tersedia' : `Stok: ${stockCount}`);

                    // Cek Pricing Rules (Markup)
                    if(typeof pricingRules !== 'undefined' && pricingRules[code]) {
                        const r = pricingRules[code];
                        price += (typeof r === 'object') ? parseInt(r.price || 0) : parseInt(r);
                        if(typeof r === 'object' && r.name) name = r.name;
                    } else {
                        price += 2000; // Default Margin
                    }

                    const div = document.createElement('div');
                    div.className = `p-4 rounded-2xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 cursor-pointer mb-2 flex justify-between items-center transition hover:shadow-sm active:scale-[0.98] ${isHabis ? 'opacity-60 grayscale' : ''}`;
                    
                    if(isHabis) {
                        div.innerHTML = `
                            <div>
                                <p class="text-xs font-bold text-red-500 line-through">${name}</p>
                                <p class="text-[9px] text-red-400 mt-0.5 font-bold">${stockInfo}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-black text-gray-400">Rp ${window.formatRp(price).replace('Rp', '')}</p>
                            </div>`;
                    } else {
                        div.onclick = () => window.selectProduct(code, name, price, stockInfo, encodeURIComponent(name));
                        div.innerHTML = `
                            <div>
                                <p class="text-xs font-bold text-gray-700 dark:text-gray-200">${name}</p>
                                <p class="text-[9px] text-gray-400 mt-0.5">${stockInfo}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-black text-blue-600 dark:text-blue-400">Rp ${window.formatRp(price).replace('Rp', '')}</p>
                            </div>`;
                    }
                    listContainer.appendChild(div);
                });
             } else {
                 if(txtProd) txtProd.innerText = 'Stok Kosong';
                 listContainer.innerHTML = '<div class="text-center py-10 flex flex-col items-center opacity-50"><i class="fas fa-box-open text-3xl mb-2"></i><p class="text-xs">Produk belum tersedia</p></div>';
             }
             return; // STOP di sini agar tidak lanjut ke logika KHFY
        }

        // --- LOGIKA LAMA: KHFY (Backup) ---
        if(!globalProducts || globalProducts.length === 0) {
             if(txtProd) txtProd.innerText = 'Data Belum Siap';
             window.initProductData(); 
             return;
        }

        const filtered = globalProducts.filter(p => {
            const code = (p.code || p.kode_produk || p.buyer_sku_code || '').toUpperCase();
            const name = (p.name || p.nama_produk || p.product_name || '').toUpperCase();
            const brand = (p.brand || p.kode_provider || p.operator || '').toUpperCase();
            
            // FILTER KHFY LEBIH KETAT
            if (providerCode === 'XDA') return code.startsWith('XDA') || brand.includes('AKRAB FRESH');
            if (providerCode === 'XLA') return (code.startsWith('XLA') || code.startsWith('XLC')) && !code.startsWith('XDA');
            if (providerCode === 'FMX') return (code.startsWith('FMX') || code === 'CFMX') || brand === 'FMAX';
            
            // --- MODIFIKASI: FILTER XL REGULER KHUSUS ---
            if (providerCode === 'XLR') {
                const allowedXLR = ['FMX50', 'FMX65', 'FMX80', 'FMX150'];
                return allowedXLR.includes(code);
            }
            // -------------------------------------------
            
            if (providerCode === 'PLN') return brand.includes('PLN') || code.includes('PLN');

            // Default
            return brand.includes(providerCode) || name.includes(providerCode) || code.includes(providerCode);
        });

        if(filtered.length === 0) {
            if(txtProd) txtProd.innerText = `Kosong (${providerCode})`;
            listContainer.innerHTML = `<div class="text-center py-8 text-gray-400 flex flex-col items-center"><i class="fas fa-box-open text-2xl mb-2"></i><p class="text-xs">Tidak ada produk tersedia</p></div>`;
            return;
        }

        if(btnProd) {
            btnProd.classList.remove('cursor-not-allowed', 'opacity-50');
            btnProd.classList.add('bg-white', 'hover:bg-gray-50');
            if(btnProd.classList.contains('bg-gray-100')) btnProd.classList.remove('bg-gray-100');
        }
        
        if(txtProd) txtProd.innerText = '-- Klik Untuk Pilih Produk --';

        filtered.sort((a, b) => {
            const priceA = a.price || a.harga_final || a.buyer_price || 0;
            const priceB = b.price || b.harga_final || b.buyer_price || 0;
            return priceA - priceB;
        });

        filtered.forEach(p => {
            let price = p.price || p.harga_final || p.buyer_price || 0;
            const code = p.code || p.kode_produk || p.buyer_sku_code;
            let name = p.name || p.nama_produk || p.product_name;
            const desc = p.deskripsi || '';
            
            // LOGIKA BARU (KHFY): Support Rename & Markup Object
            if(typeof pricingRules !== 'undefined' && pricingRules[code]) {
                const r = pricingRules[code];
                if(typeof r === 'object') {
                    if(r.price) price += parseInt(r.price);
                    if(r.name) name = r.name;
                } else {
                    price += parseInt(r);
                }
            }
            
            let isGangguan = false;
            if (p.gangguan == 1) isGangguan = true;
            if (p.kosong == 1) isGangguan = true;
            if (p.buyer_product_status === false || p.buyer_product_status == 0) isGangguan = true;
            if (p.seller_product_status === false || p.seller_product_status == 0) isGangguan = true;
            if (p.stock == 0 && p.unlimited_stock === false) isGangguan = true;

            const isPreorder = !document.getElementById('preorderPage').classList.contains('hide');
            const div = document.createElement('div');
            div.className = `p-4 rounded-2xl border ${isGangguan && !isPreorder ? 'border-red-200 bg-red-50 dark:bg-red-900/10 cursor-not-allowed opacity-70' : 'border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 cursor-pointer transition active:scale-[0.98]'} mb-2 flex justify-between items-center group`;
            
            if(isGangguan && !isPreorder) {
                div.innerHTML = `
                    <div>
                        <p class="text-xs font-bold text-red-500 line-through">${name}</p>
                        <p class="text-[9px] text-red-400 font-bold mt-1">GANGGUAN / KOSONG</p>
                    </div>
                    <div class="text-right opacity-50">
                        <p class="text-sm font-black text-gray-400">Rp ${window.formatRp(price).replace('Rp', '')}</p>
                    </div>`;
            } else {
                div.onclick = () => window.selectProduct(code, name, price, desc, encodeURIComponent(name));
                div.innerHTML = `
                    <div class="flex-1 pr-2">
                        <p class="text-xs font-bold text-gray-700 dark:text-gray-200 leading-tight group-hover:text-blue-600 transition">${name}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-blue-600 dark:text-blue-400">Rp ${window.formatRp(price).replace('Rp', '')}</p>
                        <p class="text-[9px] text-gray-400">Harga</p>
                    </div>`;
            }
            listContainer.appendChild(div);
        });
    };window.toggleMultiTrx = () => {
        isMultiTrx = !isMultiTrx;
        const check = document.getElementById('multiTrxCheck');
        const icon = check.querySelector('i');
        const single = document.getElementById('singleNumContainer');
        const multi = document.getElementById('multiNumContainer');
        const btnAdd = document.getElementById('btnAddNum');
        
        if(isMultiTrx) {
            check.className = "w-5 h-5 rounded border border-blue-600 bg-blue-600 flex items-center justify-center text-white transition-colors";
            icon.classList.remove('opacity-0');
            single.classList.add('hide');
            multi.classList.remove('hide');
            btnAdd.classList.remove('hide');
            if(multi.children.length === 0) window.addMultiInput();
        } else {
            check.className = "w-5 h-5 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-white transition-colors";
            icon.classList.add('opacity-0');
            single.classList.remove('hide');
            multi.classList.add('hide');
            btnAdd.classList.add('hide');
        }
    };

    window.addMultiInput = () => {
        const container = document.getElementById('multiNumContainer');
        const div = document.createElement('div');
        div.className = "flex gap-2 animate-fade-in-down";
        div.innerHTML = '<input type="tel" placeholder="Nomor Tujuan..." class="flex-1 h-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"><button onclick="this.parentElement.remove()" class="w-12 h-12 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl hover:bg-red-100 transition flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>';
        container.appendChild(div);
    };

    window.executeMultiBatch = async (code, numbers, price, name) => {
        window.showLoader(true);
        const totalRequired = numbers.length * price;

        if (currentBalance < totalRequired) {
            window.showLoader(false);
            return window.showAlert("Saldo Kurang", `Saldo tidak cukup untuk memproses ${numbers.length} transaksi.\nTotal dibutuhkan: ${window.formatRp(totalRequired)}`, "error");
        }

        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < numbers.length; i++) {
            const num = numbers[i].trim();
            if (num.length < 5) continue;

            document.getElementById('loaderText').innerText = `Batch ${i + 1}/${numbers.length}: ${num}`;
            
            const uniqueId = Math.random().toString(36).substring(2, 7).toUpperCase();
            const reffId = `BTCH-${Date.now()}-${uniqueId}`;
            const trxCode = Math.floor(100000 + Math.random() * 900000).toString();

            try {
                await runTransaction(db, async (t) => {
                    const uRef = doc(db, "users", currentUser.uid);
                    const uDoc = await t.get(uRef);
                    const bal = uDoc.data().balance || 0;

                    if (bal < price) throw new Error("Saldo tidak mencukupi");

                    t.update(uRef, { balance: bal - price });
                    t.set(doc(db, "users", currentUser.uid, "history", reffId), {
                        title: `${name} (${num})`,
                        amount: price,
                        type: 'out',
                        date: new Date().toISOString(),
                        status: 'Pending',
                        api_msg: 'Menunggu respon server...',
                        trx_id: reffId,
                        trx_code: trxCode,
                        dest_num: num
                    });
                });

                const result = await callApi('/trx', { produk: code, tujuan: num, reff_id: reffId });
                
                let isOk = false;
                let apiMsg = "Diproses";

                if (result.ok && result.data) {
                    const d = result.data;
                    const dataObj = d.data || d;
                    const rawMsg = String(d.message || d.sn || "").toLowerCase();
                    if (d.status === true || d.success === true || (d.data && d.data.id) || rawMsg.includes('proses') || rawMsg.includes('pending')) {
                        isOk = true;
                        apiMsg = d.message || d.sn || "Transaksi Berhasil Dikirim";
                    }
                }

                if (isOk) {
                    successCount++;
                    await updateDoc(doc(db, "users", currentUser.uid, "history", reffId), {
                        api_msg: apiMsg,
                        raw_json: JSON.stringify(result.data || {})
                    });
                } else {
                    throw new Error(result.data?.message || result.error || "Ditolak Server");
                }

            } catch (e) {
                failCount++;
                await runTransaction(db, async (t) => {
                    const uRef = doc(db, "users", currentUser.uid);
                    const uDoc = await t.get(uRef);
                    t.update(uRef, { balance: (uDoc.data().balance || 0) + price });
                    t.update(doc(db, "users", currentUser.uid, "history", reffId), {
                        status: 'Gagal',
                        api_msg: 'Refund: ' + e.message
                    });
                });
            }
            
            await new Promise(r => setTimeout(r, 2000));
        }

        window.showLoader(false);
        window.showAlert("Selesai", `Berhasil: ${successCount}\nGagal/Refund: ${failCount}`, successCount > 0 ? "success" : "error");
        window.nav('homePage');
    };

            window.processFormTransaction = () => {
        const provider = document.getElementById('formProvider').value;
        const formProductVal = document.getElementById('formProduct').value;
        const icsSelect = document.getElementById('icsProductSelect');
        
        const code = formProductVal || (icsSelect ? icsSelect.value : '');
        
        // Ambil nama produk dengan aman
        let name = document.getElementById('selectedProductName').value;
        if (!name && icsSelect && icsSelect.selectedIndex >= 0) {
            name = icsSelect.options[icsSelect.selectedIndex]?.dataset.name;
        }

        // Ambil harga
        const priceInput = document.getElementById('selectedProductPrice').value;
        let price = parseInt(priceInput || 0);
        if (price === 0 && icsSelect && icsSelect.selectedIndex >= 0) {
             price = parseInt(icsSelect.options[icsSelect.selectedIndex]?.dataset.price || 0);
        }
        
        const number = document.getElementById('ppobNumber').value;

        if(!code) return window.showAlert('Peringatan', 'Silakan pilih Produk terlebih dahulu!', 'error');

        // FITUR BARU: Cegah Transaksi Ganda ke Nomor Sama jika masih Pending
        if (transactions) {
            const pendingSameNum = transactions.find(t => 
                (t.status === 'Pending' || t.status === 'Proses') && 
                t.dest_num === number &&
                t.raw_code === code 
            );

            if (pendingSameNum) {
                return window.showAlert(
                    'Transaksi Tertunda',
                    'Masih ada transaksi PENDING untuk nomor ' + number + '. Harap tunggu hingga sukses atau gagal sebelum membeli lagi.',
                    'warning'
                );
            }
        }

        // --- HANDLER KHUSUS ICS ---
        if (provider && provider.startsWith('ICS_')) {
            if(!number || number.length < 9) return window.showAlert('Validasi', "Nomor HP tidak valid!", 'error');
            if(currentBalance < price) return window.showAlert('Saldo', "Saldo tidak cukup!", 'error');
            
            window.customConfirm('Konfirmasi Transaksi', `Produk: ${name}\nNomor: ${number}\nHarga: ${window.formatRp(price)}`, async () => {
                window.executeIcsTransaction(code, number, price, name, provider);
            });
            return;
        }

        if (code === 'CEKPLN') {
            window.checkPLN(number);
            return;
        }

        if (isMultiTrx) {
            const inputs = document.querySelectorAll('#multiNumContainer input');
            const numbers = [];
            inputs.forEach(i => { if(i.value.length > 5) numbers.push(i.value); });
            
            if(numbers.length === 0) return window.showAlert('Validasi', "Masukkan minimal 1 nomor tujuan valid!", 'error');
            const total = numbers.length * price;
            if (currentBalance < total) return window.showAlert('Saldo', `Saldo kurang! Butuh Rp ${window.formatRp(total)}`, 'error');
            
            window.customConfirm('Multi Transaksi', `Proses ${numbers.length} nomor?\nTotal: Rp ${window.formatRp(total)}`, () => {
                window.executeMultiBatch(code, numbers, price, name);
            });
        } else {
            if(number.length < 5) return window.showAlert('Validasi', 'Masukkan Nomor Tujuan yang valid!', 'error');
            window.confirmTransaction(code, name, price);
        }
    };


    window.checkPLN = async (num) => {
        window.showLoader(true);
        const reffId = crypto.randomUUID();
        const result = await callApi('/trx', { produk: 'CEKPLN', tujuan: num, reff_id: reffId });
        window.showLoader(false);

        if (result.ok && result.data) {
            const data = result.data.data || result.data;
            const msg = (data.message || data.sn || '').toLowerCase();
            const status = data.status;
            
            const isSuccess = (status === true || status === 'success' || String(data.success) === 'true');
            const isDataFound = msg.includes('tagihan') || msg.includes('lembar') || msg.includes('nama') || msg.includes('tarif');

            if (isSuccess || isDataFound) {
                let displayMsg = (data.message || data.sn).replace(/\//g, '\n');
                window.customConfirm('TAGIHAN DITEMUKAN', `Detail Pelanggan:\n------------------\n${displayMsg}\n\n(Silakan lakukan pembayaran manual)`, () => window.closeConfirm());
            } else {
                window.showAlert("Tidak Ditemukan", "PENGGUNA TIDAK TERDAFTAR\n\nSilakan periksa kembali Nomor ID Pelanggan PLN anda.", "error");
            }
        } else {
            window.showAlert("Gagal Koneksi", "Gagal Terhubung ke Server:\n" + result.error, "error");
        }
    };

    window.showInvoice = (code, name, price, dest, provCode) => {
        const fmtPrice = window.formatRp(price);
        document.getElementById('invTotalMain').innerText = fmtPrice;
        document.getElementById('invTotalBottom').innerText = fmtPrice;
        document.getElementById('invProductName').innerText = name;
        document.getElementById('invDestNum').innerText = dest;
        document.getElementById('invPrice').innerText = fmtPrice;
        
        const btnPay = document.getElementById('btnPayInvoice');
        btnPay.onclick = () => {
            window.closeInvoice();
            window.executeApiTransaction(code, dest, price, name, provCode);
        };

        document.getElementById('invoiceModal').classList.remove('hide');
    };

    window.closeInvoice = () => document.getElementById('invoiceModal').classList.add('hide');

    window.confirmTransaction = (code, name, price) => {
        if(currentBalance < price) return alert('Saldo Aplikasi Kurang! (Top Up Manual dulu)'); 
        const num = document.getElementById('ppobNumber').value;
        const prov = document.getElementById('formProvider').value;
        window.showInvoice(code, name, price, num, prov);
    };

            
        
    window.cancelPreorder = async (trxId) => {
        window.customConfirm("Batalkan Preorder", "Apakah Anda yakin ingin membatalkan preorder ini?\nSaldo akan dikembalikan otomatis.", async () => {
            window.showLoader(true);
            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", currentUser.uid);
                    const trxRef = doc(db, "users", currentUser.uid, "history", trxId);
                    const poRef = doc(db, "preorders", trxId);

                    const userSnap = await transaction.get(userRef);
                    const trxSnap = await transaction.get(trxRef);

                    if (!trxSnap.exists() || trxSnap.data().status !== 'Pending') {
                        throw "Transaksi tidak dapat dibatalkan.";
                    }

                    const refundAmount = trxSnap.data().amount || 0;
                    const currentBal = userSnap.data().balance || 0;

                    transaction.update(userRef, { balance: currentBal + refundAmount });
                    transaction.update(trxRef, {
                        status: 'Dibatalkan',
                        api_msg: 'Dibatalkan oleh pengguna (Auto Refund)',
                        balance_final: currentBal + refundAmount
                    });
                    transaction.delete(poRef);
                });

                window.showLoader(false);
                window.showAlert("Berhasil", "Preorder berhasil dibatalkan dan saldo telah dikembalikan.", "success");
                window.closeTrxDetail();
                window.renderHistoryList();
            } catch (e) {
                window.showLoader(false);
                window.showAlert("Gagal", (typeof e === 'string' ? e : e.message), "error");
            }
        });
    };

  window.submitPreorder = async () => {
        const prov = document.getElementById('formProvider').value;
        const code = document.getElementById('formProduct').value;
        const name = document.getElementById('selectedProductName').value;
        const price = parseInt(document.getElementById('selectedProductPrice').value) || parseInt(document.getElementById('icsProductSelect')?.options[document.getElementById('icsProductSelect').selectedIndex]?.dataset.price || 0);
        const num = document.getElementById('poNumber').value;

        if(!code || !num) return alert('Lengkapi data preorder!');
        
        window.showLoader(true);
        try {
            const trxId = 'PO-' + Date.now();
            
            await runTransaction(db, async (transaction) => {
                const userRef = doc(db, "users", currentUser.uid);
                const userSnap = await transaction.get(userRef);
                
                if (!userSnap.exists()) throw "User tidak ditemukan!";
                
                const currentBal = userSnap.data().balance || 0;
                if (currentBal < price) throw "Saldo tidak cukup untuk preorder!";

                const balanceAfter = currentBal - price;

                // 1. Potong Saldo User
                transaction.update(userRef, { balance: balanceAfter });

                                // 2. Tambah ke Antrean Admin
                const poRef = doc(db, "preorders", trxId);
                
                // Deteksi Server Type Otomatis (ICS/KHFY)
                const serverType = prov.startsWith('ICS_') ? 'ICS' : 'KHFY';

                transaction.set(poRef, {
                    uid: currentUser.uid,
                    username: currentUsername,
                    email: currentUser.email,
                    targetNumber: num,
                    provider: code,
                    productName: name,
                    price: price,
                    status: "Pending",
                    historyId: trxId,
                    serverType: serverType, // Data Baru: Identitas Server
                    timestamp: serverTimestamp()
                });

                // 3. Catat di Riwayat User (Status Pending & Saldo Terpotong)
                const historyRef = doc(db, "users", currentUser.uid, "history", trxId);
                transaction.set(historyRef, {
                    title: "Preorder: " + name,
                    amount: price,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Pending',
                    api_msg: 'Pesanan sedang diproses admin',
                    trx_id: trxId,
                    dest_num: num,
                    raw_code: code,
                    balance_before: currentBal,
                    balance_after: balanceAfter
                });
            });

                        // Kirim Notif Telegram Preorder
            if(typeof window.sendTelegramNotif === 'function') {
                 window.sendTelegramNotif('ORDER', { 
                    title: "PREORDER - " + name, 
                    amount: price, 
                    dest: num, 
                    trxId: trxId 
                });
            }

            
  window.showLoader(false);
            alert('Pesanan Preorder dikirim! Saldo telah dipotong dan menunggu konfirmasi admin.');
            window.nav('homePage');
        } catch(e) {
            window.showLoader(false);
            alert(typeof e === 'string' ? e : e.message);
        }
    };
    window.executeApiTransaction = async (code, dest, price, name, provCode) => {
        window.showLoader(true);
        // Format Baru: TRX-08xx-JamMenitDetik
        const d = new Date();
        const timeStr = String(d.getHours()).padStart(2, '0') + String(d.getMinutes()).padStart(2, '0') + String(d.getSeconds()).padStart(2, '0');
        const cleanDest = dest.replace(/[^0-9]/g, '');
        const reffId = 'TRX-' + cleanDest + '-' + timeStr;
        
        const trxCode = Math.floor(100000 + Math.random() * 900000).toString();
        const trxRef = doc(db, "users", currentUser.uid, "history", reffId);
        
        try {
            await runTransaction(db, async (t) => {
                const uRef = doc(db, "users", currentUser.uid);
                const uDoc = await t.get(uRef);
                const currentBal = uDoc.data().balance || 0;
                if(currentBal < price) throw "Saldo tidak cukup!";
                
                                                                const balanceBefore = currentBal;
                const balanceAfter = currentBal - price;
                t.update(uRef, { balance: balanceAfter });
                window.logDoniGuardAudit(t, currentUser.uid, 'OUT', price, balanceBefore, balanceAfter, reffId, 'Purchase PPOB');

                t.set(trxRef, {
                    title: name,
                    amount: price,
                    type: 'out',
                    date: new Date().toISOString(),
                    status: 'Proses',
                    api_msg: 'Menghubungkan ke server...',
                    trx_id: reffId,
                    trx_code: trxCode,
                    provider_id: '', // ID Server (Akan diupdate)
                    provider_code: provCode || '', // Kode Provider App
                    raw_code: code, // Kode Produk
                    dest_num: dest, // Nomor Tujuan
                    balance_before: balanceBefore,
                    balance_after: balanceAfter
                });
            });
        } catch(e) {
            window.showLoader(false);
            return window.showAlert("Gagal", "Gagal memproses transaksi: " + e, "error");
        }

        // Update UI Lokal
        currentBalance -= price;
        if(document.getElementById('displayBalance')) document.getElementById('displayBalance').innerText = window.formatRp(currentBalance);

        // 2. CALL API
        try {
                        const result = await callApi('/trx', { produk: code, tujuan: dest, reff_id: reffId });
            window.showLoader(false);

            // --- FIX BUG FALSE NEGATIVE (Anti Refund saat RTO & Network Glitch) ---
            // UPDATE: Menambahkan deteksi 'Load failed' dan error generik proxy untuk mencegah refund prematur
            const errStr = result.error ? String(result.error) : "";
            const isNetworkError = errStr.includes('Failed to fetch') || 
                                 errStr.includes('NetworkError') || 
                                 errStr.includes('Gagal Koneksi') ||
                                 errStr.includes('Load failed') ||
                                 errStr.includes('upstream') ||
                                 (!result.ok && !result.data && !result.error); // Respon kosong/gelap

            if (!result.ok && isNetworkError) {
                console.warn("Network Error Detected - Holding Refund");
                
                await updateDoc(trxRef, { 
                    status: 'Pending', 
                    api_msg: 'Koneksi Terputus (Verifikasi Otomatis)...',
                    raw_json: JSON.stringify(result)
                });
                
                window.customConfirm(
                    'Koneksi Terganggu',
                    'Sinyal terputus saat kirim data. JANGAN transaksi ulang! Sistem sedang memverifikasi status transaksi Anda ke server.',
                    () => window.manualCheckTrx(reffId, null)
                );

                // Auto Cek Status ke Server Pusat (Delay 3 detik)
                setTimeout(() => window.manualCheckTrx(reffId, null), 3000);
                
                window.nav('homePage');
                return; // STOP: Jangan lanjut ke logika refund!
            }
            // ------------------------------------------------------
            
            let isSuccess = false;
            let msg = 'Tidak ada respon server';

            // UPDATE: Jika semua proxy gagal (misal: HTTP_CLIENT_RESPONSE_BODY_ERR)
            // Paksa pesan jadi 'Server Sedang Sibuk' agar masuk ke logika refund dengan info yang jelas
            if (!result.ok) {
                msg = "Server Sedang Sibuk";
            }
            
            let providerId = '';
            
            // DETEKSI KHUSUS ERROR LOCK_TIMEOUT (Server Busy)
            const rawRes = JSON.stringify(result).toLowerCase();
            const isLockTimeout = rawRes.includes('lock_timeout');

            // --- FIX: Handle Lock Timeout sebagai PENDING (Anti-Refund) ---
            if (isLockTimeout) {
                 console.warn("Lock Timeout Detected - Holding Refund");
                 await updateDoc(trxRef, { 
                    status: 'Pending', 
                    api_msg: 'Server Busy (Lock Timeout). Mengecek status...',
                    raw_json: rawRes
                });
                
                // Auto Cek Status (Delay 3 detik)
                setTimeout(() => window.manualCheckTrx(reffId, null), 3000);

                window.customConfirm(
                    'Server Sedang Sibuk',
                    'Transaksi masuk antrean (Lock Timeout). Sistem akan mengecek status otomatis. Mohon tunggu sebentar.',
                    () => window.manualCheckTrx(reffId, null)
                );
                
                window.nav('homePage');
                return; // STOP: Jangan lanjut ke logika sukses/gagal biasa
            }

            if(result.ok && result.data) {
                 const d = result.data;
                 msg = d.message || d.msg || d.sn || (d.data ? d.data.message : '') || msg;
                 // --- SENSOR DATA SENSITIF (Anti-Leak) ---
                 // Menghapus total parameter kodereseller, password, dan pin agar tidak tampil
                 if(typeof msg === 'string') {
                    // 1. Hapus key=value untuk data sensitif (termasuk & di belakangnya)
                    msg = msg.replace(/(kodereseller|password|pin)=[^&\s#]*&?/gi, "");
                    
                    // 2. Hapus sisa 'trx?' atau '?' di awal string agar rapi (misal: trx?produk=... jadi produk=...)
                    msg = msg.replace(/^(trx)?\?/i, "");
                 }

                 // --- SENSOR DATA SENSITIF (Anti-Leak) ---
                 // Menyembunyikan kodereseller, password, dan pin dari pesan error
                 if(typeof msg === 'string') {
                    msg = msg.replace(/(kodereseller|password|pin)=([^&\s#]*)/gi, '$1=******');
                 }
                 if(d.data && d.data.id) providerId = d.data.id;
                 isSuccess = d.status === true || d.success === true || d.status === 'success' || (d.data && d.data.status === 'Pending') || String(msg).toLowerCase().includes('proses');
            }

            if(isSuccess) {
                let safeMsg = msg;
                if (safeMsg.includes('password=') || safeMsg.includes('pin=')) {
                    safeMsg = safeMsg.split('#').pop() || 'Tujuan Diluar Wilayah';
                }
                await updateDoc(trxRef, { status: 'Pending', api_msg: safeMsg, provider_id: providerId, raw_json: JSON.stringify(result.data || result || {}) });
                
                alert(`Transaksi Berhasil Dikirim!\nInfo: ${msg}`);
                window.nav('homePage');
                        } else {
                // GAGAL DARI RESPON API -> LAKUKAN REFUND OTOMATIS (LEDGER V2)
                // Logic Baru: Bersih & Aman
                const finalMsg = isLockTimeout ? msg : (msg.includes('wilayah') ? 'Gagal Tujuan di luar wilayah' : msg);
                
                // 1. Panggil Sistem Ledger untuk Refund Database
                const refundResult = await window.processSmartRefund(currentUser.uid, reffId, finalMsg);
                
                // 2. Update Tampilan Saldo (Visual Saja)
                currentBalance += price;
                if(document.getElementById('displayBalance')) document.getElementById('displayBalance').innerText = window.formatRp(currentBalance);

                                // 3. Tampilkan Pesan ke User
                // PERBAIKAN: Gunakan 'finalMsg' agar pesan asli server (Misal: Nomor Salah/Suspect) muncul
                const displayMsg = finalMsg || msg || "Transaksi Gagal";
                window.showAlert("Transaksi Gagal", displayMsg + "\n\n" + (refundResult.msg || "Saldo telah dikembalikan otomatis."), "error");
                window.nav('homePage');
            }

                } catch(e) {
            window.showLoader(false);
            // 3. ERROR KONEKSI (Murni jaringan, bukan error logic server)
            await updateDoc(trxRef, { 
                status: 'Pending', 
                api_msg: 'Koneksi Timeout. Klik tombol refresh pada riwayat.',
                error_log: String(e)
            });
            
            window.customConfirm(
                'Koneksi Timeout', 
                'Koneksi terputus saat transaksi. Saldo aman. Silakan cek status untuk memastikan keberhasilan transaksi atau pengembalian saldo.', 
                async () => {
                    window.manualCheckTrx(reffId, null);
                }
            );
        }
    };


    // --- TOP UP LOGIC & SMART BADGE ---
        // --- BACKGROUND SERVICE (AUTO CHECK 5 Detik) ---
    window.autoCheckInterval = null;

            // --- INTELLIGENT WATCHDOG SYSTEM (AUTO-HEALING) ---
    window.startBackgroundService = () => {
        if(window.autoCheckInterval) clearInterval(window.autoCheckInterval);
        
        console.log(" Watchdog System V3: Activated");

        // Interval Pengecekan (Setiap 20 Detik)
        window.autoCheckInterval = setInterval(async () => {
            if(!currentUser) return;

            try {
                // 1. Cari Transaksi yang 'Pending' atau 'Proses' di Database
                // Limit 10 transaksi terakhir untuk efisiensi
                const q = query(
                    collection(db, "users", currentUser.uid, "history"), 
                    where("status", "in", ["Pending", "Proses"]),
                    orderBy("date", "desc"),
                    limit(10)
                );
                
                const snapshot = await getDocs(q);
                if (snapshot.empty) return; // Tidak ada transaksi gantung

                const now = Date.now();

                for (const docSnap of snapshot.docs) {
                    const trx = docSnap.data();
                    const trxTime = new Date(trx.date).getTime();
                    const diffSeconds = (now - trxTime) / 1000;

                    // ATURAN WATCHDOG:
                    // 1. Abaikan transaksi manual/topup (butuh admin)
                    if (trx.provider_id === 'MANUAL' || trx.provider_id === 'MANUAL_SEABANK' || String(trx.trx_id).startsWith('ICS-PO')) continue;
                    
                    // 2. Hanya cek transaksi yang sudah berumur > 60 detik tapi < 24 jam
                    // (Agar tidak bentrok saat animasi loading awal)
                    if (diffSeconds > 60 && diffSeconds < 86400) {
                        console.log(` Watchdog: Checking Stuck Trx ${trx.trx_id}...`);
                        
                        // Panggil Cek Status Manual (Logic Shared)
                        // Fungsi ini sudah tertanam logika 'Smart Refund' di dalamnya
                        await window.manualCheckTrx(trx.trx_id, trx.provider_id, true);
                    }
                }
            } catch (e) {
                console.warn(" Watchdog Error (Silent):", e);
            }
        }, 20000); // Jalan setiap 20 detik
        };

    window.checkPendingTopUp = () => {
        if(!currentUser) return false;
        const savedData = localStorage.getItem('qios_trx_' + currentUser.uid);
        if (savedData) {
            const ticket = JSON.parse(savedData);
            const now = Date.now();
            const limit = 25 * 60 * 1000;
            if ((now - ticket.created) < limit) return true;
            else localStorage.removeItem('qios_trx_' + currentUser.uid);
        }
        return false;
    };

    window.setTopUpAmount = (amount) => { document.getElementById('qiosInputAmount').value = amount; };

        window.checkPendingTrx = async () => {
        if(!currentUser) return;
        const q = query(collection(db, "users", currentUser.uid, "history"), where("status", "==", "Pending"));
        const snapshot = await getDocs(q);
        
        for (const docSnap of snapshot.docs) {
            const trx = docSnap.data();
            if (trx.provider_id === 'MANUAL' || trx.provider_id === 'MANUAL_SEABANK') continue;

            await window.manualCheckTrx(trx.trx_id, trx.provider_id, true);
        }
    };

    
  window.renderTopUpHistory = () => {
        const container = document.getElementById('qiosMiniHistory');
        if(!container) return;
        
        const topups = transactions.filter(t => t.type === 'in' && (t.title.toLowerCase().includes('top') || (t.method && t.method.includes('Qios')))).slice(0, 5);
        
        if(topups.length === 0) {
            container.innerHTML = '<p class="text-[10px] text-center text-gray-400 py-2">Belum ada riwayat Top Up</p>';
            return;
        }

        let html = '';
        topups.forEach(t => {
            let statusColor = 'text-gray-500';
            if(t.status === 'Sukses') statusColor = 'text-green-500';
            else if(t.status === 'Gagal' || t.status.includes('Batal')) statusColor = 'text-red-500';
            else statusColor = 'text-orange-500';

            html += `<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-2 rounded-lg border border-gray-100 dark:border-gray-700">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[10px]"><i class="fas fa-arrow-down"></i></div>
                    <div><p class="text-[10px] font-bold text-gray-800 dark:text-white">Rp ${window.formatRp(t.amount)}</p>                                     <p class="text-[9px] text-gray-400">${new Date(t.date).toLocaleDateString('id-ID', {day:'numeric', month:'short'})}  ${new Date(t.date).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</p></div>
                </div>
                <span class="text-[9px] font-bold ${statusColor}">${t.status}</span>
            </div>`;
        });
        container.innerHTML = html;
    };

    window.updateTopUpBadge = () => {
        const hasPending = window.checkPendingTopUp();
        const b1 = document.getElementById('badge-topup-home');
        const b2 = document.getElementById('badge-topup-nav');
        if(hasPending) {
            if(b1) b1.classList.remove('hide');
            if(b2) b2.classList.remove('hide');
        } else {
            if(b1) b1.classList.add('hide');
            if(b2) b2.classList.add('hide');
        }
    };

        window.checkPendingManualSeabank = async () => {
        if(!currentUser) return false;
        try {
            const q = query(collection(db, "users", currentUser.uid, "history"), 
                where("status", "==", "Pending"), 
                where("provider_id", "==", "MANUAL_SEABANK")
            );
            const snap = await getDocs(q);
            return !snap.empty;
        } catch(e) { return false; }
    };

    window.openTopUpSheet = async () => {
        // 1. Cek Qios (Lokal)
        if(window.checkPendingTopUp()) {
            window.openQios(); 
            return;
        }

        // 2. Cek Manual Seabank (Database)
        // Tampilkan loader sebentar karena butuh koneksi internet
        window.showLoader(true);
        const hasPendingManual = await window.checkPendingManualSeabank();
        window.showLoader(false);

        if(hasPendingManual) {
            window.openManualTopUp();
        } else {
            document.getElementById('topUpSheet').classList.remove('hide');
        }
    };

        window.openManualTopUp = async () => {
        if (topupStatus && topupStatus.manual === false) return window.showAlert("Maintenance", "Layanan Top Up Manual sedang dalam perbaikan.", "error");
        document.getElementById('topUpSheet').classList.add('hide');
        document.getElementById('manualTopUpModal').classList.remove('hide');
        
        const q = query(collection(db, "users", currentUser.uid, "history"), 
            where("status", "==", "Pending"), 
            where("provider_id", "==", "MANUAL_SEABANK")
        );
        const snap = await getDocs(q);
        
        if (!snap.empty) {
            const trx = snap.docs.sort((a,b) => new Date(b.data().date) - new Date(a.data().date))[0].data();
            const trxTime = new Date(trx.date).getTime();
            const now = Date.now();
            const diff = now - trxTime;
            const limit = 3 * 60 * 60 * 1000; 

            if (diff < limit) {
                currentMtTrxId = snap.docs[0].id;
                window.showMtStep2(trx.amount, trxTime + limit);
            } else {
                window.resetMtUI();
            }
        } else {
            window.resetMtUI();
        }
    };
    
    window.closeTopUp = () => document.getElementById('topUpSheet').classList.add('hide');
    
    // Auto Update Badge
    setInterval(window.updateTopUpBadge, 2000);

        window.liveStockInterval = null;

    window.fetchLiveStock = async () => {
        // Hemat resource: Jangan fetch jika tidak di Home Page
        if(document.getElementById('homePage').classList.contains('hide')) return;

        const targetUrl = "https://panel.khfy-store.com/api_v3/cek_stock_akrab";
        let data = null;

        for (const proxy of PROXY_LIST) {
            try {
                const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3500);
                
                const res = await fetch(fullUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if(res.ok) {
                    const json = await res.json();
                    if(json.ok || json.message === "success") {
                        data = json.data;
                        break; 
                    }
                }
            } catch(e) { }
        }

        const container = document.getElementById('liveStockContainer');
        if(!container) return;

        if(data && Array.isArray(data)) {
            let html = '';
                        data.forEach(item => {
                 const isAvail = item.sisa_slot > 0;
                 // Tampilan Super Ringkas (Grid Friendly)
                 html += `<div class="flex justify-between items-center px-2 py-1.5 bg-white dark:bg-gray-900 rounded-lg border border-gray-100 dark:border-gray-800">
                    <div class="flex items-center gap-1.5 overflow-hidden">
                         <div class="w-1.5 h-1.5 shrink-0 rounded-full ${isAvail ? 'bg-green-500' : 'bg-red-500'} "></div>
                         <p class="text-[9px] font-bold text-gray-700 dark:text-gray-300 truncate leading-none">${item.nama}</p>
                    </div>
                    <span class="text-[9px] ${isAvail ? 'text-blue-600 dark:text-blue-400 font-bold' : 'text-gray-300'} shrink-0">${item.sisa_slot}</span>
                 </div>`;
            });
            container.innerHTML = html;
        }
    };

        window.startLiveStock = () => {
        if(window.liveStockInterval) clearInterval(window.liveStockInterval);
        window.fetchLiveStock(); // Fetch awal sekali saja saat load
    };

    window.manualRefreshStock = async () => {
        const btn = document.getElementById('btnRefreshStock');
        const originalContent = '<i class="fas fa-sync-alt text-[10px] text-blue-600 dark:text-blue-400"></i><span class="text-[10px] text-blue-700 dark:text-blue-400 font-bold">Refresh Stok</span>';
        
        // Ubah UI jadi loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin text-[10px] text-blue-600 dark:text-blue-400"></i><span class="text-[10px] text-blue-700 dark:text-blue-400 font-bold">Sedang merefresh...</span>';

        // Tahan 1.5 detik sesuai request
        await new Promise(r => setTimeout(r, 1500));

        // Fetch Data
        await window.fetchLiveStock();

        // Kembalikan UI tombol
        btn.innerHTML = originalContent;
        btn.disabled = false;
    };

    window.checkAkrabStock = async () => {
        window.showLoader(true);
        const targetUrl = "https://panel.khfy-store.com/api_v3/cek_stock_akrab";
        let data = null;

        for (const proxy of PROXY_LIST) {
            try {
                const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const res = await fetch(fullUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if(res.ok) {
                    const json = await res.json();
                    if(json.ok || json.message === "success") {
                        data = json.data;
                        break; 
                    }
                }
            } catch(e) { console.log("Proxy skip:", e); }
        }

        window.showLoader(false);

        if(data && Array.isArray(data)) {
            let html = '';
            data.forEach(item => {
                 const isAvail = item.sisa_slot > 0;
                 html += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                             <p class="text-xs font-bold text-gray-800 dark:text-white uppercase">${item.nama}</p>
                             <span class="text-[9px] px-1.5 py-0.5 rounded ${isAvail ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} font-bold">${item.type}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-black ${isAvail ? 'text-blue-600 dark:text-blue-400' : 'text-gray-300'}">${item.sisa_slot}</p>
                        <p class="text-[9px] text-gray-400">Slot</p>
                    </div>
                 </div>`;
            });
            document.getElementById('stockList').innerHTML = html;
            document.getElementById('stockModal').classList.remove('hide');
        } else {
            window.showAlert("Gagal", "Gagal mengambil data stok. Pastikan koneksi internet stabil.", "error");
        }
    };
    window.closeStockModal = () => document.getElementById('stockModal').classList.add('hide');
                                    // FUNGSI BANTUAN: Format Tampilan Detail
    window.formatDetailInfo = (json) => {
        let d = json.data || json;
        if (Array.isArray(d) && d.length > 0) d = d[0];
        if (!d) return '-';

        return `
        <div class="space-y-1 text-[10px] font-mono">
            <div class="border-b border-blue-200 dark:border-blue-800 pb-1 mb-1">
                <span class="block font-bold text-blue-700 dark:text-blue-300">SN / Token:</span>
                <span class="break-all">${d.sn || d.message || '-'}</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="text-gray-500">Kode:</span> <span class="font-bold">${d.kode_produk || d.code || '-'}</span></div>
                <div><span class="text-gray-500">Tujuan:</span> <span class="font-bold">${d.tujuan || '-'}</span></div>
                
            </div>
            <div class="mt-1 pt-1 border-t border-dashed border-gray-300 dark:border-gray-700">
                <div class="flex justify-between"><span>Masuk:</span> <span>${d.tgl_entri ? d.tgl_entri.replace('T', ' ').split('.')[0] : '-'}</span></div>
                <div class="flex justify-between"><span>Update:</span> <span>${d.tgl_status ? d.tgl_status.replace('T', ' ').split('.')[0] : '-'}</span></div>
            </div>
            ${d.keterangan ? `<div class="mt-1 text-gray-500 italic">Ket: ${d.keterangan}</div>` : ''}
        </div>`;
    };

                        window.openTrxDetail = (trxId) => {
        const cacheKey = `trx_cache_${currentUser.uid}`;
        let cachedData = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        let trx = cachedData.find(t => t.trx_id === trxId) || transactions.find(t => t.trx_id === trxId);
        
        if(!trx) return;

        // FITUR BARU: Redirect ke Modal Topup Manual jika status Pending
        if(trx.provider_id === 'MANUAL_SEABANK' && trx.status === 'Pending') {
            window.openManualTopUp();
            return;
        }

        document.getElementById('dtTitle').innerText = trx.title;
        document.getElementById('dtTrxCode').innerText = trx.trx_code || '------';
        document.getElementById('dtAmount').innerText = window.formatRp(trx.amount);
        document.getElementById('dtDate').innerText = new Date(trx.date).toLocaleString('id-ID');
        
        const statusEl = document.getElementById('dtStatus');
        statusEl.innerText = trx.status;
        statusEl.className = 'text-xs font-bold ' + (trx.status === 'Sukses' ? 'text-green-600' : (trx.status === 'Gagal' ? 'text-red-500' : 'text-orange-500'));
        
        const infoEl = document.getElementById('dtSn');
        infoEl.innerText = trx.api_msg || '-';

        // Tampilkan Tombol Refresh Manual (Kecuali Dibatalkan)
        const btnRefresh = document.getElementById('btnRefreshStatus');
        if (trx.status !== 'Dibatalkan') {
            btnRefresh.classList.remove('hide');
            btnRefresh.onclick = () => window.manualCheckTrx(trx.trx_id, trx.provider_code || trx.provider_id);
        } else {
            btnRefresh.classList.add('hide');
        }

        // Auto Check khusus Pending (tanpa klik)
        if(trx.status === 'Pending' || trx.status === 'Proses') {
             if(!trx.trx_id.startsWith('PO-')) window.manualCheckTrx(trx.trx_id, trx.provider_code || trx.provider_id);
        }
        
        // Tombol Batalkan Preorder (PO)
        const btnCancelPo = document.getElementById('btnCancelPreorder');
        if(trx.trx_id.startsWith('PO-') && trx.status === 'Pending') {
            btnCancelPo.classList.remove('hide');
            btnCancelPo.onclick = () => window.cancelPreorder(trx.trx_id);
        } else {
            btnCancelPo.classList.add('hide');
        }

        document.getElementById('detailTrxModal').classList.remove('hide');
    };

                        window.manualCheckTrx = async (docId, providerId, isSilent = false) => {
        const btn = document.getElementById('btnRefreshStatus');
        if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            // 1. Ambil Data Lokal
            const trxRef = doc(db, "users", currentUser.uid, "history", docId);
            const trxSnap = await getDoc(trxRef);
            if(!trxSnap.exists()) return;
            const localData = trxSnap.data();

            // --- LOGIKA ICS (Update V4 with Error Handler) ---
            if (String(docId).startsWith('ICS-') || providerId === 'ICS' || (localData.provider_code && localData.provider_code.startsWith('ICS'))) {
                console.log("[Check] Mode ICS untuk", docId);
                const res = await callIcsApi('checkTransaction', { refid: docId });
                
                if (res.success) {
                    let freshStatus = 'Pending';
                    const rawStatus = (res.data?.status || res.status || '').toLowerCase();
                                        let sn = '';
                    // Prioritas ambil 'message' dari data ICS jika ada (Format: PRODUK.DEST SUKSES...)
                    if (res.data && res.data.message) {
                        sn = res.data.message;
                    } else {
                        sn = res.data?.sn || res.sn || res.message || '';
                    }
                    
                    if (rawStatus === 'sukses' || rawStatus === 'success') freshStatus = 'Sukses';
                    else if (rawStatus === 'gagal' || rawStatus === 'failed' || rawStatus === 'error') freshStatus = 'Gagal';
                    
                    if (freshStatus === 'Gagal') {
                        if(localData.status !== 'Gagal') {
                             await window.processSmartRefund(currentUser.uid, docId, 'Refund: ' + (sn || 'Transaksi Gagal'));
                             alert("Status Gagal: Saldo telah dikembalikan.");
                        }
                    } else if (freshStatus === 'Sukses') {
                        if(localData.status !== 'Sukses') {
                                                        await updateDoc(trxRef, {
                                status: 'Sukses',
                                api_msg: sn || 'Transaksi Berhasil',
                                sn: sn,
                                raw_json: JSON.stringify(res)
                            });
                            if(typeof window.sendTelegramNotif === 'function') { window.sendTelegramNotif('ORDER', { title: localData.title, amount: localData.amount, dest: localData.dest_num, trxId: docId }); } 
                            alert("Status Berhasil Diperbarui!");
                        }
                    } else {
                                                                        if(!isSilent) window.showToast("Status Masih Pending di Pusat...", "warning");
                    }

                    const statusEl = document.getElementById('dtStatus');
                    if (statusEl) {
                        statusEl.innerText = freshStatus;
                        statusEl.className = 'text-xs font-bold ' + (freshStatus === 'Sukses' ? 'text-green-600' : (freshStatus === 'Gagal' ? 'text-red-500' : 'text-orange-500'));
                        if(freshStatus !== 'Pending' && document.getElementById('dtSn')) {
                             document.getElementById('dtSn').innerText = sn;
                        }
                    }
                } else {
                    // --- INI BAGIAN PENTING YANG SEBELUMNYA HILANG ---
                    console.error("[Check Error]", res);
                    alert("Gagal Cek Status ICS:\n" + (res.message || "Tidak ada respon dari server.") + "\n\n(Kemungkinan relay.js belum diupdate)");
                }
            } else {
                // --- LOGIKA KHFY (LAMA) ---
                const res = await callApi('/history', { refid: docId });
                
                if(res.ok && res.data) {
                    let root = res.data;
                    let item = root.data;
                    if (Array.isArray(item)) item = item[0];
                    
                    if (item) {
                        const statusText = (item.status_text || '').toUpperCase();
                        const keterangan = item.keterangan || '';
                        const sn = item.sn || '';
                        
                        let freshStatus = 'Pending';
                        if (statusText === 'SUKSES') freshStatus = 'Sukses';
                        else if (statusText === 'GAGAL') freshStatus = 'Gagal';

                        if (freshStatus === 'Gagal') {
                            if(localData.status !== 'Gagal') {
                                 await window.processSmartRefund(currentUser.uid, docId, 'Refund: ' + (keterangan || 'Transaksi Gagal'));
                                 alert("Transaksi Gagal. Saldo dikembalikan.");
                            }
                        } else if (freshStatus === 'Sukses') {
                            if(localData.status !== 'Sukses') {
                                await updateDoc(trxRef, {
                                    status: 'Sukses',
                                    api_msg: 'Transaksi Berhasil',
                                    sn: sn || keterangan || 'Sukses',
                                    raw_json: JSON.stringify(root)
                                });
                                if(typeof window.sendTelegramNotif === 'function') { window.sendTelegramNotif('ORDER', { title: localData.title, amount: localData.amount, dest: localData.dest_num, trxId: docId }); } 
                                alert("Transaksi Sukses!");
                            }
                        } else {
                                                                            if(!isSilent) window.showToast("Status masih PENDING/PROSES.", "warning");
                        }
                        
                        // Update UI Realtime
                        const statusEl = document.getElementById('dtStatus');
                        if (statusEl) {
                            statusEl.innerText = freshStatus;
                            statusEl.className = 'text-xs font-bold ' + (freshStatus === 'Sukses' ? 'text-green-600' : (freshStatus === 'Gagal' ? 'text-red-500' : 'text-orange-500'));
                            if(freshStatus !== 'Pending') document.getElementById('dtSn').innerText = (freshStatus === 'Gagal' ? keterangan : sn);
                        }
                    }
                } else {
                     alert("Gagal Cek Status KHFY: " + (res.error || "Koneksi Bermasalah"));
                }
            }
        } catch(e) { console.log("Check manual error:", e); alert("Error Sistem: " + e.message); }
        
        if(btn) btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
    };


    window.closeTrxDetail = () => document.getElementById('detailTrxModal').classList.add('hide');

    // --- FULL QR PREVIEW ---
    window.openFullQr = () => {
        const src = document.getElementById('qiosQrDisplay').src;
        if(!src) return;
        document.getElementById('fullQrImage').src = src;
        document.getElementById('fullQrModal').classList.remove('hide');
    };
    
    window.closeFullQr = () => {
        document.getElementById('fullQrModal').classList.add('hide');
    };

    // --- QIOSPAY SYSTEM V2 (Timer & History) ---
    let qiosInterval = null;

        let mtInterval = null;
    let currentMtTrxId = null;

    window.openManualTopUp = async () => {
        document.getElementById('topUpSheet').classList.add('hide');
        document.getElementById('manualTopUpModal').classList.remove('hide');
        
        // Cek apakah ada pending trx
        const q = query(collection(db, "users", currentUser.uid, "history"), 
            where("status", "==", "Pending"), 
            where("provider_id", "==", "MANUAL_SEABANK")
        );
        const snap = await getDocs(q);
        
        if (!snap.empty) {
            // Ambil trx terbaru
            const trx = snap.docs.sort((a,b) => new Date(b.data().date) - new Date(a.data().date))[0].data();
            const trxTime = new Date(trx.date).getTime();
            const now = Date.now();
            const diff = now - trxTime;
            const limit = 3 * 60 * 60 * 1000; // 3 Jam

            if (diff < limit) {
                currentMtTrxId = snap.docs[0].id;
                window.showMtStep2(trx.amount, trxTime + limit);
            } else {
                // Expired, auto cancel logic could go here, for now just show input
                window.resetMtUI();
            }
        } else {
            window.resetMtUI();
        }
    };

    window.resetMtUI = () => {
        document.getElementById('mtStep1').classList.remove('hide');
        document.getElementById('mtStep2').classList.add('hide');
        document.getElementById('mtInputAmount').value = '';
        currentMtTrxId = null;
        if(mtInterval) clearInterval(mtInterval);
    };

    window.closeManualTopUp = () => document.getElementById('manualTopUpModal').classList.add('hide');

    window.submitManualTopUp = async () => {
        const amount = parseInt(document.getElementById('mtInputAmount').value);
        if(!amount || amount < 10000) return alert('Minimal top up Rp 10.000');

        const unique = Math.floor(Math.random() * 999);
        const total = amount + unique;
        const trxId = 'MANUAL-' + Date.now();

        try {
            window.showLoader(true);
            const hRef = doc(db, "users", currentUser.uid, "history", trxId);
            await setDoc(hRef, {
                title: "Top Up Manual (Seabank)",
                amount: total,
                type: "in",
                date: new Date().toISOString(),
                status: "Pending",
                method: "Seabank",
                provider_id: "MANUAL_SEABANK",
                trx_id: trxId,
                api_msg: "Menunggu konfirmasi admin"
            });
            
            currentMtTrxId = trxId;
            window.showLoader(false);
            window.showMtStep2(total, Date.now() + (3 * 60 * 60 * 1000));
            
        } catch(e) {
            window.showLoader(false);
            alert("Gagal membuat transaksi: " + e.message);
        }
    };

    window.showMtStep2 = (amount, endTime) => {
        document.getElementById('mtStep1').classList.add('hide');
        document.getElementById('mtStep2').classList.remove('hide');
        document.getElementById('mtTotalDisplay').innerText = window.formatRp(amount);

        if(mtInterval) clearInterval(mtInterval);
        mtInterval = setInterval(() => {
            const now = Date.now();
            const diff = endTime - now;
            if(diff <= 0) {
                clearInterval(mtInterval);
                document.getElementById('mtTimer').innerText = "00:00:00";
                // Bisa tambah auto cancel disini
                return;
            }
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('mtTimer').innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }, 1000);
    };

    window.cancelManualTopUp = async () => {
        if(!currentMtTrxId) return;
        if(!confirm("Batalkan transaksi ini?")) return;

        try {
            window.showLoader(true);
            await updateDoc(doc(db, "users", currentUser.uid, "history", currentMtTrxId), {
                status: "Dibatalkan",
                api_msg: "Dibatalkan oleh User"
            });
            window.showLoader(false);
            alert("Transaksi dibatalkan.");
            window.resetMtUI();
        } catch(e) {
            window.showLoader(false);
            alert("Gagal membatalkan: " + e.message);
        }
    };

  window.openQios = () => {
        if (topupStatus && topupStatus.qios === false) return window.showAlert("Maintenance", "Layanan QRIS sedang dalam perbaikan.", "error");
        document.getElementById('topUpSheet').classList.add('hide');
        document.getElementById('qiosModal').classList.remove('hide');
        window.renderTopUpHistory(); 
        
        const savedData = localStorage.getItem('qios_trx_' + currentUser.uid);
        if (savedData) {
            const ticket = JSON.parse(savedData);
            const now = Date.now();
            const limit = 25 * 60 * 1000; 
            
            if ((now - ticket.created) < limit) {
                qiosTicket = ticket;
                window.restoreQiosUI();
                return;
            } else {
                localStorage.removeItem('qios_trx_' + currentUser.uid);
            }
        }
        window.resetQiosStep();
    };
    
    window.closeQios = () => document.getElementById('qiosModal').classList.add('hide');
    
    window.resetQiosStep = () => {
        document.getElementById('qiosStep1').classList.remove('hide');
        document.getElementById('qiosStep2').classList.add('hide');
        document.getElementById('qiosInputAmount').value = '';
        if(qiosInterval) clearInterval(qiosInterval);
        qiosTicket = null;
    };

    window.generateQiosTicket = () => {
        const input = parseInt(document.getElementById('qiosInputAmount').value);
        if(!input || input < 1000) return alert('Minimal Top Up Rp 1.000');
        
        const uniqueCode = Math.floor(Math.random() * 900) + 100;
        const total = input + uniqueCode;
        
        qiosTicket = {
            base: input,
            unique: uniqueCode,
            total: total,
            created: Date.now()
        };
        
        localStorage.setItem('qios_trx_' + currentUser.uid, JSON.stringify(qiosTicket));
        window.restoreQiosUI();
    };

    window.restoreQiosUI = () => {
        document.getElementById('qiosTotalDisplay').innerText = window.formatRp(qiosTicket.total);
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(QIOS_CONFIG.qr_string)}`;
        document.getElementById('qiosQrDisplay').src = qrUrl;

        document.getElementById('qiosStep1').classList.add('hide');
        document.getElementById('qiosStep2').classList.remove('hide');
        window.startQiosTimer();
    };

    window.startQiosTimer = () => {
        if(qiosInterval) clearInterval(qiosInterval);
        
        const tick = () => {
            if(!qiosTicket) return;
            const now = Date.now();
            const endTime = qiosTicket.created + (25 * 60 * 1000);
            const diff = endTime - now;

            if(diff <= 0) {
                clearInterval(qiosInterval);
                document.getElementById('qiosTimerDisplay').innerText = "00:00";
                alert("Waktu pembayaran habis. Transaksi dibatalkan.");
                window.cancelQiosTransaction(true, "Gagal (Timeout)");
                return;
            }

            const m = Math.floor(diff / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('qiosTimerDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        };
        
        tick();
        qiosInterval = setInterval(tick, 1000);
    };

    window.cancelQiosTransaction = async (silent = false, statusLabel = "Dibatalkan") => {
        if(!silent && !confirm("Batalkan transaksi ini?")) return;

        if(qiosTicket) {
            try {
                const hRef = doc(db, "users", currentUser.uid, "history", "TOPUP-FAIL-"+qiosTicket.created);
                await setDoc(hRef, {
                    title: "Top Up " + statusLabel,
                    amount: qiosTicket.total,
                    type: "in",
                    date: new Date().toISOString(),
                    status: statusLabel,
                    method: "QiosPay QRIS"
                });
            } catch(e) { console.error(e); }
        }

        localStorage.removeItem('qios_trx_' + currentUser.uid);
        if(qiosInterval) clearInterval(qiosInterval);
        window.resetQiosStep();
    };

    window.checkQiosStatus = async () => {
        if(!qiosTicket) return;
        const btn = document.getElementById('btnCheckQios');
        const originalText = "SAYA SUDAH BAYAR";
        btn.innerText = "Memverifikasi Dana...";
        btn.disabled = true;

        try {
            const targetUrl = `https://qiospay.id/api/mutasi/qris/${QIOS_CONFIG.merchant_code}/${QIOS_CONFIG.api_key}`;
            let resultData = null;
            let isConnected = false;

            for (const proxy of PROXY_LIST) {
                if(isConnected) break;
                try {
                    const fullUrl = proxy.url ? proxy.url + encodeURIComponent(targetUrl) : targetUrl;
                    const response = await fetch(fullUrl);
                    if (response.ok) {
                        const text = await response.text();
                        let rawData = JSON.parse(text);
                        // Membongkar data jika dibungkus oleh proxy AllOrigins/CodeTabs
                        let cleanData = rawData.contents ? JSON.parse(rawData.contents) : rawData;
                        if (cleanData && (cleanData.status || cleanData.data)) {
                            resultData = cleanData;
                            isConnected = true;
                        }
                    }
                } catch (e) { console.warn("Proxy skip:", e); }
            }

            if (!isConnected || !resultData) throw new Error("Gagal terhubung ke server mutasi. Pastikan koneksi internet stabil.");

            const mutations = resultData.data || [];
            const targetAmount = parseInt(qiosTicket.total);
            
            // Mencari kecocokan nominal dan tipe kredit (dana masuk)
            const foundTx = mutations.find(tx => {
                const txAmount = parseInt(String(tx.amount).replace(/[^0-9]/g, ''));
                const txType = String(tx.type).toLowerCase();
                return txAmount === targetAmount && (txType === 'cr' || txType === 'credit' || txType === 'masuk');
            });

                        if(foundTx) {
                await runTransaction(db, async (t) => {
                    // 1. Definisikan Referensi Dokumen History DULU
                    const trxId = "TOPUP-" + qiosTicket.created;
                    const hRef = doc(db, "users", currentUser.uid, "history", trxId);
                    
                    // 2. CEK APAKAH SUDAH PERNAH DIKLAIM? (INI KUNCINYA)
                    const hDoc = await t.get(hRef);
                    if (hDoc.exists()) {
                        throw "Transaksi ini sudah diproses sebelumnya!";
                    }

                    const userRef = doc(db, "users", currentUser.uid);
                    const uDoc = await t.get(userRef);
                    if (!uDoc.exists()) throw "User tidak ditemukan";
                    
                                                            const beforeBal = (uDoc.data().balance || 0);
                    const newBal = beforeBal + targetAmount;
                    t.update(userRef, { balance: newBal });
                    window.logDoniGuardAudit(t, currentUser.uid, 'IN', targetAmount, beforeBal, newBal, "QP-" + qiosTicket.created, 'Top Up QRIS Success');
                    
                    // 4. Catat riwayat sukses
                    t.set(hRef, {
                        title: "Top Up QRIS Berhasil",
                        amount: targetAmount,
                        type: "in",
                        date: new Date().toISOString(),
                        status: "Sukses",
                        method: "QiosPay",
                        trx_id: "QP-" + qiosTicket.created
                    });
                });

                // Kirim Notif Telegram
                window.sendTelegramNotif('TOPUP', { amount: targetAmount, trxId: "QP-" + qiosTicket.created });

                alert(`SUKSES! Saldo Rp ${targetAmount.toLocaleString()} telah masuk ke akun Anda.`);
                localStorage.removeItem('qios_trx_' + currentUser.uid);
                window.closeQios();
                window.nav('homePage');
            } else {
                alert(`Dana Rp ${targetAmount.toLocaleString()} belum ditemukan.\n\nTips:\n1. Pastikan nominal transfer sama persis.\n2. Tunggu 1 menit jika baru saja transfer.`);
            }
        } catch(e) {
            alert("Kendala Sistem: " + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };

        window.copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => alert('Disalin: ' + text));
    };

    // --- SYSTEM LIVE CHAT ---
    let chatListenerUnsub = null;
    
    window.toggleChat = () => {
        const modal = document.getElementById('liveChatModal');
        const isClosed = modal.classList.contains('hide');
        
        if (isClosed) {
            modal.classList.remove('hide');
            document.getElementById('chatBadge').classList.add('hide');
            if(!chatListenerUnsub) initChatListener();
            setTimeout(() => scrollChatBottom(), 100);
        } else {
            modal.classList.add('hide');
        }
    };

    window.initChatListener = () => {
        if (!currentUser) return;
        const msgsRef = collection(db, "chats", currentUser.uid, "messages");
        const q = query(msgsRef, orderBy("timestamp", "asc"));

        chatListenerUnsub = onSnapshot(q, (snapshot) => {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            if(snapshot.empty) {
                container.innerHTML = '<div class="text-center mt-10 opacity-50"><i class="fas fa-comments text-4xl text-gray-300 dark:text-gray-600 mb-2"></i><p class="text-xs text-gray-400">Halo, ada yang bisa kami bantu?</p></div>';
                return;
            }

            let unreadCount = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                const isMe = data.sender === 'user';
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${isMe ? 'chat-me' : 'chat-admin'}`;
                bubble.innerHTML = `${data.text}<br><span class="text-[9px] opacity-70 block text-right mt-1">${formatTime(data.timestamp)}</span>`;
                container.appendChild(bubble);

                // Hitung notifikasi jika window tertutup & pengirim adalah admin
                if(!isMe && document.getElementById('liveChatModal').classList.contains('hide')) {
                    unreadCount++;
                }
            });

            if(unreadCount > 0) {
                 document.getElementById('chatBadge').innerText = unreadCount;
                 document.getElementById('chatBadge').classList.remove('hide');
            }
            scrollChatBottom();
        });
    };

    window.sendChatMessage = async () => {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text || !currentUser) return;

        input.value = ''; // Clear dulu biar responsif
        
        try {
            // 1. Simpan Pesan
            await addDoc(collection(db, "chats", currentUser.uid, "messages"), {
                text: text,
                sender: 'user',
                timestamp: serverTimestamp(),
                isRead: false
            });

            // 2. Update Info Header Chat (Untuk Admin List)
            await setDoc(doc(db, "chats", currentUser.uid), {
                username: currentUsername,
                lastMessage: text,
                lastTimestamp: serverTimestamp(),
                lastSender: 'user',
                isRead: false,
                userEmail: currentUser.email || '-'
            }, { merge: true });

        } catch(e) {
            console.error("Chat Error", e);
            alert("Gagal mengirim pesan.");
        }
    };

    function scrollChatBottom() {
        const el = document.getElementById('chatMessages');
        el.scrollTop = el.scrollHeight;
    }

    function formatTime(ts) {
        if(!ts) return '...';
        return new Date(ts.toDate()).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
    }

    // Tampilkan tombol chat hanya jika login
    onAuthStateChanged(auth, (user) => {
        if(user) {
            document.getElementById('chatFloatBtn').classList.remove('hide');
            initChatListener(); // Listen background untuk notifikasi
        } else {
            document.getElementById('chatFloatBtn').classList.add('hide');
            if(chatListenerUnsub) chatListenerUnsub();
        }
    });

  </script>
</body>
</html>