<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEBUG - SUPER ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #1e293b; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; padding-bottom: 50px; }
        
        /* KOMPONEN UI */
        .debug-card { background-color: #0f172a; border: 1px solid #334155; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .input-dark { width: 100%; background-color: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 12px; color: white; outline: none; transition: 0.3s; font-size: 13px; }
        .input-dark:focus { border-color: #3b82f6; }
        .btn-action { width: 100%; padding: 12px; border-radius: 12px; font-weight: bold; font-size: 13px; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        .btn-action:active { transform: scale(0.98); }

        /* GRID PRODUK */
        .provider-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
        .provider-scroll::-webkit-scrollbar { display: none; }
        .provider-badge { flex-shrink: 0; padding: 8px 16px; border-radius: 12px; background: #1e293b; border: 1px solid #334155; color: #94a3b8; font-size: 11px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.3s; }
        .provider-badge.active { background: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }
        
        .product-card { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 12px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .product-card:active { transform: scale(0.98); }
        .product-card.selected { border-color: #3b82f6; background: #1e3a8a; }

        .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-container p-4">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-black text-white tracking-tight"><span class="text-red-500">ROOT</span> ACCESS</h1>
            <p class="text-[10px] text-slate-400">OWNER CONTROL PANEL</p>
        </div>
        <div id="adminStatus" class="text-[10px] font-bold bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">Checking...</div>
    </div>

    <div class="debug-card border-l-4 border-l-blue-500">
        <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-500 flex items-center justify-center"><i class="fas fa-ghost"></i></div>
            <div>
                <h3 class="font-bold text-white text-sm">Ghost Transaction</h3>
                <p class="text-[10px] text-slate-400">Bypass Saldo & Tanpa Riwayat</p>
            </div>
        </div>

        <div class="space-y-3">
            <div class="relative">
                <input type="tel" id="ghostNumber" placeholder="Nomor Tujuan (08xx...)" class="input-dark pl-10 font-mono font-bold tracking-wider">
                <i class="fas fa-mobile-alt absolute left-3.5 top-3.5 text-slate-500"></i>
            </div>

            <div>
                <p class="text-[10px] text-slate-500 font-bold mb-2 ml-1">PILIH PROVIDER</p>
                <div class="provider-scroll" id="providerContainer"></div>
            </div>

            <div>
                <p class="text-[10px] text-slate-500 font-bold mb-2 ml-1">PILIH PRODUK</p>
                <div id="productGrid" class="grid grid-cols-2 gap-2 max-h-[250px] overflow-y-auto pr-1">
                    <div class="col-span-2 text-center py-8 opacity-50 border border-dashed border-slate-600 rounded-xl">
                        <i class="fas fa-hand-pointer mb-2"></i>
                        <p class="text-xs">Pilih provider di atas</p>
                    </div>
                </div>
            </div>

            <input type="hidden" id="selectedProviderCode">
            <input type="hidden" id="selectedProductCode">

            <button onclick="executeGhostTrx()" id="btnGhost" class="btn-action bg-blue-600 text-white opacity-50 cursor-not-allowed" disabled>
                TEMBAK (TANPA LOG)
            </button>
        </div>
    </div>

    <div class="debug-card border-l-4 border-l-green-500">
        <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 rounded-full bg-green-500/20 text-green-500 flex items-center justify-center"><i class="fas fa-syringe"></i></div>
            <div>
                <h3 class="font-bold text-white text-sm">Injeksi Saldo (QRIS)</h3>
                <p class="text-[10px] text-slate-400">Saldo Masuk + Notif Telegram Asli</p>
            </div>
        </div>
        <div class="space-y-3">
            <input type="text" id="targetUsername" placeholder="Username User Target" class="input-dark">
            <input type="number" id="topupAmount" placeholder="Nominal (Contoh: 50000)" class="input-dark">
            <button onclick="injectTopup()" class="btn-action bg-green-600 text-white hover:bg-green-700">
                INJEKSI SEKARANG
            </button>
        </div>
    </div>

    <div class="debug-card border-l-4 border-l-red-500">
        <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center"><i class="fas fa-trash-alt"></i></div>
            <div>
                <h3 class="font-bold text-white text-sm">Force Delete</h3>
                <p class="text-[10px] text-slate-400">Hapus Permanen Riwayat Transaksi</p>
            </div>
        </div>
        <div class="space-y-3">
            <input type="text" id="delUid" placeholder="UID User" class="input-dark">
            <input type="text" id="delTrxId" placeholder="ID Transaksi (TRX-...)" class="input-dark">
            <button onclick="forceDelete()" class="btn-action bg-red-600 text-white hover:bg-red-700">
                HAPUS DATA
            </button>
        </div>
    </div>

    <div class="text-center mt-6">
        <a href="index.html" class="text-xs font-bold text-slate-500 hover:text-white transition">Kembali ke Menu Utama</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBnVxgxkS8InH1PQCMGe3cY8IvPqSN6dLo",
        authDomain: "ppob-3ea96.firebaseapp.com",
        projectId: "ppob-3ea96",
        storageBucket: "ppob-3ea96.firebasestorage.app",
        messagingSenderId: "181320175094",
        appId: "1:181320175094:web:306b79071018410b910bd7",
        measurementId: "G-0K2V796QDX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- CONFIG API ---
    // URL Relay Internal
    const KHFY_RELAY_URL = "/api/relaykhfy"; 
    // Config Proxy Cadangan
    const PROXY_LIST = [
        { name: 'RelayLocal', url: '' }, // Prioritas 1: Relay Sendiri
        { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
        { name: 'CorsProxy', url: 'https://corsproxy.io/?' }
    ];
    
    // Config Server Pusat (Untuk fallback proxy)
    const CONFIG = { apiKey: "8F1199C1-483A-4C96-825E-F5EBD33AC60A", baseUrl: "https://panel.khfy-store.com/api_v2" };
    const ICS_CONFIG = { apiKey: "7274410f84b7e2810795810e879a4e0be8779c451d55e90e29d9bc174547ff77", baseUrl: "https://www.pandawa-digital.store/api/relay" };
    
    const TELEGRAM_CONFIG = {
        token: "7507761189:AAGUCYltzj_IMuDRgjUzUPiZDz4nbVXvOME",
        chatId: "-1002997407612"
    };

    let pricingRules = {};
    let globalProducts = [];
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('adminStatus').innerHTML = `<span class="text-green-400">ONLINE</span>`;
            await loadPricingRules();
            renderProviders();
        } else {
            alert("Silakan Login di Index/Panel Admin dulu!");
            window.location.href = 'index.html';
        }
    });

    // --- FUNGSI FETCH UTAMA (KHUSUS UNTUK RELAY ANDA) ---
    async function fetchKhfyData(endpoint, params = {}) {
        let lastError = "";

        // 1. Prioritas Utama: RELAY (Sesuai file relaykhfy.js Anda)
        try {
            // Relay Anda butuh 'endpoint' sebagai parameter.
            const relayParams = new URLSearchParams({ 
                endpoint: endpoint, 
                ...params 
            }).toString();

            console.log(`[DEBUG] Calling Relay: ${KHFY_RELAY_URL}?${relayParams}`);
            const res = await fetch(`${KHFY_RELAY_URL}?${relayParams}`);
            
            if (res.ok) {
                const json = await res.json();
                console.log("[DEBUG] Relay Success:", json);
                return json;
            } else {
                console.warn("[DEBUG] Relay Failed:", res.status);
                lastError += `Relay ${res.status}; `;
            }
        } catch (e) {
            console.warn("[DEBUG] Relay Error:", e);
            lastError += `Relay Err; `;
        }

        // 2. Fallback: PROXY (Jika file relay belum dideploy/gagal)
        console.log("[DEBUG] Switching to Proxy Fallback...");
        const targetUrl = `${CONFIG.baseUrl}${endpoint}?${new URLSearchParams(params).toString()}`;
        
        for (const proxy of PROXY_LIST) {
            if(proxy.name === 'RelayLocal') continue; 
            try {
                const fullUrl = proxy.url + encodeURIComponent(targetUrl);
                const res = await fetch(fullUrl);
                if (res.ok) return await res.json();
            } catch (e) {}
        }

        throw new Error("Gagal ambil data (Relay & Proxy mati). " + lastError);
    }

    async function loadPricingRules() {
        try {
            const snap = await getDoc(doc(db, "settings", "pricing"));
            if (snap.exists()) pricingRules = snap.data().rules || {};
        } catch(e) {}
    }

    const PPOB_PROVIDERS = [
        { code: 'ICS_XDA', name: 'Akrab Fresh', type: 'ics', icon: 'fa-bolt' },
        { code: 'ICS_CIRCLE', name: 'XL Circle', type: 'ics', icon: 'fa-circle-nodes' },
        { code: 'ICS_XLA', name: 'Akrab v2 (XLA)', type: 'ics', icon: 'fa-star' },
        { code: 'XLA', name: 'Akrab v1 (XLA)', type: 'khfy', icon: 'fa-mobile-screen' },
        { code: 'XLR', name: 'XL Reguler', type: 'khfy', icon: 'fa-mobile-screen' },
        { code: 'FMX', name: 'FlexMax', type: 'khfy', icon: 'fa-fire' },
        { code: 'PLN', name: 'Token PLN', type: 'khfy', icon: 'fa-lightbulb' }
    ];

    function renderProviders() {
        const container = document.getElementById('providerContainer');
        container.innerHTML = '';
        PPOB_PROVIDERS.forEach(p => {
            const btn = document.createElement('div');
            btn.className = `provider-badge`;
            btn.innerHTML = `<i class="fa-solid ${p.icon}"></i> ${p.name}`;
            btn.onclick = () => selectProvider(p.code, btn);
            container.appendChild(btn);
        });
    }

    async function selectProvider(code, btnElement) {
        document.querySelectorAll('.provider-badge').forEach(el => el.classList.remove('active'));
        btnElement.classList.add('active');
        document.getElementById('selectedProviderCode').value = code;
        document.getElementById('selectedProductCode').value = "";
        
        const btnGhost = document.getElementById('btnGhost');
        btnGhost.disabled = true;
        btnGhost.classList.add('opacity-50', 'cursor-not-allowed');

        const grid = document.getElementById('productGrid');
        grid.innerHTML = '<div class="col-span-2 text-center py-8"><span class="loader"></span><p class="text-[10px] mt-2 text-slate-400">Loading Data...</p></div>';

        let products = [];

        try {
            // A. FETCH ICS (Aman)
            if(code.startsWith('ICS_')) {
                let icsType = 'xda';
                if(code === 'ICS_CIRCLE') icsType = 'circle';
                if(code === 'ICS_XLA') icsType = 'xla';

                const res = await (await fetch(ICS_CONFIG.baseUrl + `?action=listProducts&apikey=${ICS_CONFIG.apiKey}&type=${icsType}&_t=${Date.now()}`)).json();
                if (res) {
                    let raw = [];
                    if (res.ready && Array.isArray(res.ready)) raw = res.ready;
                    else if (res.data && res.data.ready) raw = res.data.ready;
                    else if (Array.isArray(res.data)) raw = res.data;

                    if (code === 'ICS_CIRCLE') products = raw.filter(p => (p.type === 'circle' || (p.code||'').toUpperCase().startsWith('XCL')));
                    else if (code === 'ICS_XDA') products = raw.filter(p => (p.type === 'xda' || (p.code||'').toUpperCase().startsWith('XDA')));
                    else if (code === 'ICS_XLA') products = raw.filter(p => (p.type === 'xla' || (p.code||'').toUpperCase().startsWith('XLA')));
                }

            } else {
                // B. FETCH KHFY (Gunakan Fungsi Baru)
                if(globalProducts.length === 0) {
                    // Panggil fetchKhfyData dengan endpoint /list_product
                    const res = await fetchKhfyData('/list_product', { api_key: CONFIG.apiKey });
                    
                    // PARSER FLEKSIBEL (Menangani berbagai kemungkinan bentuk JSON)
                    if (res) {
                        if (Array.isArray(res.data)) globalProducts = res.data; // Format standard
                        else if (res.data && Array.isArray(res.data.data)) globalProducts = res.data.data; // Nested data
                        else if (Array.isArray(res)) globalProducts = res; // Direct array
                        
                        console.log("[DEBUG] KHFY Loaded:", globalProducts.length, "items");
                    }
                }

                // Filtering Logic
                if (globalProducts.length > 0) {
                    products = globalProducts.filter(p => {
                        const c = (p.code || p.kode_produk || '').toUpperCase();
                        const b = (p.brand || p.operator || '').toUpperCase();
                        if (code === 'XLA') return (c.startsWith('XLA') || c.startsWith('XLC')) && !c.startsWith('XDA');
                        if (code === 'FMX') return c.startsWith('FMX') || c === 'CFMX' || b === 'FMAX';
                        if (code === 'XLR') return ['FMX50','FMX65','FMX80','FMX150'].includes(c);
                        if (code === 'PLN') return b.includes('PLN') || c.includes('PLN');
                        return false;
                    });
                }
            }

            renderGrid(products);

        } catch (e) {
            console.error(e);
            grid.innerHTML = `<div class="col-span-2 text-center text-xs text-red-400 py-4">Error: ${e.message}</div>`;
            alert("Gagal Fetch: " + e.message + "\n(Pastikan file /api/relaykhfy.js sudah dideploy!)");
        }
    }

    function renderGrid(products) {
        const grid = document.getElementById('productGrid');
        grid.innerHTML = '';
        
        if(!products || products.length === 0) {
            grid.innerHTML = '<div class="col-span-2 text-center text-xs text-red-400 py-4">Produk Kosong</div>';
            return;
        }

        products.sort((a, b) => (parseInt(a.harga || a.price || 0) - parseInt(b.harga || b.price || 0)));

        products.forEach(p => {
            let rawPrice = parseInt(p.harga || p.price || 0);
            let price = rawPrice;
            let name = p.nama_produk || p.name || 'Produk';
            const code = p.kode_produk || p.code || p.buyer_sku_code;
            const stock = p.stock || p.stok || 0;

            if(pricingRules[code]) {
                const r = pricingRules[code];
                if(typeof r === 'object') { 
                    if(r.price) price += parseInt(r.price); 
                    if(r.name) name = r.name; 
                } else { price += parseInt(r); }
            } else { price += 2000; }

            const el = document.createElement('div');
            el.className = 'product-card group';
            el.onclick = () => selectProduct(code, el);
            el.innerHTML = `
                <div class="flex flex-col justify-between h-full">
                    <div class="mb-2">
                        <p class="text-[9px] text-blue-400 font-bold mb-0.5">${code}</p>
                        <h4 class="text-[11px] font-bold text-slate-200 leading-tight">${name}</h4>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-[9px] text-slate-500">Stok: ${stock}</span>
                        <p class="text-xs font-black text-white">Rp ${price.toLocaleString('id-ID')}</p>
                    </div>
                </div>
            `;
            grid.appendChild(el);
        });
    }

    function selectProduct(code, el) {
        document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedProductCode').value = code;
        const btn = document.getElementById('btnGhost');
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    // --- GHOST TRANSACTION (DIPERBAIKI UNTUK RELAY) ---
    window.executeGhostTrx = async () => {
        const num = document.getElementById('ghostNumber').value;
        const code = document.getElementById('selectedProductCode').value;
        const provider = document.getElementById('selectedProviderCode').value;
        
        if(!num || num.length < 10) return alert("Nomor HP tidak valid!");
        if(!code) return alert("Pilih produk dulu!");

        if(!confirm(`âš ï¸ GHOST TRANSACTION âš ï¸\n\nProduk: ${code}\nTujuan: ${num}\n\nSaldo Supplier: TERPOTONG\nSaldo DB: AMAN\nLog: TIDAK DICATAT\n\nLanjutkan?`)) return;

        const btn = document.getElementById('btnGhost');
        btn.innerText = 'MEMPROSES...';
        btn.disabled = true;

        const trxId = (provider.startsWith('ICS') ? 'ICS-GHOST-' : 'TRX-GHOST-') + Date.now();
        
        try {
            let result = null;

            if(provider.startsWith('ICS')) {
                const url = `${ICS_CONFIG.baseUrl}?action=createTransaction&apikey=${ICS_CONFIG.apiKey}&kode_produk=${code}&nomor_tujuan=${num}&refid=${trxId}`;
                result = await (await fetch(url)).json();
            } else {
                // KHFY GHOST
                // Gunakan fetchKhfyData agar lewat Relay dengan benar.
                // Relay Anda mengubah semua param menjadi URL Query, jadi ini aman.
                result = await fetchKhfyData('/trx', {
                    api_key: CONFIG.apiKey,
                    produk: code,
                    tujuan: num,
                    reff_id: trxId
                });
            }

            console.log("Ghost Response:", result);
            let msg = "No Response";
            if(result) {
                // Cek berbagai kemungkinan format pesan sukses/gagal
                msg = result.message || result.sn || (result.data ? result.data.message : '') || JSON.stringify(result);
            }
            
            alert(`HASIL TEMBAK:\n${msg}`);
            
        } catch(e) {
            alert("ERROR SYSTEM: " + e.message);
        } finally {
            btn.innerText = 'TEMBAK (TANPA LOG)';
            btn.disabled = false;
        }
    };

    // --- FUNGSI INJEKSI & UTILS ---
    window.formatRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    window.sendTelegramNotif = async (type, data) => {
        let message = "";
        let topicId = null;
        const now = new Date();
        const formattedDate = now.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/ pukul /g, ' | ');
        let safeTrxId = data.trxId || "QP-FAKE-" + Date.now(); 

        if (type === 'TOPUP') {
            topicId = 7;
            message = `âœ… DEPOSIT BERHASIL \nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’³ Jumlah : Rp ${window.formatRp(data.amount).replace('Rp', '').trim()}\nðŸ•’ Waktu : ${formattedDate}\nðŸ‘¤ User ID : ${data.username}\nðŸ“Œ Status : BERHASIL\nðŸ†” ID Transaksi :\n${safeTrxId}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ¢ PANDAWA SYSTEM\nhttps://www.pandawa-digital.store`;
        }
        const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.token}/sendMessage?chat_id=${TELEGRAM_CONFIG.chatId}&text=${encodeURIComponent(message)}&message_thread_id=${topicId}`;
        for(const p of PROXY_LIST) { if(p.name==='RelayLocal') continue; try { await fetch(p.url + encodeURIComponent(url)); break; } catch(e) {} }
    };

    window.injectTopup = async () => {
        const targetUser = document.getElementById('targetUsername').value;
        const amount = parseInt(document.getElementById('topupAmount').value);
        if(!targetUser || !amount) return alert("Isi Data Lengkap!");
        try {
            const q = query(collection(db, "users"), where("username", "==", targetUser));
            const snap = await getDocs(q);
            if(snap.empty) return alert("Username tidak ditemukan!");
            
            const userDoc = snap.docs[0];
            const uid = userDoc.id;
            const currentBal = userDoc.data().balance || 0;
            const trxId = "QP-" + Date.now();

            await runTransaction(db, async (t) => {
                const uRef = doc(db, "users", uid);
                const hRef = doc(db, "users", uid, "history", trxId);
                t.update(uRef, { balance: currentBal + amount });
                t.set(hRef, {
                    title: "Top Up QRIS Berhasil",
                    amount: amount,
                    type: "in",
                    date: new Date().toISOString(),
                    status: "Sukses",
                    method: "QiosPay",
                    trx_id: trxId,
                    note: "Injected by Admin"
                });
            });
            await window.sendTelegramNotif('TOPUP', { amount: amount, trxId: trxId, username: targetUser });
            alert("INJEKSI SUKSES!");
        } catch(e) { alert("Error: " + e.message); }
    }

    window.forceDelete = async () => {
        const uid = document.getElementById('delUid').value;
        const tid = document.getElementById('delTrxId').value;
        if(!uid || !tid) return alert("Data kurang!");
        if(!confirm("Hapus permanen?")) return;
        try { await deleteDoc(doc(db, "users", uid, "history", tid)); alert("Terhapus."); } catch(e) { alert(e.message); }
    }

    // Expose Global
    window.selectProvider = selectProvider;
    window.executeGhostTrx = executeGhostTrx;
    window.injectTopup = injectTopup;
    window.forceDelete = forceDelete;
</script>
</body>
</html>